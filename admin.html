<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administra√ß√£o - Falc√µes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #0a0a0a; --card-color: #141414; --neon-green: #00e640;
            --text-color: #e0e0e0; --border-color: #222; --danger-color: #ff4444;
            --warning-color: #ffaa00; --info-color: #007bff; --money-color: #00d4ff;
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh;
        }

        /* HEADER */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #000; padding: 12px 20px; border-bottom: 1px solid var(--border-color);
        }
        .logo-pequeno { height: 35px; filter: drop-shadow(0 0 5px var(--neon-green)); }
        
        /* MENU TABS - RESPONSIVO */
        .menu-tabs { 
            display: flex; background: #000; padding: 8px 15px; gap: 8px;
            overflow-x: auto; border-bottom: 1px solid var(--border-color);
            scrollbar-width: none; /* Firefox */
        }
        .menu-tabs::-webkit-scrollbar { display: none; } /* Chrome/Safari */

        .tab-btn {
            background: transparent; border: 1px solid #222; color: #666;
            padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; 
            transition: 0.3s; white-space: nowrap; display: flex; align-items: center; gap: 6px; font-size: 13px;
        }
        .tab-btn.ativo { background: var(--neon-green); color: black; border-color: var(--neon-green); box-shadow: 0 0 15px rgba(0, 230, 64, 0.2); }

        .container-principal { padding: 15px; flex: 1; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* CARDS ESTAT√çSTICAS - RESPONSIVO */
        .cards-resumo { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* 2 por linha no mobile */
            gap: 12px; 
            margin-bottom: 25px; 
        }
        @media (min-width: 768px) { .cards-resumo { grid-template-columns: repeat(4, 1fr); gap: 20px; } }

        .card-stat { 
            background: var(--card-color); padding: 15px; border-radius: 12px; 
            border: 1px solid var(--border-color); text-align: center; position: relative;
        }
        .stat-valor { font-size: 24px; font-weight: 800; color: var(--neon-green); display: block; margin-top: 5px; }
        .stat-titulo { color: #888; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: bold; }
        .card-faturamento { border-color: var(--money-color); background: rgba(0, 212, 255, 0.05); }
        .card-faturamento .stat-valor { color: var(--money-color); }

        /* TABELAS RESPONSIVAS */
        .tabela-container { 
            background: var(--card-color); border-radius: 12px; border: 1px solid var(--border-color); 
            overflow-x: auto; /* Scroll lateral no celular */
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background-color: #000; color: var(--neon-green); font-size: 11px; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 13px; }

        /* STATUS TAGS */
        .status-tag { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .status-concluida { background: rgba(0, 123, 255, 0.1); color: var(--info-color); border: 1px solid var(--info-color); }
        .status-cancelada { background: rgba(255, 68, 68, 0.1); color: var(--danger-color); border: 1px solid var(--danger-color); }
        .status-aceita { background: rgba(0, 230, 64, 0.1); color: var(--neon-green); border: 1px solid var(--neon-green); }

        /* GEST√ÉO DE USU√ÅRIOS */
        .painel-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 900px) { .painel-grid { grid-template-columns: 1fr 1fr; } }
        
        .coluna { background: var(--card-color); padding: 20px; border-radius: 15px; border: 1px solid var(--border-color); }
        .card-user-gestao { background: #1f1f1f; padding: 12px; border-radius: 10px; margin-bottom: 12px; border-left: 3px solid var(--neon-green); position: relative; }
        .user-name { font-weight: bold; font-size: 14px; color: #fff; display: block; }
        .user-sub { font-size: 12px; color: #777; display: block; margin-top: 3px; }

        .vazio { text-align: center; color: #444; padding: 20px; font-size: 13px; }

        /* MOTIVO CANCELAMENTO */
        .motivo-box {
            color: var(--danger-color); font-size: 11px; font-weight: bold; margin-top: 8px; 
            padding: 6px; background: rgba(255, 68, 68, 0.05); border-radius: 4px; border: 1px dashed rgba(255, 68, 68, 0.3);
        }
    </style>
</head>

<body>

<div class="header">
    <img src="assets/logo.png" class="logo-pequeno">
    <div style="text-align: right;">
        <span style="display: block; font-size: 10px; color: #666;">ADM ONLINE</span>
        <a href="index.html" style="color: var(--danger-color); text-decoration: none; font-weight: bold; font-size: 12px;">SAIR <i class="fas fa-sign-out-alt"></i></a>
    </div>
</div>

<div class="menu-tabs">
    <button class="tab-btn ativo" onclick="mudarAba('dashboard', event)"><i class="fas fa-chart-line"></i> DASHBOARD</button>
    <button class="tab-btn" onclick="mudarAba('aprovacoes', event)"><i class="fas fa-user-clock"></i> APROVA√á√ïES</button>
    <button class="tab-btn" onclick="mudarAba('gerenciar', event)"><i class="fas fa-users-cog"></i> GEST√ÉO</button>
</div>

<div class="container-principal">
    
    <div id="dashboard" class="conteudo-aba ativo">
    <div class="cards-resumo">
    <div class="card-stat card-faturamento">
        <span class="stat-titulo">Faturamento Hoje</span>
        <span class="stat-valor" id="faturamento-hoje">R$ 0,00</span>
    </div>

    <div class="card-stat">
        <span class="stat-titulo"><i class="fas fa-building"></i> Empresas</span>
        <span class="stat-valor" id="total-empresas" style="color: var(--warning-color)">0</span>
    </div>
    <div class="card-stat">
        <span class="stat-titulo"><i class="fas fa-motorcycle"></i> Pilotos</span>
        <span class="stat-valor" id="total-pilotos">0</span>
    </div>
    <div class="card-stat">
        <span class="stat-titulo"><i class="fas fa-users"></i> Clientes</span>
        <span class="stat-valor" id="total-clientes" style="color: var(--info-color)">0</span>
    </div>
</div>

        <h3 style="color: #666; font-size: 14px; margin-bottom: 12px; text-transform: uppercase;"><i class="fas fa-history"></i> Pedidos Recentes</h3>
        <div class="tabela-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>VALOR</th>
                        <th>LOCALIZA√á√ÉO</th>
                        <th>STATUS</th>
                        <th>PILOTO</th>
                    </tr>
                </thead>
                <tbody id="tabela-historico"></tbody>
            </table>
        </div>
    </div>

    <div id="aprovacoes" style="display:none;" class="conteudo-aba">
    <div class="painel-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
        <div class="coluna" style="border-top: 3px solid var(--warning-color);">
            <h3><i class="fas fa-building"></i> EMPRESAS PENDENTES</h3>
            <div id="lista-empresas">Carregando...</div>
        </div>

        <div class="coluna" style="border-top: 3px solid var(--neon-green);">
            <h3><i class="fas fa-motorcycle"></i> PILOTOS PENDENTES</h3>
            <div id="lista-motoboys">Carregando...</div>
        </div>

        <div class="coluna" style="border-top: 3px solid #666;">
            <h3><i class="fas fa-user-check"></i> CLIENTES</h3>
            <div id="lista-clientes"><div class="vazio">Aprova√ß√£o autom√°tica.</div></div>
        </div>
    </div>
</div>

    <div id="gerenciar" style="display:none;" class="conteudo-aba">
        <div class="painel-grid">
            <div class="coluna">
                <h3><i class="fas fa-user-shield"></i> PILOTOS ATIVOS</h3>
                <div id="container-motoboys-ativos"></div>
            </div>
            <div class="coluna">
                <h3><i class="fas fa-users"></i> CLIENTES ATIVOS</h3>
                <div id="container-clientes-ativos"></div>
            </div>
        </div>
    </div>

</div>

<script>
    const MEU_IP = 'https://falcoes-app.onrender.com';
    const usuarioLogado = JSON.parse(localStorage.getItem('usuario'));

    if (!usuarioLogado || usuarioLogado.tipo !== 'admin') window.location.href = 'index.html';

    function mudarAba(aba, event) {
        document.querySelectorAll('.conteudo-aba').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('ativo'));
        document.getElementById(aba).style.display = 'block';
        event.currentTarget.classList.add('ativo');

        if (aba === 'dashboard') carregarDashboard();
        if (aba === 'aprovacoes') carregarPendentes();
        if (aba === 'gerenciar') { carregarMotoboysAtivos(); carregarClientes(); }
    }

  async function carregarDashboard() {
    try {
        const res = await fetch(`${MEU_IP}/admin/dashboard`);
        const data = await res.json();
        // ... dentro de carregarDashboard()
try {
    const resUsers = await fetch(`${MEU_IP}/admin/clientes`); // Pega todos os usu√°rios ativos
    const todosUsuarios = await resUsers.json();
    
    const resMotos = await fetch(`${MEU_IP}/admin/motoboys`);
    const todosMotos = await resMotos.json();

    const qtdEmpresas = todosUsuarios.filter(u => u.tipo === 'empresa').length;
    const qtdClientes = todosUsuarios.filter(u => u.tipo === 'cliente').length;
    const qtdPilotos = todosMotos.length;

    document.getElementById('total-empresas').innerText = qtdEmpresas;
    document.getElementById('total-clientes').innerText = qtdClientes;
    document.getElementById('total-pilotos').innerText = qtdPilotos;
    
    // ... resto da sua l√≥gica de faturamento
} catch (err) { console.error("Erro nos contadores:", err); }

        // Fun√ß√£o segura para atualizar texto sem dar erro se o ID n√£o existir
        const atualizarTexto = (id, valor) => {
            const el = document.getElementById(id);
            if (el) el.innerText = valor;
        };

        atualizarTexto('total-hoje', data.total_hoje || 0);
        atualizarTexto('total-mes', data.total_mes || 0);
        atualizarTexto('qtd-moto', data.qtd_moto || 0);

        data.historico.forEach(c => {
    const valorF = parseFloat(c.valor || 0).toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});
    
    // Define se a etiqueta √© Azul (Pix) ou Amarela (Dinheiro)
    const corPgto = c.forma_pagamento === 'PIX' ? '#007bff' : '#ffc107';

    tbody.innerHTML += `
        <tr>
            <td style="color:#666; font-size:11px;">#${c.id}</td>
            <td style="font-weight:bold; color:var(--neon-green)">${valorF}</td>
            <td>
                <span style="background:${corPgto}; color:#fff; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold;">
                    ${c.forma_pagamento || 'DINHEIRO'}
                </span>
            </td>
            <td>
                <div style="color:#fff; font-weight:600;">üìç ${(c.origem || '').split(',')[0]}</div>
                <div style="color:#666; font-size:11px;">üèÅ ${(c.destino || '').split(',')[0]}</div>
            </td>
            <td><span class="status-tag status-${c.status}">${c.status}</span></td>
            <td>${c.nome_motoboy || '---'}</td>
        </tr>`;
});

        const formatar = (v) => v.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
        atualizarTexto('faturamento-hoje', formatar(somaHoje));
        atualizarTexto('faturamento-mes', formatar(somaMes));

        // Tabela (seu c√≥digo original de renderiza√ß√£o permanece abaixo...)
        const tbody = document.getElementById('tabela-historico');
        if (tbody) {
            tbody.innerHTML = '';
            data.historico.forEach(c => {
                const valorF = parseFloat(c.valor || 0).toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});
                tbody.innerHTML += `
                    <tr>
                        <td style="color:#666; font-size:11px;">#${c.id}</td>
                        <td style="font-weight:bold; color:var(--neon-green)">${valorF}</td>
                        <td>
                            <div style="color:#fff; font-weight:600;">üìç ${(c.origem || '').split(',')[0]}</div>
                            <div style="color:#666; font-size:11px;">üèÅ ${(c.destino || '').split(',')[0]}</div>
                        </td>
                        <td><span class="status-tag status-${c.status}">${c.status}</span></td>
                        <td>${c.nome_motoboy || '---'}</td>
                    </tr>`;
            });
        }
    } catch (err) { console.error("Erro dashboard:", err); }
}

    // --- MANTENDO SUAS FUN√á√ïES DE GEST√ÉO ---
    async function carregarPendentes() {
    try {
        const res = await fetch(`${MEU_IP}/admin/pendentes`);
        const users = await res.json();
        
        const divMoto = document.getElementById('lista-motoboys');
        const divEmpresa = document.getElementById('lista-empresas');
        
        divMoto.innerHTML = '';
        divEmpresa.innerHTML = '';

        // Filtra Pilotos
        const pendentesMoto = users.filter(u => u.tipo === 'motoboy');
        if(pendentesMoto.length === 0) divMoto.innerHTML = '<div class="vazio">Nenhum piloto aguardando.</div>';
        
        // Filtra Empresas
        const pendentesEmpresa = users.filter(u => u.tipo === 'empresa');
        if(pendentesEmpresa.length === 0) divEmpresa.innerHTML = '<div class="vazio">Nenhuma empresa aguardando.</div>';

        // Renderiza Pilotos
        pendentesMoto.forEach(u => {
            divMoto.innerHTML += criarCardAprovacao(u, 'PILOTO');
        });

        // Renderiza Empresas
        pendentesEmpresa.forEach(u => {
            divEmpresa.innerHTML += criarCardAprovacao(u, 'EMPRESA');
        });

    } catch (e) { console.error("Erro ao carregar pendentes:", e); }
}

// Fun√ß√£o auxiliar para n√£o repetir c√≥digo de cria√ß√£o de card
function criarCardAprovacao(u, label) {
    const cor = label === 'EMPRESA' ? 'var(--warning-color)' : 'var(--neon-green)';
    return `
        <div class="card-user-gestao" style="border-left-color: ${cor}">
            <span class="user-name">${u.nome} <small style="color:${cor}">[${label}]</small></span>
            <span class="user-sub"><i class="fas fa-phone"></i> ${u.telefone}</span>
            <span class="user-sub"><i class="fas fa-envelope"></i> ${u.email}</span>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-acao" style="background:${cor}; border:none; padding:7px 12px; border-radius:5px; font-weight:bold; cursor:pointer; color:#000;" onclick="decisao(${u.id}, 'aprovar')">LIBERAR ACESSO</button>
                <button class="btn-acao" style="background:none; border:1px solid var(--danger-color); color:var(--danger-color); padding:7px 12px; border-radius:5px; cursor:pointer;" onclick="decisao(${u.id}, 'rejeitar')">RECUSAR</button>
            </div>
        </div>`;
}

    async function carregarMotoboysAtivos() {
        const div = document.getElementById('container-motoboys-ativos');
        try {
            const res = await fetch(`${MEU_IP}/admin/motoboys`);
            const data = await res.json();
            div.innerHTML = data.map(m => `
                <div class="card-user-gestao">
                    <button style="float:right; background:none; border:none; color:#444;" onclick="removerUsuario(${m.id})"><i class="fas fa-trash"></i></button>
                    <span class="user-name">${m.nome}</span>
                    <span class="user-sub">${m.email}</span>
                </div>`).join('');
        } catch (e) { div.innerHTML = "Erro ao carregar."; }
    }

    async function carregarClientes() {
    const div = document.getElementById('container-clientes-ativos');
    try {
        const res = await fetch(`${MEU_IP}/admin/clientes`);
        const data = await res.json();
        
        // Vamos mostrar Clientes e Empresas aqui, mas com cores diferentes
        div.innerHTML = data.map(c => {
            const ehEmpresa = c.tipo === 'empresa';
            const borda = ehEmpresa ? 'var(--warning-color)' : '#555';
            const tag = ehEmpresa ? '<small style="color:var(--warning-color)">[EMPRESA]</small>' : '';
            
            return `
                <div class="card-user-gestao" style="border-left-color: ${borda};">
                    <button style="float:right; background:none; border:none; color:#444; cursor:pointer;" onclick="removerUsuario(${c.id})"><i class="fas fa-trash"></i></button>
                    <span class="user-name">${c.nome} ${tag}</span>
                    <span class="user-sub">${c.telefone} | ${c.email}</span>
                </div>`;
        }).join('');
    } catch (e) { div.innerHTML = "Erro ao carregar."; }
}

    async function decisao(id, acao) {
        if(!confirm(`Confirma ${acao}?`)) return;
        const res = await fetch(`${MEU_IP}/admin/${acao === 'aprovar' ? 'aprovar' : 'rejeitar'}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id })
        });
        if((await res.json()).success) carregarPendentes();
    }

    async function removerUsuario(id) {
        if(!confirm("REMOVER?")) return;
        const res = await fetch(`${MEU_IP}/admin/remover/${id}`, { method: 'DELETE' });
        if((await res.json()).success) { carregarMotoboysAtivos(); carregarClientes(); }
    }

    // Inicializa√ß√£o
    carregarDashboard();
</script>

</body>
</html>