<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Falcões</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-color: #0a0a0a; --card-color: #141414; --neon-green: #00e640;
            --text-color: #e0e0e0; --border-color: #222; --danger-color: #ff4444;
            --warning-color: #ffaa00; --info-color: #007bff; --money-color: #00d4ff;
        }

        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh;
        }

        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #000; padding: 12px 20px; border-bottom: 1px solid var(--border-color);
        }
        .logo-pequeno { height: 35px; filter: drop-shadow(0 0 5px var(--neon-green)); }
        
        .menu-tabs { 
            display: flex; background: #000; padding: 8px 15px; gap: 8px;
            overflow-x: auto; border-bottom: 1px solid var(--border-color);
            scrollbar-width: none;
        }
        .menu-tabs::-webkit-scrollbar { display: none; }

        .tab-btn {
            background: transparent; border: 1px solid #222; color: #666;
            padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; 
            transition: 0.3s; white-space: nowrap; display: flex; align-items: center; gap: 6px; font-size: 13px;
        }
        .tab-btn.ativo { background: var(--neon-green); color: black; border-color: var(--neon-green); box-shadow: 0 0 15px rgba(0, 230, 64, 0.2); }

        .container-principal { padding: 15px; flex: 1; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        .cards-resumo { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px; }
        @media (min-width: 768px) { .cards-resumo { grid-template-columns: repeat(4, 1fr); gap: 20px; } }

        .card-stat { 
            background: var(--card-color); padding: 20px; border-radius: 12px; 
            border: 1px solid var(--border-color); text-align: left; position: relative;
        }
        .stat-valor { font-size: 26px; font-weight: 800; color: var(--neon-green); display: block; margin-top: 5px; }
        .stat-titulo { color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        
        .card-destaque { border-left: 4px solid var(--money-color); }
        .card-pendente { border-left: 4px solid var(--danger-color); }

        .tabela-container { 
            background: var(--card-color); border-radius: 12px; border: 1px solid var(--border-color); 
            overflow-x: auto; margin-top: 10px;
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background-color: #000; color: var(--neon-green); font-size: 11px; padding: 15px; text-align: left; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 13px; }

        .status-tag { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .status-concluida { background: rgba(0, 230, 64, 0.1); color: var(--neon-green); border: 1px solid var(--neon-green); }

        .painel-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 900px) { .painel-grid { grid-template-columns: 1fr 1fr; } }
        
        .coluna { background: var(--card-color); padding: 20px; border-radius: 15px; border: 1px solid var(--border-color); }
        .card-user-gestao { background: #1a1a1a; padding: 15px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #333; }
        .btn-remover { color: var(--danger-color); background: none; border: none; cursor: pointer; padding: 5px; font-size: 16px; }
        
        .input-busca { flex: 1; background: #000; border: 1px solid #333; color: white; padding: 8px 12px; border-radius: 6px; outline: none; }
        
        /* Estilo do Gráfico */
        .chart-box { max-width: 400px; margin: 20px auto; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 15px; }
    </style>
</head>

<body>

<div class="header">
    <img src="assets/logo.png" class="logo-pequeno">
    <div style="text-align: right;">
        <span style="display: block; font-size: 10px; color: var(--neon-green); font-weight: 900;">PAINEL ADMINISTRATIVO</span>
        <a href="index.html" style="color: var(--danger-color); text-decoration: none; font-weight: bold; font-size: 12px;">SAIR <i class="fas fa-sign-out-alt"></i></a>
    </div>
</div>

<div class="menu-tabs">
    <button class="tab-btn ativo" onclick="mudarAba('dashboard', event)"><i class="fas fa-chart-line"></i> DASHBOARD</button>
    <button class="tab-btn" onclick="mudarAba('relatorios', event)"><i class="fas fa-file-invoice-dollar"></i> RELATÓRIOS</button>
    <button class="tab-btn" onclick="mudarAba('aprovacoes', event)"><i class="fas fa-user-clock"></i> APROVAÇÕES</button>
    <button class="tab-btn" onclick="mudarAba('gerenciar', event)"><i class="fas fa-users-cog"></i> GESTÃO GERAL</button>
</div>

<div class="container-principal">
    
    <div id="dashboard" class="conteudo-aba">
        <div class="cards-resumo">
            <div class="card-stat card-destaque">
                <span class="stat-titulo">Faturamento (Hoje)</span>
                <span class="stat-valor" id="faturamento-hoje">R$ 0,00</span>
            </div>
            <div class="card-stat card-pendente">
                <span class="stat-titulo">Comissões a Receber</span>
                <span class="stat-valor" id="saldo-a-receber" style="color: var(--danger-color)">R$ 0,00</span>
                <small style="font-size: 9px; color: #666;">15% DE CORRIDAS EM DINHEIRO</small>
            </div>
            <div class="card-stat">
                <span class="stat-titulo">Pilotos Online</span>
                <span class="stat-valor" id="total-pilotos">0</span>
            </div>
            <div class="card-stat">
                <span class="stat-titulo">Empresas / Clientes</span>
                <span class="stat-valor" id="total-usuarios" style="color: var(--info-color)">0</span>
            </div>
        </div>

        <h3 style="color: #888; font-size: 14px; margin-bottom: 12px;"><i class="fas fa-exchange-alt"></i> ÚLTIMAS MOVIMENTAÇÕES</h3>
        <div class="tabela-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th> <th>PILOTO</th> <th>VALOR</th> <th>TAXA ADM</th> <th>PAGAMENTO</th> <th>STATUS</th> <th>DATA/HORA</th>
                    </tr>
                </thead>
                <tbody id="tabela-historico"></tbody>
            </table>
        </div>
    </div>

    <div id="relatorios" style="display:none;" class="conteudo-aba">
        <div class="coluna" style="margin-bottom: 20px;">
            <h3><i class="fas fa-filter"></i> FILTRAR HISTÓRICO</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size:11px; color:#888;">DATA INICIAL</label>
                    <input type="date" id="filtro-data-inicio" class="input-busca">
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size:11px; color:#888;">DATA FINAL</label>
                    <input type="date" id="filtro-data-fim" class="input-busca">
                </div>
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <button onclick="gerarRelatorio()" style="background: var(--neon-green); color: black; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer;">CONSULTAR</button>
                    <button onclick="exportarPlanilhaInteligente()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer;"><i class="fas fa-file-excel"></i> PLANILHA</button>
                </div>
            </div>
        </div>

        <div class="cards-resumo">
            <div class="card-stat card-destaque">
                <span class="stat-titulo">Total Período</span>
                <span class="stat-valor" id="rel-faturamento-total">R$ 0,00</span>
            </div>
            <div class="card-stat" style="border-left: 4px solid var(--info-color);">
                <span class="stat-titulo">Total Corridas</span>
                <span class="stat-valor" id="rel-total-corridas" style="color: var(--info-color)">0</span>
            </div>
            <div class="card-stat" style="border-left: 4px solid #a29bfe;">
                <span class="stat-titulo">Entregas</span>
                <span class="stat-valor" id="rel-total-entregas" style="color: #a29bfe">0</span>
            </div>
            <div class="card-stat" style="border-left: 4px solid #fab1a0;">
                <span class="stat-titulo">Moto Táxi</span>
                <span class="stat-valor" id="rel-total-mototaxi" style="color: #fab1a0">0</span>
            </div>
        </div>

        <div class="painel-grid">
            <div class="coluna">
                <div class="chart-box">
                    <canvas id="graficoCategorias"></canvas>
                </div>
            </div>
            <div class="coluna">
                <div class="tabela-container" style="max-height: 400px;">
                    <table id="tabela-relatorio">
                        <thead>
                            <tr><th>DATA</th> <th>CATEGORIA</th> <th>PILOTO</th> <th>VALOR</th> <th>ADM</th></tr>
                        </thead>
                        <tbody id="tabela-relatorio-corpo"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="aprovacoes" style="display:none;" class="conteudo-aba">
        <div class="painel-grid">
            <div class="coluna">
                <h3 style="color: var(--warning-color)"><i class="fas fa-building"></i> EMPRESAS PENDENTES</h3>
                <div id="lista-empresas">Carregando...</div>
            </div>
            <div class="coluna">
                <h3 style="color: var(--neon-green)"><i class="fas fa-motorcycle"></i> PILOTOS PENDENTES</h3>
                <div id="lista-motoboys">Carregando...</div>
            </div>
        </div>
    </div>

    <div id="gerenciar" style="display:none;" class="conteudo-aba">
        <div class="painel-grid">
            <div class="coluna">
                <h3><i class="fas fa-motorcycle"></i> PILOTOS ATIVOS</h3>
                <input type="text" class="input-busca" placeholder="Buscar piloto..." onkeyup="filtrarLista('container-motoboys-ativos', this.value)">
                <div id="container-motoboys-ativos" style="margin-top: 15px;"></div>
            </div>
            <div class="coluna">
                <h3><i class="fas fa-users"></i> CLIENTES & EMPRESAS</h3>
                <input type="text" class="input-busca" placeholder="Buscar cliente..." onkeyup="filtrarLista('container-clientes-ativos', this.value)">
                <div id="container-clientes-ativos" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const MEU_IP = 'https://falcoes-app.onrender.com';
    let dadosRelatorioGlobal = [];
    let meuGrafico = null;

    function mudarAba(aba, event) {
        document.querySelectorAll('.conteudo-aba').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('ativo'));
        document.getElementById(aba).style.display = 'block';
        event.currentTarget.classList.add('ativo');
        if (aba === 'dashboard') carregarDashboard();
        if (aba === 'aprovacoes') carregarPendentes();
        if (aba === 'gerenciar') { carregarMotoboysAtivos(); carregarClientes(); }
    }

    const formatarBRL = (v) => parseFloat(v || 0).toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });

    async function carregarDashboard() {
        try {
            const res = await fetch(`${MEU_IP}/admin/dashboard`);
            const data = await res.json();
            document.getElementById('faturamento-hoje').innerText = formatarBRL(data.faturamento_valor_hoje);
            document.getElementById('saldo-a-receber').innerText = formatarBRL(data.saldo_adm_a_receber);
            
            const tbody = document.getElementById('tabela-historico');
            tbody.innerHTML = data.historico.map(c => `
                <tr>
                    <td style="color:#666;">#${c.id}</td>
                    <td style="font-weight:bold;">${c.nome_motoboy || '---'}</td>
                    <td style="color:var(--neon-green); font-weight:800;">${formatarBRL(c.valor)}</td>
                    <td style="color:var(--danger-color); font-weight:bold;">${formatarBRL(c.valor * 0.15)}</td>
                    <td><span style="background:${c.forma_pagamento === 'PIX' ? '#007bff' : '#ffc107'}; color:#000; padding:3px 8px; border-radius:4px; font-size:10px; font-weight:900;">${c.forma_pagamento || 'DINHEIRO'}</span></td>
                    <td><span class="status-tag status-concluida" style="text-transform: uppercase;">${c.status}</span></td>
                    <td style="font-size:11px; color:#666;">${new Date(c.data_hora || Date.now()).toLocaleDateString()}</td>
                </tr>
            `).join('');

            const resUsers = await fetch(`${MEU_IP}/admin/clientes`);
            const users = await resUsers.json();
            const resMotos = await fetch(`${MEU_IP}/admin/motoboys`);
            const motos = await resMotos.json();
            document.getElementById('total-pilotos').innerText = motos.length;
            document.getElementById('total-usuarios').innerText = users.length;
        } catch (err) { console.error(err); }
    }

   async function gerarRelatorio() {
    const inicioInput = document.getElementById('filtro-data-inicio').value; // Ex: "2026-01-01"
    const fimInput = document.getElementById('filtro-data-fim').value;       // Ex: "2026-01-01"

    if (!inicioInput || !fimInput) return alert("Selecione as datas inicial e final!");

    try {
        const res = await fetch(`${MEU_IP}/admin/dashboard`);
        const data = await res.json();
        
        if (!data.historico) return alert("Nenhum histórico encontrado no servidor.");

        // Filtro robusto para datas do Postgres e status
        const filtrados = data.historico.filter(item => {
            if (!item.data_hora || !item.status) return false;

            // 1. Limpa a data do banco (pega apenas YYYY-MM-DD)
            // Funciona se vier "2026-01-01 11:10:15" ou "2026-01-01T14:10:15.000Z"
            const dataBancoTratada = item.data_hora.split(' ')[0].split('T')[0];

            // 2. Normaliza o status
            const statusNormalizado = item.status.trim().toLowerCase();

            // 3. Comparação direta de strings (YYYY-MM-DD)
            const dataBate = dataBancoTratada >= inicioInput && dataBancoTratada <= fimInput;
            const statusBate = statusNormalizado === 'concluida';

            return dataBate && statusBate;
        });

        if (filtrados.length === 0) {
            alert("Nenhuma corrida concluída encontrada para este período.");
        }

        dadosRelatorioGlobal = filtrados;
        exibirDadosRelatorio(filtrados);
    } catch (err) {
        console.error("Erro ao gerar relatório:", err);
        alert("Erro ao conectar com o servidor.");
    }
}
    function exibirDadosRelatorio(dados) {
        const tbody = document.getElementById('tabela-relatorio-corpo');
        let t = { valor: 0, eQ: 0, mQ: 0 };

        tbody.innerHTML = dados.length ? dados.map(c => {
            const v = parseFloat(c.valor || 0);
            t.valor += v;
            if (c.categoria === 'entrega' || c.tipo_servico === 'entrega') t.eQ++; else t.mQ++;

            return `<tr>
                <td>${new Date(c.data_hora).toLocaleDateString()}</td>
                <td style="text-transform:uppercase; font-size:10px;">${c.categoria || 'Moto Táxi'}</td>
                <td>${c.nome_motoboy || '---'}</td>
                <td style="color:var(--neon-green); font-weight:bold;">${formatarBRL(v)}</td>
                <td style="color:var(--danger-color);">${formatarBRL(v * 0.15)}</td>
            </tr>`;
        }).join('') : '<tr><td colspan="5" class="vazio">Sem dados.</td></tr>';

        document.getElementById('rel-faturamento-total').innerText = formatarBRL(t.valor);
        document.getElementById('rel-total-corridas').innerText = dados.length;
        document.getElementById('rel-total-entregas').innerText = t.eQ;
        document.getElementById('rel-total-mototaxi').innerText = t.mQ;

        atualizarGrafico(t.eQ, t.mQ);
    }

    function atualizarGrafico(entregas, mototaxi) {
        const ctx = document.getElementById('graficoCategorias').getContext('2d');
        if (meuGrafico) meuGrafico.destroy();

        meuGrafico = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Entregas', 'Moto Táxi'],
                datasets: [{
                    data: [entregas, mototaxi],
                    backgroundColor: ['#a29bfe', '#fab1a0'],
                    borderColor: '#141414',
                    borderWidth: 2
                }]
            },
            options: {
                plugins: {
                    legend: { labels: { color: '#e0e0e0', font: { size: 12 } } },
                    title: { display: true, text: 'Volume de Serviços', color: '#888' }
                }
            }
        });
    }

    function exportarPlanilhaInteligente() {
        if (!dadosRelatorioGlobal.length) return alert("Gere um relatório primeiro!");
        const dadosFormatados = dadosRelatorioGlobal.map(c => ({
            "DATA": new Date(c.data_hora).toLocaleDateString(),
            "PILOTO": c.nome_motoboy,
            "CATEGORIA": c.categoria || "Moto Táxi",
            "VALOR TOTAL": parseFloat(c.valor),
            "PAGAMENTO": c.forma_pagamento,
            "QUEM RECEBEU": c.forma_pagamento === 'PIX' ? 'EMPRESA (BANCO)' : 'PILOTO (MÃO)',
            "TAXA ADM (15%)": parseFloat(c.valor) * 0.15,
            "AUDITORIA": c.forma_pagamento === 'PIX' ? 'CONFERIR NO MERCADO PAGO' : 'COBRAR COMISSÃO DO PILOTO'
        }));

        const ws = XLSX.utils.json_to_sheet(dadosFormatados);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Financeiro");
        XLSX.writeFile(wb, `Financeiro_Falcoes_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    /* FUNÇÕES DE GESTÃO (PRESERVADAS) */
    async function carregarPendentes() {
        const res = await fetch(`${MEU_IP}/admin/pendentes`);
        const users = await res.json();
        document.getElementById('lista-motoboys').innerHTML = users.filter(u => u.tipo === 'motoboy').map(u => criarCardAprovacao(u, 'PILOTO')).join('') || '<div class="vazio">Nenhum</div>';
        document.getElementById('lista-empresas').innerHTML = users.filter(u => u.tipo === 'empresa').map(u => criarCardAprovacao(u, 'EMPRESA')).join('') || '<div class="vazio">Nenhum</div>';
    }

    function criarCardAprovacao(u, label) {
        const cor = label === 'EMPRESA' ? 'var(--warning-color)' : 'var(--neon-green)';
        return `<div class="card-user-gestao" style="border-left: 3px solid ${cor}">
            <div class="user-name">${u.nome} <span style="font-size:9px; background:${cor}; color:#000; padding:2px 5px; border-radius:3px;">${label}</span></div>
            <div style="margin-top:10px; display:flex; gap:8px;">
                <button style="flex:1; background:${cor}; border:none; padding:8px; border-radius:5px; font-weight:bold; cursor:pointer;" onclick="decisao(${u.id}, 'aprovar')">APROVAR</button>
                <button style="flex:1; background:transparent; border:1px solid var(--danger-color); color:var(--danger-color); padding:8px; border-radius:5px; cursor:pointer;" onclick="decisao(${u.id}, 'rejeitar')">RECUSAR</button>
            </div>
        </div>`;
    }

    async function carregarMotoboysAtivos() {
        const res = await fetch(`${MEU_IP}/admin/motoboys`);
        const data = await res.json();
        document.getElementById('container-motoboys-ativos').innerHTML = data.map(m => `
            <div class="card-user-gestao user-item">
                <div class="user-name">${m.nome} <button class="btn-remover" onclick="removerUsuario(${m.id}, 'motoboy')"><i class="fas fa-trash-alt"></i></button></div>
                <span class="user-sub">${m.email}</span>
            </div>`).join('');
    }

    async function carregarClientes() {
        const res = await fetch(`${MEU_IP}/admin/clientes`);
        const data = await res.json();
        document.getElementById('container-clientes-ativos').innerHTML = data.map(c => `
            <div class="card-user-gestao user-item">
                <div class="user-name">${c.nome} ${c.tipo === 'empresa' ? '<span style="color:var(--warning-color); font-size:10px;">[EMPRESA]</span>' : ''} <button class="btn-remover" onclick="removerUsuario(${c.id}, 'cliente')"><i class="fas fa-trash-alt"></i></button></div>
                <span class="user-sub">${c.telefone}</span>
            </div>`).join('');
    }

    async function decisao(id, acao) {
        if(!confirm(`Confirmar ${acao}?`)) return;
        await fetch(`${MEU_IP}/admin/${acao}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
        carregarPendentes();
    }

    async function removerUsuario(id, tipo) {
        if(!confirm(`Remover permanentemente este ${tipo}?`)) return;
        const res = await fetch(`${MEU_IP}/admin/remover/${id}`, { method: 'DELETE' });
        if((await res.json()).success) { carregarMotoboysAtivos(); carregarClientes(); carregarDashboard(); }
    }

    function filtrarLista(id, termo) {
        const items = document.getElementById(id).getElementsByClassName('user-item');
        Array.from(items).forEach(item => item.style.display = item.innerText.toLowerCase().includes(termo.toLowerCase()) ? 'block' : 'none');
    }

    carregarDashboard();
</script>
</body>
</html>