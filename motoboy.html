<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Motoboy - Falc√µes</title>
    <style>
        /* --- IDENTIDADE VISUAL DARK --- */
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --neon-green: #00e640;
            --text-color: #ffffff;
            --border-color: #333;
            --danger-color: #ff4444;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            gap: 15px;
            padding-bottom: 15px;
        }

        .logo-pequeno {
            height: 60px;
        }

        .moto-saudacao {
            font-weight: 800;
            color: white;
            font-size: 18px;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
            text-align: center;
        }

        .status-moto {
            background-color: var(--neon-green);
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
        }

        .logout {
            color: var(--danger-color);
            text-decoration: none;
            font-weight: 700;
            font-size: 13px;
            border: 1px solid var(--danger-color);
            padding: 4px 10px;
            border-radius: 15px;
            margin-left: 10px;
        }

        #tela-lista,
        #tela-bloqueio,
        #tela-corrida-ativa {
            display: none;
        }

        /* CARD CORRIDA */
        .card-corrida {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tipo-servico {
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            background: #333;
            padding: 5px 10px;
            border-radius: 5px;
            color: #ccc;
        }

        .valor {
            font-size: 24px;
            font-weight: 800;
            color: var(--neon-green);
        }

        .rota {
            margin-bottom: 20px;
            font-size: 15px;
            line-height: 1.6;
        }

        .destaque-endereco {
            color: white;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        /* NOVO: ESTILO PARA O CONTADOR */
        .contador-tempo {
            font-size: 18px;
            font-weight: 800;
            color: var(--danger-color);
            text-align: right;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        .btn-acao {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-verde {
            background-color: var(--neon-green);
            color: #000;
        }

        .btn-vermelho {
            background-color: var(--danger-color);
            color: white;
        }

        /* NOVO ESTILO DO BOT√ÉO DE CANCELAMENTO */

        /* TELA BLOQUEIO */
        .aviso-bloqueio {
            text-align: center;
            padding: 40px 20px;
            border: 1px solid var(--danger-color);
            border-radius: 15px;
            background: rgba(255, 68, 68, 0.1);
        }

        .tempo-bloqueio {
            font-size: 40px;
            font-weight: 800;
            color: var(--danger-color);
            margin: 20px 0;
            display: block;
        }

        /* TELA ATIVA */
        .titulo-ativa {
            text-align: center;
            color: var(--neon-green);
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: 800;
            animation: piscar 2s infinite;
        }

        .info-cliente {
            background: #000;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }

        @keyframes piscar {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* --- MODAIS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-box {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 20px;
            width: 85%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 230, 64, 0.1);
            animation: popup 0.3s ease;
        }

        .modal-titulo {
            font-size: 20px;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .modal-desc {
            color: #aaa;
            margin-bottom: 25px;
            font-size: 15px;
        }

        .modal-botoes {
            display: flex;
            gap: 10px;
        }

        .btn-modal {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-sim {
            background-color: var(--neon-green);
            color: black;
        }

        .btn-nao {
            background-color: #333;
            color: white;
        }

        .modal-icon-sucesso,
        .modal-icon-erro {
            font-size: 50px;
            margin-bottom: 10px;
            display: block;
        }

        .texto-verde {
            color: var(--neon-green);
        }

        .texto-vermelho {
            color: var(--danger-color);
        }

        @keyframes popup {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ESTILO PARA O CAMPO TEXTAREA NO MODAL DE CANCELAMENTO */
        .modal-box textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--card-color);
            color: white;
            resize: none;
            font-family: inherit;
            margin-top: 10px;
        }
    </style>
    <script>
    /***********************
     * ¬†VARI√ÅVEIS GLOBAIS
     ***********************/
    const usuario = JSON.parse(localStorage.getItem('usuario'));
    // 6. ADICIONE ESTE DEBUG
console.log('Usu√°rio logado:', usuario);
if (!usuario || !usuario.id) {
    console.error('Usu√°rio n√£o tem ID definido');
    window.location.href = 'index.html';
}

    // VERIFICA√á√ÉO SIMPLES E CORRETA
    if (!usuario || usuario.tipo !== 'motoboy') {
        window.location.href = 'index.html';
        throw new Error("Usu√°rio n√£o autorizado");
    }

    // AGORA SIM MOSTRA O NOME E CATEGORIA
    const msgOla = document.getElementById('msg-ola');
    if (msgOla && usuario.nome) { // <--- CORRE√á√ÉO DE ERRO
        msgOla.innerText = "OL√Å, " + usuario.nome.split(' ')[0].toUpperCase();
    } else if (msgOla) {
        msgOla.innerText = "OL√Å, PILOTO"; // Mant√©m o texto se o nome n√£o vier
    }
    
    // VERIFICA CATEGORIA CORRETAMENTE
    const categoriaExibicao = usuario.categoria || "GERAL";
    document.getElementById('label-categoria').innerText = `SUA CATEGORIA: ${categoriaExibicao.toUpperCase()}`;

    const MEU_IP = 'https://falcoes-app.onrender.com';
    let idCorridaSelecionada = null;
    let idCorridaAtual = null;
    let onlineInterval = null;

function mostrarCorridaEmAndamento() {
    // Alterna para a tela de corrida ativa
    mostrarTela('ativa');
    
    // Busca os dados atualizados da corrida
    fetch(`${MEU_IP}/minha-corrida-atual/${usuario.id}`)
        .then(res => res.json())
        .then(data => {
            if (data.tem_corrida) {
                preencherDadosAtiva(data.corrida);
            }
        });
}

    // Armazena os IDs dos setIntervals para os contadores
    let intervalosContadores = {};

    // NOVO: Controle da corrida sendo exibida (apenas 1 por vez, conforme o backend)
    let corridaSendoExibida = null;
    let notificacaoAtiva = false;

    /***********************
     * ¬†FUN√á√ïES DE STATUS ONLINE
     ***********************/
    
    async function enviarStatusOnline(online) {
        try {
            const response = await fetch(`${MEU_IP}/motoboy/status-online`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    motoboy_id: usuario.id,
                    online: online,
                    latitude: null,
                    longitude: null
                })
            });
            
            const result = await response.json();
            if (result.success) {
                const statusElement = document.getElementById('status-online-indicator');
                if (online) {
                    statusElement.innerText = "‚óè ONLINE";
                    statusElement.style.backgroundColor = "var(--neon-green)";
                } else {
                    statusElement.innerText = "‚óè OFFLINE";
                    statusElement.style.backgroundColor = "#666";
                }
            }
        } catch (err) {
            console.error("Erro ao enviar status online:", err);
        }
    }

    // Fun√ß√£o para deslogar
    function deslogar() {
        enviarStatusOnline(false);
        if (onlineInterval) {
            clearInterval(onlineInterval);
        }
        localStorage.clear();
        window.location.href = 'index.index';
    }

    // INICIALIZA STATUS ONLINE AO CARREGAR A P√ÅGINA
    document.addEventListener('DOMContentLoaded', function() {
        enviarStatusOnline(true);
        onlineInterval = setInterval(() => {
            enviarStatusOnline(true);
        }, 5000); // Polling de status online reduzido para 5s
    });

    /***********************
     * ¬†√ÅUDIO / NOTIFICA√á√ÉO
     ***********************/
    function tocarAlerta() {
        const audio = document.getElementById('som-alerta');
        if (!audio) return;
        try {
            audio.pause();
            audio.currentTime = 0;
            audio.play().catch(err => console.log("Som bloqueado at√© intera√ß√£o do usu√°rio"));
        } catch (e) {
            console.log("Erro ao tocar som:", e);
        }
    }

    /***********************
     * ¬†CONTADORES
     ***********************/
    function limparContadores() {
        Object.values(intervalosContadores).forEach(clearInterval);
        intervalosContadores = {};
    }

    function iniciarContador(id, tempoInicial, onTimeout) {
        limparContadores(); 

        let tempoRestante = tempoInicial;
        const cardElement = document.getElementById(`card-${id}`);
        const contadorElement = cardElement ? cardElement.querySelector('.contador-tempo') : null;

        if (!contadorElement) return;

        const decremento = async () => {
            if (tempoRestante <= 0) {
                clearInterval(intervalosContadores[id]);
                delete intervalosContadores[id];

                if (cardElement) cardElement.remove();

                try {
                    await fetch(`${MEU_IP}/expirar-corrida`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            corrida_id: id,
                            motoboy_id: usuario.id
                        })
                    });
                } catch (e) {
                    console.error("Erro ao notificar timeout da corrida:", e);
                }

                if (typeof onTimeout === 'function') onTimeout();
                return;
            }

            contadorElement.innerText = `‚è≥ SUA VEZ: ${tempoRestante}s`;
            tempoRestante--;
        };

        decremento();
        intervalosContadores[id] = setInterval(decremento, 1000);
    }

    /***********************
     * ¬†MODAIS E AJUDA
     ***********************/
    function fecharModal(idModal) {
        document.getElementById(idModal).style.display = 'none';
        if (idModal === 'modal-confirmacao') idCorridaSelecionada = null;
    }

    function mostrarErro(mensagem) {
        document.getElementById('msg-erro-texto').innerText = mensagem;
        document.getElementById('modal-erro').style.display = 'flex';
        // Resetar para estilo de erro padr√£o
        document.querySelector('#modal-erro .modal-titulo').innerText = "OCORREU UM ERRO";
        document.querySelector('#modal-erro .modal-icon-erro').innerText = "‚ö†Ô∏è";
        document.querySelector('#modal-erro .modal-box').style.borderColor = 'var(--danger-color)';
        document.querySelector('#modal-erro .modal-titulo').classList.remove('texto-verde');
        document.querySelector('#modal-erro .modal-titulo').classList.add('texto-vermelho');
        document.querySelector('#modal-erro .btn-modal').style.display = 'block';
    }

    // FUN√á√ÉO ADICIONADA PARA ABRIR O MODAL DE ACEITE
    function abrirModalAceitar(id) {
        idCorridaSelecionada = id;
        document.getElementById('modal-confirmacao').style.display = 'flex';
    }

    /***********************
     * ¬†POLLING / ESTADO
     ***********************/
    async function verificarEstado() {
        try {
            // 1. VERIFICA CORRIDA ATIVA
            const resAtiva = await fetch(`${MEU_IP}/minha-corrida-atual/${usuario.id}`);
            const dadosAtiva = await resAtiva.json();

            if (dadosAtiva.tem_corrida) {
                limparContadores();
                mostrarTela('ativa');
                preencherDadosAtiva(dadosAtiva.corrida);
                return;
            }

            // 2. VERIFICA BLOQUEIO OU CORRIDAS PENDENTES
            const resLista = await fetch(`${MEU_IP}/corridas-pendentes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ motoboy_id: usuario.id })
            });
            const dadosLista = await resLista.json();

            if (dadosLista.success === false && dadosLista.bloqueado) {
                limparContadores();
                mostrarTela('bloqueio');
                document.getElementById('tempo-restante').innerText = dadosLista.tempo + " min";
            } else if (dadosLista.success === false && dadosLista.offline) {
                document.getElementById('lista-corridas').innerHTML = 
                    '<div style="text-align:center; color:#ff4444; padding:30px;">‚ö†Ô∏è VOC√ä PRECISA ESTAR ONLINE</div>';
                mostrarTela('lista');
            } else {
                mostrarTela('lista');
                
                // CORRE√á√ÉO DA L√ìGICA: Busca o campo "corrida" (singular)
                let corrida = null;
                if (dadosLista.corrida) {
                    corrida = dadosLista.corrida;
                }
                renderizarLista(corrida);
            }

        } catch (err) { 
            console.error("Erro ao verificar estado:", err);
        }
    }

    function mostrarTela(tela) {
        document.getElementById('tela-lista').style.display = 'none';
        document.getElementById('tela-corrida-ativa').style.display = 'none';
        document.getElementById('tela-bloqueio').style.display = 'none';

        if (tela === 'lista') document.getElementById('tela-lista').style.display = 'block';
        if (tela === 'ativa') document.getElementById('tela-corrida-ativa').style.display = 'block';
        if (tela === 'bloqueio') document.getElementById('tela-bloqueio').style.display = 'block';
    }

    function preencherDadosAtiva(c) {
    // DEBUG: Verifica o que est√° vindo do backend
    console.log('üì¶ DADOS DA CORRIDA ATIVA RECEBIDOS:', c);
    
    // TENTE AMBAS AS POSSIBILIDADES DE NOME DE CAMPO
    idCorridaAtual = c.corrida_id || c.id;
    console.log('üîë idCorridaAtual definido como:', idCorridaAtual);
    
    document.getElementById('ativa-tipo').innerText = (c.tipo_servico || '--').toUpperCase();
    document.getElementById('ativa-valor').innerText = "R$ " + parseFloat(c.valor || 0).toFixed(2);
    document.getElementById('ativa-cliente').innerText = c.nome_cliente || '--';
    document.getElementById('ativa-fone').innerText = c.telefone_cliente || '--';
    document.getElementById('ativa-origem').innerText = c.origem || '--';
    document.getElementById('ativa-destino').innerText = c.destino || '--';
}

    /***********************
     * ¬†CRIA√á√ÉO E RENDERIZA√á√ÉO
     ***********************/

    // Fun√ß√£o para criar e exibir o card (mantida e adaptada)
    function criarCardCorrida(corrida) {
        const container = document.getElementById('lista-corridas');

        const div = document.createElement('div');
        div.className = 'card-corrida';
        div.id = `card-${corrida.corrida_id}`;

        const htmlConteudo = `
        <div class="card-top">
            <span class="tipo-servico">${corrida.tipo_servico.toUpperCase()}</span>
            <span class="valor">R$ ${parseFloat(corrida.valor).toFixed(2)}</span>
        </div>
        ${corrida.ciclo && corrida.ciclo > 1 ? 
            `<div style="background: #333; color: #ff9900; padding: 5px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; text-align: center;">
                ‚ö° CICLO ${corrida.ciclo}
            </div>` 
            : ''
        }
        <div class="rota">
            <div style="color:#ddd; margin-bottom:5px;">üìç ${corrida.origem}</div>
            <div style="color:#ddd;">üèÅ ${corrida.destino}</div>
        </div>
        <div class="contador-tempo" id="contador-${corrida.corrida_id}"></div>
        <button class="btn-acao btn-verde" onclick="aceitarCorrida(${corrida.corrida_id})">ACEITAR</button>
    `;
        container.innerHTML = ''; // Limpa antes de adicionar
        div.innerHTML = htmlConteudo;
        container.appendChild(div);

        // Calcula o tempo restante: 60 segundos menos os segundos j√° passados
        const tempoRestante = 60 - Math.ceil(parseFloat(corrida.segundos_passados || 0));
        
        // Inicia o contador
        if (tempoRestante > 0) {
            tocarAlerta();
            iniciarContador(corrida.corrida_id, tempoRestante, () => {
                // Se o tempo acabar, limpa a tela de lista e verifica estado
                document.getElementById('lista-corridas').innerHTML = '<div style="text-align:center; color:#555; padding:30px;">Nenhuma corrida dispon√≠vel.</div>';
                notificacaoAtiva = false;
                verificarEstado();
            });
        } else {
            // Se a corrida j√° expirou no backend, apenas ignora
            div.remove(); 
            verificarEstado(); // Verifica se h√° uma pr√≥xima
        }
    }


    function renderizarLista(corrida) {
        const container = document.getElementById('lista-corridas');
        
        // Se n√£o houver corrida, exibe mensagem e limpa o estado
        if (!corrida) {
            container.innerHTML = '<div style="text-align:center; color:#555; padding:30px;">Nenhuma corrida dispon√≠vel.</div>';
            limparContadores();
            notificacaoAtiva = false;
            corridaSendoExibida = null;
            return;
        }
        
        // Corrige o bug de s√≥ ver corridas da sua categoria. O filtro √© feito pelo backend.
        
        // Se j√° estiver exibindo a mesma corrida, n√£o faz nada
        if (corridaSendoExibida && corridaSendoExibida.corrida_id === corrida.corrida_id) {
            return;
        }
        
        // Limpa a tela e come√ßa a exibir a nova corrida (apenas 1 por vez)
        container.innerHTML = '';
        limparContadores();
        corridaSendoExibida = corrida;
        notificacaoAtiva = true;
        
        // Cria o card e inicia o contador
        criarCardCorrida(corrida);
    }


    /***********************
     * ¬†ACEITAR / CONFIRMAR / FINALIZAR
     ***********************/
    async function aceitarCorrida(id) { 
    try {
        console.log('üéØ CLICOU EM ACEITAR CORRIDA ID:', id);
        
        // Garante que est√° online
        await enviarStatusOnline(true);
        
        // Verifica se ainda pode aceitar (n√£o expirou)
        const cardElement = document.getElementById(`card-${id}`);
        if (!cardElement) {
            mostrarErro("Corrida n√£o dispon√≠vel mais.");
            return;
        }
        
        // DEBUG: Mostra o ID antes de abrir o modal
        console.log('üìù idCorridaSelecionada ser√° definido como:', id);
        idCorridaSelecionada = id;
        
        // CHAMA A FUN√á√ÉO CORRETA
        abrirModalAceitar(id);
    } catch (err) {
        console.error("Erro ao aceitar corrida:", err);
        mostrarErro("Erro ao processar. Tente novamente.");
    }
}

// FUN√á√ÉO CONFIRMAR ACEITE
async function confirmarAceite() {
    if (!idCorridaSelecionada) {
        alert('Nenhuma corrida selecionada.');
        return;
        
    }

    try {
        console.log('Confirmando aceite da corrida:', idCorridaSelecionada);

        const res = await fetch(`${MEU_IP}/aceitar-corrida`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                corrida_id: idCorridaSelecionada,
                motoboy_id: usuario.id
            })
        });

        const data = await res.json();

        if (!data.success) {
            fecharModal('modal-confirmacao'); // Fecha o modal antes de mostrar o erro
            mostrarErro(data.message || 'N√£o foi poss√≠vel aceitar a corrida. Tente novamente.');
            return;
        }

        // DEFINE A CORRIDA ATUAL CORRETAMENTE
        idCorridaAtual = idCorridaSelecionada;
        console.log('Corrida atual definida:', idCorridaAtual);

        // Fecha o modal de confirma√ß√£o e mostra o modal de sucesso (opcional, mas bom feedback)
        fecharModal('modal-confirmacao');
        document.getElementById('modal-sucesso').style.display = 'flex';
        setTimeout(() => fecharModal('modal-sucesso'), 3000);

        // Mostra a corrida em andamento
        mostrarCorridaEmAndamento();

    } catch (err) {
        console.error('Erro ao aceitar corrida:', err);
        fecharModal('modal-confirmacao');
        mostrarErro('Erro ao aceitar corrida (falha de comunica√ß√£o).');
    }
}

// FUN√á√ÉO FINALIZAR CORRIDA
async function finalizarCorrida() {
    console.log('ID Corrida Atual para finalizar:', idCorridaAtual);
    
    if (!idCorridaAtual) {
        alert('Nenhuma corrida ativa para finalizar.');
        return;
    }

    if (!confirm("Tem certeza que deseja finalizar esta corrida?")) return;

    try {
        const res = await fetch(`${MEU_IP}/finalizar-corrida`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                corrida_id: idCorridaAtual,
                motoboy_id: usuario.id 
            })
        });

        const data = await res.json();

        if (data.success) {
            alert('Corrida finalizada com sucesso!');
            
            // Limpa a corrida atual
            idCorridaAtual = null;
            
            // Volta para a tela de listagem
            verificarEstado();
            
        } else {
            alert(data.message || 'Erro ao finalizar corrida.');
        }

    } catch (err) {
        console.error('Erro ao finalizar corrida:', err);
        alert('Erro de conex√£o. Tente novamente.');
    }
}

    /***********************
     * ¬†CANCELAMENTO COM JUSTIFICATIVA
     ***********************/
    function cancelarCorridaMotoboy() {
        console.log('ID CORRIDA ATUAL:', idCorridaAtual);
        if (!idCorridaAtual) return;
        document.getElementById('modal-cancelamento-motoboy').style.display = 'flex';
        document.getElementById('justificativa-motoboy').value = '';
        document.getElementById('justificativa-motoboy').focus();
    }


    async function confirmarCancelamentoMotoboy() {
        const motivo = document.getElementById('justificativa-motoboy').value.trim();

        if (motivo.length < 5) {
            mostrarErro("A justificativa deve ter pelo menos 5 caracteres.");
            return;
        }

        fecharModal('modal-cancelamento-motoboy');
        document.getElementById('modal-erro').style.display = 'flex';
        document.getElementById('msg-erro-texto').innerText = "Processando cancelamento e notificando o cliente...";
        document.querySelector('#modal-erro .modal-titulo').innerText = "ENVIANDO CANCELAMENTO";
        document.querySelector('#modal-erro .modal-icon-erro').innerText = "‚è≥";
        document.querySelector('#modal-erro .btn-modal').style.display = 'none';
        document.querySelector('#modal-erro .modal-box').style.borderColor = '#ccc';
        document.querySelector('#modal-erro .modal-titulo').classList.remove('texto-verde');
        document.querySelector('#modal-erro .modal-titulo').classList.add('texto-vermelho');


        try {
            // Use o endpoint correto para cancelamento pelo motoboy
            const res = await fetch(`${MEU_IP}/motoboy-cancelar-corrida`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    corrida_id: idCorridaAtual,
                    motoboy_id: usuario.id,
                    motivo: motivo
                })
            });

            const json = await res.json();

            if (json.success) {
                document.querySelector('#modal-erro .modal-titulo').innerText = "CANCELADO COM SUCESSO";
                document.querySelector('#modal-erro .modal-icon-erro').innerText = "‚úÖ";
                document.getElementById('msg-erro-texto').innerText = "O cliente foi notificado. Voc√™ ser√° redirecionado em 3s. Voc√™ pode ter sido bloqueado temporariamente.";
                document.querySelector('#modal-erro .modal-box').style.borderColor = 'var(--neon-green)';
                document.querySelector('#modal-erro .modal-titulo').classList.remove('texto-vermelho');
                document.querySelector('#modal-erro .modal-titulo').classList.add('texto-verde');
                document.querySelector('#modal-erro .btn-modal').style.display = 'none';

                // Limpa a corrida atual
                idCorridaAtual = null;

                setTimeout(() => {
                    verificarEstado();
                    fecharModal('modal-erro');
                }, 3000);

            } else {
                document.querySelector('#modal-erro .modal-titulo').innerText = "FALHA NO CANCELAMENTO";
                document.querySelector('#modal-erro .modal-icon-erro').innerText = "‚ö†Ô∏è";
                document.getElementById('msg-erro-texto').innerText = json.message || "Erro desconhecido. Tente novamente.";
                document.querySelector('#modal-erro .modal-box').style.borderColor = 'var(--danger-color)';
                document.querySelector('#modal-erro .btn-modal').style.display = 'block';
            }

        } catch (e) {
            document.querySelector('#modal-erro .modal-titulo').innerText = "ERRO DE CONEX√ÉO";
            document.getElementById('msg-erro-texto').innerText = "N√£o foi poss√≠vel conectar ao servidor para cancelar.";
            document.querySelector('#modal-erro .btn-modal').style.display = 'block';
        }
    }

    /***********************
     * ¬†INICIALIZA√á√ÉO
     ***********************/
    // Inicia a verifica√ß√£o
    setTimeout(() => {
        verificarEstado();
        // Polling para 5s
        setInterval(verificarEstado, 5000);
    }, 1000);
</script>
</body>
</html>