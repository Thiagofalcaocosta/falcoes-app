<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Motoboy - FalcÃµes</title>
    <style>
        /* --- IDENTIDADE VISUAL DARK --- */
        :root {
            --bg-color: #121212; --card-color: #1e1e1e; --neon-green: #00e640;
            --text-color: #ffffff; --border-color: #333; --danger-color: #ff4444;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); padding: 20px; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; }

        .header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); gap: 15px; padding-bottom: 15px;}
        .logo-pequeno { height: 60px; }
        .moto-saudacao { font-weight: 800; color: white; font-size: 18px; text-transform: uppercase; margin-bottom: 8px; display: block; text-align: center;}
        .status-moto { background-color: var(--neon-green); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: 800; font-size: 12px; text-transform: uppercase; }
        .logout { color: var(--danger-color); text-decoration: none; font-weight: 700; font-size: 13px; border: 1px solid var(--danger-color); padding: 4px 10px; border-radius: 15px; margin-left: 10px;}

        #tela-lista, #tela-bloqueio, #tela-corrida-ativa { display: none; }

        /* CARD CORRIDA */
        .card-corrida { background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); animation: slideIn 0.5s ease;}
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .tipo-servico { font-weight: bold; font-size: 14px; text-transform: uppercase; background: #333; padding: 5px 10px; border-radius: 5px; color: #ccc; }
        .valor { font-size: 24px; font-weight: 800; color: var(--neon-green); }
        .rota { margin-bottom: 20px; font-size: 15px; line-height: 1.6; }
        .destaque-endereco { color: white; font-weight: bold; display: block; margin-bottom: 5px;}

        .btn-acao { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 18px; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-top: 10px;}
        .btn-verde { background-color: var(--neon-green); color: #000; }
        .btn-vermelho { background-color: var(--danger-color); color: white; } /* NOVO ESTILO DO BOTÃƒO DE CANCELAMENTO */
        
        /* TELA BLOQUEIO */
        .aviso-bloqueio { text-align: center; padding: 40px 20px; border: 1px solid var(--danger-color); border-radius: 15px; background: rgba(255, 68, 68, 0.1); }
        .tempo-bloqueio { font-size: 40px; font-weight: 800; color: var(--danger-color); margin: 20px 0; display: block;}

        /* TELA ATIVA */
        .titulo-ativa { text-align: center; color: var(--neon-green); font-size: 22px; margin-bottom: 20px; font-weight: 800; animation: piscar 2s infinite; }
        .info-cliente { background: #000; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #333; }
        @keyframes piscar { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        /* --- MODAIS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-box { background: var(--card-color); border: 1px solid var(--border-color); padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 0 30px rgba(0, 230, 64, 0.1); animation: popup 0.3s ease; }
        .modal-titulo { font-size: 20px; font-weight: 800; color: white; margin-bottom: 10px; text-transform: uppercase; }
        .modal-desc { color: #aaa; margin-bottom: 25px; font-size: 15px; }
        .modal-botoes { display: flex; gap: 10px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-sim { background-color: var(--neon-green); color: black; }
        .btn-nao { background-color: #333; color: white; }
        .modal-icon-sucesso, .modal-icon-erro { font-size: 50px; margin-bottom: 10px; display: block; }
        .texto-verde { color: var(--neon-green); } .texto-vermelho { color: var(--danger-color); }
        @keyframes popup { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* ESTILO PARA O CAMPO TEXTAREA NO MODAL DE CANCELAMENTO */
        .modal-box textarea {
            width: 100%; 
            height: 80px; 
            padding: 10px; 
            box-sizing: border-box; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            background: var(--card-color); 
            color: white; 
            resize: none;
            font-family: inherit;
            margin-top: 10px;
        }
    </style>
</head>
<body>

Â  Â  <audio id="som-alerta" src="assets/som.mp3"></audio>

Â  Â  <div id="modal-confirmacao" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-box">
Â  Â  Â  Â  Â  Â  <div class="modal-titulo">Aceitar Corrida?</div>
Â  Â  Â  Â  Â  Â  <p class="modal-desc">VocÃª se compromete a buscar o passageiro/encomenda imediatamente.</p>
Â  Â  Â  Â  Â  Â  <div class="modal-botoes">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-modal btn-nao" onclick="fecharModal('modal-confirmacao')">CANCELAR</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-confirma-final" class="btn-modal btn-sim" onclick="confirmarAceite()">CONFIRMAR</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="modal-sucesso" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-box" style="border-color: var(--neon-green);">
Â  Â  Â  Â  Â  Â  <span class="modal-icon-sucesso">âœ…</span>
Â  Â  Â  Â  Â  Â  <div class="modal-titulo texto-verde">CORRIDA ACEITA!</div>
Â  Â  Â  Â  Â  Â  <p class="modal-desc">VÃ¡ para o local de busca.<br>Boa viagem, FalcÃ£o.</p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="modal-erro" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-box" style="border-color: var(--danger-color);">
Â  Â  Â  Â  Â  Â  <span class="modal-icon-erro">âš ï¸</span>
Â  Â  Â  Â  Â  Â  <div class="modal-titulo texto-vermelho">OCORREU UM ERRO</div>
Â  Â  Â  Â  Â  Â  <p class="modal-desc" id="msg-erro-texto">NÃ£o foi possÃ­vel aceitar a corrida.</p>
Â  Â  Â  Â  Â  Â  <button class="btn-modal btn-nao" onclick="fecharModal('modal-erro')">FECHAR</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
    
    <div id="modal-cancelamento-motoboy" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--danger-color); box-shadow: 0 0 30px rgba(255, 68, 68, 0.2);">
            <div class="modal-titulo texto-vermelho">ğŸš« CANCELAR CORRIDA</div>
            <p class="modal-desc">VocÃª serÃ¡ bloqueado temporariamente se cancelar apÃ³s aceitar sem justificativa vÃ¡lida.</p>
            <textarea id="justificativa-motoboy" placeholder="Qual o motivo do cancelamento? (mÃ­nimo 5 caracteres)"></textarea>
            
            <div class="modal-botoes" style="margin-top: 20px;">
                <button class="btn-modal btn-nao" onclick="fecharModal('modal-cancelamento-motoboy')">VOLTAR</button>
                <button class="btn-modal btn-vermelho" onclick="confirmarCancelamentoMotoboy()">CANCELAR E NOTIFICAR</button>
            </div>
        </div>
    </div>


Â  Â  <div class="container">
Â  Â  Â  Â  <div class="header">
Â  Â  Â  Â  Â  Â  <img src="assets/logo.png" alt="Logo" class="logo-pequeno">
Â  Â  Â  Â  Â  Â  <div class="user-area">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="msg-ola" class="moto-saudacao">OLÃ, PILOTO</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="status-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-moto">â— ONLINE</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="index.html" class="logout" onclick="localStorage.clear()">SAIR</a>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <span id="label-categoria" class="categoria-badge">CATEGORIA: --</span>
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="tela-lista">
Â  Â  Â  Â  Â  Â  <h2 style="text-align:center; color:var(--neon-green)">CORRIDAS DISPONÃVEIS</h2>
Â  Â  Â  Â  Â  Â  <div id="lista-corridas">Carregando...</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="tela-corrida-ativa">
Â  Â  Â  Â  Â  Â  <div class="titulo-ativa">â— CORRIDA EM ANDAMENTO</div>
Â  Â  Â  Â  Â  Â  <div class="card-corrida" style="border-color: var(--neon-green);">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-top">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="tipo-servico" id="ativa-tipo">MOTO TÃXI</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="valor" id="ativa-valor">R$ 0,00</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-cliente">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color:#aaa; font-size:12px;">CLIENTE:</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:bold; font-size:18px;" id="ativa-cliente">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color:#fff; margin-top:5px;" id="ativa-fone">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="rota">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:#aaa; font-size:12px;">BUSCAR EM:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="destaque-endereco" id="ativa-origem">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:#aaa; font-size:12px;">LEVAR PARA:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="destaque-endereco" id="ativa-destino">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-acao btn-verde" onclick="finalizarCorrida()">âœ… FINALIZAR CORRIDA</button>
                <button class="btn-acao btn-vermelho" onclick="cancelarCorridaMotoboy()">âŒ CANCELAR CORRIDA</button> Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="tela-bloqueio">
Â  Â  Â  Â  Â  Â  <div class="aviso-bloqueio">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color:var(--danger-color); margin:0;">PAUSA OBRIGATÃ“RIA</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="tempo-bloqueio" id="tempo-restante">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Novas corridas aparecerÃ£o apÃ³s este tempo.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="verificarEstado()" style="background:transparent; border:1px solid #555; color:#aaa; padding:10px; border-radius:5px; cursor:pointer;">Atualizar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  const usuario = JSON.parse(localStorage.getItem('usuario'));
Â  Â  Â  Â  // Corrigindo a verificaÃ§Ã£o de tipo para ser robusta (garante que nÃ£o seja o cliente)
Â  Â  Â  Â  if (!usuario || usuario.tipo !== 'motoboy') {
            // Se nÃ£o houver 'motoboy' logado, cria um mock bÃ¡sico para testes ou redireciona
            if (!usuario) {
                localStorage.setItem("usuario", JSON.stringify({id: 99, nome: "Piloto Teste", tipo: "motoboy", categoria: "Passageiro"}));
                window.location.reload();
            } else if(usuario.tipo !== 'motoboy') {
                window.location.href = 'index.html';
            }
        }
        
Â  Â  Â  Â  document.getElementById('msg-ola').innerText = "OLÃ, " + usuario.nome.split(' ')[0].toUpperCase();
Â  Â  Â  Â  const catExibicao = usuario.categoria ? usuario.categoria.toUpperCase() : "GERAL";
Â  Â  Â  Â  document.getElementById('label-categoria').innerText = `SUA CATEGORIA: ${catExibicao}`;

Â  Â  Â  Â  let idCorridaSelecionada = null;
Â  Â  Â  Â  let idCorridaAtual = null;
Â  Â  Â  Â  let corridasVisiveis = []; // Para controlar o som

Â  Â  Â  Â  // --- TOCA SOM ---
Â  Â  Â  Â  function tocarAlerta() {
Â  Â  Â  Â  Â  Â  const audio = document.getElementById('som-alerta');
Â  Â  Â  Â  Â  Â  // Tenta tocar. Se o navegador bloquear, paciÃªncia (precisa de interaÃ§Ã£o do usuÃ¡rio)
Â  Â  Â  Â  Â  Â  audio.play().catch(err => console.log("Som bloqueado atÃ© interaÃ§Ã£o do usuÃ¡rio"));
Â  Â  Â  Â  }

Â  Â  Â  Â  // MODAIS E AÃ‡Ã•ES (FunÃ§Ã£o fecharModal foi mantida, mas Ã© Ãºtil aqui)
        function fecharModal(idModal) {
Â  Â  Â  Â  Â  Â  document.getElementById(idModal).style.display = 'none';
Â  Â  Â  Â  Â  Â  if(idModal === 'modal-confirmacao') idCorridaSelecionada = null;
Â  Â  Â  Â  }
        function mostrarErro(mensagem) {
Â  Â  Â  Â  Â  Â  document.getElementById('msg-erro-texto').innerText = mensagem;
Â  Â  Â  Â  Â  Â  document.getElementById('modal-erro').style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  async function verificarEstado() {
Â  Â  Â  Â  Â  Â  try {
                const MEU_IP = 'https://falcoes-app.onrender.com';
Â  Â  Â  Â  Â  Â  Â  Â  const resAtiva = await fetch(`${MEU_IP}/minha-corrida-atual/${usuario.id}`);
Â  Â  Â  Â  Â  Â  Â  Â  const dadosAtiva = await resAtiva.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (dadosAtiva.tem_corrida) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('ativa');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preencherDadosAtiva(dadosAtiva.corrida);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const resLista = await fetch('https://falcoes-app.onrender.com/corridas-pendentes', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ motoboy_id: usuario.id })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const dadosLista = await resLista.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (dadosLista.success === false && dadosLista.bloqueado) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('bloqueio');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tempo-restante').innerText = dadosLista.tempo + " min";
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('lista');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderizarLista(dadosLista.corridas || []);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (err) { console.error(err); }
Â  Â  Â  Â  }

Â  Â  Â  Â  function mostrarTela(tela) {
Â  Â  Â  Â  Â  Â  document.getElementById('tela-lista').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('tela-corrida-ativa').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('tela-bloqueio').style.display = 'none';

Â  Â  Â  Â  Â  Â  if(tela === 'lista') document.getElementById('tela-lista').style.display = 'block';
Â  Â  Â  Â  Â  Â  if(tela === 'ativa') document.getElementById('tela-corrida-ativa').style.display = 'block';
Â  Â  Â  Â  Â  Â  if(tela === 'bloqueio') document.getElementById('tela-bloqueio').style.display = 'block';
Â  Â  Â  Â  }

Â  Â  Â  Â  function preencherDadosAtiva(c) {
Â  Â  Â  Â  Â  Â  idCorridaAtual = c.id;
Â  Â  Â  Â  Â  Â  document.getElementById('ativa-tipo').innerText = c.tipo_servico.toUpperCase();
Â  Â  Â  Â  Â  Â  document.getElementById('ativa-valor').innerText = "R$ " + parseFloat(c.valor).toFixed(2);
Â  Â  Â  Â  Â  Â  document.getElementById('ativa-cliente').innerText = c.nome_cliente;
Â  Â  Â  Â  Â  Â  document.getElementById('ativa-fone').innerText = c.telefone_cliente;
Â  Â  Â  Â  Â  Â  document.getElementById('ativa-origem').innerText = c.origem;
Â  Â  Â  Â  Â  Â  document.getElementById('ativa-destino').innerText = c.destino;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderizarLista(todasCorridas) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('lista-corridas');
Â  Â  Â  Â  Â  Â  if(document.getElementById('modal-confirmacao').style.display === 'flex') return;

Â  Â  Â  Â  Â  Â  container.innerHTML = ''; 

Â  Â  Â  Â  Â  Â  // Filtra pela categoria
Â  Â  Â  Â  Â  Â  const filtradas = todasCorridas.filter(c => {
Â  Â  Â  Â  Â  Â  Â  Â  if (usuario.tipo === 'admin') return true;
Â  Â  Â  Â  Â  Â  Â  Â  const minhaCategoria = usuario.categoria; 
Â  Â  Â  Â  Â  Â  Â  Â  if (minhaCategoria === 'Passageiro') return c.tipo_servico === 'moto-taxi';
Â  Â  Â  Â  Â  Â  Â  Â  if (minhaCategoria === 'Entregas') return c.tipo_servico === 'entrega';
Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // --- LÃ“GICA DO SOM ---
Â  Â  Â  Â  Â  Â  // Verifica se tem algum ID novo que nÃ£o estava na lista anterior
Â  Â  Â  Â  Â  Â  let temNova = false;
Â  Â  Â  Â  Â  Â  filtradas.forEach(nova => {
Â  Â  Â  Â  Â  Â  Â  Â  // Se esse ID nÃ£o estava na lista 'corridasVisiveis'
Â  Â  Â  Â  Â  Â  Â  Â  if (!corridasVisiveis.includes(nova.id)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temNova = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Se tem nova, toca o som!
Â  Â  Â  Â  Â  Â  if (temNova) {
Â  Â  Â  Â  Â  Â  Â  Â  tocarAlerta();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Atualiza a lista de conhecidos para a prÃ³xima verificaÃ§Ã£o
Â  Â  Â  Â  Â  Â  corridasVisiveis = filtradas.map(c => c.id);
Â  Â  Â  Â  Â  Â  // ---------------------

Â  Â  Â  Â  Â  Â  if (filtradas.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '<div style="text-align:center; color:#555; padding:30px;">Nenhuma corrida disponÃ­vel.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  filtradas.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const html = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-corrida">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-top">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="tipo-servico">${c.tipo_servico}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="valor">R$ ${parseFloat(c.valor).toFixed(2)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="rota">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color:#ddd; margin-bottom:5px;">ğŸ“ ${c.origem}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color:#ddd;">ğŸ ${c.destino}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-acao btn-verde" onclick="aceitarCorrida(${c.id})">ACEITAR</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML += html;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // MODAIS E AÃ‡Ã•ES (Igual anterior)
Â  Â  Â  Â  function abrirModalAceitar(id) {
Â  Â  Â  Â  Â  Â  idCorridaSelecionada = id;
Â  Â  Â  Â  Â  Â  document.getElementById('modal-confirmacao').style.display = 'flex';
Â  Â  Â  Â  }
Â  Â  Â  Â  // fecharModal jÃ¡ foi definida acima

Â  Â  Â  Â  async function aceitarCorrida(id) { abrirModalAceitar(id); }

Â  Â  Â  Â  async function confirmarAceite() {
Â  Â  Â  Â  Â  Â  if (!idCorridaSelecionada) return;
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('btn-confirma-final');
Â  Â  Â  Â  Â  Â  btn.innerText = "..."; btn.disabled = true;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('https://falcoes-app.onrender.com/aceitar-corrida', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ corrida_id: idCorridaSelecionada, motoboy_id: usuario.id })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  fecharModal('modal-confirmacao'); btn.innerText = "CONFIRMAR"; btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  if (result.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modal-sucesso').style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { verificarEstado(); document.getElementById('modal-sucesso').style.display = 'none'; }, 2500);
Â  Â  Â  Â  Â  Â  Â  Â  } else { mostrarErro("Erro: " + result.message); }
Â  Â  Â  Â  Â  Â  } catch (err) { fecharModal('modal-confirmacao'); btn.innerText = "CONFIRMAR"; btn.disabled = false; mostrarErro("Erro conexÃ£o."); }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function finalizarCorrida() {
Â  Â  Â  Â  Â  Â  if(!confirm("Finalizar corrida?")) return;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await fetch('https://falcoes-app.onrender.com/finalizar-corrida', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ corrida_id: idCorridaAtual })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  verificarEstado();
Â  Â  Â  Â  Â  Â  } catch (err) { alert("Erro ao finalizar."); }
Â  Â  Â  Â  }
        
        // === NOVAS FUNÃ‡Ã•ES DE CANCELAMENTO COM JUSTIFICATIVA ===
        function cancelarCorridaMotoboy() {
            if (!idCorridaAtual) return;
            // 1. Abre o modal de justificativa
            document.getElementById('modal-cancelamento-motoboy').style.display = 'flex';
            document.getElementById('justificativa-motoboy').value = ''; // Limpa campo
            document.getElementById('justificativa-motoboy').focus();
        }

        async function confirmarCancelamentoMotoboy() {
            const motivo = document.getElementById('justificativa-motoboy').value.trim();
            
            if (motivo.length < 5) {
                mostrarErro("A justificativa deve ter pelo menos 5 caracteres.");
                return;
            }

            // Fecha o modal de justificativa e mostra feedback de carregamento
            fecharModal('modal-cancelamento-motoboy');
            document.getElementById('modal-erro').style.display = 'flex'; // Reutilizando modal de erro para feedback
            document.getElementById('msg-erro-texto').innerText = "Processando cancelamento e notificando o cliente...";
            document.querySelector('#modal-erro .modal-titulo').innerText = "ENVIANDO CANCELAMENTO";
            document.querySelector('#modal-erro .modal-icon-erro').innerText = "â³";
            document.querySelector('#modal-erro .btn-modal').style.display = 'none'; // Esconde o botÃ£o fechar temporariamente

            try {
                const MEU_IP = 'https://falcoes-app.onrender.com';
                const res = await fetch(`${MEU_IP}/cancelar-pedido`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    // Envia a justificativa do motoboy
                    body: JSON.stringify({ 
                        id: idCorridaAtual, 
                        motivo: `[MOTOBOY] ${motivo}` 
                    })
                });
                
                const json = await res.json();

                if (json.success) {
                    // Sucesso no cancelamento
                    document.querySelector('#modal-erro .modal-titulo').innerText = "CANCELADO COM SUCESSO";
                    document.querySelector('#modal-erro .modal-icon-erro').innerText = "âœ…";
                    document.getElementById('msg-erro-texto').innerText = "O cliente foi notificado. VocÃª serÃ¡ redirecionado em 3s.";
                    document.querySelector('#modal-erro .modal-box').style.borderColor = 'var(--neon-green)';
                    document.querySelector('#modal-erro .modal-titulo').classList.remove('texto-vermelho');
                    document.querySelector('#modal-erro .modal-titulo').classList.add('texto-verde');


                    setTimeout(() => {
                        verificarEstado(); // Atualiza a tela, deve voltar para a lista
                        fecharModal('modal-erro');
                    }, 3000);

                } else {
                     // Falha no cancelamento
                    document.querySelector('#modal-erro .modal-titulo').innerText = "FALHA NO CANCELAMENTO";
                    document.querySelector('#modal-erro .modal-icon-erro').innerText = "âš ï¸";
                    document.getElementById('msg-erro-texto').innerText = json.message || "Erro desconhecido. Tente novamente.";
                    document.querySelector('#modal-erro .modal-box').style.borderColor = 'var(--danger-color)';
                    document.querySelector('#modal-erro .btn-modal').style.display = 'block'; // Mostra o botÃ£o fechar
                }

            } catch (e) {
                document.querySelector('#modal-erro .modal-titulo').innerText = "ERRO DE CONEXÃƒO";
                document.getElementById('msg-erro-texto').innerText = "NÃ£o foi possÃ­vel conectar ao servidor para cancelar.";
                document.querySelector('#modal-erro .btn-modal').style.display = 'block';
            }
        }

Â  Â  Â  Â  verificarEstado();
Â  Â  Â  Â  setInterval(verificarEstado, 5000);
Â  Â  </script>
</body>
</html>
