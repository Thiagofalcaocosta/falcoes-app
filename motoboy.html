<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Motoboy - Falc√µes</title>
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
        /* --- IDENTIDADE VISUAL DARK --- */
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --neon-green: #00e640;
            --text-color: #ffffff;
            --border-color: #333;
            --danger-color: #ff4444;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            gap: 15px;
            padding-bottom: 15px;
        }

        .logo-pequeno {
            height: 60px;
        }

        .moto-saudacao {
            font-weight: 800;
            color: white;
            font-size: 18px;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
            text-align: center;
        }

        .status-moto {
            background-color: var(--neon-green);
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
        }

        

        #tela-lista,
        #tela-bloqueio,
        #tela-corrida-ativa {
            display: none;
        }

        /* CARD CORRIDA */
        .card-corrida {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tipo-servico {
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            background: #333;
            padding: 5px 10px;
            border-radius: 5px;
            color: #ccc;
        }

        .valor {
            font-size: 24px;
            font-weight: 800;
            color: var(--neon-green);
        }

        .rota {
            margin-bottom: 20px;
            font-size: 15px;
            line-height: 1.6;
        }

        .destaque-endereco {
            color: white;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        /* NOVO: ESTILO PARA O CONTADOR */
        .contador-tempo {
            font-size: 18px;
            font-weight: 800;
            color: var(--danger-color);
            text-align: right;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        .btn-acao {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-verde {
            background-color: var(--neon-green);
            color: #000;
        }

        .btn-vermelho {
            background-color: var(--danger-color);
            color: white;
        }

        /* TELA BLOQUEIO */
        .aviso-bloqueio {
            text-align: center;
            padding: 40px 20px;
            border: 1px solid var(--danger-color);
            border-radius: 15px;
            background: rgba(255, 68, 68, 0.1);
        }

        .tempo-bloqueio {
            font-size: 40px;
            font-weight: 800;
            color: var(--danger-color);
            margin: 20px 0;
            display: block;
        }

        /* TELA ATIVA */
        .titulo-ativa {
            text-align: center;
            color: var(--neon-green);
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: 800;
            animation: piscar 2s infinite;
        }

        .info-cliente {
            background: #000;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }

        @keyframes piscar {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* --- MODAIS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-box {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 20px;
            width: 85%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 230, 64, 0.1);
            animation: popup 0.3s ease;
        }

        .modal-titulo {
            font-size: 20px;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .modal-desc {
            color: #aaa;
            margin-bottom: 25px;
            font-size: 15px;
        }

        .modal-botoes {
            display: flex;
            gap: 10px;
        }

        .btn-modal {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-sim {
            background-color: var(--neon-green);
            color: black;
        }

        .btn-nao {
            background-color: #333;
            color: white;
        }

        .modal-icon-sucesso,
        .modal-icon-erro {
            font-size: 50px;
            margin-bottom: 10px;
            display: block;
        }

        .texto-verde {
            color: var(--neon-green);
        }

        .texto-vermelho {
            color: var(--danger-color);
        }

        @keyframes popup {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

   /* Estilo do Bot√£o Neon */
.logout {
    position: absolute;
    top: 15px;
    right: 15px;
    color: #ff4444; 
    text-decoration: none;
    font-weight: 900;
    font-size: 10px;
    border: 1px solid #ff4444;
    padding: 6px 15px;
    border-radius: 20px;
    text-transform: uppercase;
    background: rgba(255, 68, 68, 0.05);
    z-index: 1000;
    
    /* Aplica a anima√ß√£o: nome 'pulsarNeon', dura√ß√£o 1.5s, infinita */
    animation: pulsarNeon 1.5s infinite ease-in-out;
    transition: all 0.3s ease;
}

/* Defini√ß√£o da Anima√ß√£o de Piscar/Pulsar */
@keyframes pulsarNeon {
    0% {
        box-shadow: 0 0 5px rgba(255, 68, 68, 0.4), inset 0 0 2px rgba(255, 68, 68, 0.2);
        text-shadow: 0 0 2px rgba(255, 68, 68, 0.5);
        opacity: 0.8;
    }
    50% {
        box-shadow: 0 0 15px rgba(255, 68, 68, 0.9), inset 0 0 8px rgba(255, 68, 68, 0.4);
        text-shadow: 0 0 8px rgba(255, 68, 68, 1);
        opacity: 1;
    }
    100% {
        box-shadow: 0 0 5px rgba(255, 68, 68, 0.4), inset 0 0 2px rgba(255, 68, 68, 0.2);
        text-shadow: 0 0 2px rgba(255, 68, 68, 0.5);
        opacity: 0.8;
    }
}

/* Efeito ao passar o mouse ou tocar */
.logout:hover {
    background: #ff4444;
    color: white;
    box-shadow: 0 0 25px #ff4444;
    animation: none; /* Para de pulsar quando foca nele */
}
        /* ESTILO PARA O CAMPO TEXTAREA NO MODAL DE CANCELAMENTO */
.modal-box textarea {
    width: 100%;
    height: 80px;
    padding: 10px;
    box-sizing: border-box;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--card-color);
    color: white;
    resize: none;
    font-family: inherit;
    margin-top: 10px;
}

/* --- NOVOS ESTILOS PARA TELA ATIVA (CORRIGIDO) --- */

.resumo-valor {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    margin-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.rota-ativa-mapa {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

.ponto-rota {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.icone-rota {
    font-size: 24px;
    line-height: 1;
    color: var(--neon-green);
}

.label-endereco {
    color: #aaa;
    font-size: 12px;
    display: block;
    margin-bottom: 3px;
}

.destaque-endereco {
    color: white;
    font-weight: bold;
    font-size: 15px;
    display: block;
}

/* NOVO ESTILO PARA BOTOES DE A√á√ÉO */
#botoes-acao-ativa {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}
/* --- NOVO VISUAL DOS ENDERE√áOS (COLE NO SEU CSS) --- */

/* Caixa cinza transl√∫cida para cada endere√ßo */
.box-endereco {
    background: rgba(255, 255, 255, 0.05);
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 12px;
    position: relative;
    border-left: 4px solid #555; /* Cor padr√£o */
    display: flex;
    flex-direction: column;
}

/* Borda vermelha para origem (Pin) */
.box-endereco.origem {
    border-left-color: #ff4444; 
}

/* Borda verde para destino (Bandeira) */
.box-endereco.destino {
    border-left-color: var(--neon-green);
}

/* Label pequena (Origem/Destino) */
.label-rota {
    font-size: 10px;
    text-transform: uppercase;
    font-weight: 900;
    margin-bottom: 4px;
    color: #888;
    letter-spacing: 1px;
}

/* O texto do endere√ßo em si */
.texto-end {
    font-size: 14px;
    color: #eee;
    line-height: 1.4;
}

/* Efeito Neon Azul no Bairro */
.bairro-neon {
    color: #00eaff; /* Azul Cyan */
    font-weight: bold;
    text-transform: uppercase;
    text-shadow: 0 0 10px rgba(0, 234, 255, 0.4);
}

/* Texto de Urg√™ncia Piscando */
.aviso-urgencia {
    font-size: 13px;
    color: #ffcc00; /* Amarelo Ouro */
    text-align: center;
    margin-top: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    animation: pulsarTexto 1.5s infinite alternate;
}

@keyframes pulsarTexto {
    from { opacity: 0.7; text-shadow: 0 0 0px #ffcc00; }
    to { opacity: 1; text-shadow: 0 0 10px #ffcc00; }
}
/* --- ESTILO TELA DE ESPERA (AGUARDANDO PAGAMENTO) --- */

/* O Card que pulsa */
.card-espera-gold {
    background: rgba(255, 215, 0, 0.05); /* Fundo Dourado Transparente */
    border: 2px solid #ffd700; /* Borda Dourada */
    border-radius: 20px;
    padding: 40px 20px;
    text-align: center;
    margin-top: 20px;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
    animation: pulsoDourado 2s infinite;
}

@keyframes pulsoDourado {
    0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
    70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
}

/* O Spinner Girando */
.spinner-gold {
    width: 60px;
    height: 60px;
    border: 6px solid rgba(255, 215, 0, 0.3); /* Parte apagada */
    border-top: 6px solid #ffd700; /* Parte brilhante */
    border-radius: 50%;
    margin: 0 auto 20px auto; /* Centraliza */
    animation: girarSpinner 1s linear infinite;
}

@keyframes girarSpinner {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.titulo-espera {
    color: #ffd700;
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.desc-espera {
    color: #ddd;
    font-size: 14px;
    line-height: 1.5;
}
/* --- ESTILO NEON LIMPO E PROFISSIONAL --- */
.header {
    display: flex;
    flex-direction: column;
    align-items: center; /* Centraliza tudo no meio */
    padding-bottom: 20px;
    border-bottom: 1px solid #333;
}

.saldo-wrapper {
    background: #1a1a1a;
    border: 2px solid #333;
    border-radius: 15px;
    padding: 12px 30px;
    margin: 15px 0;
    text-align: center;
    min-width: 180px;
    transition: all 0.3s ease;
}

/* Classes de brilho controladas pelo JavaScript */
.card-verde { border-color: #00e640; box-shadow: 0 0 15px rgba(0, 230, 64, 0.3); }
.card-vermelho { border-color: #ff4444; box-shadow: 0 0 15px rgba(255, 68, 68, 0.3); }

.label-mini {
    font-size: 10px;
    color: #888;
    text-transform: uppercase;
    font-weight: 900;
    letter-spacing: 2px;
    display: block;
    margin-bottom: 4px;
}

#saldo-piloto {
    font-size: 26px;
    font-weight: 900;
    font-family: 'Arial Black', sans-serif;
    color: #fff; /* Cor base antes do JS carregar */
}

.botoes-row {
    display: flex;
    gap: 15px;
    justify-content: center;
    align-items: center;
}

        
    </style>
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker
                .register("/service-worker.js")
                .then(() => console.log("SW registrado!"))
                .catch(err => console.log("Erro SW:", err));
        }
        
    </script>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00e640">
</head>

<body>

    <audio id="som-alerta" src="assets/som.mp3"></audio>
    <div id="modal-senha-seguranca" class="modal-overlay" style="display: none;">
    <div class="modal-box" style="border-color: #ffcc00; box-shadow: 0 0 20px rgba(255, 204, 0, 0.2);">
        <div style="font-size: 50px; margin-bottom: 10px;">‚ö†Ô∏è</div>
        <div class="modal-titulo" style="color: #ffcc00;">BLOQUEIO DE SEGURAN√áA</div>
        <p class="modal-desc" style="color: #fff; font-size: 16px;">
            Pe√ßa a <strong>SENHA DE 4 D√çGITOS</strong> para o cliente.<br><br>
            <span style="color: #00e640; font-size: 14px;">Ela aparece na tela dele (Cart√£o Verde).</span>
        </p>
        <button class="btn-modal btn-sim" onclick="fecharModal('modal-senha-seguranca')" style="width: 100%; padding: 15px; font-size: 16px;">OK, ENTENDIDO</button>
    </div>
</div>

    <div id="modal-cancelado-radar" class="modal-overlay" style="display: none; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999;">
    <div class="modal-box" style="background: #000; border: 2px solid #ff4444; padding: 25px; border-radius: 15px; text-align: center; max-width: 90%; width: 350px; box-shadow: 0 0 20px rgba(255, 68, 68, 0.4);">
        
        <div style="font-size: 50px; margin-bottom: 15px;">üö´</div>
        
        <h2 style="color: #ff4444; font-size: 22px; font-weight: 900; margin-bottom: 10px; text-transform: uppercase;">
            CORRIDA CANCELADA
        </h2>
        
        <p style="color: #ddd; font-size: 14px; margin-bottom: 20px; line-height: 1.5;">
            O cliente cancelou a solicita√ß√£o.<br>
            <span style="font-size: 12px; color: #888;">(Atualize para voltar √† lista)</span>
        </p>

        <button onclick="window.location.reload()" style="background: #ff4444; color: #fff; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: 800; font-size: 16px; cursor: pointer; text-transform: uppercase;">
            OK, ENTENDIDO
        </button>
    </div>
</div>

    <div id="modal-confirmacao" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-titulo">Aceitar Corrida?</div>
            <p class="modal-desc">Voc√™ se compromete a buscar o passageiro/encomenda imediatamente.</p>
            <div class="modal-botoes">
                <button class="btn-modal btn-nao" onclick="fecharModal('modal-confirmacao')">CANCELAR</button>
                <button id="btn-confirma-final" class="btn-modal btn-sim" onclick="confirmarAceitarCorrida()">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="modal-sucesso" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--neon-green);">
            <span class="modal-icon-sucesso">‚úÖ</span>
            <div class="modal-titulo texto-verde">CORRIDA ACEITA!</div>
            <p class="modal-desc">V√° para o local de busca.<br>Boa viagem, Falc√£o.</p>
        </div>
    </div>

    <div id="modal-erro" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--danger-color);">
            <span class="modal-icon-erro">‚ö†Ô∏è</span>
            <div class="modal-titulo texto-vermelho">OCORREU UM ERRO</div>
            <p class="modal-desc" id="msg-erro-texto">N√£o foi poss√≠vel aceitar a corrida.</p>
            <button class="btn-modal btn-nao" onclick="fecharModal('modal-erro')">FECHAR</button>
        </div>
    </div>

    <div id="modal-cancelamento-motoboy" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--danger-color); box-shadow: 0 0 30px rgba(255, 68, 68, 0.2);">
            <div class="modal-titulo texto-vermelho">üö´ CANCELAR CORRIDA</div>
            <p class="modal-desc">Voc√™ ser√° bloqueado temporariamente se cancelar ap√≥s aceitar sem justificativa v√°lida.
            </p>
            <textarea id="justificativa-motoboy"
                placeholder="Qual o motivo do cancelamento? (m√≠nimo 5 caracteres)"></textarea>

            <div class="modal-botoes" style="margin-top: 20px;">
                <button class="btn-modal btn-nao" onclick="fecharModal('modal-cancelamento-motoboy')">VOLTAR</button>
                <button class="btn-modal btn-vermelho" onclick="confirmarCancelamentoMotoboy()">CANCELAR E
                    NOTIFICAR</button>
            </div>
        </div>
    </div>


    <div id="camada-ativacao" onclick="ativarRecursos()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer;">
    <i class="fas fa-mouse-pointer" style="font-size: 50px; color: #00e640; margin-bottom: 20px;"></i>
    <h2 style="color: white; text-align: center; font-weight: 900;">TOQUE PARA ATIVAR<br><span style="font-size: 14px; color: #888; font-weight: 400;">(Sons e tela sempre acesa)</span></h2>
</div>

<div class="container">
<div class="header" style="padding-top: 20px;">
    <img src="assets/logo.png" alt="Logo" class="logo-pequeno">
    
    <span id="msg-ola" class="moto-saudacao" style="margin-top: 15px;">OL√Å, PILOTO</span>
    <a href="index.html" class="logout" onclick="deslogar()">SAIR</a>
    <div style="margin: 10px 0;">
        <span style="font-size: 11px; color: #888; font-weight: bold; letter-spacing: 1px;">CATEGORIA:</span>
        <span id="label-categoria" style="color: #00e640; font-weight: 900; background: rgba(0, 230, 64, 0.15); padding: 4px 12px; border-radius: 5px; text-transform: uppercase; border: 1px solid rgba(0, 230, 64, 0.3); margin-left: 5px;">--</span>
    </div>

    <div class="saldo-wrapper card-verde" id="card-saldo-neon" style="margin-bottom: 5px;">
        <span class="label-mini">Saldo em Conta</span>
        <div id="saldo-piloto">R$ 0,00</div>
        
        <button onclick="solicitarPagamentoAdm()" style="background: #25d366; color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 900; font-size: 12px; margin-top: 12px; cursor: pointer; width: 100%; text-transform: uppercase;">
            <i class="fab fa-whatsapp"></i> Solicitar Pagamento
        </button>
    </div>
</div>    

        <div id="tela-lista">
            <h2 style="text-align:center; color:var(--neon-green)">CORRIDAS DISPON√çVEIS</h2>
            <div id="lista-corridas">Carregando...</div>
        </div>

        <div id="tela-corrida-ativa" style="display: none;">
            <div class="titulo-ativa">‚óè CORRIDA LIBERADA</div>
            <div class="card-corrida" id="ativa-card" style="border-color: var(--neon-green); padding: 20px;">
                
                <div class="resumo-valor" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <span class="tipo-servico" id="ativa-tipo" style="background: #333; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: bold; color: #fff;">MOTO T√ÅXI</span>
                    <div style="text-align: right;">
                        <span class="valor" id="ativa-valor" style="color: var(--neon-green); font-size: 24px; font-weight: 800; display: block;">R$ 0,00</span>
                        <span id="ativa-metodo-pagamento" style="font-size: 10px; text-transform: uppercase; font-weight: 800; color: #aaa;">DINHEIRO</span>
                    </div>
                </div>

                <div class="info-cliente" style="background: #000; padding: 15px; border-radius: 12px; margin-bottom: 20px; position: relative; border: 1px solid #333;">
    <div style="color:#888; font-size: 10px; font-weight: bold; text-transform: uppercase;">Passageiro/Cliente</div>
    <div style="font-weight: bold; font-size: 18px; color: #fff;" id="ativa-cliente">--</div>
    <div style="color:#fff; font-size: 13px; margin-top: 5px;" id="ativa-fone">--</div>
    
    <a id="btn-whatsapp-cliente" 
   onclick="abrirConversaZap()"
   style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: #25d366; color: white; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50%; text-decoration: none; z-index: 100; cursor: pointer;">
    <i class="fab fa-whatsapp" style="font-size: 24px;"></i>
</a>
</div>
                
                <div class="rota-ativa-mapa" style="margin-bottom: 25px;">
                    <div class="ponto-rota" style="display: flex; gap: 12px; margin-bottom: 15px;">
                        <span style="font-size: 18px;">üìç</span>
                        <div style="flex: 1;">
                            <span style="color: #ff4444; font-size: 10px; font-weight: bold; display: block;">ORIGEM:</span>
                            <span id="ativa-origem" style="color: #fff; font-size: 14px; display: block;">--</span>
                            <button onclick="abrirGPS('origem')" style="background: transparent; border: 2px solid #00d4ff; color: #00d4ff; padding: 8px 15px; border-radius: 8px; font-size: 11px; font-weight: 900; cursor: pointer; text-transform: uppercase; box-shadow: 0 0 10px rgba(0, 212, 255, 0.4); margin-top: 8px;">
    ABRIR NO MAPS
</button>
                        </div>
                    </div>
                    
                    <div class="ponto-rota" style="display: flex; gap: 12px;">
                        <span style="font-size: 18px;">üèÅ</span>
                        <div style="flex: 1;">
                            <span style="color: var(--neon-green); font-size: 10px; font-weight: bold; display: block;">DESTINO:</span>
                            <span id="ativa-destino" style="color: #fff; font-size: 14px; display: block;">--</span>
                            <button onclick="abrirGPS('destino')" style="background: transparent; border: 2px solid #00d4ff; color: #00d4ff; padding: 8px 15px; border-radius: 8px; font-size: 11px; font-weight: 900; cursor: pointer; text-transform: uppercase; box-shadow: 0 0 10px rgba(0, 212, 255, 0.4); margin-top: 8px;">
                                NAVEGAR AGORA
                            </button>
                        </div>
                    </div>
                </div> <div id="botoes-acao-ativa" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 10px; border: 1px solid #444; text-align: center;">
                        <label style="color: #bbb; font-size: 11px; font-weight: bold; display: block; margin-bottom: 8px;">SENHA DO CLIENTE:</label>
                        <input type="tel" id="input-pin-corrida" maxlength="4" placeholder="----" 
                               style="background: #000; border: 2px solid #555; color: #fff; 
                                      font-size: 28px; padding: 12px; width: 100%; text-align: center; 
                                      border-radius: 8px; letter-spacing: 8px; outline: none; font-weight: 800;">
                    </div>

                    <button onclick="finalizarCorrida()" class="btn-finalizar" id="btn-finalizar-corrida" style="background: var(--neon-green); color: #000; padding: 16px; border: none; border-radius: 10px; font-weight: 900; font-size: 15px; cursor: pointer; text-transform: uppercase;">
                        FINALIZAR CORRIDA
                    </button>
                    
                    <button class="btn-cancelar-ativa" id="btn-cancelar-ativa" style="background: transparent; color: #666; border: 1px solid #444; padding: 10px; border-radius: 10px; font-size: 12px; cursor: pointer;">
                        CANCELAR
                    </button>
                </div>
            </div>
        </div>

        <div id="tela-bloqueio" style="display: none;">
    <div class="container" style="margin-top: 50px; text-align: center;">
        <div class="aviso-bloqueio" style="border: 1px solid #ff4444; padding: 30px; border-radius: 15px; background: rgba(255, 68, 68, 0.1);">
            <span style="font-size: 60px;">üîí</span>
            <h2 style="color: #ff4444; margin: 10px 0;">VOC√ä EST√Å BLOQUEADO</h2>
            <p style="color: #ccc;">Voc√™ cancelou uma corrida recentemente.</p>
            
            <span id="tempo-restante" style="font-size: 40px; font-weight: 800; color: #ff4444; display: block; margin: 20px 0;">-- min</span>
            
            <p style="font-size: 12px; color: #888;">Aguarde o tempo acabar para voltar a receber chamadas.</p>
            
            <button onclick="window.location.reload()" style="background: #333; color: white; padding: 15px; width: 100%; border: none; border-radius: 10px; margin-top: 20px; cursor: pointer;">
                ATUALIZAR AGORA
            </button>
        </div>
    </div>
</div>
    <script>
    /***********************
     * VARI√ÅVEIS GLOBAIS
     ***********************/
    const usuario = JSON.parse(localStorage.getItem('usuario'));
    const MEU_IP = 'https://falcoes-app.onrender.com';
    
    // VARI√ÅVEL GLOBAL - DEVE FICAR AQUI NO TOPO
    let telefoneClienteGlobal = ""; 

    // VERIFICA√á√ÉO DE LOGIN
    if (!usuario || !usuario.id || usuario.tipo !== 'motoboy') {
        console.error('Usu√°rio n√£o autorizado ou n√£o logado.');
        window.location.href = 'index.html';
    }

    // EXIBE NOME E CATEGORIA
    // EXIBE NOME E CATEGORIA (AJUSTADO)
document.getElementById('msg-ola').innerText = "OL√Å, " + usuario.nome.split(' ')[0].toUpperCase();

const categoriaExibicao = usuario.categoria || "GERAL";
// Removemos o "SUA CATEGORIA:" para aparecer apenas o nome da categoria no destaque
document.getElementById('label-categoria').innerText = categoriaExibicao.toUpperCase();
    let idCorridaSelecionada = null;
    let idCorridaAtual = null;
    let onlineInterval = null;
    let estadoVerificacaoInterval = null;
    let temCorridaAtiva = false;

    // Armazena os IDs dos setIntervals para os contadores (Corrida na lista)
    let intervalosContadores = {};

    // Controle da corrida sendo exibida (Corrida na lista)
    let corridaSendoExibida = null;
    let notificacaoAtiva = false;
    let intervaloMonitoramento = null; // Monitora se a corrida na lista foi aceita por outro

    // Monitoramento da corrida ACEITA
    let monitoramentoAtivaInterval = null;

    // --- NOVO: FUNCIONALIDADE PARA MANTER A TELA ACESA (WAKE LOCK) ---
let wakeLock = null;

// Fun√ß√£o que pede permiss√£o ao sistema para manter a tela ligada
async function ativarWakeLock() {
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('üí° TELA MANTIDA ACESA (Wake Lock ativado com sucesso!)');

            // Se o sistema soltar o bloqueio (ex: bateria fraca), avisa no console
            wakeLock.addEventListener('release', () => {
                console.log('üí° Wake Lock foi solto pelo sistema.');
            });
        } catch (err) {
            // Erros comuns: bateria muito baixa ou navegador n√£o permitiu
            console.warn(`‚ö†Ô∏è N√£o foi poss√≠vel manter a tela acesa: ${err.name}, ${err.message}`);
        }
    } else {
        console.log('‚ÑπÔ∏è Seu navegador n√£o suporta manter a tela acesa nativamente.');
    }
}

// Se o motoboy minimizar o app e voltar, o navegador solta o bloqueio.
// Esse c√≥digo detecta quando ele volta e pede o bloqueio de novo.
document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        console.log('üîÑ Voltando ao app: Reativando Wake Lock...');
        await ativarWakeLock();
    }
});

// --- IMPORTANTE: GATILHO INICIAL ---
// Navegadores (principalmente Chrome no Android) S√ì permitem tocar som e 
// manter a tela acesa se o usu√°rio interagir com a p√°gina pelo menos uma vez.
// Adicionamos este "ouvinte" no corpo inteiro da p√°gina. No primeiro toque em 
// qualquer lugar, ele ativa tudo.
document.body.addEventListener('click', async function liberarRecursos() {
    console.log('üëÜ Primeiro toque detectado: Liberando som e tela...');
    
    // 1. Tenta ativar o Wake Lock
    await ativarWakeLock();
    
    // 2. Toca e pausa o som rapidamente s√≥ para "destravar" o √°udio no navegador
    const audio = document.getElementById('som-alerta');
    if(audio) {
        audio.muted = true; // Toca mudo para n√£o assustar
        audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
            audio.muted = false; // Deixa pronto para tocar com som
        }).catch(()=>{});
    }
    
    // Remove este ouvinte para n√£o ficar executando a cada clique
    document.body.removeEventListener('click', liberarRecursos);
}, { once: true });
// ------------------------------------------------------------------


    /***********************
     * ¬†FUN√á√ïES DE UTILIDADE
     ***********************/
     // FUN√á√ÉO √öNICA PARA O WHATSAPP COM MENSAGEM AUTOM√ÅTICA
function abrirConversaZap() {
    if (!telefoneClienteGlobal || telefoneClienteGlobal === "") {
        alert("N√∫mero n√£o identificado.");
        return;
    }

    let foneLimpo = telefoneClienteGlobal.toString().replace(/\D/g, '');
    if (!foneLimpo.startsWith('55')) foneLimpo = '55' + foneLimpo;

    const nomeC = document.getElementById('ativa-cliente')?.innerText || "Cliente";
    const nomeP = usuario.nome || "Piloto";
    const motoP = usuario.modelo_moto || "Moto";
    const placaP = usuario.placa || "";

    // MENSAGEM COM IDENTIDADE E ORGANIZA√á√ÉO
    // Use \n para pular linha e deixar o texto arrumado
    const mensagem = `*FALC√ïES APP* ü¶Ö\n\n` +
                     `Ol√°, *${nomeC}*!\n` +
                     `Sou o piloto *${nomeP}* e j√° estou a caminho.\n\n` +
                     `*Ve√≠culo:* ${motoP}\n` +
                     `${placaP ? '*Placa:* ' + placaP + '\n' : ''}` +
                     `*Status:* Em deslocamento üèçÔ∏è\n\n` +
                     `Aguarde no local de origem, chego em breve!`;
    
    const linkFinal = `https://api.whatsapp.com/send?phone=${foneLimpo}&text=${encodeURIComponent(mensagem)}`;

    const a = document.createElement('a');
    a.href = linkFinal;
    a.target = '_blank';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

    function limparContadores() {
        Object.values(intervalosContadores).forEach(clearInterval);
        intervalosContadores = {};
    }

    function limparMonitoramento() {
        if (intervaloMonitoramento) {
            clearInterval(intervaloMonitoramento);
            intervaloMonitoramento = null;
        }
        corridaAtualMonitorada = null;
    }

    function pararMonitoramentoAtiva() {
        if (monitoramentoAtivaInterval) {
            clearInterval(monitoramentoAtivaInterval);
            monitoramentoAtivaInterval = null;
        }
    }

    function pararVerificacaoEstado() {
        if (estadoVerificacaoInterval) {
            clearInterval(estadoVerificacaoInterval);
            estadoVerificacaoInterval = null;
        }
    }

    // --- SUBSTITUA A FUN√á√ÉO tocarAlerta ANTIGA POR ESTA ---
// Vari√°vel para controlar o loop da vibra√ß√£o
// Vari√°vel para controlar o loop da vibra√ß√£o
let loopVibracao = null;

let loopAlertaGeral = null; // Vari√°vel global para controlar som + vibra√ß√£o

function tocarAlerta() {
    const audio = document.getElementById('som-alerta');
    
    // Se o alerta j√° estiver rodando, n√£o cria outro por cima
    if (loopAlertaGeral) return; 

    console.log("üîä Iniciando Alerta Infinito (Som + Vibra√ß√£o)...");

    const executarChamada = () => {
        // 1. FOR√áA O SOM
        if (audio) {
            audio.currentTime = 0; // Volta o som para o in√≠cio toda vez
            audio.play().catch(e => {
                console.warn("Navegador bloqueou √°udio. O motoboy precisa tocar na tela uma vez.");
            });
        }

        // 2. FOR√áA A VIBRA√á√ÉO
        if ("vibrate" in navigator) {
            navigator.vibrate([1000, 500, 1000]); // Vibra 1s, para 0.5s, vibra 1s
        }
    };

    // Toca a primeira vez imediatamente
    executarChamada();

    // 3. CRIA O LOOP (Repete a cada 3 segundos)
    // Se o seu som.mp3 for longo (ex: 10 segundos), mude 3000 para 10000.
    loopAlertaGeral = setInterval(executarChamada, 3000); 
}

// ESTA FUN√á√ÉO √â ESSENCIAL PARA PARAR O BARULHO

    async function carregarSaldoMotoboy() {
    try {
        const res = await fetch(`${MEU_IP}/admin/motoboys`);
        const motoboys = await res.json();
        const eu = motoboys.find(m => m.id === usuario.id);
        
        if (eu && eu.saldo !== undefined) {
            const valorNumerico = parseFloat(eu.saldo);
            const saldoElement = document.getElementById('saldo-piloto');
            const cardWrapper = document.getElementById('card-saldo-neon');
            
            // Formata o valor
            const valorFormatado = valorNumerico.toFixed(2).replace('.', ',');
            saldoElement.innerText = `R$ ${valorFormatado}`;
            
            // Troca o estilo do card conforme o saldo
            if (valorNumerico < 0) {
                saldoElement.style.color = "#ff4444";
                if(cardWrapper) cardWrapper.className = "saldo-wrapper card-vermelho";
            } else {
                saldoElement.style.color = "#00e640";
                if(cardWrapper) cardWrapper.className = "saldo-wrapper card-verde";
            }
        }
    } catch (err) {
        console.error("Erro ao carregar saldo:", err);
    }
}

// Faz o saldo carregar assim que o motoboy entra no app
document.addEventListener('DOMContentLoaded', carregarSaldoMotoboy);
// Pede permiss√£o no primeiro clique que o motoboy der na tela
document.body.addEventListener('click', async function() {
    if ('Notification' in window && Notification.permission === 'default') {
        const permissao = await Notification.requestPermission();
        if (permissao === 'granted') {
            console.log("Notifica√ß√µes ativadas!");
            // Opcional: mostrar um aviso visual de sucesso
        }
    }
}, { once: true }); // O '{ once: true }' faz isso rodar apenas uma vez

    // Substitua sua fun√ß√£o mostrarTela por esta vers√£o protegida
function mostrarTela(idDesejado) {
    const telas = ['tela-lista', 'tela-corrida-ativa', 'tela-bloqueio'];
    
    telas.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.style.display = (id === idDesejado) ? 'block' : 'none';
        } else {
            console.warn(`Aviso: Tela ${id} n√£o encontrada no HTML.`);
        }
    });
}
    
    // Fun√ß√£o para deslogar
    function deslogar() {
        limparContadores();
        limparMonitoramento();
        pararMonitoramentoAtiva();
        pararVerificacaoEstado();
        enviarStatusOnline(false);
        if (onlineInterval) {
            clearInterval(onlineInterval);
        }
        localStorage.clear();
        window.location.href = 'index.html';
    }

    /***********************
     * FUN√á√ïES DA CORRIDA ATIVA (GPS E WHATSAPP)
     ***********************/

    // Abre o Google Maps ou Waze
    // Abre o Google Maps ou Waze (CORRIGIDO PARA REMOVER O ITEM)
// Abre o Google Maps ou Waze (Vers√£o que limpa o ITEM apenas para o GPS)
function abrirGPS(tipo) {
    // 1. Pega o texto completo que est√° na tela (incluindo o ITEM)
    let enderecoCompleto = tipo === 'origem' 
        ? document.getElementById('ativa-origem').innerText 
        : document.getElementById('ativa-destino').innerText;

    if (enderecoCompleto && enderecoCompleto !== '--') {
        
        // 2. Limpeza inteligente apenas para o link do GPS
        // A fun√ß√£o .split('(') divide o texto onde tiver um parentese.
        // O [0] pega apenas a primeira parte (o endere√ßo) e ignora o resto (o item).
        let enderecoLimpo = enderecoCompleto.split('(')[0];

        // Remove espa√ßos vazios que podem sobrar no final (ex: "Rua X, 123 ")
        enderecoLimpo = enderecoLimpo.trim();

        // 3. Cria o link usando o endere√ßo LIMPO, mas o motoboy continua vendo o completo na tela
        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(enderecoLimpo)}`;
        
        window.open(url, '_blank');
    }
}
    /***********************
     * ¬†FUN√á√ïES DE STATUS ONLINE
     ***********************/

    let ultimoEnvioStatus = 0;

async function enviarStatusOnline(online) {
    const agora = Date.now();
    // Agora s√≥ envia para o banco se passou mais de 60 segundos (1 minuto)
    if (agora - ultimoEnvioStatus < 60000) return; 

    try {
        const response = await fetch(`${MEU_IP}/motoboy/status-online`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ motoboy_id: usuario?.id, online: online })
        });
        
        if (response.ok) {
            ultimoEnvioStatus = agora;
            console.log("üü¢ Status atualizado no banco (1 min).");
        }
    } catch (err) {
        // Erro silencioso
    }
}
    /***********************
     * ¬†CONTROLE DE FLUXO E TELAS
     ***********************/

    function mostrarTela(tela) {
        document.getElementById('tela-lista').style.display = 'none';
        document.getElementById('tela-corrida-ativa').style.display = 'none';
        document.getElementById('tela-bloqueio').style.display = 'none';

        if (tela === 'lista') document.getElementById('tela-lista').style.display = 'block';
        if (tela === 'ativa') document.getElementById('tela-corrida-ativa').style.display = 'block';
        if (tela === 'bloqueio') document.getElementById('tela-bloqueio').style.display = 'block';
    }

// NOVO: Adicione esta fun√ß√£o para renderizar os bot√µes dinamicamente
function renderizarBotoesAtiva(status) {
    const container = document.getElementById('botoes-acao-ativa');
    if (!container) return;

    // üõ°Ô∏è TRAVA DE SEGURAN√áA: Se o usu√°rio j√° estiver digitando, N√ÉO RECRIA O CAMPO
    // Isso evita que o polling (setInterval) apague o que voc√™ escreveu
    const inputExistente = document.getElementById('input-codigo-pedido-v2');
    if (inputExistente && document.activeElement === inputExistente) {
        return; 
    }
    
    // Se o status mudar ou o campo n√£o existir, a√≠ sim n√≥s limpamos e recriamos
    container.innerHTML = ''; 

    if (status === 'liberada') {
        const btnColetar = document.createElement('button');
        btnColetar.className = 'btn-acao btn-verde';
        btnColetar.innerHTML = 'üèçÔ∏è COLETEI O PEDIDO (SAIR)';
        btnColetar.style.cssText = "width: 100%; padding: 20px; font-size: 18px; background: #00e640; color: #000; border-radius: 12px; font-weight: 900; border: none; cursor: pointer; box-shadow: 0 0 20px rgba(0, 230, 64, 0.4);";
        
        btnColetar.onclick = async () => {
            if(confirm("Confirmar que coletou o pedido e est√° saindo para entrega?")) {
                try {
                    const res = await fetch(`${MEU_IP}/iniciar-corrida`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ corrida_id: idCorridaAtual, motoboy_id: usuario.id })
                    });
                    const data = await res.json();
                    if(data.success) verificarEstado(); 
                } catch (err) { alert("Erro ao avisar sa√≠da."); }
            }
        };
        container.appendChild(btnColetar);
    } 
    else if (status === 'em_andamento') {
        const divSenha = document.createElement('div');
        divSenha.style.cssText = "background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 12px; border: 1px solid #444; text-align: center; margin: 0 auto 15px auto; width: 85%;";
        
        divSenha.innerHTML = `
            <label style="color: #00e640; font-size: 11px; font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase;">C√ìDIGO DE ENTREGA</label>
            <input type="tel" id="input-codigo-pedido-v2" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                   style="background: transparent; border: none; border-bottom: 2px solid #00e640; color: white; font-size: 30px; text-align: center; width: 100%; outline: none; letter-spacing: 10px;">
        `;
        container.appendChild(divSenha);

        const btnFinalizar = document.createElement('button');
        btnFinalizar.className = 'btn-acao btn-verde';
        btnFinalizar.innerHTML = '‚úÖ FINALIZAR ENTREGA';
        btnFinalizar.onclick = () => finalizarCorrida();
        btnFinalizar.style.cssText = "width: 100%; padding: 15px; background: #00e640; color: #000; border-radius: 10px; font-weight: 900; border: none; margin-top: 10px;";
        container.appendChild(btnFinalizar);
    }

    const btnCancelar = document.createElement('button');
    btnCancelar.innerText = 'CANCELAR CORRIDA';
    btnCancelar.onclick = () => cancelarCorridaMotoboy();
    btnCancelar.style.cssText = "background: transparent; color: #ff4444; border: 1px solid #ff4444; padding: 10px; border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer; width: 100%; margin-top: 20px; text-transform: uppercase;";
    container.appendChild(btnCancelar);
}


function preencherDadosAtiva(c) {
    idCorridaAtual = c.corrida_id || c.id;
    
    const valorBruto = parseFloat(c.valor);
    const taxa = 0.15;
    const valorTaxa = valorBruto * taxa;
    const valorLiquido = valorBruto - valorTaxa;

    let avisoHTML = "";
    let valorPrincipal = "";

    if (c.forma_pagamento === 'DINHEIRO') {
        // No dinheiro, o valor de cima fica bem pequeno e o aviso toma conta da tela
        valorPrincipal = "";
        
        avisoHTML = `
            <div style="background: #ff0000; color: #fff; padding: 20px; border-radius: 12px; margin: 15px 0; font-weight: 900; text-align: center; border: 4px solid #fff; animation: piscar 1s infinite;">
                <span style="font-size: 22px; display: block; margin-bottom: 5px;">‚ö†Ô∏è ATEN√á√ÉO PILOTO</span>
                <span style="font-size: 26px; display: block;">RECEBER R$ ${valorBruto.toFixed(2).replace('.', ',')}</span>
                <span style="font-size: 12px; display: block; margin-top: 10px; color: #ffcccc;">(A taxa ser√° descontada do seu saldo automaticamente)</span>
            </div>
            <style>
                @keyframes piscar {
                    0% { opacity: 1; transform: scale(1); }
                    50% { opacity: 0.8; transform: scale(0.98); }
                    100% { opacity: 1; transform: scale(1); }
                }
            </style>`;
    } else {
        // No PIX, mantemos o foco no que ele ganhou
        valorPrincipal = `<span style="font-size: 24px; color: #25d366; font-weight: 800;">GANHO: R$ ${valorLiquido.toFixed(2).replace('.', ',')}</span>`;
        
        avisoHTML = `
            <div style="background: #25d366; color: #000; padding: 15px; border-radius: 12px; margin: 15px 0; font-weight: 800; text-align: center;">
                <span style="font-size: 18px;">‚úÖ PAGAMENTO VIA PIX</span>
                <br>
                <span style="font-size: 14px;">N√ÉO COBRAR O CLIENTE</span>
            </div>`;
    }

    // Aplica os dados na tela
    document.getElementById('ativa-tipo').innerText = (c.tipo_servico || "MOTO T√ÅXI").toUpperCase();
    
    // Substitui o valor de cima pelo valor ajustado (pequeno no dinheiro, grande no pix)
    document.getElementById('ativa-valor').innerHTML = valorPrincipal;
    
    // Insere o aviso gigante
    const campoMetodo = document.getElementById('ativa-metodo-pagamento');
    if (campoMetodo) {
        campoMetodo.innerHTML = avisoHTML;
    }

    document.getElementById('ativa-cliente').innerText = c.nome_cliente;
    document.getElementById('ativa-fone').innerText = c.telefone_cliente;
    document.getElementById('ativa-origem').innerText = c.origem;
    document.getElementById('ativa-destino').innerText = c.destino;

    if (c.telefone_cliente) {
        telefoneClienteGlobal = c.telefone_cliente.replace(/\D/g, '');
    }
    
    renderizarBotoesAtiva(c.status); 
}
    /***********************
     * ¬†L√ìGICA DO POLLING DE ESTADO
     ***********************/
    async function verificarDisponibilidadeCorrida(corridaId) {
    try {
        // ADICIONEI A VACINA AQUI EMBAIXO üëá
        const res = await fetch(`${MEU_IP}/status-corrida/${corridaId}?t=${Date.now()}`);
        const data = await res.json();
        // Retorna false se n√£o for 'pendente' ou se a requisi√ß√£o falhar
        return data.success && data.status === 'pendente'; 
    } catch (err) {
        console.error('Erro ao verificar disponibilidade:', err);
        return true; 
    }
}
    
    // --- SUBSTITUA A FUN√á√ÉO verificarEstado POR ESTA VERS√ÉO BLINDADA ---
async function verificarEstado() {
    try {
        // 1. Pergunta ao servidor se tem corrida ativa (AQUI VOC√ä J√Å TINHA POSTO, T√Å CERTO)
        const resAtiva = await fetch(`${MEU_IP}/minha-corrida-atual/${usuario.id}?t=${Date.now()}`);
        const dadosAtiva = await resAtiva.json();

        // Se o servidor disse que n√£o tem corrida, mas o celular lembra que tinha:
        if (!dadosAtiva.tem_corrida) {
            const idSalvo = localStorage.getItem('idCorridaAtualMotoboy');
            if (idSalvo) {
                dadosAtiva.tem_corrida = true;
                dadosAtiva.corrida = { 
                    status: 'aguardando_pagamento', 
                    id: idSalvo, 
                    corrida_id: idSalvo 
                };
            }
        }

        if (dadosAtiva.tem_corrida) {
            temCorridaAtiva = true;
            idCorridaAtual = dadosAtiva.corrida.corrida_id || dadosAtiva.corrida.id;
            const statusCorrida = dadosAtiva.corrida.status;

            limparContadores();
            limparMonitoramento();
            pararVerificacaoEstado(); 

            if (statusCorrida === 'liberada' || statusCorrida === 'em_andamento') {
                mostrarTela('ativa');
                preencherDadosAtiva(dadosAtiva.corrida);
                iniciarRadarCancelamento(idCorridaAtual);
                
                if (!monitoramentoAtivaInterval) {
                     pararMonitoramentoAtiva();
                     monitoramentoAtivaInterval = setInterval(verificarEstado, 3000); 
                }
                return;
            } 
            
            else if (statusCorrida === 'aguardando_pagamento' || statusCorrida === 'aceita') {
                if (!monitoramentoAtivaInterval) {
                    pararMonitoramentoAtiva();
                    monitoramentoAtivaInterval = setInterval(verificarEstado, 3000); 
                }

                mostrarTela('lista'); 
                const container = document.getElementById('lista-corridas');
                
                if (container) {
                    container.innerHTML = `
                        <div class="card-espera-gold">
                            <div class="spinner-gold"></div>
                            <div class="titulo-espera">AGUARDANDO LIBERA√á√ÉO</div>
                            <div class="desc-espera">
                                O cliente est√° finalizando o pagamento.<br>
                                <span style="font-size:12px; color:#aaa; display:block; margin-top:10px;">
                                    N√£o saia desta tela. Voc√™ ser√° notificado assim que for 
                                    <strong style="color:#ffd700">LIBERADA</strong>.
                                </span>
                            </div>
                        </div>`;
                }
                return; 
            }
        return;
    }
        
        // 2. SE CHEGOU AQUI, N√ÉO TEM CORRIDA ATIVA REAL
        pararMonitoramentoAtiva();
        temCorridaAtiva = false;
        idCorridaAtual = null;

        // üëáüëáüëá AQUI ESTAVA O ERRO DO 1 MINUTO!!! üëáüëáüëá
        // Eu adicionei ?t=${Date.now()} no final da URL
        const resLista = await fetch(`${MEU_IP}/corridas-pendentes?t=${Date.now()}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ motoboy_id: usuario.id })
        });
        
        const dadosLista = await resLista.json();

        if (dadosLista.success === false && dadosLista.bloqueado) {
            limparContadores();
            limparMonitoramento();
            mostrarTela('bloqueio');
            document.getElementById('tempo-restante').innerText = dadosLista.tempo + " min";

        } else {
            mostrarTela('lista');
            let corrida = null;
            const container = document.getElementById('lista-corridas');

            if (dadosLista.corridas && dadosLista.corridas.length > 0) {
                corrida = dadosLista.corridas[0]; 
            } else {
                pararAlerta(); 
                if (container) {
                    container.innerHTML = '<div style="text-align:center; color:#555; padding:30px;">Nenhuma corrida dispon√≠vel.</div>';
                }
            }

            if (corridaSendoExibida && corrida && corridaSendoExibida.corrida_id !== corrida.corrida_id) {
                corridaSendoExibida = null;
            } else if (!corrida && corridaSendoExibida) {
                corridaSendoExibida = null;
            }
            
            renderizarLista(corrida);
        }
        
        if (!estadoVerificacaoInterval && !temCorridaAtiva) {
            estadoVerificacaoInterval = setInterval(verificarEstado, 5000);
        }

    } catch (err) {
        console.error("Erro ao verificar estado:", err);
    }
}


    /***********************
     * ¬†CRIA√á√ÉO E RENDERIZA√á√ÉO DA LISTA
     ***********************/
     function iniciarContador(id, tempoInicial, onTimeout) {
    let tempoRestante = tempoInicial;
    const cardElement = document.getElementById(`card-${id}`);
    const contadorElement = cardElement ? cardElement.querySelector('.contador-tempo') : null;

    if (!contadorElement) return;

    // Garante que n√£o tem outro timer rodando no mesmo ID para n√£o acelerar a contagem
    if (intervalosContadores[id]) clearInterval(intervalosContadores[id]);

    const decremento = async () => {
        // Se o tempo acabou
        if (tempoRestante <= 0) {
            clearInterval(intervalosContadores[id]);
            delete intervalosContadores[id];
            
            contadorElement.innerText = "‚åõ ATUALIZANDO...";
            
            // --- AQUI ESTAVA O ERRO ---
            // Antes voc√™ chamava: iniciarContador(id, 15, onTimeout);
            // Agora chamamos o callback para verificar o status real no servidor:
            if (onTimeout) onTimeout(); 
            
            return;
        }

        contadorElement.innerText = `‚è≥ SUA VEZ: ${tempoRestante}s`;
        tempoRestante--;
    };

    decremento(); // Chama uma vez imediatamente para n√£o esperar 1 seg
    intervalosContadores[id] = setInterval(decremento, 1000);
}
    // --- SUBSTITUA A FUN√á√ÉO criarCardCorrida POR ESTA ---

function criarCardCorrida(corrida) {
    const container = document.getElementById('lista-corridas');

    // 1. C√°lculos de valor
    const valorBruto = parseFloat(corrida.valor);
    const taxa = 0.15;
    const ganhoLiquido = valorBruto * (1 - taxa);
    const ganhoFormatado = ganhoLiquido.toFixed(2).replace('.', ',');

    // 2. Formata√ß√£o de endere√ßo (Mantida igual)
    const formatarEndereco = (texto) => {
        if (!texto) return "--";
        if (texto.includes('(')) {
            const partesItem = texto.split('(');
            let enderecoBase = partesItem[0]; 
            let itemTexto = partesItem[1].replace(')', ''); 
            const partesEnd = enderecoBase.split(',');
            if (partesEnd.length > 1) {
                const rua = partesEnd[0];
                const resto = partesEnd.slice(1).join(',');
                enderecoBase = `${rua}, <span class="bairro-neon">${resto}</span>`;
            }
            const itemDestacado = `
                <div style="margin-top: 8px; background: rgba(255, 215, 0, 0.1); border: 1px dashed #ffd700; color: #ffd700; padding: 8px; border-radius: 6px; font-weight: 900; font-size: 14px; text-transform: uppercase; display: block;">
                    üì¶ ${itemTexto}
                </div>`;
            return enderecoBase + itemDestacado;
        }
        const partes = texto.split(',');
        if (partes.length > 1) {
            const rua = partes[0];
            const resto = partes.slice(1).join(','); 
            return `${rua}, <span class="bairro-neon">${resto}</span>`;
        }
        return texto;
    };

    const div = document.createElement('div');
    div.className = 'card-corrida';
    div.id = `card-${corrida.corrida_id}`;

    // 3. O HTML NOVO
    const htmlConteudo = `
        <div class="card-top">
            <span class="tipo-servico">${(corrida.tipo_servico || 'MOTO').toUpperCase()}</span>
            <div style="text-align: right;">
                <span class="valor" style="display: block; color: var(--neon-green); font-size: 22px; font-weight: 800; text-shadow: 0 0 10px rgba(0, 230, 64, 0.3);">
                    R$ ${ganhoFormatado}
                </span>
                <span style="font-size: 10px; color: #888; font-weight: bold;">(L√çQUIDO PARA VOC√ä)</span>
            </div>
        </div>

        ${corrida.ciclo && corrida.ciclo > 1 ?
            `<div style="background: rgba(255, 153, 0, 0.2); color: #ff9900; padding: 5px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; text-align: center; border: 1px solid #ff9900;">
                ‚ö° CORRIDA REJEITADA ANTERIORMENTE (CICLO ${corrida.ciclo})
            </div>` : ''
        }

        <div class="rota" style="margin: 15px 0;">
            <div class="box-endereco origem">
                <span class="label-rota" style="color:#ff4444;">üìç RETIRADA (Origem)</span>
                <div class="texto-end">${formatarEndereco(corrida.origem)}</div>
            </div>
            <div class="box-endereco destino">
                <span class="label-rota" style="color:var(--neon-green);">üèÅ ENTREGA (Destino)</span>
                <div class="texto-end">${formatarEndereco(corrida.destino)}</div>
            </div>
        </div>

        <div class="contador-tempo" id="contador-${corrida.corrida_id}" style="text-align: center; margin-bottom: 15px;"></div>
        
        <button class="btn-acao btn-verde" onclick="aceitarCorridaWrapper(${corrida.corrida_id})" style="box-shadow: 0 0 15px rgba(0, 230, 64, 0.4);">
            ACEITAR CORRIDA
        </button>

        <div class="aviso-urgencia">‚ö° SEJA R√ÅPIDO! ESSA OFERTA PODE EXPIRAR.</div>
    `;
    
    div.innerHTML = htmlConteudo;
    container.appendChild(div);

    // --- CORRE√á√ÉO DO LOOP INFINITO ---
    // Pega o tempo real
    let tempoCalculado = 60 - Math.ceil(parseFloat(corrida.segundos_passados || 0));
    
    // Se o tempo j√° estourou (√© negativo), a gente inventa um tempo de 15s
    // s√≥ para o contador rodar e chamar a aten√ß√£o, SEM APAGAR A CORRIDA.
    if (tempoCalculado <= 0) {
        tempoCalculado = 15; 
    }

    tocarAlerta(); // Toca o som

    // Inicia o contador visual
    iniciarContador(corrida.corrida_id, tempoCalculado, () => {
        // Quando acabar o tempo visual, ele N√ÉO apaga mais. 
        // Ele apenas recarrega a tela. Se a corrida ainda estiver l√°, ela volta.
        verificarEstado(); 
    });
}

    function renderizarLista(corrida) {
        const container = document.getElementById('lista-corridas');

        if (!corrida) {
            container.innerHTML = '<div style="text-align:center; color:#555; padding:30px;">Nenhuma corrida dispon√≠vel.</div>';
            limparContadores();
            limparMonitoramento();
            notificacaoAtiva = false;
            corridaSendoExibida = null;
            return;
        }

        // Se a corrida for a mesma que est√° sendo exibida, n√£o faz nada (mant√©m contador e monitoramento)
        if (corridaSendoExibida && corridaSendoExibida.corrida_id === corrida.corrida_id) {
            return;
        }

        // Se for uma nova corrida ou a anterior sumiu, limpa e renderiza
        limparMonitoramento();
        container.innerHTML = '';
        limparContadores();
        corridaSendoExibida = corrida;
        notificacaoAtiva = true;
        criarCardCorrida(corrida);
        iniciarMonitoramento(corrida.corrida_id);
    }
    
    function iniciarMonitoramento(corridaId) {
        limparMonitoramento();

        corridaAtualMonitorada = corridaId;

        // Monitora se a corrida na lista foi aceita por outro motoboy
        intervaloMonitoramento = setInterval(async () => {
            if (temCorridaAtiva) return; // Se j√° tem corrida ativa, sai

            const disponivel = await verificarDisponibilidadeCorrida(corridaId);

            if (!disponivel && corridaSendoExibida && corridaSendoExibida.corrida_id === corridaId) {
                console.log(`Corrida ${corridaId} foi aceita por outro motoboy. Limpando...`);

                const container = document.getElementById('lista-corridas');
                container.innerHTML = '<div style="text-align:center; color:#ff4444; padding:30px;">‚ö†Ô∏è Esta corrida j√° foi aceita por outro piloto</div>';

                limparContadores();
                limparMonitoramento();
                notificacaoAtiva = false;
                corridaSendoExibida = null;

                tocarAlerta();

                setTimeout(verificarEstado, 3000);
            }
        }, 2000);
    }


    /***********************
     * ¬†A√á√ïES E BOT√ïES
     ***********************/

    function fecharModal(idModal) {
        document.getElementById(idModal).style.display = 'none';
        if (idModal === 'modal-confirmacao') idCorridaSelecionada = null;
    }

    function mostrarErro(mensagem) {
        document.getElementById('msg-erro-texto').innerText = mensagem;
        document.getElementById('modal-erro').style.display = 'flex';
    }

    // Fun√ß√£o de clique no bot√£o "ACEITAR" no card
    async function aceitarCorridaWrapper(id) { 
        try {
            await enviarStatusOnline(true);
            
            const disponivel = await verificarDisponibilidadeCorrida(id);
            if (!disponivel) {
                mostrarErro("Esta corrida j√° foi aceita por outro piloto.");
                verificarEstado();
                return;
            }
            
            idCorridaSelecionada = id;
            limparMonitoramento();
            
            document.getElementById('modal-confirmacao').style.display = 'flex';
        } catch (err) {
            console.error("Erro ao preparar aceite:", err);
            mostrarErro("Erro ao processar. Tente novamente.");
        }
    }

    async function confirmarAceitarCorrida() {
        pararAlerta();
        
        if (!idCorridaSelecionada) {
            alert('Nenhuma corrida selecionada.');
            return;
        }

        try {
            const res = await fetch(`${MEU_IP}/aceitar-corrida`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    corrida_id: idCorridaSelecionada,
                    motoboy_id: usuario.id
                }),
            });

            if (!res.ok) {
                throw new Error(`Erro HTTP: ${res.status}`);
            }

            const data = await res.json();

            if (!data.success) {
                fecharModal('modal-confirmacao');
                mostrarErro(data.message || 'N√£o foi poss√≠vel aceitar a corrida.');
                verificarEstado(); 
                return;
                idCorridaAtual = idCorridaSelecionada;
                localStorage.setItem('idCorridaAtualMotoboy', idCorridaSelecionada);
            temCorridaAtiva = true;
                
                

            }

            // Sucesso
           
            
            limparContadores();
            limparMonitoramento();
            pararVerificacaoEstado();
            
            fecharModal('modal-confirmacao');
            document.getElementById('modal-sucesso').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('modal-sucesso').style.display = 'none';
                verificarEstado(); // Atualiza para a tela ativa (aguardando ou liberada)
            }, 1000);

        } catch (err) {
            console.error('Erro ao confirmar aceite da corrida:', err);
            mostrarErro('Erro ao aceitar corrida: ' + (err.message || ''));
        }
    }
    
    
    
    async function finalizarCorrida() {
        // 1. Pega o valor digitado no campo de senha (PIN)
        let campoPin = document.getElementById('input-codigo-pedido-v2');
        const pinDigitado = campoPin ? campoPin.value.trim() : '';

        if (!idCorridaAtual) {
            alert('Nenhuma corrida ativa para finalizar.');
            return;
        }

        // 2. Valida√ß√£o: Obriga a digitar 4 n√∫meros
        if (pinDigitado.length !== 4) {
            document.getElementById('msg-erro-texto').innerHTML = "‚ö†Ô∏è <b>BLOQUEIO DE SEGURAN√áA</b><br><br>Pe√ßa a SENHA DE 4 D√çGITOS para o cliente.<br>Ela aparece na tela dele (Cart√£o Verde).";
    document.getElementById('modal-erro').style.display = 'flex';
    
    if(campoPin) campoPin.focus();
    return; 
}
if (!confirm("Confirmar finaliza√ß√£o da corrida?")) return;
        try {
            // Envia para o servidor JUNTO com a senha
            const res = await fetch(`${MEU_IP}/finalizar-corrida`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    corrida_id: idCorridaAtual,
                    motoboy_id: usuario.id,
                    codigo_seguranca: pinDigitado // <--- AQUI EST√Å A CHAVE
                })
            });

            const data = await res.json();

            if (data.success) {
                if (data.success) {
    alert(`‚úÖ CORRIDA FINALIZADA COM SUCESSO!`);
}
                
                idCorridaAtual = null;
                temCorridaAtiva = false;
                
                // Recarrega para atualizar saldo e limpar tela
                window.location.reload(); 
            } else {
                // Se a senha estiver errada, o servidor manda a mensagem aqui
                alert("‚ùå " + (data.message || 'Erro ao finalizar. Verifique a senha.'));
            }

        } catch (err) {
            console.error('Erro ao finalizar corrida:', err);
            alert('Erro de conex√£o. Tente novamente.');
        }
    }


    /***********************
     * ¬†INICIALIZA√á√ÉO
     ***********************/
    
    // Funcao que verifica o estado inicial
    async function inicializarApp() {
        enviarStatusOnline(true);
        onlineInterval = setInterval(() => {
            enviarStatusOnline(true);
        }, 5000);
        
        // Inicia a verifica√ß√£o do estado imediatamente
        await verificarEstado(); 
        
        // Garante que o polling da lista inicie, caso n√£o haja corrida ativa
        if (!temCorridaAtiva && !estadoVerificacaoInterval) {
            estadoVerificacaoInterval = setInterval(verificarEstado, 5000);
        }
    }


    document.addEventListener('DOMContentLoaded', function() {
        inicializarApp();
    });
    
    // Limpeza ao fechar/sair
    window.addEventListener('beforeunload', function() {
        limparContadores();
        limparMonitoramento();
        pararMonitoramentoAtiva();
        pararVerificacaoEstado();

        
        
        
    });
window.cancelarCorridaMotoboy = function() {
    console.log("Clicou em cancelar!");
    const modal = document.getElementById('modal-cancelamento-motoboy');
    
    if (modal) {
        modal.style.display = 'flex';
    } else {
        // Se o modal de justificativa falhar, usa o confirm padr√£o
        if(confirm("Deseja cancelar a corrida?")) {
            confirmarCancelamentoMotoboy();
        }
    }
};

// 2. ENVIA O CANCELAMENTO (A√ß√£o do bot√£o vermelho dentro do modal)
// Substitua a fun√ß√£o inteira 'window.confirmarCancelamentoMotoboy' por esta:

window.confirmarCancelamentoMotoboy = async function() {
pararAlerta(); 

    const inputMotivo = document.getElementById('justificativa-motoboy');
    const motivoTexto = inputMotivo ? inputMotivo.value : "Recusado";

    if (motivoTexto.length < 5) {
        alert("Digite um motivo v√°lido (m√≠nimo 5 letras).");
        return;
    }

    fecharModal('modal-cancelamento-motoboy');

    // --- MUDAN√áA AQUI: SEGURAN√áA PARA PEGAR O ID DA LISTA OU DA ATIVA ---
    const idParaCancelar = idCorridaAtual || (corridaSendoExibida ? corridaSendoExibida.corrida_id : null) || window.radarIdCorrida;

    if (!idParaCancelar) {
        alert("Erro: ID da corrida n√£o encontrado.");
        return;
    }

    try {
        // ... resto do seu c√≥digo (o fetch e o modal de aviso de 5 min) continua igual
        const res = await fetch(`${MEU_IP}/cancelar-pedido`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: idParaCancelar,
                motivo: `[PILOTO] Cancelou: ${motivoTexto}`,
                cancelado_por: 'motoboy',
                motoboy_id: usuario.id
            })
        });

        const data = await res.json();

        if (data.success) {
            // --- AQUI EST√Å A M√ÅGICA VISUAL (SEM ALERT) ---
            
            // Cria um modal din√¢mico usando seu CSS existente
            const divAviso = document.createElement('div');
            divAviso.className = 'modal-overlay';
            divAviso.style.display = 'flex'; // J√° mostra direto
            divAviso.innerHTML = `
                <div class="modal-box" style="border-color: #ff4444; box-shadow: 0 0 30px rgba(255, 68, 68, 0.3);">
                    <span style="font-size: 50px; display: block; margin-bottom: 15px;">üö´</span>
                    <div class="modal-titulo texto-vermelho">CORRIDA CANCELADA</div>
                    <p class="modal-desc" style="color: #fff;">
                        Voc√™ cancelou a corrida.<br>
                        <span style="color: #ff9999; font-size: 13px; margin-top: 10px; display: block;">
                            ‚ö†Ô∏è Uma restri√ß√£o de 5 minutos foi aplicada.
                        </span>
                    </p>
                    <button class="btn-modal btn-vermelho" onclick="window.location.reload()">ENTENDIDO</button>
                </div>
            `;
            document.body.appendChild(divAviso);

            // Toca som de erro se tiver
            if (typeof tocarAlerta === 'function') tocarAlerta();

        } else {
            mostrarErro("Erro ao cancelar: " + (data.message || "Tente novamente."));
        }
    } catch (err) {
        console.error("Erro ao cancelar:", err);
        mostrarErro("Erro de conex√£o ao cancelar.");
    }
};

// 3. FECHAR QUALQUER MODAL
window.fecharModal = function(idModal) {
    const modal = document.getElementById(idModal);
    if(modal) modal.style.display = 'none';
};

// 4. RADAR DE CANCELAMENTO (CLIENTE CANCELOU?)
window.iniciarRadarCancelamento = function(idCorrida) {
    // Evita duplicar radar para a mesma corrida
    if (window.radarIntervalo && window.radarIdCorrida === idCorrida) return;
    
    // Limpa anterior se mudar de corrida
    if (window.radarIntervalo) clearInterval(window.radarIntervalo);
    
    window.radarIdCorrida = idCorrida;
    console.log("üì° RADAR VIGIANDO CORRIDA:", idCorrida);

    window.radarIntervalo = setInterval(async () => {
        if (!idCorrida) return;

        try {
            const res = await fetch(`${MEU_IP}/status-corrida/${idCorrida}`);
            const data = await res.json();

            // SE DETECTAR CANCELAMENTO
            if (data.success && (data.status === 'cancelada' || data.status === 'cancelado')) {
                clearInterval(window.radarIntervalo);
                pararAlerta();
                
                // 1. Som e Vibra√ß√£o
                if (typeof tocarAlerta === 'function') tocarAlerta();
                if (navigator.vibrate) navigator.vibrate([500, 500, 500]);

                // 2. TENTA ABRIR O MODAL BONITO (NEON)
                const modalBonito = document.getElementById('modal-cancelado-radar');
                
                if (modalBonito) {
                    modalBonito.style.display = 'flex'; // <--- AQUI ELE MOSTRA O NEON
                } else {
                    // SE ELE N√ÉO ACHAR O MODAL NEON NO HTML, ELE MOSTRA O FEIO (ALERT)
                    console.warn("Modal Neon n√£o encontrado no HTML!");
                    alert("üö´ A CORRIDA FOI CANCELADA PELO CLIENTE!");
                    window.location.reload();
                }
            }
        } catch (e) {
            console.error("Erro radar:", e);
        }
    }, 3000); // Verifica a cada 3 segundos
}; 
function pararAlerta() {


    // 1. Limpa o loop de repeti√ß√£o imediatamente
    if (loopAlertaGeral) {
        clearInterval(loopAlertaGeral);
        loopAlertaGeral = null;
    }

    // 2. Para o som fisicamente
    const audio = document.getElementById('som-alerta');
    if (audio) {
        audio.pause();
        audio.currentTime = 0;
    }

    // 3. Interrompe a vibra√ß√£o
    if ("vibrate" in navigator) {
        navigator.vibrate(0);
    }
}
if ('serviceWorker' in navigator && 'PushManager' in window) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js').then(function(reg) {
            console.log('Service Worker registrado com sucesso!', reg);
        }).catch(function(err) {
            console.error('Erro ao registrar Service Worker:', err);
        });
    });
}

// Fun√ß√£o para pedir permiss√£o ao piloto (Chame isso ao clicar em "Ficar Online")
async function pedirPermissaoNotificacao() {
    const permissao = await Notification.requestPermission();
    if (permissao === 'granted') {
        console.log('Piloto aceitou notifica√ß√µes!');
    } else {
        alert('Voc√™ precisa permitir as notifica√ß√µes para receber corridas!');
    }
}

// 1. FUN√á√ÉO PARA SOLICITAR PAGAMENTO (WHATSAPP DO ADM)
function solicitarPagamentoAdm() {
    const nomePiloto = document.getElementById('msg-ola').innerText.replace('OL√Å, ', '');
    const saldo = document.getElementById('saldo-piloto').innerText;
    const numAdm = "5535997806080"; // Seu n√∫mero configurado
    
    const texto = `*FALC√ïES APP - FINANCEIRO* ü¶Ö\n\n` +
                  `Ol√°, Admin!\n` +
                  `Sou o piloto *${nomePiloto}*.\n` +
                  `Gostaria de solicitar a retirada do meu saldo atual: *${saldo}*.\n\n` +
                  `Pode verificar para mim?`;
                  
    window.open(`https://api.whatsapp.com/send?phone=${numAdm}&text=${encodeURIComponent(texto)}`, '_blank');
}

async function ativarRecursos() {
    // Esconde a tela de ativa√ß√£o
    document.getElementById('camada-ativacao').style.display = 'none';
    
    // NOVO: Destrava a vibra√ß√£o no primeiro toque
    if ("vibrate" in navigator) {
        navigator.vibrate(10); // Vibra√ß√£o curtinha s√≥ para validar
    }

    if (typeof ativarWakeLock === "function") {
        await ativarWakeLock();
    }
    
    const audio = document.getElementById('som-alerta');
    if(audio) {
        audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
            console.log("üîä √Åudio desbloqueado com sucesso!");
        }).catch(() => {});
    }
    
    enviarStatusOnline(true);
}
 
</script>