<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Motoboy - Falc√µes</title>
    <style>
        /* --- IDENTIDADE VISUAL DARK --- */
        :root {
            --bg-color: #121212; --card-color: #1e1e1e; --neon-green: #00e640;
            --text-color: #ffffff; --border-color: #333; --danger-color: #ff4444;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); padding: 20px; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; }

        .header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); gap: 15px; padding-bottom: 15px;}
        .logo-pequeno { height: 60px; }
        .moto-saudacao { font-weight: 800; color: white; font-size: 18px; text-transform: uppercase; margin-bottom: 8px; display: block; text-align: center;}
        .status-moto { background-color: var(--neon-green); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: 800; font-size: 12px; text-transform: uppercase; }
        .logout { color: var(--danger-color); text-decoration: none; font-weight: 700; font-size: 13px; border: 1px solid var(--danger-color); padding: 4px 10px; border-radius: 15px; margin-left: 10px;}

        #tela-lista, #tela-bloqueio, #tela-corrida-ativa { display: none; }

        /* CARD CORRIDA */
        .card-corrida { background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); animation: slideIn 0.5s ease;}
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .tipo-servico { font-weight: bold; font-size: 14px; text-transform: uppercase; background: #333; padding: 5px 10px; border-radius: 5px; color: #ccc; }
        .valor { font-size: 24px; font-weight: 800; color: var(--neon-green); }
        .rota { margin-bottom: 20px; font-size: 15px; line-height: 1.6; }
        .destaque-endereco { color: white; font-weight: bold; display: block; margin-bottom: 5px;}

        .btn-acao { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 18px; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-top: 10px;}
        .btn-verde { background-color: var(--neon-green); color: #000; }
        
        /* TELA BLOQUEIO */
        .aviso-bloqueio { text-align: center; padding: 40px 20px; border: 1px solid var(--danger-color); border-radius: 15px; background: rgba(255, 68, 68, 0.1); }
        .tempo-bloqueio { font-size: 40px; font-weight: 800; color: var(--danger-color); margin: 20px 0; display: block;}

        /* TELA ATIVA */
        .titulo-ativa { text-align: center; color: var(--neon-green); font-size: 22px; margin-bottom: 20px; font-weight: 800; animation: piscar 2s infinite; }
        .info-cliente { background: #000; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #333; }
        @keyframes piscar { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        /* --- MODAIS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-box { background: var(--card-color); border: 1px solid var(--border-color); padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 0 30px rgba(0, 230, 64, 0.1); animation: popup 0.3s ease; }
        .modal-titulo { font-size: 20px; font-weight: 800; color: white; margin-bottom: 10px; text-transform: uppercase; }
        .modal-desc { color: #aaa; margin-bottom: 25px; font-size: 15px; }
        .modal-botoes { display: flex; gap: 10px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-sim { background-color: var(--neon-green); color: black; }
        .btn-nao { background-color: #333; color: white; }
        .modal-icon-sucesso, .modal-icon-erro { font-size: 50px; margin-bottom: 10px; display: block; }
        .texto-verde { color: var(--neon-green); } .texto-vermelho { color: var(--danger-color); }
        @keyframes popup { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <audio id="som-alerta" src="assets/som.mp3"></audio>

    <div id="modal-confirmacao" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-titulo">Aceitar Corrida?</div>
            <p class="modal-desc">Voc√™ se compromete a buscar o passageiro/encomenda imediatamente.</p>
            <div class="modal-botoes">
                <button class="btn-modal btn-nao" onclick="fecharModal('modal-confirmacao')">CANCELAR</button>
                <button id="btn-confirma-final" class="btn-modal btn-sim" onclick="confirmarAceite()">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="modal-sucesso" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--neon-green);">
            <span class="modal-icon-sucesso">‚úÖ</span>
            <div class="modal-titulo texto-verde">CORRIDA ACEITA!</div>
            <p class="modal-desc">V√° para o local de busca.<br>Boa viagem, Falc√£o.</p>
        </div>
    </div>

    <div id="modal-erro" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--danger-color);">
            <span class="modal-icon-erro">‚ö†Ô∏è</span>
            <div class="modal-titulo texto-vermelho">OCORREU UM ERRO</div>
            <p class="modal-desc" id="msg-erro-texto">N√£o foi poss√≠vel aceitar a corrida.</p>
            <button class="btn-modal btn-nao" onclick="fecharModal('modal-erro')">FECHAR</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <img src="assets/logo.png" alt="Logo" class="logo-pequeno">
            <div class="user-area">
                <span id="msg-ola" class="moto-saudacao">OL√Å, PILOTO</span>
                <div class="status-wrapper">
                    <span class="status-moto">‚óè ONLINE</span>
                    <a href="index.html" class="logout" onclick="localStorage.clear()">SAIR</a>
                </div>
            </div>
        </div>

        <span id="label-categoria" class="categoria-badge">CATEGORIA: --</span>
        
        <div id="tela-lista">
            <h2 style="text-align:center; color:var(--neon-green)">CORRIDAS DISPON√çVEIS</h2>
            <div id="lista-corridas">Carregando...</div>
        </div>

        <div id="tela-corrida-ativa">
            <div class="titulo-ativa">‚óè CORRIDA EM ANDAMENTO</div>
            <div class="card-corrida" style="border-color: var(--neon-green);">
                <div class="card-top">
                    <span class="tipo-servico" id="ativa-tipo">MOTO T√ÅXI</span>
                    <span class="valor" id="ativa-valor">R$ 0,00</span>
                </div>
                <div class="info-cliente">
                    <div style="color:#aaa; font-size:12px;">CLIENTE:</div>
                    <div style="font-weight:bold; font-size:18px;" id="ativa-cliente">--</div>
                    <div style="color:#fff; margin-top:5px;" id="ativa-fone">--</div>
                </div>
                <div class="rota">
                    <div style="margin-bottom: 15px;">
                        <span style="color:#aaa; font-size:12px;">BUSCAR EM:</span>
                        <span class="destaque-endereco" id="ativa-origem">--</span>
                    </div>
                    <div>
                        <span style="color:#aaa; font-size:12px;">LEVAR PARA:</span>
                        <span class="destaque-endereco" id="ativa-destino">--</span>
                    </div>
                </div>
                <button class="btn-acao btn-verde" onclick="finalizarCorrida()">‚úÖ FINALIZAR CORRIDA</button>
            </div>
        </div>

        <div id="tela-bloqueio">
            <div class="aviso-bloqueio">
                <h2 style="color:var(--danger-color); margin:0;">PAUSA OBRIGAT√ìRIA</h2>
                <span class="tempo-bloqueio" id="tempo-restante">--</span>
                <p>Novas corridas aparecer√£o ap√≥s este tempo.</p>
                <button onclick="verificarEstado()" style="background:transparent; border:1px solid #555; color:#aaa; padding:10px; border-radius:5px; cursor:pointer;">Atualizar</button>
            </div>
        </div>
    </div>

    <script>
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario || usuario.tipo !== 'motoboy') window.location.href = 'index.html';
        
        document.getElementById('msg-ola').innerText = "OL√Å, " + usuario.nome.split(' ')[0].toUpperCase();
        const catExibicao = usuario.categoria ? usuario.categoria.toUpperCase() : "GERAL";
        document.getElementById('label-categoria').innerText = `SUA CATEGORIA: ${catExibicao}`;

        let idCorridaSelecionada = null;
        let idCorridaAtual = null;
        let corridasVisiveis = []; // Para controlar o som

        // --- TOCA SOM ---
        function tocarAlerta() {
            const audio = document.getElementById('som-alerta');
            // Tenta tocar. Se o navegador bloquear, paci√™ncia (precisa de intera√ß√£o do usu√°rio)
            audio.play().catch(err => console.log("Som bloqueado at√© intera√ß√£o do usu√°rio"));
        }

        async function verificarEstado() {
            try {
                const resAtiva = await fetch(`https://falcoes-app.onrender.com/minha-corrida-atual/${usuario.id}`);
                const dadosAtiva = await resAtiva.json();

                if (dadosAtiva.tem_corrida) {
                    mostrarTela('ativa');
                    preencherDadosAtiva(dadosAtiva.corrida);
                    return; 
                }

                const resLista = await fetch('https://falcoes-app.onrender.com/corridas-pendentes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ motoboy_id: usuario.id })
                });
                const dadosLista = await resLista.json();

                if (dadosLista.success === false && dadosLista.bloqueado) {
                    mostrarTela('bloqueio');
                    document.getElementById('tempo-restante').innerText = dadosLista.tempo + " min";
                } else {
                    mostrarTela('lista');
                    renderizarLista(dadosLista.corridas || []);
                }

            } catch (err) { console.error(err); }
        }

        function mostrarTela(tela) {
            document.getElementById('tela-lista').style.display = 'none';
            document.getElementById('tela-corrida-ativa').style.display = 'none';
            document.getElementById('tela-bloqueio').style.display = 'none';

            if(tela === 'lista') document.getElementById('tela-lista').style.display = 'block';
            if(tela === 'ativa') document.getElementById('tela-corrida-ativa').style.display = 'block';
            if(tela === 'bloqueio') document.getElementById('tela-bloqueio').style.display = 'block';
        }

        function preencherDadosAtiva(c) {
            idCorridaAtual = c.id;
            document.getElementById('ativa-tipo').innerText = c.tipo_servico.toUpperCase();
            document.getElementById('ativa-valor').innerText = "R$ " + parseFloat(c.valor).toFixed(2);
            document.getElementById('ativa-cliente').innerText = c.nome_cliente;
            document.getElementById('ativa-fone').innerText = c.telefone_cliente;
            document.getElementById('ativa-origem').innerText = c.origem;
            document.getElementById('ativa-destino').innerText = c.destino;
        }

        function renderizarLista(todasCorridas) {
            const container = document.getElementById('lista-corridas');
            if(document.getElementById('modal-confirmacao').style.display === 'flex') return;

            container.innerHTML = ''; 

            // Filtra pela categoria
            const filtradas = todasCorridas.filter(c => {
                if (usuario.tipo === 'admin') return true;
                const minhaCategoria = usuario.categoria; 
                if (minhaCategoria === 'Passageiro') return c.tipo_servico === 'moto-taxi';
                if (minhaCategoria === 'Entregas') return c.tipo_servico === 'entrega';
                return true;
            });

            // --- L√ìGICA DO SOM ---
            // Verifica se tem algum ID novo que n√£o estava na lista anterior
            let temNova = false;
            filtradas.forEach(nova => {
                // Se esse ID n√£o estava na lista 'corridasVisiveis'
                if (!corridasVisiveis.includes(nova.id)) {
                    temNova = true;
                }
            });

            // Se tem nova, toca o som!
            if (temNova) {
                tocarAlerta();
            }

            // Atualiza a lista de conhecidos para a pr√≥xima verifica√ß√£o
            corridasVisiveis = filtradas.map(c => c.id);
            // ---------------------

            if (filtradas.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#555; padding:30px;">Nenhuma corrida dispon√≠vel.</div>';
                return;
            }

            filtradas.forEach(c => {
                const html = `
                    <div class="card-corrida">
                        <div class="card-top">
                            <span class="tipo-servico">${c.tipo_servico}</span>
                            <span class="valor">R$ ${parseFloat(c.valor).toFixed(2)}</span>
                        </div>
                        <div class="rota">
                            <div style="color:#ddd; margin-bottom:5px;">üìç ${c.origem}</div>
                            <div style="color:#ddd;">üèÅ ${c.destino}</div>
                        </div>
                        <button class="btn-acao btn-verde" onclick="aceitarCorrida(${c.id})">ACEITAR</button>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // MODAIS E A√á√ïES (Igual anterior)
        function abrirModalAceitar(id) {
            idCorridaSelecionada = id;
            document.getElementById('modal-confirmacao').style.display = 'flex';
        }
        function fecharModal(idModal) {
            document.getElementById(idModal).style.display = 'none';
            if(idModal === 'modal-confirmacao') idCorridaSelecionada = null;
        }
        function mostrarErro(mensagem) {
            document.getElementById('msg-erro-texto').innerText = mensagem;
            document.getElementById('modal-erro').style.display = 'flex';
        }

        async function aceitarCorrida(id) { abrirModalAceitar(id); }

        async function confirmarAceite() {
            if (!idCorridaSelecionada) return;
            const btn = document.getElementById('btn-confirma-final');
            btn.innerText = "..."; btn.disabled = true;
            try {
                const response = await fetch('https://falcoes-app.onrender.com/aceitar-corrida', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ corrida_id: idCorridaSelecionada, motoboy_id: usuario.id })
                });
                const result = await response.json();
                fecharModal('modal-confirmacao'); btn.innerText = "CONFIRMAR"; btn.disabled = false;
                if (result.success) {
                    document.getElementById('modal-sucesso').style.display = 'flex';
                    setTimeout(() => { verificarEstado(); document.getElementById('modal-sucesso').style.display = 'none'; }, 2500);
                } else { mostrarErro("Erro: " + result.message); }
            } catch (err) { fecharModal('modal-confirmacao'); btn.innerText = "CONFIRMAR"; btn.disabled = false; mostrarErro("Erro conex√£o."); }
        }

        async function finalizarCorrida() {
            if(!confirm("Finalizar corrida?")) return;
            try {
                await fetch('https://falcoes-app.onrender.com/finalizar-corrida', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ corrida_id: idCorridaAtual })
                });
                verificarEstado();
            } catch (err) { alert("Erro ao finalizar."); }
        }

        verificarEstado();
        setInterval(verificarEstado, 5000);
    </script>
</body>
</html>