<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Motoboy - Falc√µes</title>
    <style>
        /* --- IDENTIDADE VISUAL DARK --- */
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --neon-green: #00e640;
            --text-color: #ffffff;
            --border-color: #333;
            --danger-color: #ff4444;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            gap: 15px;
            padding-bottom: 15px;
        }

        .logo-pequeno {
            height: 60px;
        }

        .moto-saudacao {
            font-weight: 800;
            color: white;
            font-size: 18px;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
            text-align: center;
        }

        .status-moto {
            background-color: var(--neon-green);
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
        }

        .logout {
            color: var(--danger-color);
            text-decoration: none;
            font-weight: 700;
            font-size: 13px;
            border: 1px solid var(--danger-color);
            padding: 4px 10px;
            border-radius: 15px;
            margin-left: 10px;
        }

        #tela-lista,
        #tela-bloqueio,
        #tela-corrida-ativa {
            display: none;
        }

        /* CARD CORRIDA */
        .card-corrida {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tipo-servico {
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            background: #333;
            padding: 5px 10px;
            border-radius: 5px;
            color: #ccc;
        }

        .valor {
            font-size: 24px;
            font-weight: 800;
            color: var(--neon-green);
        }

        .rota {
            margin-bottom: 20px;
            font-size: 15px;
            line-height: 1.6;
        }

        .destaque-endereco {
            color: white;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        /* NOVO: ESTILO PARA O CONTADOR */
        .contador-tempo {
            font-size: 18px;
            font-weight: 800;
            color: var(--danger-color);
            text-align: right;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        .btn-acao {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-verde {
            background-color: var(--neon-green);
            color: #000;
        }

        .btn-vermelho {
            background-color: var(--danger-color);
            color: white;
        }

        /* TELA BLOQUEIO */
        .aviso-bloqueio {
            text-align: center;
            padding: 40px 20px;
            border: 1px solid var(--danger-color);
            border-radius: 15px;
            background: rgba(255, 68, 68, 0.1);
        }

        .tempo-bloqueio {
            font-size: 40px;
            font-weight: 800;
            color: var(--danger-color);
            margin: 20px 0;
            display: block;
        }

        /* TELA ATIVA */
        .titulo-ativa {
            text-align: center;
            color: var(--neon-green);
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: 800;
            animation: piscar 2s infinite;
        }

        .info-cliente {
            background: #000;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }

        @keyframes piscar {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* --- MODAIS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-box {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 20px;
            width: 85%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 230, 64, 0.1);
            animation: popup 0.3s ease;
        }

        .modal-titulo {
            font-size: 20px;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .modal-desc {
            color: #aaa;
            margin-bottom: 25px;
            font-size: 15px;
        }

        .modal-botoes {
            display: flex;
            gap: 10px;
        }

        .btn-modal {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-sim {
            background-color: var(--neon-green);
            color: black;
        }

        .btn-nao {
            background-color: #333;
            color: white;
        }

        .modal-icon-sucesso,
        .modal-icon-erro {
            font-size: 50px;
            margin-bottom: 10px;
            display: block;
        }

        .texto-verde {
            color: var(--neon-green);
        }

        .texto-vermelho {
            color: var(--danger-color);
        }

        @keyframes popup {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        /* ESTILO PARA O CAMPO TEXTAREA NO MODAL DE CANCELAMENTO */
.modal-box textarea {
    width: 100%;
    height: 80px;
    padding: 10px;
    box-sizing: border-box;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--card-color);
    color: white;
    resize: none;
    font-family: inherit;
    margin-top: 10px;
}

/* --- NOVOS ESTILOS PARA TELA ATIVA (CORRIGIDO) --- */

.resumo-valor {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    margin-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.rota-ativa-mapa {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

.ponto-rota {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.icone-rota {
    font-size: 24px;
    line-height: 1;
    color: var(--neon-green);
}

.label-endereco {
    color: #aaa;
    font-size: 12px;
    display: block;
    margin-bottom: 3px;
}

.destaque-endereco {
    color: white;
    font-weight: bold;
    font-size: 15px;
    display: block;
}

/* NOVO ESTILO PARA BOTOES DE A√á√ÉO */
#botoes-acao-ativa {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}

        
    </style>
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker
                .register("/service-worker.js")
                .then(() => console.log("SW registrado!"))
                .catch(err => console.log("Erro SW:", err));
        }
    </script>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00e640">
</head>

<body>

    <audio id="som-alerta" src="assets/som.mp3"></audio>

    <div id="modal-confirmacao" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-titulo">Aceitar Corrida?</div>
            <p class="modal-desc">Voc√™ se compromete a buscar o passageiro/encomenda imediatamente.</p>
            <div class="modal-botoes">
                <button class="btn-modal btn-nao" onclick="fecharModal('modal-confirmacao')">CANCELAR</button>
                <button id="btn-confirma-final" class="btn-modal btn-sim" onclick="confirmarAceitarCorrida()">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="modal-sucesso" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--neon-green);">
            <span class="modal-icon-sucesso">‚úÖ</span>
            <div class="modal-titulo texto-verde">CORRIDA ACEITA!</div>
            <p class="modal-desc">V√° para o local de busca.<br>Boa viagem, Falc√£o.</p>
        </div>
    </div>

    <div id="modal-erro" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--danger-color);">
            <span class="modal-icon-erro">‚ö†Ô∏è</span>
            <div class="modal-titulo texto-vermelho">OCORREU UM ERRO</div>
            <p class="modal-desc" id="msg-erro-texto">N√£o foi poss√≠vel aceitar a corrida.</p>
            <button class="btn-modal btn-nao" onclick="fecharModal('modal-erro')">FECHAR</button>
        </div>
    </div>

    <div id="modal-cancelamento-motoboy" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--danger-color); box-shadow: 0 0 30px rgba(255, 68, 68, 0.2);">
            <div class="modal-titulo texto-vermelho">üö´ CANCELAR CORRIDA</div>
            <p class="modal-desc">Voc√™ ser√° bloqueado temporariamente se cancelar ap√≥s aceitar sem justificativa v√°lida.
            </p>
            <textarea id="justificativa-motoboy"
                placeholder="Qual o motivo do cancelamento? (m√≠nimo 5 caracteres)"></textarea>

            <div class="modal-botoes" style="margin-top: 20px;">
                <button class="btn-modal btn-nao" onclick="fecharModal('modal-cancelamento-motoboy')">VOLTAR</button>
                <button class="btn-modal btn-vermelho" onclick="confirmarCancelamentoMotoboy()">CANCELAR E
                    NOTIFICAR</button>
            </div>
        </div>
    </div>


    <div class="container">
        <div class="header">
            <img src="assets/logo.png" alt="Logo" class="logo-pequeno">
            <div class="user-area">
                <span id="msg-ola" class="moto-saudacao">OL√Å, PILOTO</span>
                <div class="status-wrapper">
                    <span id="status-online-indicator" class="status-moto">‚óè ONLINE</span>
                    <a href="index.html" class="logout" onclick="deslogar()">SAIR</a>
                </div>
            </div>
        </div>

        <span id="label-categoria" class="categoria-badge">CATEGORIA: --</span>

        <div id="tela-lista">
            <h2 style="text-align:center; color:var(--neon-green)">CORRIDAS DISPON√çVEIS</h2>
            <div id="lista-corridas">Carregando...</div>
        </div>

        <div id="tela-corrida-ativa">
    <div class="titulo-ativa">‚óè CORRIDA EM ANDAMENTO</div>
    <div class="card-corrida" id="ativa-card" style="border-color: var(--neon-green);">
        
        <div class="resumo-valor">
            <span class="tipo-servico" id="ativa-tipo">MOTO T√ÅXI</span>
            <span class="valor" id="ativa-valor">R$ 0,00</span>
        </div>

        <div class="info-cliente">
            <div style="color:#aaa; font-size:12px;">CLIENTE:</div>
            <div style="font-weight:bold; font-size:18px;" id="ativa-cliente">--</div>
            <div style="color:#fff; margin-top:5px;" id="ativa-fone">--</div>
        </div>
        
        <div class="rota-ativa-mapa">
            <div class="ponto-rota">
                <span class="icone-rota">üî∫</span>
                <div class="endereco-wrapper">
                    <span class="label-endereco">BUSCAR EM:</span>
                    <span class="destaque-endereco" id="ativa-origem">--</span>
                </div>
            </div>
            
            <div class="ponto-rota">
                <span class="icone-rota">üèÅ</span>
                <div class="endereco-wrapper">
                    <span class="label-endereco">LEVAR PARA:</span>
                    <span class="destaque-endereco" id="ativa-destino">--</span>
                </div>
            </div>
        </div>

        <div id="botoes-acao-ativa">
            </div>
    </div>
</div>

        <div id="tela-bloqueio">
            <div class="aviso-bloqueio">
                <h2 style="color:var(--danger-color); margin:0;">PAUSA OBRIGAT√ìRIA</h2>
                <span class="tempo-bloqueio" id="tempo-restante">--</span>
                <p>Novas corridas aparecer√£o ap√≥s este tempo.</p>
                <button onclick="verificarEstado()"
                    style="background:transparent; border:1px solid #555; color:#aaa; padding:10px; border-radius:5px; cursor:pointer;">Atualizar</button>
            </div>
        </div>
    </div>

    <script>
    /***********************
     * ¬†VARI√ÅVEIS GLOBAIS
     ***********************/
    const usuario = JSON.parse(localStorage.getItem('usuario'));

    // VERIFICA√á√ÉO DE LOGIN
    if (!usuario || !usuario.id || usuario.tipo !== 'motoboy') {
        console.error('Usu√°rio n√£o autorizado ou n√£o logado.');
        window.location.href = 'index.html';
    }

    // EXIBE NOME E CATEGORIA
    document.getElementById('msg-ola').innerText = "OL√Å, " + usuario.nome.split(' ')[0].toUpperCase();
    const categoriaExibicao = usuario.categoria || "GERAL";
    document.getElementById('label-categoria').innerText = `SUA CATEGORIA: ${categoriaExibicao.toUpperCase()}`;

    const MEU_IP = 'https://falcoes-app.onrender.com';
    let idCorridaSelecionada = null;
    let idCorridaAtual = null;
    let onlineInterval = null;
    let estadoVerificacaoInterval = null;
    let temCorridaAtiva = false;

    // Armazena os IDs dos setIntervals para os contadores (Corrida na lista)
    let intervalosContadores = {};

    // Controle da corrida sendo exibida (Corrida na lista)
    let corridaSendoExibida = null;
    let notificacaoAtiva = false;
    let intervaloMonitoramento = null; // Monitora se a corrida na lista foi aceita por outro

    // Monitoramento da corrida ACEITA
    let monitoramentoAtivaInterval = null;


    /***********************
     * ¬†FUN√á√ïES DE UTILIDADE
     ***********************/
    function limparContadores() {
        Object.values(intervalosContadores).forEach(clearInterval);
        intervalosContadores = {};
    }

    function limparMonitoramento() {
        if (intervaloMonitoramento) {
            clearInterval(intervaloMonitoramento);
            intervaloMonitoramento = null;
        }
        corridaAtualMonitorada = null;
    }

    function pararMonitoramentoAtiva() {
        if (monitoramentoAtivaInterval) {
            clearInterval(monitoramentoAtivaInterval);
            monitoramentoAtivaInterval = null;
        }
    }

    function pararVerificacaoEstado() {
        if (estadoVerificacaoInterval) {
            clearInterval(estadoVerificacaoInterval);
            estadoVerificacaoInterval = null;
        }
    }

    function tocarAlerta() {
        const audio = document.getElementById('som-alerta');
        if (!audio) return;
        try {
            audio.pause();
            audio.currentTime = 0;
            audio.play().catch(err => console.log("Som bloqueado at√© intera√ß√£o do usu√°rio"));
        } catch (e) {
            console.log("Erro ao tocar som:", e);
        }
    }
    
    // Fun√ß√£o para deslogar
    function deslogar() {
        limparContadores();
        limparMonitoramento();
        pararMonitoramentoAtiva();
        pararVerificacaoEstado();
        enviarStatusOnline(false);
        if (onlineInterval) {
            clearInterval(onlineInterval);
        }
        localStorage.clear();
        window.location.href = 'index.html';
    }


    /***********************
     * ¬†FUN√á√ïES DE STATUS ONLINE
     ***********************/

    async function enviarStatusOnline(online) {
        try {
            const response = await fetch(`${MEU_IP}/motoboy/status-online`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    motoboy_id: usuario.id,
                    online: online,
                    latitude: null,
                    longitude: null
                })
            });

            const result = await response.json();
            if (result.success) {
                const statusElement = document.getElementById('status-online-indicator');
                if (online) {
                    statusElement.innerText = "‚óè ONLINE";
                    statusElement.style.backgroundColor = "var(--neon-green)";
                } else {
                    statusElement.innerText = "‚óè OFFLINE";
                    statusElement.style.backgroundColor = "#666";
                }
            }
        } catch (err) {
            console.error("Erro ao enviar status online:", err);
        }
    }

    /***********************
     * ¬†CONTROLE DE FLUXO E TELAS
     ***********************/

    function mostrarTela(tela) {
        document.getElementById('tela-lista').style.display = 'none';
        document.getElementById('tela-corrida-ativa').style.display = 'none';
        document.getElementById('tela-bloqueio').style.display = 'none';

        if (tela === 'lista') document.getElementById('tela-lista').style.display = 'block';
        if (tela === 'ativa') document.getElementById('tela-corrida-ativa').style.display = 'block';
        if (tela === 'bloqueio') document.getElementById('tela-bloqueio').style.display = 'block';
    }

// NOVO: Adicione esta fun√ß√£o para renderizar os bot√µes dinamicamente
function renderizarBotoesAtiva(status) {
    const container = document.getElementById('botoes-acao-ativa');
    if (!container) return;
    
    // Limpa bot√µes anteriores
    container.innerHTML = ''; 

    // Bot√£o de Cancelar
    const btnCancelar = document.createElement('button');
    btnCancelar.className = 'btn-acao btn-vermelho';
    btnCancelar.innerText = '‚ùå CANCELAR CORRIDA';
    btnCancelar.setAttribute('onclick', 'cancelarCorridaMotoboy()');
    
    // Bot√£o Finalizar
    const btnFinalizar = document.createElement('button');
    btnFinalizar.className = 'btn-acao btn-verde';
    btnFinalizar.innerText = '‚úÖ FINALIZAR CORRIDA';
    btnFinalizar.setAttribute('onclick', 'finalizarCorrida()');

    // L√≥gica de exibi√ß√£o:
    // A corrida √© considerada "iniciada" assim que est√° liberada.
    if (status === 'liberada' || status === 'em_andamento') {
        container.appendChild(btnFinalizar);
        container.appendChild(btnCancelar); 
    }
}


function preencherDadosAtiva(c) {
    idCorridaAtual = c.corrida_id || c.id;
    
    document.getElementById('ativa-tipo').innerText = c.tipo_servico.toUpperCase();
    document.getElementById('ativa-valor').innerText = "R$ " + parseFloat(c.valor).toFixed(2);
    document.getElementById('ativa-cliente').innerText = c.nome_cliente;
    document.getElementById('ativa-fone').innerText = c.telefone_cliente;
    document.getElementById('ativa-origem').innerText = c.origem;
    document.getElementById('ativa-destino').innerText = c.destino;
    
    // Renderiza os bot√µes dinamicamente com base no status
    renderizarBotoesAtiva(c.status); 
}

    /***********************
     * ¬†L√ìGICA DO POLLING DE ESTADO
     ***********************/
    async function verificarDisponibilidadeCorrida(corridaId) {
        try {
            const res = await fetch(`${MEU_IP}/status-corrida/${corridaId}`);
            const data = await res.json();
            // Retorna false se n√£o for 'pendente' ou se a requisi√ß√£o falhar
            return data.success && data.status === 'pendente'; 
        } catch (err) {
            console.error('Erro ao verificar disponibilidade:', err);
            return true; 
        }
    }
    
    async function verificarEstado() {
        try {
            // 1. Verifica se h√° corrida ativa (aceita)
            const resAtiva = await fetch(`${MEU_IP}/minha-corrida-atual/${usuario.id}`);
            const dadosAtiva = await resAtiva.json();

            if (dadosAtiva.tem_corrida) {
                temCorridaAtiva = true;
                idCorridaAtual = dadosAtiva.corrida.corrida_id || dadosAtiva.corrida.id;
                const statusCorrida = dadosAtiva.corrida.status;

                limparContadores();
                limparMonitoramento();
                pararVerificacaoEstado(); // Parar o polling de lista

                // Se a corrida for liberada ou em andamento, mostra a tela ativa
                if (statusCorrida === 'liberada' || statusCorrida === 'em_andamento') {
                    mostrarTela('ativa');
                    preencherDadosAtiva(dadosAtiva.corrida);
                    // Garante que o monitoramento de corrida ativa est√° rodando
                    if (!monitoramentoAtivaInterval) {
                         pararMonitoramentoAtiva();
                         monitoramentoAtivaInterval = setInterval(verificarEstado, 3000); // Polling r√°pido para corrida ativa
                    }
                    return;
                } 
                // Se a corrida foi aceita mas ainda aguarda pagamento
                else if (statusCorrida === 'aguardando_pagamento' || statusCorrida === 'aceita') {
                    // Estado de espera ap√≥s aceitar
                    pararMonitoramentoAtiva();
                    monitoramentoAtivaInterval = setInterval(verificarEstado, 3000); // Polling r√°pido

                    mostrarTela('lista'); // Volta para a tela de lista com aviso
                    const container = document.getElementById('lista-corridas');
                    if (container) {
                        container.innerHTML = `
                            <div style="text-align:center; padding:30px;">
                                <div style="color:#ffca28; font-size:24px; margin-bottom:10px;">‚è≥</div>
                                <div style="color:#ffca28; font-weight:bold; margin-bottom:10px;">
                                    AGUARDANDO LIBERA√á√ÉO DA CORRIDA
                                </div>
                                <div style="color:#ccc; font-size:14px;">
                                    Aguardando confirma√ß√£o de pagamento do cliente.<br>
                                    Voc√™ ser√° notificado assim que for **liberada**.
                                </div>
                            </div>
                        `;
                    }
                    return;
                }
                // Se o status for 'cancelada' ou 'finalizada', ele cai para o passo 2
            }
            
            // 2. N√£o h√° corrida ativa ou a corrida ativa foi cancelada/finalizada. Limpa e verifica lista/bloqueio.
            pararMonitoramentoAtiva();
            temCorridaAtiva = false;
            idCorridaAtual = null;


            const resLista = await fetch(`${MEU_IP}/corridas-pendentes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ motoboy_id: usuario.id })
            });
            const dadosLista = await resLista.json();

            if (dadosLista.success === false && dadosLista.bloqueado) {
                limparContadores();
                limparMonitoramento();
                mostrarTela('bloqueio');
                document.getElementById('tempo-restante').innerText = dadosLista.tempo + " min";
                
            } else if (dadosLista.success === false && dadosLista.offline) {
                document.getElementById('lista-corridas').innerHTML =
                    '<div style="text-align:center; color:#ff4444; padding:30px;">‚ö†Ô∏è VOC√ä PRECISA ESTAR ONLINE</div>';
                mostrarTela('lista');

            } else {
                mostrarTela('lista');
                let corrida = dadosLista.corrida || null;

                // Se a corrida que est√°vamos monitorando na lista n√£o existe mais, ou n√£o est√° mais pendente
                if (corridaSendoExibida && corrida && corridaSendoExibida.corrida_id !== corrida.corrida_id) {
                    // Uma nova corrida chegou ou a antiga sumiu, for√ßamos a limpeza
                    corridaSendoExibida = null;
                } else if (!corrida && corridaSendoExibida) {
                     // Corrida anterior sumiu, mas n√£o veio nova
                    corridaSendoExibida = null;
                }
                
                renderizarLista(corrida);
            }
            
            // Inicia o polling de lista/bloqueio, se ainda n√£o estiver ativo
            if (!estadoVerificacaoInterval && !temCorridaAtiva) {
                estadoVerificacaoInterval = setInterval(verificarEstado, 5000);
            }

        } catch (err) {
            console.error("Erro ao verificar estado:", err);
            // Em caso de erro, tenta reiniciar o polling da lista
            mostrarTela('lista');
            if (!estadoVerificacaoInterval) {
                 estadoVerificacaoInterval = setInterval(verificarEstado, 5000);
            }
        }
    }


    /***********************
     * ¬†CRIA√á√ÉO E RENDERIZA√á√ÉO DA LISTA
     ***********************/
     function iniciarContador(id, tempoInicial, onTimeout) {
        limparContadores();

        let tempoRestante = tempoInicial;
        const cardElement = document.getElementById(`card-${id}`);
        const contadorElement = cardElement ? cardElement.querySelector('.contador-tempo') : null;

        if (!contadorElement) return;

        const decremento = async () => {
            if (tempoRestante <= 0) {
                clearInterval(intervalosContadores[id]);
                delete intervalosContadores[id];

                if (cardElement) cardElement.remove();

                try {
                    await fetch(`${MEU_IP}/expirar-corrida`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            corrida_id: id,
                            motoboy_id: usuario.id
                        })
                    });
                } catch (e) {
                    console.error("Erro ao notificar timeout da corrida:", e);
                }

                if (typeof onTimeout === 'function') onTimeout();
                return;
            }

            contadorElement.innerText = `‚è≥ SUA VEZ: ${tempoRestante}s`;
            tempoRestante--;
        };

        decremento();
        intervalosContadores[id] = setInterval(decremento, 1000);
    }

    function criarCardCorrida(corrida) {
        const container = document.getElementById('lista-corridas');

        const div = document.createElement('div');
        div.className = 'card-corrida';
        div.id = `card-${corrida.corrida_id}`;

        const htmlConteudo = `
            <div class="card-top">
                <span class="tipo-servico">${corrida.tipo_servico.toUpperCase()}</span>
                <span class="valor">R$ ${parseFloat(corrida.valor).toFixed(2)}</span>
            </div>
            ${corrida.ciclo && corrida.ciclo > 1 ?
                `<div style="background: #333; color: #ff9900; padding: 5px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; text-align: center;">
                    ‚ö° CICLO ${corrida.ciclo}
                </div>`
                : ''
            }
            <div class="rota">
                <div style="color:#ddd; margin-bottom:5px;">üìç ${corrida.origem}</div>
                <div style="color:#ddd;">üèÅ ${corrida.destino}</div>
            </div>
            <div class="contador-tempo" id="contador-${corrida.corrida_id}"></div>
            <button class="btn-acao btn-verde" onclick="aceitarCorridaWrapper(${corrida.corrida_id})">ACEITAR</button>
            <div style="font-size: 12px; color: #888; text-align: center; margin-top: 10px;">
                ‚ö†Ô∏è Outros pilotos tamb√©m est√£o vendo esta corrida
            </div>
        `;
        div.innerHTML = htmlConteudo;
        container.appendChild(div);

        const tempoRestante = 60 - Math.ceil(parseFloat(corrida.segundos_passados || 0));

        if (tempoRestante > 0) {
            tocarAlerta();
            iniciarContador(corrida.corrida_id, tempoRestante, () => {
                // A corrida expirou na tela do motoboy, pede um novo estado
                verificarEstado();
            });
        } else {
            div.remove();
            verificarEstado();
        }
    }

    function renderizarLista(corrida) {
        const container = document.getElementById('lista-corridas');

        if (!corrida) {
            container.innerHTML = '<div style="text-align:center; color:#555; padding:30px;">Nenhuma corrida dispon√≠vel.</div>';
            limparContadores();
            limparMonitoramento();
            notificacaoAtiva = false;
            corridaSendoExibida = null;
            return;
        }

        // Se a corrida for a mesma que est√° sendo exibida, n√£o faz nada (mant√©m contador e monitoramento)
        if (corridaSendoExibida && corridaSendoExibida.corrida_id === corrida.corrida_id) {
            return;
        }

        // Se for uma nova corrida ou a anterior sumiu, limpa e renderiza
        limparMonitoramento();
        container.innerHTML = '';
        limparContadores();
        corridaSendoExibida = corrida;
        notificacaoAtiva = true;
        criarCardCorrida(corrida);
        iniciarMonitoramento(corrida.corrida_id);
    }
    
    function iniciarMonitoramento(corridaId) {
        limparMonitoramento();

        corridaAtualMonitorada = corridaId;

        // Monitora se a corrida na lista foi aceita por outro motoboy
        intervaloMonitoramento = setInterval(async () => {
            if (temCorridaAtiva) return; // Se j√° tem corrida ativa, sai

            const disponivel = await verificarDisponibilidadeCorrida(corridaId);

            if (!disponivel && corridaSendoExibida && corridaSendoExibida.corrida_id === corridaId) {
                console.log(`Corrida ${corridaId} foi aceita por outro motoboy. Limpando...`);

                const container = document.getElementById('lista-corridas');
                container.innerHTML = '<div style="text-align:center; color:#ff4444; padding:30px;">‚ö†Ô∏è Esta corrida j√° foi aceita por outro piloto</div>';

                limparContadores();
                limparMonitoramento();
                notificacaoAtiva = false;
                corridaSendoExibida = null;

                tocarAlerta();

                setTimeout(verificarEstado, 3000);
            }
        }, 2000);
    }


    /***********************
     * ¬†A√á√ïES E BOT√ïES
     ***********************/

    function fecharModal(idModal) {
        document.getElementById(idModal).style.display = 'none';
        if (idModal === 'modal-confirmacao') idCorridaSelecionada = null;
    }

    function mostrarErro(mensagem) {
        document.getElementById('msg-erro-texto').innerText = mensagem;
        document.getElementById('modal-erro').style.display = 'flex';
    }

    // Fun√ß√£o de clique no bot√£o "ACEITAR" no card
    async function aceitarCorridaWrapper(id) { 
        try {
            await enviarStatusOnline(true);
            
            const disponivel = await verificarDisponibilidadeCorrida(id);
            if (!disponivel) {
                mostrarErro("Esta corrida j√° foi aceita por outro piloto.");
                verificarEstado();
                return;
            }
            
            idCorridaSelecionada = id;
            limparMonitoramento();
            
            document.getElementById('modal-confirmacao').style.display = 'flex';
        } catch (err) {
            console.error("Erro ao preparar aceite:", err);
            mostrarErro("Erro ao processar. Tente novamente.");
        }
    }

    async function confirmarAceitarCorrida() {
        if (!idCorridaSelecionada) {
            alert('Nenhuma corrida selecionada.');
            return;
        }

        try {
            const res = await fetch(`${MEU_IP}/aceitar-corrida`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    corrida_id: idCorridaSelecionada,
                    motoboy_id: usuario.id
                }),
            });

            if (!res.ok) {
                throw new Error(`Erro HTTP: ${res.status}`);
            }

            const data = await res.json();

            if (!data.success) {
                fecharModal('modal-confirmacao');
                mostrarErro(data.message || 'N√£o foi poss√≠vel aceitar a corrida.');
                verificarEstado(); 
                return;
            }

            // Sucesso
            idCorridaAtual = idCorridaSelecionada;
            temCorridaAtiva = true;
            
            limparContadores();
            limparMonitoramento();
            pararVerificacaoEstado();
            
            fecharModal('modal-confirmacao');
            document.getElementById('modal-sucesso').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('modal-sucesso').style.display = 'none';
                verificarEstado(); // Atualiza para a tela ativa (aguardando ou liberada)
            }, 1000);

        } catch (err) {
            console.error('Erro ao confirmar aceite da corrida:', err);
            mostrarErro('Erro ao aceitar corrida: ' + (err.message || ''));
        }
    }
    
    
    
    async function finalizarCorrida() {
        if (!idCorridaAtual) {
            alert('Nenhuma corrida ativa para finalizar.');
            return;
        }

        if (!confirm("Tem certeza que deseja finalizar esta corrida?")) return;

        try {
            const res = await fetch(`${MEU_IP}/finalizar-corrida`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    corrida_id: idCorridaAtual,
                    motoboy_id: usuario.id 
                })
            });

            const data = await res.json();

            if (data.success) {
                alert('Corrida finalizada com sucesso!');
                idCorridaAtual = null;
                temCorridaAtiva = false;
                verificarEstado(); 
            } else {
                alert(data.message || 'Erro ao finalizar corrida.');
            }

        } catch (err) {
            console.error('Erro ao finalizar corrida:', err);
            alert('Erro de conex√£o. Tente novamente.');
        }
    }
    
    function cancelarCorridaMotoboy() {
        if (!idCorridaAtual) return;
        document.getElementById('modal-cancelamento-motoboy').style.display = 'flex';
        document.getElementById('justificativa-motoboy').value = '';
        document.getElementById('justificativa-motoboy').focus();
    }
    
    async function confirmarCancelamentoMotoboy() {
        const motivo = document.getElementById('justificativa-motoboy').value.trim();

        if (motivo.length < 5) {
            mostrarErro("A justificativa deve ter pelo menos 5 caracteres.");
            return;
        }

        try {
            const res = await fetch(`${MEU_IP}/motoboy-cancelar-corrida`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    corrida_id: idCorridaAtual,
                    motoboy_id: usuario.id,
                    motivo: motivo
                })
            });

            const data = await res.json();

            if (data.success) {
                alert('Corrida cancelada. O cliente ser√° notificado.');
                idCorridaAtual = null;
                temCorridaAtiva = false;
                fecharModal('modal-cancelamento-motoboy');
                verificarEstado(); 
            } else {
                mostrarErro(data.message || 'Erro ao cancelar corrida.');
            }

        } catch (err) {
            console.error('Erro ao cancelar corrida:', err);
            mostrarErro('Erro de conex√£o. Tente novamente.');
        }
    }


    /***********************
     * ¬†INICIALIZA√á√ÉO
     ***********************/
    
    // Funcao que verifica o estado inicial
    async function inicializarApp() {
        enviarStatusOnline(true);
        onlineInterval = setInterval(() => {
            enviarStatusOnline(true);
        }, 5000);
        
        // Inicia a verifica√ß√£o do estado imediatamente
        await verificarEstado(); 
        
        // Garante que o polling da lista inicie, caso n√£o haja corrida ativa
        if (!temCorridaAtiva && !estadoVerificacaoInterval) {
            estadoVerificacaoInterval = setInterval(verificarEstado, 5000);
        }
    }


    document.addEventListener('DOMContentLoaded', function() {
        inicializarApp();
    });
    
    // Limpeza ao fechar/sair
    window.addEventListener('beforeunload', function() {
        limparContadores();
        limparMonitoramento();
        pararMonitoramentoAtiva();
        pararVerificacaoEstado();
        enviarStatusOnline(false);
    });
</script>