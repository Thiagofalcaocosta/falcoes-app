<!DOCTYPE html>
<html lang="pt-br">
<head>
ย ย <meta charset="UTF-8" />
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0" />
ย ย <title>Falcรตes App</title>

ย ย <link
ย ย ย ย rel="stylesheet"
ย ย ย ย href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
ย ย ย ย crossorigin=""
ย ย />

ย ย <style>
ย ย ย ย /* --- IDENTIDADE VISUAL FALCรES (DARK MODE OFICIAL - PRESERVADO) --- */
ย ย ย ย :root {
ย ย ย ย ย ย --bg-color: #121212;
ย ย ย ย ย ย --card-color: #1e1e1e;
ย ย ย ย ย ย --neon-green: #00e640;
ย ย ย ย ย ย --text-color: #ffffff;
ย ย ย ย ย ย --input-bg: #2c2c2c;
ย ย ย ย ย ย --border-color: #333;
ย ย ย ย ย ย --error-color: #ff4444;
ย ย ย ย ย ย --dica-color: #888;
ย ย ย ย }

ย ย ย ย body {
ย ย ย ย ย ย font-family: "Segoe UI", Roboto, sans-serif;
ย ย ย ย ย ย background-color: var(--bg-color);
ย ย ย ย ย ย color: var(--text-color);
ย ย ย ย ย ย padding: 20px;
ย ย ย ย ย ย margin: 0;
ย ย ย ย ย ย -webkit-tap-highlight-color: transparent;
ย ย ย ย }

ย ย ย ย .container {
ย ย ย ย ย ย max-width: 500px;
ย ย ย ย ย ย margin: 0 auto;
ย ย ย ย ย ย background: var(--card-color);
ย ย ย ย ย ย padding: 25px;
ย ย ย ย ย ย border-radius: 15px;
ย ย ย ย ย ย box-shadow: 0 4px 20px rgba(0, 230, 64, 0.1);
ย ย ย ย ย ย position: relative;
ย ย ย ย ย ย border: 1px solid var(--border-color);
ย ย ย ย ย ย padding-bottom: 80px; /* Espaรงo para nรฃo cortar conteudo em mobile */
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* Gerenciamento de Telas */
ย ย ย ย .tela {
ย ย ย ย ย ย display: none; /* Todas as telas escondidas por padrรฃo */
ย ย ย ย }
ย ย ย ย .tela.ativa {
ย ย ย ย ย ย display: block; /* Tela ativa */
ย ย ย ย ย ย animation: fadeIn 0.5s;
ย ย ย ย }

ย ย ย ย .logo-area {
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย margin-bottom: 20px;
ย ย ย ย }
ย ย ย ย .logo-area img {
ย ย ย ย ย ย max-height: 100px;
ย ย ย ย ย ย filter: drop-shadow(0 0 5px rgba(0, 230, 64, 0.5));
ย ย ย ย }

ย ย ย ย .header-top {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย justify-content: space-between;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย margin-bottom: 15px;
ย ย ย ย ย ย font-size: 14px;
ย ย ย ย }
ย ย ย ย .user-info {
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย ย ย color: #ccc;
ย ย ย ย }
ย ย ย ย .estrelas {
ย ย ย ย ย ย background-color: rgba(255, 215, 0, 0.2);
ย ย ย ย ย ย color: #ffd700;
ย ย ย ย ย ย padding: 4px 10px;
ย ย ย ย ย ย border-radius: 15px;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย }
ย ย ย ย .logout a {
ย ย ย ย ย ย color: var(--error-color);
ย ย ย ย ย ย text-decoration: none;
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย }

ย ย ย ย h2 {
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย margin-bottom: 20px;
ย ย ย ย ย ย font-weight: 700;
ย ย ย ย ย ย color: var(--neon-green);
ย ย ย ย ย ย letter-spacing: 1px;
ย ย ย ย }

ย ย ย ย /* --- SELETOR DE SERVIรO --- */
ย ย ย ย .opcoes-servico {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย gap: 15px;
ย ย ย ย ย ย margin-bottom: 10px;
ย ย ย ย }
ย ย ย ย .card {
ย ย ย ย ย ย flex: 1;
ย ย ย ย ย ย padding: 15px;
ย ย ย ย ย ย border: 2px solid var(--border-color);
ย ย ย ย ย ย border-radius: 12px;
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย transition: 0.3s;
ย ย ย ย ย ย background: #252525;
ย ย ย ย ย ย color: #aaa;
ย ย ย ย }
ย ย ย ย .card:hover {
ย ย ย ย ย ย border-color: var(--neon-green);
ย ย ย ย ย ย color: white;
ย ย ย ย }
ย ย ย ย .card.selecionado {
ย ย ย ย ย ย border-color: var(--neon-green);
ย ย ย ย ย ย background-color: rgba(0, 230, 64, 0.1);
ย ย ย ย ย ย color: var(--neon-green);
ย ย ย ย ย ย box-shadow: 0 0 15px rgba(0, 230, 64, 0.2);
ย ย ย ย }
ย ย ย ย .icon {
ย ย ย ย ย ย font-size: 28px;
ย ย ย ย ย ย display: block;
ย ย ย ย ย ย margin-bottom: 5px;
ย ย ย ย }
ย ย ย ย .preco {
ย ย ย ย ย ย font-size: 14px;
ย ย ย ย ย ย font-weight: 500;
ย ย ย ย }

ย ย ย ย /* --- NOVOS CAMPOS DE ENDEREรO (GRID) --- */
ย ย ย ย label {
ย ย ย ย ย ย display: block;
ย ย ย ย ย ย margin-top: 15px;
ย ย ย ย ย ย font-weight: 700;
ย ย ย ย ย ย color: var(--neon-green); /* Label verde para destaque */
ย ย ย ย ย ย margin-bottom: 8px;
ย ย ย ย ย ย font-size: 13px;
ย ย ย ย ย ย text-transform: uppercase;
ย ย ย ย ย ย letter-spacing: 1px;
ย ย ย ย }

ย ย ย ย .address-container {
ย ย ย ย ย ย background: rgba(255,255,255,0.03);
ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย border-radius: 10px;
ย ย ย ย ย ย border: 1px solid var(--border-color);
ย ย ย ย }

ย ย ย ย /* Linha 1: Rua + Botรฃo Mapa */
ย ย ย ย .row-rua {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย gap: 8px;
ย ย ย ย ย ย margin-bottom: 8px;
ย ย ย ย ย ย position: relative;
ย ย ย ย }
ย ย ย ย .input-rua-wrapper {
ย ย ย ย ย ย flex: 1;
ย ย ย ย ย ย position: relative;
ย ย ย ย }
ย ย ย ย .btn-map-icon {
ย ย ย ย ย ย background: transparent;
ย ย ย ย ย ย border: 1px solid var(--neon-green);
ย ย ย ย ย ย color: var(--neon-green);
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย width: 44px;
ย ย ย ย ย ย font-size: 20px;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย }
ย ย ย ย .btn-map-icon:hover {
ย ย ย ย ย ย background: rgba(0,230,64,0.1);
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* Linha 2: Nรบmero e Bairro */
ย ย ย ย .row-details {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย gap: 8px;
ย ย ย ย }
ย ย ย ย .input-num-wrapper {
ย ย ย ย ย ย flex: 1; /* 25% */
ย ย ย ย ย ย max-width: 80px;
ย ย ย ย ย ย position: relative;
ย ย ย ย }
ย ย ย ย .input-bairro-wrapper {
ย ย ย ย ย ย flex: 3; /* 75% */
ย ย ย ย }

ย ย ย ย input {
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย padding: 12px;
ย ย ย ย ย ย background-color: var(--input-bg);
ย ย ย ย ย ย border: 1px solid var(--border-color);
ย ย ย ย ย ย color: white;
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย box-sizing: border-box;
ย ย ย ย ย ย font-size: 15px;
ย ย ย ย ย ย transition: 0.3s;
ย ย ย ย }
ย ย ย ย input:focus {
ย ย ย ย ย ย border-color: var(--neon-green);
ย ย ย ย ย ย outline: none;
ย ย ย ย }
ย ย ย ย /* Erro especรญfico para nรบmero vazio */
ย ย ย ย input.erro {
ย ย ย ย ย ย border-color: var(--error-color) !important;
ย ย ย ย ย ย animation: shake 0.4s ease-in-out;
ย ย ย ย }
ย ย ย ย .erro-msg {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย bottom: -16px;
ย ย ย ย ย ย left: 0;
ย ย ย ย ย ย font-size: 10px;
ย ย ย ย ย ย color: var(--error-color);
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย ย ย display: none;
ย ย ย ย }
ย ย ย ย input.erro + .erro-msg {
ย ย ย ย ย ย display: block;
ย ย ย ย }

ย ย ย ย @keyframes shake {
ย ย ย ย ย ย 0%, 100% { transform: translateX(0); }
ย ย ย ย ย ย 25% { transform: translateX(-5px); }
ย ย ย ย ย ย 75% { transform: translateX(5px); }
ย ย ย ย }

ย ย ย ย /* Campo de detalhes da entrega */
ย ย ย ย #detalhes-entrega-container {
ย ย ย ย ย ย display: none; /* Sรณ aparece se for entrega */
ย ย ย ย ย ย margin-top: 15px;
ย ย ย ย ย ย animation: fadeIn 0.3s ease;
ย ย ย ย }
ย ย ย ย @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }


ย ย ย ย /* Lista de Sugestรตes */
ย ย ย ย .sugestoes-lista {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย top: 100%;
ย ย ย ย ย ย left: 0;
ย ย ย ย ย ย right: 0;
ย ย ย ย ย ย background: var(--card-color);
ย ย ย ย ย ย border: 1px solid var(--border-color);
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย max-height: 250px;
ย ย ย ย ย ย overflow-y: auto;
ย ย ย ย ย ย z-index: 1000;
ย ย ย ย ย ย display: none;
ย ย ย ย ย ย box-shadow: 0 10px 30px rgba(0,0,0,0.8);
ย ย ย ย }
ย ย ย ย .sugestao-item {
ย ย ย ย ย ย padding: 12px 15px;
ย ย ย ย ย ย border-bottom: 1px solid #333;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย }
ย ย ย ย .sugestao-item:last-child { border-bottom: none; }
ย ย ย ย .sugestao-item:hover {
ย ย ย ย ย ย background-color: #2c2c2c;
ย ย ย ย }
ย ย ย ย .rua-texto {
ย ย ย ย ย ย display: block;
ย ย ย ย ย ย font-size: 15px;
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย ย ย color: var(--neon-green);
ย ย ย ย }
ย ย ย ย .bairro-texto {
ย ย ย ย ย ย display: block;
ย ย ย ย ย ย font-size: 12px;
ย ย ย ย ย ย color: #aaa;
ย ย ย ย ย ย margin-top: 2px;
ย ย ย ย }

ย ย ย ย /* --- RESUMO E BOTรO --- */
ย ย ย ย .resumo-final {
ย ย ย ย ย ย margin-top: 25px;
ย ย ย ย ย ย padding: 15px;
ย ย ย ย ย ย background-color: rgba(0, 230, 64, 0.1);
ย ย ย ย ย ย color: var(--neon-green);
ย ย ย ย ย ย border: 1px solid var(--neon-green);
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย border-radius: 10px;
ย ย ย ย ย ย font-size: 18px;
ย ย ย ย ย ย font-weight: 700;
ย ย ย ย ย ย display: none;
ย ย ย ย }

ย ย ย ย .btn {
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย padding: 16px;
ย ย ย ย ย ย margin-top: 20px;
ย ย ย ย ย ย background-color: var(--neon-green);
ย ย ย ย ย ย color: black;
ย ย ย ย ย ย border: none;
ย ย ย ย ย ย border-radius: 10px;
ย ย ย ย ย ย font-size: 18px;
ย ย ย ย ย ย font-weight: 800;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย transition: 0.3s;
ย ย ย ย ย ย text-transform: uppercase;
ย ย ย ย }
ย ย ย ย .btn:hover {
ย ย ย ย ย ย transform: scale(1.02);
ย ย ย ย ย ย box-shadow: 0 0 15px var(--neon-green);
ย ย ย ย }
ย ย ย ย .btn:disabled {
ย ย ย ย ย ย background-color: #444;
ย ย ย ย ย ย color: #888;
ย ย ย ย ย ย cursor: not-allowed;
ย ย ย ย ย ย transform: none;
ย ย ย ย ย ย box-shadow: none;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* --- ESTILOS ESPECรFICOS ACOMPANHAMENTO --- */
ย ย ย ย .info-card {
ย ย ย ย ย ย background: #252525;
ย ย ย ย ย ย padding: 15px;
ย ย ย ย ย ย border-radius: 10px;
ย ย ย ย ย ย margin-bottom: 15px;
ย ย ย ย ย ย border: 1px solid var(--border-color);
ย ย ย ย }
ย ย ย ย .info-card .label {
ย ย ย ย ย ย font-size: 12px;
ย ย ย ย ย ย color: #999;
ย ย ย ย ย ย text-transform: uppercase;
ย ย ย ย ย ย margin-bottom: 3px;
ย ย ย ย }
ย ย ย ย .info-card .value {
ย ย ย ย ย ย font-size: 16px;
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย ย ย color: var(--text-color);
ย ย ย ย }
ย ย ย ย .motoboy-box {
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย margin: 20px 0;
ย ย ย ย ย ย padding: 20px;
ย ย ย ย ย ย border: 2px solid var(--neon-green);
ย ย ย ย ย ย border-radius: 15px;
ย ย ย ย ย ย background: rgba(0, 230, 64, 0.1);
ย ย ย ย }
ย ย ย ย .motoboy-box .nome {
ย ย ย ย ย ย font-size: 24px;
ย ย ย ย ย ย font-weight: 800;
ย ย ย ย ย ย color: var(--neon-green);
ย ย ย ย ย ย margin-top: 5px;
ย ย ย ย }
ย ย ย ย .motoboy-box .placa {
ย ย ย ย ย ย font-size: 14px;
ย ย ย ย ย ย color: #ccc;
ย ย ย ย ย ย margin-bottom: 10px;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* NOVO ESTILO WHATSAPP */
ย ย ย ย .btn-whatsapp {
ย ย ย ย ย ย background-color: #25D366; /* Cor oficial do WhatsApp */
ย ย ย ย ย ย color: white;
ย ย ย ย ย ย border: none;
ย ย ย ย ย ย padding: 12px;
ย ย ย ย ย ย border-radius: 10px;
ย ย ย ย ย ย font-size: 16px;
ย ย ย ย ย ย font-weight: 700;
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย margin-top: 15px;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย transition: background-color 0.2s;
ย ย ย ย ย ย text-decoration: none;
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย ย ย gap: 10px;
ย ย ย ย }
ย ย ย ย .btn-whatsapp:hover {
ย ย ย ย ย ย background-color: #1FAF59;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* --- MODAL DE BUSCA (temporรกrio) --- */
ย ย ย ย .modal-overlay {
ย ย ย ย ย ย position: fixed;
ย ย ย ย ย ย top: 0;
ย ย ย ย ย ย left: 0;
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย height: 100%;
ย ย ย ย ย ย background: rgba(0, 0, 0, 0.95);
ย ย ย ย ย ย display: none;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย z-index: 9999;
ย ย ย ย }
ย ย ย ย .modal-content {
ย ย ย ย ย ย background: var(--card-color);
ย ย ย ย ย ย padding: 30px;
ย ย ย ย ย ย border-radius: 20px;
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย width: 85%;
ย ย ย ย ย ย max-width: 350px;
ย ย ย ย ย ย border: 1px solid var(--border-color);
ย ย ย ย ย ย box-shadow: 0 0 40px rgba(0, 230, 64, 0.15);
ย ย ย ย }
ย ย ย ย .spinner {
ย ย ย ย ย ย border: 5px solid #333;
ย ย ย ย ย ย border-top: 5px solid var(--neon-green);
ย ย ย ย ย ย border-radius: 50%;
ย ย ย ย ย ย width: 50px;
ย ย ย ย ย ย height: 50px;
ย ย ย ย ย ย animation: girar 1s linear infinite;
ย ย ย ย ย ย margin: 0 auto 20px auto;
ย ย ย ย }
ย ย ย ย @keyframes girar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
ย ย ย ย 
ย ย ย ย .btn-cancelar {
ย ย ย ย ย ย background-color: transparent;
ย ย ย ย ย ย border: 1px solid var(--error-color);
ย ย ย ย ย ย color: var(--error-color);
ย ย ย ย ย ย font-size: 14px;
ย ย ย ย ย ย margin-top: 20px;
ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* ESTILO PARA O CAMPO TEXTAREA NO MODAL DE JUSTIFICATIVA */
ย ย ย ย .modal-content textarea {
ย ย ย ย ย ย width: 100%; 
ย ย ย ย ย ย height: 80px; 
ย ย ย ย ย ย padding: 10px; 
ย ย ย ย ย ย box-sizing: border-box; 
ย ย ย ย ย ย border-radius: 8px; 
ย ย ย ย ย ย border: 1px solid var(--border-color); 
ย ย ย ย ย ย background: var(--input-bg); 
ย ย ย ย ย ย color: white; 
ย ย ย ย ย ย resize: none;
ย ย ย ย ย ย font-family: inherit;
ย ย ย ย ย ย /* --- CORREรรO APLICADA AQUI --- */
ย ย ย ย ย ย **position: relative;** ย ย ย ย ย ย **z-index: 10000;** /* Garante que fique acima de outros elementos do modal e do teclado */
ย ย ย ย }


ย ย ย ย #map {
ย ย ย ย ย ย height: 180px;
ย ย ย ย ย ย border-radius: 12px;
ย ย ย ย ย ย margin-top: 20px;
ย ย ย ย ย ย border: 1px solid var(--border-color);
ย ย ย ย }

ย ย ย ย /* --- TOAST --- */
ย ย ย ย .toast-container {
ย ย ย ย ย ย position: fixed;
ย ย ย ย ย ย left: 50%;
ย ย ย ย ย ย bottom: 24px;
ย ย ย ย ย ย transform: translateX(-50%);
ย ย ย ย ย ย z-index: 10050;
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย flex-direction: column;
ย ย ย ย ย ย gap: 10px;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย pointer-events: none;
ย ย ย ย ย ย width: 90%;
ย ย ย ย }
ย ย ย ย .toast {
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย max-width: 400px;
ย ย ย ย ย ย background: #000;
ย ย ย ย ย ย border-radius: 12px;
ย ย ย ย ย ย padding: 12px 16px;
ย ย ย ย ย ย color: #fff;
ย ย ย ย ย ย box-shadow: 0 10px 30px rgba(0,0,0,0.8);
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย gap: 12px;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย opacity: 0;
ย ย ย ย ย ย transform: translateY(10px);
ย ย ย ย ย ย animation: toast-in 0.3s forwards;
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย ย ย border: 1px solid var(--neon-green);
ย ย ย ย ย ย pointer-events: auto;
ย ย ย ย }
ย ย ย ย @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
ย ย ย ย .toast.error { border-color: var(--error-color); }
ย ย ย ย .toast .msg { flex: 1; font-size: 14px; }
ย ย ย ย .toast .close { background: none; border: none; color: #fff; cursor: pointer; font-size: 18px; }

ย ย </style>
<script type="importmap">
{
ย ย "imports": {
ย ย ย ย "react/": "https://aistudiocdn.com/react@^19.2.0/",
ย ย ย ย "react": "https://aistudiocdn.com/react@^19.2.0",
ย ย ย ย "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
ย ย ย ย "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
ย ย }
}
</script>
<script>
if ("serviceWorker" in navigator) {
ย navigator.serviceWorker
ย ย .register("/service-worker.js")
ย ย .then(() => console.log("SW registrado!"))
ย ย .catch(err => console.log("Erro SW:", err));
}
</script>

<link rel="stylesheet" href="/style.css">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#00e640">
</head>
<body>

ย ย <div class="toast-container" id="toast-container"></div>

ย ย <div class="modal-overlay" id="modal-busca">
ย ย ย ย <div class="modal-content">
ย ย ย ย ย ย <div id="area-spinner" class="spinner"></div>

ย ย ย ย ย ย <div id="status-titulo-modal" style="font-size: 18px; font-weight: bold; color: white; margin-bottom: 10px;">BUSCANDO PILOTO...</div>
ย ย ย ย ย ย <div id="status-desc-modal" style="font-size: 14px; color: #aaa;">Notificando parceiros prรณximos.</div>

ย ย ย ย ย ย <button id="btn-cancelar-pedido-modal" class="btn-cancelar" onclick="cancelarPedido()">CANCELAR PEDIDO</button>
ย ย ย ย </div>
ย ย </div>
ย ย 
ย ย <div class="modal-overlay" id="modal-justificativa">
ย ย ย ย <div class="modal-content">
ย ย ย ย ย ย <div style="font-size: 24px; color: var(--error-color); margin-bottom: 15px;">โ๏ธ Cancelar Pedido</div>
ย ย ย ย ย ย <div id="justificativa-titulo" style="font-size: 16px; color: white; margin-bottom: 10px; font-weight: 600;">Por que deseja cancelar?</div>
ย ย ย ย ย ย 
ย ย ย ย ย ย <textarea id="campo-justificativa" 
ย ย ย ย ย ย ย ย ย ย ย placeholder="Ex: Nรฃo preciso mais, endereรงo errado, demora do piloto..."></textarea>
ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย <button onclick="confirmarCancelamentoCliente()" class="btn" style="background-color: var(--error-color); color: white; margin-top: 15px;">
ย ย ย ย ย ย ย ย CONFIRMAR CANCELAMENTO
ย ย ย ย ย ย </button>
ย ย ย ย ย ย <button onclick="document.getElementById('modal-justificativa').style.display='none'" class="btn-cancelar" style="border: none; color: #aaa; margin-top: 10px;">
ย ย ย ย ย ย ย ย Voltar
ย ย ย ย ย ย </button>
ย ย ย ย </div>
ย ย </div>

ย ย <div class="container">
ย ย ย ย <div class="logo-area"><img src="assets/logo.png" alt="Logo" onerror="this.style.display='none'; document.querySelector('.logo-area').innerHTML='<h1 style=\'color:var(--neon-green)\'>FALCรES</h1>'" /></div>

ย ย ย ย <div class="header-top">
ย ย ย ย ย ย <div class="user-info"><span id="msg-ola">Piloto</span> <span class="estrelas">โ 5.0</span></div>
ย ย ย ย ย ย <div class="logout"><a href="#" onclick="logout()">SAIR</a></div>
ย ย ย ย </div>

ย ย ย ย <div id="tela-pedido" class="tela ativa">
ย ย ย ย ย ย 
ย ย ย ย ย ย <h2>NOVA SOLICITAรรO</h2>

ย ย ย ย ย ย <div class="opcoes-servico">
ย ย ย ย ย ย ย ย <div class="card" id="card-moto" onclick="selecionarServico('moto-taxi', 10.0)">
ย ย ย ย ย ย ย ย ย ย <span class="icon">๐๏ธ</span>
ย ย ย ย ย ย ย ย ย ย <div class="card-title">MOTO TรXI</div>
ย ย ย ย ย ย ย ย ย ย <div class="preco">R$ 10,00 + Km</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="card" id="card-entrega" onclick="selecionarServico('entrega', 8.50)">
ย ย ย ย ย ย ย ย ย ย <span class="icon">๐ฆ</span>
ย ย ย ย ย ย ย ย ย ย <div class="card-title">ENTREGA</div>
ย ย ย ย ย ย ย ย ย ย <div class="preco">R$ 8,50 + Km</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div id="form-endereco">
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย <label>๐ Onde vamos buscar? (Origem)</label>
ย ย ย ย ย ย ย ย <div class="address-container">
ย ย ย ย ย ย ย ย ย ย <div class="row-rua">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="input-rua-wrapper">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="rua-origem" placeholder="Busque a rua..." oninput="buscarEndereco(this.value, 'lista-origem', 'origem')" autocomplete="off">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="lista-origem" class="sugestoes-lista"></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-map-icon" onclick="ativarMapa('origem')" title="Marcar no mapa">๐บ๏ธ</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="row-details">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="input-num-wrapper">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="num-origem" placeholder="Nยบ" oninput="removerErro(this)">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="erro-msg">Obrigatรณrio</span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="input-bairro-wrapper">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="bairro-origem" placeholder="Bairro">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <label>๐ Onde vamos levar? (Destino)</label>
ย ย ย ย ย ย ย ย <div class="address-container">
ย ย ย ย ย ย ย ย ย ย <div class="row-rua">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="input-rua-wrapper">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="rua-destino" placeholder="Busque a rua..." oninput="buscarEndereco(this.value, 'lista-destino', 'destino')" autocomplete="off">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="lista-destino" class="sugestoes-lista"></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn-map-icon" onclick="ativarMapa('destino')" title="Marcar no mapa">๐บ๏ธ</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="row-details">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="input-num-wrapper">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="num-destino" placeholder="Nยบ" oninput="removerErro(this)">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="erro-msg">Obrigatรณrio</span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="input-bairro-wrapper">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="bairro-destino" placeholder="Bairro">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div id="detalhes-entrega-container">
ย ย ย ย ย ย ย ย ย ย <label>๐ฆ O que vamos levar?</label>
ย ย ย ย ย ย ย ย ย ย <input type="text" id="detalhes-entrega" placeholder="Ex: Chaves, Marmita, Documento..." oninput="removerErro(this)">
ย ย ย ย ย ย ย ย ย ย <span class="erro-msg" style="position:relative; bottom:0;">Descreva o item</span>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div id="map"></div>
ย ย ย ย ย ย <p style="font-size:12px; color:#666; text-align:center; margin-top:5px;">Toque no botรฃo ๐บ๏ธ para marcar no mapa</p>

ย ย ย ย ย ย <div class="resumo-final" id="resumo"></div>

ย ย ย ย ย ย <button onclick="pedir()" id="btn-pedir" class="btn" disabled>SELECIONE O SERVIรO</button>
ย ย ย ย </div>
ย ย ย ย 
ย ย ย ย <div id="tela-acompanhamento" class="tela">
ย ย ย ย ย ย <h2>ACOMPANHANDO PEDIDO <span id="acompanhamento-id">#--</span></h2>
ย ย ย ย ย ย 
ย ย ย ย ย ย <div id="acompanhamento-status-area" class="motoboy-box" style="border-color: #ffd700; background: rgba(255, 215, 0, 0.1);">
ย ย ย ย ย ย ย ย <div style="font-size: 36px; margin-bottom: 5px;">โณ</div>
ย ย ย ย ย ย ย ย <div class="nome" id="acompanhamento-status-titulo" style="color: #ffd700;">BUSCANDO PILOTO...</div>
ย ย ย ย ย ย ย ย <div class="placa" id="acompanhamento-status-desc" style="font-size: 16px;">Notificando parceiros prรณximos.</div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div id="motoboy-info-box" style="display:none; margin-top: 20px;">
ย ย ย ย ย ย ย ย <div class="motoboy-box">
ย ย ย ย ย ย ย ย ย ย <div style="font-size: 32px; margin-bottom: 5px;">๐๏ธ</div>
ย ย ย ย ย ย ย ย ย ย <div style="font-size: 12px; color: #aaa; text-transform:uppercase;">Seu Piloto</div>
ย ย ย ย ย ย ย ย ย ย <div class="nome" id="motoboy-nome">--</div>
ย ย ย ย ย ย ย ย ย ย <div class="placa" id="motoboy-placa">--</div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <a id="btn-whatsapp-motoboy" href="#" target="_blank" class="btn-whatsapp" style="display: none;">
ย ย ย ย ย ย ย ย ย ย <span style="font-size: 20px;">๐</span>
ย ย ย ย ย ย ย ย ย ย CHAMAR NO WHATSAPP
ย ย ย ย ย ย ย ย </a>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <h3>Detalhes da Viagem</h3>
ย ย ย ย ย ย <div id="viagem-origem" class="info-card">
ย ย ย ย ย ย ย ย <div class="label">๐ Origem</div>
ย ย ย ย ย ย ย ย <div class="value" id="detalhe-origem">Aguardando...</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div id="viagem-destino" class="info-card">
ย ย ย ย ย ย ย ย <div class="label">๐ Destino</div>
ย ย ย ย ย ย ย ย <div class="value" id="detalhe-destino">Aguardando...</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div id="viagem-valor" class="info-card" style="text-align:center; border: 1px solid var(--neon-green);">
ย ย ย ย ย ย ย ย <div class="label">Total Estimado</div>
ย ย ย ย ย ย ย ย <div class="value" id="detalhe-valor" style="color: var(--neon-green); font-size: 20px;">R$ --</div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <button onclick="cancelarPedido()" id="btn-cancelar-acomp" class="btn-cancelar">CANCELAR PEDIDO</button>
ย ย ย ย ย ย <button onclick="reiniciarApp()" class="btn" style="background-color: #333; color: #ccc; margin-top: 10px;">FECHAR (apenas se finalizado)</button>
ย ย ย ย </div>

ย ย </div>

ย ย <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
ย ย <script>
ย ย ย ย // === CONFIGURAรรO E DADOS ===
ย ย ย ย const MEU_IP = 'https://falcoes-app.onrender.com';
ย ย ย ย const LAT_TC = -21.6975;
ย ย ย ย const LON_TC = -45.2556;
ย ย ย ย 
ย ย ย ย // Mock de usuรกrio se nรฃo existir (para testes)
ย ย ย ย if(!localStorage.getItem("usuario")) {
ย ย ย ย ย ย localStorage.setItem("usuario", JSON.stringify({id: 1, nome: "Visitante", telefone: "00000000"}));
ย ย ย ย }
ย ย ย ย const usuario = JSON.parse(localStorage.getItem("usuario"));
ย ย ย ย document.getElementById("msg-ola").innerText = "OLร, " + usuario.nome.split(" ")[0].toUpperCase();

ย ย ย ย // Variรกveis de Estado
ย ย ย ย let servicoSelecionado = null;
ย ย ย ย let coordsOrigem = null;
ย ย ย ย let coordsDestino = null;
ย ย ย ย let timeoutBusca = null;
ย ย ย ย let mapMode = null; 
ย ย ย ย let markerOrigem = null;
ย ย ย ย let markerDestino = null;
ย ย ย ย let idPedidoAtual = null;
ย ย ย ย let intervaloVerificacao = null;

ย ย ย ย const precos = {
ย ย ย ย ย ย 'moto-taxi': { base: 10.0, kmExtra: 3.15, franquia: 3 },
ย ย ย ย ย ย 'entrega': { base: 8.50, kmExtra: 2.0, franquia: 3 }
ย ย ย ย };

ย ย ย ย // === FUNรรES DE GERENCIAMENTO DE TELA ===
ย ย ย ย function mudarTela(novaTelaId) {
ย ย ย ย ย ย document.querySelectorAll('.tela').forEach(tela => {
ย ย ย ย ย ย ย ย tela.classList.remove('ativa');
ย ย ย ย ย ย });
ย ย ย ย ย ย document.getElementById(novaTelaId).classList.add('ativa');
ย ย ย ย }

ย ย ย ย function reiniciarApp() {
ย ย ย ย ย ย // Limpa o estado e recarrega para voltar ร tela de pedido limpa
ย ย ย ย ย ย localStorage.removeItem('idPedidoAtual');
ย ย ย ย ย ย if (intervaloVerificacao) clearInterval(intervaloVerificacao);
ย ย ย ย ย ย window.location.reload(); 
ย ย ย ย }

ย ย ย ย // === INICIALIZAรรO DO MAPA (Permanece) ===
ย ย ย ย const map = L.map('map').setView([LAT_TC, LON_TC], 14);
ย ย ย ย L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
ย ย ย ย ย ย attribution: '&copy; OpenStreetMap',
ย ย ย ย ย ย maxZoom: 19
ย ย ย ย }).addTo(map);

ย ย ย ย map.on('click', async (e) => {
ย ย ย ย ย ย if (!mapMode) {
ย ย ย ย ย ย ย ย showToast("Clique no botรฃo ๐บ๏ธ ao lado do endereรงo primeiro.", "info");
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย const { lat, lng } = e.latlng;
ย ย ย ย ย ย showToast("Buscando endereรงo...", "info", 1000);

ย ย ย ย ย ย // Reverse Geocoding via Nominatim (Gratuito)
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
ย ย ย ย ย ย ย ย const data = await res.json();
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย const rua = data.address.road || data.address.pedestrian || "Local Marcado";
ย ย ย ย ย ย ย ย const bairro = data.address.suburb || data.address.neighbourhood || data.address.city_district || "Trรชs Coraรงรตes";

ย ย ย ย ย ย ย ย if (mapMode === 'origem') {
ย ย ย ย ย ย ย ย ย ย document.getElementById('rua-origem').value = rua;
ย ย ย ย ย ย ย ย ย ย document.getElementById('bairro-origem').value = bairro;
ย ย ย ย ย ย ย ย ย ย document.getElementById('num-origem').focus();
ย ย ย ย ย ย ย ย ย ย coordsOrigem = { lat, lon: lng };
ย ย ย ย ย ย ย ย ย ย if(markerOrigem) map.removeLayer(markerOrigem);
ย ย ย ย ย ย ย ย ย ย markerOrigem = L.marker([lat, lng]).addTo(map);
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย document.getElementById('rua-destino').value = rua;
ย ย ย ย ย ย ย ย ย ย document.getElementById('bairro-destino').value = bairro;
ย ย ย ย ย ย ย ย ย ย document.getElementById('num-destino').focus();
ย ย ย ย ย ย ย ย ย ย coordsDestino = { lat, lon: lng };
ย ย ย ย ย ย ย ย ย ย if(markerDestino) map.removeLayer(markerDestino);
ย ย ย ย ย ย ย ย ย ย markerDestino = L.marker([lat, lng]).addTo(map);
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย showToast("Endereรงo preenchido! Digite o nรบmero.", "success");
ย ย ย ย ย ย ย ย mapMode = null; // Reset modo
ย ย ย ย ย ย ย ย calcularRota();

ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย showToast("Erro ao obter endereรงo do mapa.", "error");
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // === FUNรรES DE UI (Permanece) ===
ย ย ย ย function ativarMapa(modo) {
ย ย ย ย ย ย mapMode = modo;
ย ย ย ย ย ย showToast(`Toque no mapa para definir a ${modo.toUpperCase()}`, "info");
ย ย ย ย ย ย // Rola atรฉ o mapa
ย ย ย ย ย ย document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
ย ย ย ย }

ย ย ย ย function selecionarServico(tipo, valorBase) {
ย ย ย ย ย ย servicoSelecionado = tipo;
ย ย ย ย ย ย 
ย ย ย ย ย ย // Visual Cards
ย ย ย ย ย ย document.querySelectorAll('.card').forEach(c => c.classList.remove('selecionado'));
ย ย ย ย ย ย if(tipo === 'moto-taxi') document.getElementById('card-moto').classList.add('selecionado');
ย ย ย ย ย ย else document.getElementById('card-entrega').classList.add('selecionado');

ย ย ย ย ย ย // Campo Detalhes da Entrega
ย ย ย ย ย ย const detailsDiv = document.getElementById('detalhes-entrega-container');
ย ย ย ย ย ย if(tipo === 'entrega') {
ย ย ย ย ย ย ย ย detailsDiv.style.display = 'block';
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย detailsDiv.style.display = 'none';
ย ย ย ย ย ย }

ย ย ย ย ย ย document.getElementById('btn-pedir').disabled = false;
ย ย ย ย ย ย document.getElementById('btn-pedir').innerText = tipo === 'entrega' ? "SOLICITAR ENTREGA" : "CHAMAR MOTO TรXI";
ย ย ย ย ย ย 
ย ย ย ย ย ย calcularRota(); 
ย ย ย ย }

ย ย ย ย function logout() {
ย ย ย ย ย ย localStorage.clear();
ย ย ย ย ย ย window.location.reload();
ย ย ย ย }

ย ย ย ย function removerErro(input) {
ย ย ย ย ย ย input.classList.remove('erro');
ย ย ย ย }

ย ย ย ย // Fechar sugestรตes ao clicar fora
ย ย ย ย document.addEventListener('click', (e) => {
ย ย ย ย ย ย if (!e.target.closest('.input-rua-wrapper')) {
ย ย ย ย ย ย ย ย document.querySelectorAll('.sugestoes-lista').forEach(el => el.style.display = 'none');
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // LรGICA DE ENDEREรO e CรLCULO DE ROTA (Omitidas para brevidade no comentรกrio, mas mantidas no cรณdigo)
ย ย ย ย function buscarEndereco(query, listId, type) { 
ย ย ย ย ย ย const list = document.getElementById(listId);
ย ย ย ย ย ย if (query.length < 3) {
ย ย ย ย ย ย ย ย list.style.display = 'none';
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย clearTimeout(timeoutBusca);
ย ย ย ย ย ย timeoutBusca = setTimeout(async () => {
ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ", Trรชs Coraรงรตes")}&addressdetails=1&limit=5&countrycodes=br`;
ย ย ย ย ย ย ย ย ย ย const res = await fetch(url);
ย ย ย ย ย ย ย ย ย ย const data = await res.json();

ย ย ย ย ย ย ย ย ย ย list.innerHTML = '';
ย ย ย ย ย ย ย ย ย ย if (data.length > 0) {
ย ย ย ย ย ย ย ย ย ย ย ย data.forEach(item => {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const rua = item.address.road || item.address.pedestrian || item.display_name.split(',')[0];
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const bairro = item.address.suburb || item.address.neighbourhood || "Centro";

ย ย ย ย ย ย ย ย ย ย ย ย ย ย const div = document.createElement('div');
ย ย ย ย ย ย ย ย ย ย ย ย ย ย div.className = 'sugestao-item';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย div.innerHTML = `<span class="rua-texto">${rua}</span><span class="bairro-texto">${bairro}</span>`;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย ย ย div.onclick = () => {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById(`rua-${type}`).value = rua;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById(`bairro-${type}`).value = bairro;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const coords = { lat: parseFloat(item.lat), lon: parseFloat(item.lon) };
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย if(type === 'origem') coordsOrigem = coords;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย else coordsDestino = coords;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย list.style.display = 'none';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const numInput = document.getElementById(`num-${type}`);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย numInput.focus();
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย numInput.classList.add('erro'); 
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย setTimeout(() => numInput.classList.remove('erro'), 500);

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย calcularRota();
ย ย ย ย ย ย ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ย ย ย ย ย ย ย list.appendChild(div);
ย ย ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย ย ย ย ย list.style.display = 'block';
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย list.style.display = 'none';
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย ย ย console.error("Erro busca", e);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }, 500); 
ย ย ย ย }

ย ย ย ย async function calcularRota() {
ย ย ย ย ย ย if (!coordsOrigem || !coordsDestino || !servicoSelecionado) return;

ย ย ย ย ย ย const resumo = document.getElementById('resumo');
ย ย ย ย ย ย resumo.style.display = 'block';
ย ย ย ย ย ย resumo.innerText = "Calculando...";

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const url = `https://router.project-osrm.org/route/v1/driving/${coordsOrigem.lon},${coordsOrigem.lat};${coordsDestino.lon},${coordsDestino.lat}?overview=false`;
ย ย ย ย ย ย ย ย const res = await fetch(url);
ย ย ย ย ย ย ย ย const json = await res.json();

ย ย ย ย ย ย ย ย let distanciaKm = 0;
ย ย ย ย ย ย ย ย if (json.routes && json.routes.length > 0) {
ย ย ย ย ย ย ย ย ย ย distanciaKm = json.routes[0].distance / 1000;
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย distanciaKm = calcDistanciaReta(coordsOrigem, coordsDestino) * 1.3;
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย const regra = precos[servicoSelecionado];
ย ย ย ย ย ย ย ย const kmCobrado = Math.max(0, distanciaKm - regra.franquia);
ย ย ย ย ย ย ย ย const total = regra.base + (kmCobrado * regra.kmExtra);

ย ย ย ย ย ย ย ย resumo.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <div style="font-size:14px; font-weight:normal; color:#ccc;">Distรขncia: ${distanciaKm.toFixed(1)} km</div>
ย ย ย ย ย ย ย ย ย ย <div>TOTAL: R$ ${total.toFixed(2).replace('.', ',')}</div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย window.valorCalculado = total;

ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error("Erro rota", e);
ย ย ย ย ย ย ย ย resumo.innerText = "Erro ao calcular rota.";
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย function calcDistanciaReta(c1, c2) {
ย ย ย ย ย ย const R = 6371; 
ย ย ย ย ย ย const dLat = (c2.lat - c1.lat) * Math.PI / 180;
ย ย ย ย ย ย const dLon = (c2.lon - c1.lon) * Math.PI / 180;
ย ย ย ย ย ย const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
ย ย ย ย ย ย ย ย ย ย ย Math.cos(c1.lat * Math.PI / 180) * Math.cos(c2.lat * Math.PI / 180) *
ย ย ย ย ย ย ย ย ย ย ย Math.sin(dLon/2) * Math.sin(dLon/2);
ย ย ย ย ย ย const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
ย ย ย ย ย ย return R * c;
ย ย ย ย }

ย ย ย ย // === ENVIO DE PEDIDO (Alterada para usar a nova tela) ===
ย ย ย ย async function pedir() {
ย ย ย ย ย ย // ... (Validaรงรฃo e montagem de dados idรชntica ร anterior) ...
ย ย ย ย ย ย if (!servicoSelecionado) { showToast("Selecione Moto Tรกxi ou Entrega", "error"); return; }
ย ย ย ย ย ย const ruaOrigem = document.getElementById('rua-origem').value;
ย ย ย ย ย ย const numOrigem = document.getElementById('num-origem').value;
ย ย ย ย ย ย const bairroOrigem = document.getElementById('bairro-origem').value;
ย ย ย ย ย ย const ruaDestino = document.getElementById('rua-destino').value;
ย ย ย ย ย ย const numDestino = document.getElementById('num-destino').value;
ย ย ย ย ย ย const bairroDestino = document.getElementById('bairro-destino').value;
ย ย ย ย ย ย const detalhes = document.getElementById('detalhes-entrega').value;

ย ย ย ย ย ย let erro = false;
ย ย ย ย ย ย if (!ruaOrigem) { showToast("Preencha a Rua de Origem", "error"); return; }
ย ย ย ย ย ย if (!numOrigem.trim()) { document.getElementById('num-origem').classList.add('erro'); erro = true; }
ย ย ย ย ย ย if (!ruaDestino) { showToast("Preencha a Rua de Destino", "error"); return; }
ย ย ย ย ย ย if (!numDestino.trim()) { document.getElementById('num-destino').classList.add('erro'); erro = true; }
ย ย ย ย ย ย if (servicoSelecionado === 'entrega' && !detalhes.trim()) { document.getElementById('detalhes-entrega').classList.add('erro'); showToast("Descreva o que vamos entregar!", "error"); return; }
ย ย ย ย ย ย if (erro) { showToast("โ๏ธ Preencha o NรMERO dos endereรงos!", "error"); return; }
ย ย ย ย ย ย 
ย ย ย ย ย ย const strOrigem = `${ruaOrigem}, Nยบ ${numOrigem}, ${bairroOrigem}`;
ย ย ย ย ย ย const strDestino = `${ruaDestino}, Nยบ ${numDestino}, ${bairroDestino}`;
ย ย ย ย ย ย const strDestinoFinal = servicoSelecionado === 'entrega' 
ย ย ย ย ย ย ย ย ? `${strDestino} (ITEM: ${detalhes})` 
ย ย ย ย ย ย ย ย : strDestino;
ย ย ย ย ย ย // ... (Fim da validaรงรฃo) ...


ย ย ย ย ย ย // 1. Mostrar o modal de carregamento
ย ย ย ย ย ย document.getElementById('modal-busca').style.display = 'flex';

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const body = {
ย ย ย ย ย ย ย ย ย ย cliente_id: usuario.id,
ย ย ย ย ย ย ย ย ย ย origem: strOrigem,
ย ย ย ย ย ย ย ย ย ย destino: strDestinoFinal,
ย ย ย ย ย ย ย ย ย ย valor: window.valorCalculado || 10.0,
ย ย ย ย ย ย ย ย ย ย tipo_servico: servicoSelecionado
ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย const res = await fetch(`${MEU_IP}/pedir-corrida`, {
ย ย ย ย ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย ย ย ย ย body: JSON.stringify(body)
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย const json = await res.json();
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย if (json.success) {
ย ย ย ย ย ย ย ย ย ย idPedidoAtual = json.id;
ย ย ย ย ย ย ย ย ย ย localStorage.setItem('idPedidoAtual', idPedidoAtual); 
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย // 2. Preencher a nova tela com os dados iniciais
ย ย ย ย ย ย ย ย ย ย document.getElementById('acompanhamento-id').innerText = `#${idPedidoAtual}`;
ย ย ย ย ย ย ย ย ย ย document.getElementById('detalhe-origem').innerText = strOrigem;
ย ย ย ย ย ย ย ย ย ย document.getElementById('detalhe-destino').innerText = strDestino;
ย ย ย ย ย ย ย ย ย ย document.getElementById('detalhe-valor').innerText = `R$ ${window.valorCalculado.toFixed(2).replace('.', ',')}`;

ย ย ย ย ย ย ย ย ย ย // 3. Trocar para a tela de Acompanhamento e fechar o modal
ย ย ย ย ย ย ย ย ย ย mudarTela('tela-acompanhamento');
ย ย ย ย ย ย ย ย ย ย document.getElementById('modal-busca').style.display = 'none';

ย ย ย ย ย ย ย ย ย ย // 4. Iniciar verificaรงรฃo de status
ย ย ย ย ย ย ย ย ย ย intervaloVerificacao = setInterval(() => verificarStatus(idPedidoAtual), 3000);
ย ย ย ย ย ย ย ย ย ย showToast("Solicitaรงรฃo enviada. Buscando piloto...", "info");

ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย throw new Error(json.message);
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย document.getElementById('modal-busca').style.display = 'none';
ย ย ย ย ย ย ย ย showToast("Erro ao enviar pedido: " + e.message, "error");
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // === VERIFICAรรO DE STATUS (Mantida) ===
ย ย ย ย async function verificarStatus(id) {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch(`${MEU_IP}/status-pedido/${id}`);
ย ย ย ย ย ย ย ย const data = await res.json();
ย ย ย ย ย ย ย ย const pedido = data.pedido;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย if (!data.success || !pedido) {
ย ย ย ย ย ย ย ย ย ย // Trata erro de API
ย ย ย ย ย ย ย ย ย ย console.error("Erro ao obter status. Tentando novamente...");
ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย // Elementos da tela de acompanhamento
ย ย ย ย ย ย ย ย const statusTitulo = document.getElementById('acompanhamento-status-titulo');
ย ย ย ย ย ย ย ย const statusDesc = document.getElementById('acompanhamento-status-desc');
ย ย ย ย ย ย ย ย const statusArea = document.getElementById('acompanhamento-status-area');
ย ย ย ย ย ย ย ย const motoboyBox = document.getElementById('motoboy-info-box');
ย ย ย ย ย ย ย ย const btnWpp = document.getElementById('btn-whatsapp-motoboy');
ย ย ย ย ย ย ย ย const btnCancelar = document.getElementById('btn-cancelar-acomp');
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Limpa quaisquer classes de cor
ย ย ย ย ย ย ย ย statusArea.style.borderColor = '#ffd700';
ย ย ย ย ย ย ย ย statusArea.style.background = 'rgba(255, 215, 0, 0.1)';
ย ย ย ย ย ย ย ย statusTitulo.style.color = '#ffd700';
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย motoboyBox.style.display = 'none';
ย ย ย ย ย ย ย ย btnWpp.style.display = 'none';

ย ย ย ย ย ย ย ย if (pedido.status === 'aceita') {
ย ย ย ย ย ย ย ย ย ย // Pedido Aceito!
ย ย ย ย ย ย ย ย ย ย statusArea.style.borderColor = 'var(--neon-green)';
ย ย ย ย ย ย ย ย ย ย statusArea.style.background = 'rgba(0, 230, 64, 0.1)';
ย ย ย ย ย ย ย ย ย ย statusTitulo.style.color = 'var(--neon-green)';
ย ย ย ย ย ย ย ย ย ย statusTitulo.innerText = "FALCรO A CAMINHO!";
ย ย ย ย ย ย ย ย ย ย statusDesc.innerText = "Seu piloto estรก indo atรฉ vocรช.";
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย document.getElementById('motoboy-nome').innerText = pedido.nome_motoboy || "Piloto Falcรตes";
ย ย ย ย ย ย ย ย ย ย document.getElementById('motoboy-placa').innerText = pedido.placa_motoboy || "Moto Indisponรญvel";
ย ย ย ย ย ย ย ย ย ย motoboyBox.style.display = 'block';

ย ย ย ย ย ย ย ย ย ย // Lรณgica do botรฃo WHATSAPP
ย ย ย ย ย ย ย ย ย ย if (pedido.telefone_motoboy) {
ย ย ย ย ย ย ย ย ย ย ย ย const foneLimpo = pedido.telefone_motoboy.replace(/\D/g, ''); 
ย ย ย ย ย ย ย ย ย ย ย ย const numeroInternacional = foneLimpo.length === 11 ? `55${foneLimpo}` : foneLimpo; 
ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย const textoWpp = encodeURIComponent(`Olรก, sou o cliente do pedido #${id} no app Falcรตes. Gostaria de confirmar a sua chegada.`);
ย ย ย ย ย ย ย ย ย ย ย ย const linkWpp = `https://wa.me/${numeroInternacional}?text=${textoWpp}`;
ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย btnWpp.href = linkWpp;
ย ย ย ย ย ย ย ย ย ย ย ย btnWpp.style.display = 'flex';
ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย } else if (pedido.status === 'finalizada') {
ย ย ย ย ย ย ย ย ย ย // Corrida finalizada
ย ย ย ย ย ย ย ย ย ย clearInterval(intervaloVerificacao);
ย ย ย ย ย ย ย ย ย ย statusTitulo.innerText = "PEDIDO CONCLUรDO!";
ย ย ย ย ย ย ย ย ย ย statusDesc.innerText = `Valor pago: R$ ${pedido.valor.toFixed(2).replace('.', ',')}`;
ย ย ย ย ย ย ย ย ย ย statusArea.style.borderColor = 'blue'; 
ย ย ย ย ย ย ย ย ย ย statusArea.style.background = 'rgba(0, 0, 255, 0.1)';
ย ย ย ย ย ย ย ย ย ย statusTitulo.style.color = 'blue';
ย ย ย ย ย ย ย ย ย ย btnCancelar.style.display = 'none';
ย ย ย ย ย ย ย ย ย ย localStorage.removeItem('idPedidoAtual');

ย ย ย ย ย ย ย ย } else if (pedido.status === 'cancelada' || pedido.status === 'expirada') {
ย ย ย ย ย ย ย ย ย ย // Pedido cancelado/expirado
ย ย ย ย ย ย ย ย ย ย clearInterval(intervaloVerificacao);
ย ย ย ย ย ย ย ย ย ย statusTitulo.innerText = "PEDIDO CANCELADO!";
ย ย ย ย ย ย ย ย ย ย statusDesc.innerText = `Motivo: ${pedido.motivo_cancelamento || "โ๏ธ Pedido Cancelado!O motoboy teve um imprevisto. ย ยPedimos desculpas!Por favor, ย faรงa um novo pedido. Obrigado!"}`;
ย ย ย ย ย ย ย ย ย ย statusArea.style.borderColor = 'var(--error-color)';
ย ย ย ย ย ย ย ย ย ย statusArea.style.background = 'rgba(255, 0, 0, 0.1)';
ย ย ย ย ย ย ย ย ย ย statusTitulo.style.color = 'var(--error-color)';
ย ย ย ย ย ย ย ย ย ย btnCancelar.style.display = 'none';
ย ย ย ย ย ย ย ย ย ย localStorage.removeItem('idPedidoAtual');
ย ย ย ย ย ย ย ย ย ย showToast("Pedido cancelado. Use o botรฃo 'FECHAR' abaixo para voltar.", "error", 5000);
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } catch (e) { 
ย ย ย ย ย ย ย ย console.error("Erro na verificaรงรฃo de status:", e); 
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย // Funรงรฃo para continuar acompanhando o pedido se o usuรกrio recarregar a pรกgina
ย ย ย ย function checkPersistedOrder() {
ย ย ย ย ย ย const persistedId = localStorage.getItem('idPedidoAtual');
ย ย ย ย ย ย if (persistedId) {
ย ย ย ย ย ย ย ย idPedidoAtual = persistedId;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Mudar para a tela de acompanhamento e iniciar a verificaรงรฃo
ย ย ย ย ย ย ย ย mudarTela('tela-acompanhamento');
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Tenta buscar o status imediatamente para preencher os dados
ย ย ย ย ย ย ย ย verificarStatus(idPedidoAtual); 
ย ย ย ย ย ย ย ย intervaloVerificacao = setInterval(() => verificarStatus(idPedidoAtual), 3000);
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย // Se nรฃo houver pedido, garante que a tela inicial esteja ativa
ย ย ย ย ย ย ย ย mudarTela('tela-pedido');
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย // Chama a funรงรฃo ao carregar a pรกgina
ย ย ย ย window.onload = checkPersistedOrder;


ย ย ย ย // === FUNรรES DE CANCELAMENTO ATUALIZADAS PARA USAR MODAL DE JUSTIFICATIVA ===
ย ย ย ย function cancelarPedido() {
ย ย ย ย ย ย if(!idPedidoAtual) {
ย ย ย ย ย ย ย ย showToast("Nenhum pedido ativo para cancelar.", "error");
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย // 1. Abre o modal de justificativa
ย ย ย ย ย ย document.getElementById('modal-justificativa').style.display = 'flex';
ย ย ย ย ย ย document.getElementById('campo-justificativa').value = ''; // Limpa campo
ย ย ย ย ย ย document.getElementById('campo-justificativa').focus();
ย ย ย ย }

ย ย ย ย async function confirmarCancelamentoCliente() {
ย ย ย ย ย ย const motivo = document.getElementById('campo-justificativa').value.trim();
ย ย ย ย ย ย 
ย ย ย ย ย ย if (motivo.length < 5) {
ย ย ย ย ย ย ย ย showToast("Dรช uma breve justificativa (mรญnimo 5 caracteres).", "error");
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย // Fecha o modal de justificativa e abre o de carregamento/status
ย ย ย ย ย ย document.getElementById('modal-justificativa').style.display = 'none';
ย ย ย ย ย ย document.getElementById('modal-busca').style.display = 'flex';
ย ย ย ย ย ย document.getElementById('status-titulo-modal').innerText = "CANCELANDO PEDIDO...";
ย ย ย ย ย ย document.getElementById('status-desc-modal').innerText = "Enviando justificativa: " + motivo.substring(0, 30) + "...";
ย ย ย ย ย ย document.getElementById('btn-cancelar-pedido-modal').style.display = 'none';

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch(`${MEU_IP}/cancelar-pedido`, {
ย ย ย ย ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย ย ย ย ย headers: {'Content-Type': 'application/json'},
ย ย ย ย ย ย ย ย ย ย body: JSON.stringify({ 
ย ย ย ย ย ย ย ย ย ย ย ย id: idPedidoAtual, 
ย ย ย ย ย ย ย ย ย ย ย ย motivo: `[CLIENTE] ${motivo}` 
ย ย ย ย ย ย ย ย ย ย })
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย const json = await res.json();

ย ย ย ย ย ย ย ย if (json.success) {
ย ย ย ย ย ย ย ย ย ย clearInterval(intervaloVerificacao);
ย ย ย ย ย ย ย ย ย ย verificarStatus(idPedidoAtual); 
ย ย ย ย ย ย ย ย ย ย showToast("Pedido cancelado. O piloto foi notificado.", "success", 5000);
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ยthrow new Error(json.message || "Erro desconhecido ao cancelar.");
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย document.getElementById('modal-busca').style.display = 'none';
ย ย ย ย ย ย ย ย showToast("Falha ao cancelar: " + e.message, "error");
ย ย ย ย ย ย } finally {
ย ย ย ย ย ย ย ย ย// Limpa o campo de justificativa para o prรณximo uso
ย ย ย ย ย ย ย ย ยdocument.getElementById('campo-justificativa').value = '';
ย ย ย ย ย ย }
ย ย ย ย }


ย ย ย ย // Toast Helper
ย ย ย ย function showToast(msg, type, duration = 3000) {
ย ย ย ย ย ย const container = document.getElementById('toast-container');
ย ย ย ย ย ย const div = document.createElement('div');
ย ย ย ย ย ย div.className = `toast ${type}`;
ย ย ย ย ย ย div.innerHTML = `<span class="msg">${msg}</span><button class="close" onclick="this.parentElement.remove()">โ</button>`;
ย ย ย ย ย ย container.appendChild(div);
ย ย ย ย ย ย // Remove toasts antigos para manter apenas 1 ou 2 visรญveis
ย ย ย ย ย ย while(container.children.length > 3) {
ย ย ย ย ย ย ย ย container.firstChild.remove();
ย ย ย ย ย ย }
ย ย ย ย ย ย setTimeout(() => div.remove(), duration);
ย ย ย ย }

ย ย </script>

</body>
</html>