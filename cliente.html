<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Falc√µes App</title>

    <!-- Leaflet CSS para o mapa -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        crossorigin=""
    />

    <style>
        /* --- IDENTIDADE VISUAL FALC√ïES (DARK MODE OFICIAL - PRESERVADO) --- */
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --neon-green: #00e640;
            --text-color: #ffffff;
            --input-bg: #2c2c2c;
            --border-color: #333;
            --error-color: #ff4444;
            --dica-color: #888;
        }

        body {
            font-family: "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--card-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 230, 64, 0.1);
            position: relative;
            border: 1px solid var(--border-color);
            padding-bottom: 80px; /* Espa√ßo para n√£o cortar conteudo em mobile */
        }

        .logo-area {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo-area img {
            max-height: 100px;
            filter: drop-shadow(0 0 5px rgba(0, 230, 64, 0.5));
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .user-info {
            font-weight: 600;
            color: #ccc;
        }
        .estrelas {
            background-color: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        .logout a {
            color: var(--error-color);
            text-decoration: none;
            font-weight: 600;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            color: var(--neon-green);
            letter-spacing: 1px;
        }

        /* --- SELETOR DE SERVI√áO --- */
        .opcoes-servico {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        .card {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: #252525;
            color: #aaa;
        }
        .card:hover {
            border-color: var(--neon-green);
            color: white;
        }
        .card.selecionado {
            border-color: var(--neon-green);
            background-color: rgba(0, 230, 64, 0.1);
            color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 230, 64, 0.2);
        }
        .icon {
            font-size: 28px;
            display: block;
            margin-bottom: 5px;
        }
        .preco {
            font-size: 14px;
            font-weight: 500;
        }

        /* --- NOVOS CAMPOS DE ENDERE√áO (GRID) --- */
        label {
            display: block;
            margin-top: 15px;
            font-weight: 700;
            color: var(--neon-green); /* Label verde para destaque */
            margin-bottom: 8px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .address-container {
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        /* Linha 1: Rua + Bot√£o Mapa */
        .row-rua {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            position: relative;
        }
        .input-rua-wrapper {
            flex: 1;
            position: relative;
        }
        .btn-map-icon {
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            border-radius: 8px;
            width: 44px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-map-icon:hover {
            background: rgba(0,230,64,0.1);
        }

        /* Linha 2: N√∫mero e Bairro */
        .row-details {
            display: flex;
            gap: 8px;
        }
        .input-num-wrapper {
            flex: 1; /* 25% */
            max-width: 80px;
            position: relative;
        }
        .input-bairro-wrapper {
            flex: 3; /* 75% */
        }

        input {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 15px;
            transition: 0.3s;
        }
        input:focus {
            border-color: var(--neon-green);
            outline: none;
        }
        /* Erro espec√≠fico para n√∫mero vazio */
        input.erro {
            border-color: var(--error-color) !important;
            animation: shake 0.4s ease-in-out;
        }
        .erro-msg {
            position: absolute;
            bottom: -16px;
            left: 0;
            font-size: 10px;
            color: var(--error-color);
            font-weight: bold;
            display: none;
        }
        input.erro + .erro-msg {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Campo de detalhes da entrega */
        #detalhes-entrega-container {
            display: none; /* S√≥ aparece se for entrega */
            margin-top: 15px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }


        /* Lista de Sugest√µes */
        .sugestoes-lista {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .sugestao-item {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
        }
        .sugestao-item:last-child { border-bottom: none; }
        .sugestao-item:hover {
            background-color: #2c2c2c;
        }
        .rua-texto {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: var(--neon-green);
        }
        .bairro-texto {
            display: block;
            font-size: 12px;
            color: #aaa;
            margin-top: 2px;
        }

        /* --- RESUMO E BOT√ÉO --- */
        .resumo-final {
            margin-top: 25px;
            padding: 15px;
            background-color: rgba(0, 230, 64, 0.1);
            color: var(--neon-green);
            border: 1px solid var(--neon-green);
            text-align: center;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            display: none;
        }

        .btn {
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            background-color: var(--neon-green);
            color: black;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
        }
        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--neon-green);
        }
        .btn:disabled {
            background-color: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .modal-content {
            background: var(--card-color);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 85%;
            max-width: 350px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 40px rgba(0, 230, 64, 0.15);
        }
        .spinner {
            border: 5px solid #333;
            border-top: 5px solid var(--neon-green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: girar 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes girar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-cancelar {
            background-color: transparent;
            border: 1px solid var(--error-color);
            color: var(--error-color);
            font-size: 14px;
            margin-top: 20px;
            padding: 10px;
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
        }

        #map {
            height: 180px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        /* --- TOAST --- */
        .toast-container {
            position: fixed;
            left: 50%;
            bottom: 24px;
            transform: translateX(-50%);
            z-index: 10050;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            pointer-events: none;
            width: 90%;
        }
        .toast {
            width: 100%;
            max-width: 400px;
            background: #000;
            border-radius: 12px;
            padding: 12px 16px;
            color: #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            display: flex;
            gap: 12px;
            align-items: center;
            opacity: 0;
            transform: translateY(10px);
            animation: toast-in 0.3s forwards;
            font-weight: 600;
            border: 1px solid var(--neon-green);
            pointer-events: auto;
        }
        @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
        .toast.error { border-color: var(--error-color); }
        .toast .msg { flex: 1; font-size: 14px; }
        .toast .close { background: none; border: none; color: #fff; cursor: pointer; font-size: 18px; }

    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>

    <div class="toast-container" id="toast-container"></div>

    <!-- MODAL DE BUSCA/STATUS -->
    <div class="modal-overlay" id="modal-busca">
        <div class="modal-content">
            <div id="area-spinner" class="spinner"></div>

            <div id="status-titulo" style="font-size: 18px; font-weight: bold; color: white; margin-bottom: 10px;">BUSCANDO PILOTO...</div>
            <div id="status-desc" style="font-size: 14px; color: #aaa;">Notificando parceiros pr√≥ximos.</div>

            <div id="info-motoboy" style="display:none; margin-top:20px; padding:15px; border:1px solid var(--neon-green); border-radius:10px; background:rgba(255,255,255,0.05);">
                <div style="font-size: 32px; margin-bottom: 5px;">üèçÔ∏è</div>
                <div style="font-size: 10px; color: #aaa; text-transform:uppercase;">Seu Piloto</div>
                <div id="nome-motoboy" style="font-size: 18px; color: var(--neon-green); font-weight: 800; margin: 5px 0;">--</div>
                <span id="fone-motoboy" style="color: white; font-size: 14px;">--</span>
                <button onclick="window.location.reload()" class="btn" style="margin-top:15px; font-size:14px; padding:10px;">FECHAR / NOVO</button>
            </div>

            <button id="btn-cancelar-pedido" class="btn-cancelar" onclick="cancelarPedido()" style="display:none;">CANCELAR PEDIDO</button>
        </div>
    </div>

    <div class="container">
        <div class="logo-area"><img src="assets/logo.png" alt="Logo" onerror="this.style.display='none'; document.querySelector('.logo-area').innerHTML='<h1 style=\'color:var(--neon-green)\'>FALC√ïES</h1>'" /></div>

        <div class="header-top">
            <div class="user-info"><span id="msg-ola">Piloto</span> <span class="estrelas">‚òÖ 5.0</span></div>
            <div class="logout"><a href="#" onclick="logout()">SAIR</a></div>
        </div>

        <h2>NOVA SOLICITA√á√ÉO</h2>

        <!-- SELE√á√ÉO DE SERVI√áO -->
        <div class="opcoes-servico">
            <div class="card" id="card-moto" onclick="selecionarServico('moto-taxi', 10.0)">
                <span class="icon">üèçÔ∏è</span>
                <div class="card-title">MOTO T√ÅXI</div>
                <div class="preco">R$ 10,00 + Km</div>
            </div>
            <div class="card" id="card-entrega" onclick="selecionarServico('entrega', 8.50)">
                <span class="icon">üì¶</span>
                <div class="card-title">ENTREGA</div>
                <div class="preco">R$ 8,50 + Km</div>
            </div>
        </div>

        <!-- FORMUL√ÅRIO DE ENDERE√áO REFATORADO -->
        <div id="form-endereco">
            
            <!-- ORIGEM -->
            <label>üìç Onde vamos buscar? (Origem)</label>
            <div class="address-container">
                <div class="row-rua">
                    <div class="input-rua-wrapper">
                        <input type="text" id="rua-origem" placeholder="Busque a rua..." oninput="buscarEndereco(this.value, 'lista-origem', 'origem')" autocomplete="off">
                        <div id="lista-origem" class="sugestoes-lista"></div>
                    </div>
                    <button class="btn-map-icon" onclick="ativarMapa('origem')" title="Marcar no mapa">üó∫Ô∏è</button>
                </div>
                <div class="row-details">
                    <div class="input-num-wrapper">
                        <input type="text" id="num-origem" placeholder="N¬∫" oninput="removerErro(this)">
                        <span class="erro-msg">Obrigat√≥rio</span>
                    </div>
                    <div class="input-bairro-wrapper">
                        <input type="text" id="bairro-origem" placeholder="Bairro">
                    </div>
                </div>
            </div>

            <!-- DESTINO -->
            <label>üèÅ Onde vamos levar? (Destino)</label>
            <div class="address-container">
                <div class="row-rua">
                    <div class="input-rua-wrapper">
                        <input type="text" id="rua-destino" placeholder="Busque a rua..." oninput="buscarEndereco(this.value, 'lista-destino', 'destino')" autocomplete="off">
                        <div id="lista-destino" class="sugestoes-lista"></div>
                    </div>
                    <button class="btn-map-icon" onclick="ativarMapa('destino')" title="Marcar no mapa">üó∫Ô∏è</button>
                </div>
                <div class="row-details">
                    <div class="input-num-wrapper">
                        <input type="text" id="num-destino" placeholder="N¬∫" oninput="removerErro(this)">
                        <span class="erro-msg">Obrigat√≥rio</span>
                    </div>
                    <div class="input-bairro-wrapper">
                        <input type="text" id="bairro-destino" placeholder="Bairro">
                    </div>
                </div>
            </div>

            <!-- DETALHES DA ENTREGA (CONDICIONAL) -->
            <div id="detalhes-entrega-container">
                <label>üì¶ O que vamos levar?</label>
                <input type="text" id="detalhes-entrega" placeholder="Ex: Chaves, Marmita, Documento..." oninput="removerErro(this)">
                <span class="erro-msg" style="position:relative; bottom:0;">Descreva o item</span>
            </div>

        </div>

        <div id="map"></div>
        <p style="font-size:12px; color:#666; text-align:center; margin-top:5px;">Toque no bot√£o üó∫Ô∏è para marcar no mapa</p>

        <div class="resumo-final" id="resumo"></div>

        <button onclick="pedir()" id="btn-pedir" class="btn" disabled>SELECIONE O SERVI√áO</button>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
    <script>
        // === CONFIGURA√á√ÉO E DADOS ===
        const MEU_IP = 'https://falcoes-app.onrender.com';
        const LAT_TC = -21.6975;
        const LON_TC = -45.2556;
        
        // Mock de usu√°rio se n√£o existir (para testes)
        if(!localStorage.getItem("usuario")) {
            localStorage.setItem("usuario", JSON.stringify({id: 1, nome: "Visitante", telefone: "00000000"}));
        }
        const usuario = JSON.parse(localStorage.getItem("usuario"));
        document.getElementById("msg-ola").innerText = "OL√Å, " + usuario.nome.split(" ")[0].toUpperCase();

        // Vari√°veis de Estado
        let servicoSelecionado = null;
        let coordsOrigem = null;
        let coordsDestino = null;
        let timeoutBusca = null;
        let mapMode = null; // 'origem' ou 'destino'
        let markerOrigem = null;
        let markerDestino = null;
        let idPedidoAtual = null;
        let intervaloVerificacao = null;

        const precos = {
            'moto-taxi': { base: 10.0, kmExtra: 3.15, franquia: 3 },
            'entrega': { base: 8.50, kmExtra: 2.0, franquia: 3 }
        };

        // === INICIALIZA√á√ÉO DO MAPA ===
        const map = L.map('map').setView([LAT_TC, LON_TC], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        map.on('click', async (e) => {
            if (!mapMode) {
                showToast("Clique no bot√£o üó∫Ô∏è ao lado do endere√ßo primeiro.", "info");
                return;
            }

            const { lat, lng } = e.latlng;
            showToast("Buscando endere√ßo...", "info", 1000);

            // Reverse Geocoding via Nominatim (Gratuito)
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                
                const rua = data.address.road || data.address.pedestrian || "Local Marcado";
                const bairro = data.address.suburb || data.address.neighbourhood || data.address.city_district || "Tr√™s Cora√ß√µes";

                if (mapMode === 'origem') {
                    document.getElementById('rua-origem').value = rua;
                    document.getElementById('bairro-origem').value = bairro;
                    document.getElementById('num-origem').focus();
                    coordsOrigem = { lat, lon: lng };
                    if(markerOrigem) map.removeLayer(markerOrigem);
                    markerOrigem = L.marker([lat, lng]).addTo(map);
                } else {
                    document.getElementById('rua-destino').value = rua;
                    document.getElementById('bairro-destino').value = bairro;
                    document.getElementById('num-destino').focus();
                    coordsDestino = { lat, lon: lng };
                    if(markerDestino) map.removeLayer(markerDestino);
                    markerDestino = L.marker([lat, lng]).addTo(map);
                }

                showToast("Endere√ßo preenchido! Digite o n√∫mero.", "success");
                mapMode = null; // Reset modo
                calcularRota();

            } catch (error) {
                showToast("Erro ao obter endere√ßo do mapa.", "error");
            }
        });

        // === FUN√á√ïES DE UI ===
        function ativarMapa(modo) {
            mapMode = modo;
            showToast(`Toque no mapa para definir a ${modo.toUpperCase()}`, "info");
            // Rola at√© o mapa
            document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
        }

        function selecionarServico(tipo, valorBase) {
            servicoSelecionado = tipo;
            
            // Visual Cards
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selecionado'));
            if(tipo === 'moto-taxi') document.getElementById('card-moto').classList.add('selecionado');
            else document.getElementById('card-entrega').classList.add('selecionado');

            // Campo Detalhes da Entrega
            const detailsDiv = document.getElementById('detalhes-entrega-container');
            if(tipo === 'entrega') {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }

            document.getElementById('btn-pedir').disabled = false;
            document.getElementById('btn-pedir').innerText = tipo === 'entrega' ? "SOLICITAR ENTREGA" : "CHAMAR MOTO T√ÅXI";
            
            calcularRota(); // Recalcula pre√ßo se j√° tiver rota
        }

        function logout() {
            localStorage.clear();
            window.location.reload();
        }

        function removerErro(input) {
            input.classList.remove('erro');
        }

        // Fechar sugest√µes ao clicar fora
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-rua-wrapper')) {
                document.querySelectorAll('.sugestoes-lista').forEach(el => el.style.display = 'none');
            }
        });

        // === L√ìGICA DE ENDERE√áO (NOMINATIM) ===
        function buscarEndereco(query, listId, type) {
            const list = document.getElementById(listId);
            if (query.length < 3) {
                list.style.display = 'none';
                return;
            }

            clearTimeout(timeoutBusca);
            timeoutBusca = setTimeout(async () => {
                try {
                    // Busca restrita ao Brasil e priorizando √°rea pr√≥xima (viewbox)
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ", Tr√™s Cora√ß√µes")}&addressdetails=1&limit=5&countrycodes=br`;
                    
                    const res = await fetch(url);
                    const data = await res.json();

                    list.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(item => {
                            // Filtro simples para manter dentro da cidade (opcional)
                            const rua = item.address.road || item.address.pedestrian || item.display_name.split(',')[0];
                            const bairro = item.address.suburb || item.address.neighbourhood || "Centro";

                            const div = document.createElement('div');
                            div.className = 'sugestao-item';
                            div.innerHTML = `<span class="rua-texto">${rua}</span><span class="bairro-texto">${bairro}</span>`;
                            
                            div.onclick = () => {
                                document.getElementById(`rua-${type}`).value = rua;
                                document.getElementById(`bairro-${type}`).value = bairro;
                                
                                // Salva coords
                                const coords = { lat: parseFloat(item.lat), lon: parseFloat(item.lon) };
                                if(type === 'origem') coordsOrigem = coords;
                                else coordsDestino = coords;

                                list.style.display = 'none';
                                
                                // Pula para o n√∫mero
                                const numInput = document.getElementById(`num-${type}`);
                                numInput.focus();
                                numInput.classList.add('erro'); // Visual hint que precisa preencher
                                setTimeout(() => numInput.classList.remove('erro'), 500);

                                calcularRota();
                            };
                            list.appendChild(div);
                        });
                        list.style.display = 'block';
                    } else {
                        list.style.display = 'none';
                    }
                } catch (e) {
                    console.error("Erro busca", e);
                }
            }, 500); // Debounce
        }

        // === C√ÅLCULO DE ROTA (OSRM) ===
        async function calcularRota() {
            if (!coordsOrigem || !coordsDestino || !servicoSelecionado) return;

            const resumo = document.getElementById('resumo');
            resumo.style.display = 'block';
            resumo.innerText = "Calculando...";

            try {
                // OSRM Public API
                const url = `https://router.project-osrm.org/route/v1/driving/${coordsOrigem.lon},${coordsOrigem.lat};${coordsDestino.lon},${coordsDestino.lat}?overview=false`;
                const res = await fetch(url);
                const json = await res.json();

                let distanciaKm = 0;
                if (json.routes && json.routes.length > 0) {
                    distanciaKm = json.routes[0].distance / 1000;
                } else {
                    // Fallback dist√¢ncia linha reta
                    distanciaKm = calcDistanciaReta(coordsOrigem, coordsDestino) * 1.3;
                }

                // Pricing
                const regra = precos[servicoSelecionado];
                const kmCobrado = Math.max(0, distanciaKm - regra.franquia);
                const total = regra.base + (kmCobrado * regra.kmExtra);

                resumo.innerHTML = `
                    <div style="font-size:14px; font-weight:normal; color:#ccc;">Dist√¢ncia: ${distanciaKm.toFixed(1)} km</div>
                    <div>TOTAL: R$ ${total.toFixed(2).replace('.', ',')}</div>
                `;
                
                // Salva valor global para envio
                window.valorCalculado = total;

            } catch (e) {
                console.error("Erro rota", e);
                resumo.innerText = "Erro ao calcular rota.";
            }
        }

        function calcDistanciaReta(c1, c2) {
            const R = 6371; 
            const dLat = (c2.lat - c1.lat) * Math.PI / 180;
            const dLon = (c2.lon - c1.lon) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(c1.lat * Math.PI / 180) * Math.cos(c2.lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // === ENVIO DE PEDIDO ===
        async function pedir() {
            if (!servicoSelecionado) {
                showToast("Selecione Moto T√°xi ou Entrega", "error");
                return;
            }

            // 1. Coletar dados
            const ruaOrigem = document.getElementById('rua-origem').value;
            const numOrigem = document.getElementById('num-origem').value;
            const bairroOrigem = document.getElementById('bairro-origem').value;
            
            const ruaDestino = document.getElementById('rua-destino').value;
            const numDestino = document.getElementById('num-destino').value;
            const bairroDestino = document.getElementById('bairro-destino').value;

            const detalhes = document.getElementById('detalhes-entrega').value;

            // 2. Valida√ß√£o Rigorosa
            let erro = false;

            if (!ruaOrigem) { showToast("Preencha a Rua de Origem", "error"); return; }
            if (!numOrigem.trim()) { 
                document.getElementById('num-origem').classList.add('erro'); 
                erro = true; 
            }
            
            if (!ruaDestino) { showToast("Preencha a Rua de Destino", "error"); return; }
            if (!numDestino.trim()) { 
                document.getElementById('num-destino').classList.add('erro'); 
                erro = true; 
            }

            if (servicoSelecionado === 'entrega' && !detalhes.trim()) {
                document.getElementById('detalhes-entrega').classList.add('erro');
                showToast("Descreva o que vamos entregar!", "error");
                return;
            }

            if (erro) {
                showToast("‚ö†Ô∏è Preencha o N√öMERO dos endere√ßos!", "error");
                return;
            }

            // 3. Montar Strings para o Backend (Mantendo compatibilidade)
            // O backend espera "origem" e "destino" como strings completas
            const strOrigem = `${ruaOrigem}, N¬∫ ${numOrigem}, ${bairroOrigem}`;
            const strDestino = `${ruaDestino}, N¬∫ ${numDestino}, ${bairroDestino}`;
            
            // Adicionar detalhes da entrega ao destino se for entrega
            const strDestinoFinal = servicoSelecionado === 'entrega' 
                ? `${strDestino} (ITEM: ${detalhes})` 
                : strDestino;

            // 4. Enviar
            document.getElementById('modal-busca').style.display = 'flex';
            document.getElementById('btn-cancelar-pedido').style.display = 'block';
            document.getElementById('area-spinner').style.display = 'block';

            try {
                const body = {
                    cliente_id: usuario.id,
                    origem: strOrigem,
                    destino: strDestinoFinal,
                    valor: window.valorCalculado || 10.0,
                    tipo_servico: servicoSelecionado
                };

                const res = await fetch(`${MEU_IP}/pedir-corrida`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const json = await res.json();
                
                if (json.success) {
                    idPedidoAtual = json.id;
                    showToast("Solicita√ß√£o enviada!", "success");
                    intervaloVerificacao = setInterval(() => verificarStatus(idPedidoAtual), 3000);
                } else {
                    throw new Error(json.message);
                }

            } catch (e) {
                document.getElementById('modal-busca').style.display = 'none';
                showToast("Erro ao enviar: " + e.message, "error");
            }
        }

        async function verificarStatus(id) {
            try {
                const res = await fetch(`${MEU_IP}/status-pedido/${id}`);
                const data = await res.json();
                
                if (data.success && data.pedido.status === 'aceita') {
                    clearInterval(intervaloVerificacao);
                    
                    document.getElementById('area-spinner').style.display = 'none';
                    document.getElementById('btn-cancelar-pedido').style.display = 'none';
                    
                    document.getElementById('status-titulo').innerText = "FALC√ÉO A CAMINHO!";
                    document.getElementById('status-titulo').style.color = "var(--neon-green)";
                    document.getElementById('status-desc').innerText = "Seu piloto est√° indo at√© voc√™.";
                    
                    document.getElementById('info-motoboy').style.display = 'block';
                    document.getElementById('nome-motoboy').innerText = data.pedido.nome_motoboy || "Piloto Falc√µes";
                    document.getElementById('fone-motoboy').innerText = data.pedido.telefone_motoboy || "";
                    
                    // Vibrar celular se suportado
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                }
            } catch (e) { console.error(e); }
        }

        async function cancelarPedido() {
            if(!idPedidoAtual) return;
            if(!confirm("Deseja realmente cancelar?")) return;

            try {
                await fetch(`${MEU_IP}/cancelar-pedido`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: idPedidoAtual, motivo: "Cancelado pelo App" })
                });
                window.location.reload();
            } catch (e) {
                showToast("Erro ao cancelar", "error");
            }
        }

        // Toast Helper
        function showToast(msg, type, duration = 3000) {
            const container = document.getElementById('toast-container');
            container.innerHTML = ''; // Limpa anteriores
            const div = document.createElement('div');
            div.className = `toast ${type}`;
            div.innerHTML = `<span class="msg">${msg}</span><button class="close" onclick="this.parentElement.remove()">‚úï</button>`;
            container.appendChild(div);
            setTimeout(() => div.remove(), duration);
        }

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
