<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Falc√µes App</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin="" />

    <style>
        /* ... (todo o CSS permanece igual) ... */
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --neon-green: #00e640;
            --text-color: #ffffff;
            --input-bg: #2c2c2c;
            --border-color: #333;
            --error-color: #ff4444;
            --dica-color: #888;
            --pix-color: #008080;
            --cartao-color: #4169E1;
            --dinheiro-color: #FFD700;
        }

        body {
            font-family: "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--card-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 230, 64, 0.1);
            position: relative;
            border: 1px solid var(--border-color);
            padding-bottom: 80px;
        }

        /* ... (restante do CSS permanece igual) ... */
    </style>

    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker
                .register("/service-worker.js")
                .then(() => console.log("SW registrado!"))
                .catch(err => console.log("Erro SW:", err));
        }
    </script>

    <link rel="stylesheet" href="/style.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00e640">
</head>

<body>

    <div class="toast-container" id="toast-container"></div>

    <!-- Modal de Busca -->
    <div class="modal-overlay" id="modal-busca">
        <div class="modal-content">
            <div id="area-spinner" class="spinner"></div>

            <div id="status-titulo-modal"
                style="font-size: 18px; font-weight: bold; color: white; margin-bottom: 10px;">BUSCANDO PILOTO...</div>
            <div id="status-desc-modal" style="font-size: 14px; color: #aaa;">Notificando parceiros pr√≥ximos.</div>

            <button class="btn-cancelar" onclick="abrirJustificativaCliente()">CANCELAR PEDIDO</button>

        </div>
    </div>

    <!-- Modal de Encerramento -->
    <div class="modal-overlay" id="modal-encerramento" style="display:none;">
        <div class="modal-content">
            <div style="font-size: 22px; color: var(--neon-green); margin-bottom: 12px;">‚úÖ Corrida Finalizada</div>
            <div id="encerramento-titulo" style="font-size:16px; color:#fff; margin-bottom:8px;">
                A corrida foi finalizada. Confirme e, se desejar, deixe uma observa√ß√£o (opcional)
            </div>
            <textarea id="campo-encerramento" placeholder="Ex: Tudo ok, atraso, avaria..."></textarea>
            <button onclick="confirmarEncerramentoCliente()" class="btn" style="margin-top:12px;">CONFIRMAR
                ENCERRAMENTO</button>
            <button onclick="document.getElementById('modal-encerramento').style.display='none'" class="btn-cancelar"
                style="margin-top:8px;">Fechar</button>
        </div>
    </div>

    <!-- Modal de Pagamento -->
    <div class="modal-overlay" id="modal-pagamento" style="display:none;">
        <div class="modal-content">
            <div style="font-size: 24px; color: var(--neon-green); margin-bottom: 10px; font-weight: bold;">üí∞ PAGAMENTO</div>
            <div id="valor-pagamento-modal" style="font-size: 28px; font-weight: 800; color: white; margin-bottom: 5px;">
                R$ 0,00</div>
            <div id="desc-pagamento-modal" style="font-size: 14px; color: #aaa; margin-bottom: 25px;">Corrida #--</div>
            
            <button class="btn-pagamento btn-pix" onclick="iniciarPagamentoPIX()">
                <span style="font-size: 22px;">üßæ</span> PAGAR COM PIX
            </button>
            
            <button class="btn-pagamento btn-cartao" onclick="iniciarPagamentoCartao()">
                <span style="font-size: 22px;">üí≥</span> PAGAR COM CART√ÉO
            </button>
            
            <button class="btn-pagamento btn-dinheiro" onclick="iniciarPagamentoDinheiro()">
                <span style="font-size: 22px;">üíµ</span> PAGAR EM DINHEIRO
            </button>
            
            <a id="btn-whatsapp-pagamento" href="#" target="_blank" class="btn-pagamento btn-whatsapp-pagamento" style="display:none;">
                <span style="font-size: 22px;">üìû</span> FALAR COM MOTORISTA
            </a>
            
            <button onclick="fecharModalPagamento()" class="btn-cancelar" style="margin-top: 20px;">
                VOLTAR
            </button>
        </div>
    </div>

    <!-- Modal de PIX -->
    <div class="modal-overlay" id="modal-pix" style="display:none;">
        <div class="modal-content">
            <div style="font-size: 22px; color: var(--neon-green); margin-bottom: 15px; font-weight: bold;">
                üßæ PAGAMENTO PIX
            </div>
            
            <div class="qr-code-container">
                <img id="qr-code-image" src="" alt="QR Code PIX">
                <div style="margin-top: 10px; font-size: 16px; color: white; font-weight: 600;" id="valor-pix">
                    R$ 0,00
                </div>
                <div style="margin-top: 5px; font-size: 12px; color: #aaa;" id="desc-pix">
                    Corrida #--
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <div style="font-size: 12px; color: #aaa; margin-bottom: 8px;">
                    Ou copie o c√≥digo PIX:
                </div>
                <div class="codigo-pix" id="codigo-pix-texto">
                    Carregando c√≥digo PIX...
                </div>
                <button onclick="copiarCodigoPIX()" class="btn" style="margin-top: 10px; background: #333; color: white;">
                    üìã COPIAR C√ìDIGO
                </button>
            </div>
            
            <div style="margin-top: 20px; padding: 12px; background: rgba(0, 230, 64, 0.1); border-radius: 10px; font-size: 12px; color: #aaa;">
                <span style="color: var(--neon-green); font-weight: bold;">‚ö†Ô∏è INSTRU√á√ïES:</span><br>
                1. Abra seu app de pagamento<br>
                2. Escolha pagar via PIX<br>
                3. Escaneie o QR Code ou cole o c√≥digo<br>
                4. Ap√≥s pagar, clique em "J√Å PAGUEI"
            </div>
            
            <button onclick="confirmarPagamentoPIX()" class="btn" style="margin-top: 15px; background: var(--neon-green);">
                ‚úÖ J√Å PAGUEI
            </button>
            
            <button onclick="fecharModalPIX()" class="btn-cancelar" style="margin-top: 10px;">
                CANCELAR
            </button>
        </div>
    </div>

    <div class="container">
        <div class="logo-area"><img src="assets/logo.png" alt="Logo"
                onerror="this.style.display='none'; document.querySelector('.logo-area').innerHTML='<h1 style=\'color:var(--neon-green)\'>FALC√ïES</h1>'" />
        </div>

        <div class="header-top">
            <div class="user-info"><span id="msg-ola">Piloto</span> <span class="estrelas">‚òÖ 5.0</span></div>
            <div class="logout"><a href="#" onclick="logout()">SAIR</a></div>
        </div>

        <div id="tela-pedido" class="tela ativa">

            <h2>NOVA SOLICITA√á√ÉO</h2>

            <div class="opcoes-servico">
                <div class="card" id="card-moto" onclick="selecionarServico('moto-taxi', 10.0)">
                    <span class="icon">üèçÔ∏è</span>
                    <div class="card-title">MOTO T√ÅXI</div>
                    <div class="preco">R$ 10,00 + Km</div>
                </div>
                <div class="card" id="card-entrega" onclick="selecionarServico('entrega', 8.50)">
                    <span class="icon">üì¶</span>
                    <div class="card-title">ENTREGA</div>
                    <div class="preco">R$ 8,50 + Km</div>
                </div>
            </div>

            <div id="form-endereco">

                <label>üìç Onde vamos buscar? (Origem)</label>
                <div class="address-container">
                    <div class="row-rua">
                        <div class="input-rua-wrapper">
                            <input type="text" id="rua-origem" placeholder="Busque a rua..."
                                oninput="buscarEndereco(this.value, 'lista-origem', 'origem')" autocomplete="off">
                            <div id="lista-origem" class="sugestoes-lista"></div>
                        </div>
                        <button class="btn-map-icon" onclick="ativarMapa('origem')" title="Marcar no mapa">üó∫Ô∏è</button>
                    </div>
                    <div class="row-details">
                        <div class="input-num-wrapper">
                            <input type="text" id="num-origem" placeholder="N¬∫" oninput="removerErro(this)">
                            <span class="erro-msg">Obrigat√≥rio</span>
                        </div>
                        <div class="input-bairro-wrapper">
                            <input type="text" id="bairro-origem" placeholder="Bairro">
                        </div>
                    </div>
                </div>

                <label>üèÅ Onde vamos levar? (Destino)</label>
                <div class="address-container">
                    <div class="row-rua">
                        <div class="input-rua-wrapper">
                            <input type="text" id="rua-destino" placeholder="Busque a rua..."
                                oninput="buscarEndereco(this.value, 'lista-destino', 'destino')" autocomplete="off">
                            <div id="lista-destino" class="sugestoes-lista"></div>
                        </div>
                        <button class="btn-map-icon" onclick="ativarMapa('destino')" title="Marcar no mapa">üó∫Ô∏è</button>
                    </div>
                    <div class="row-details">
                        <div class="input-num-wrapper">
                            <input type="text" id="num-destino" placeholder="N¬∫" oninput="removerErro(this)">
                            <span class="erro-msg">Obrigat√≥rio</span>
                        </div>
                        <div class="input-bairro-wrapper">
                            <input type="text" id="bairro-destino" placeholder="Bairro">
                        </div>
                    </div>
                </div>

                <div id="detalhes-entrega-container">
                    <label>üì¶ O que vamos levar?</label>
                    <input type="text" id="detalhes-entrega" placeholder="Ex: Chaves, Marmita, Documento..."
                        oninput="removerErro(this)">
                    <span class="erro-msg" style="position:relative; bottom:0;">Descreva o item</span>
                </div>

            </div>

            <div id="map"></div>
            <p style="font-size:12px; color:#666; text-align:center; margin-top:5px;">Toque no bot√£o üó∫Ô∏è para marcar no
                mapa</p>

            <div class="resumo-final" id="resumo"></div>

            <button onclick="pedir()" id="btn-pedir" class="btn" disabled>SELECIONE O SERVI√áO</button>
        </div>

        <div id="tela-acompanhamento" class="tela">
            <h2>ACOMPANHANDO PEDIDO <span id="acompanhamento-id">#--</span></h2>

            <div id="acompanhamento-status-area" class="motoboy-box"
                style="border-color: #ffd700; background: rgba(255, 215, 0, 0.1);">
                <div style="font-size: 36px; margin-bottom: 5px;">‚è≥</div>
                <div class="nome" id="acompanhamento-status-titulo" style="color: #ffd700;">BUSCANDO PILOTO...</div>
                <div class="placa" id="acompanhamento-status-desc" style="font-size: 16px;">Notificando parceiros
                    pr√≥ximos.</div>
            </div>

            <div id="motoboy-info-box" style="display:none; margin-top: 20px;">
                <div class="motoboy-box">
                    <div style="font-size: 32px; margin-bottom: 5px;">üèçÔ∏è</div>
                    <div style="font-size: 12px; color: #aaa; text-transform:uppercase;">Seu Piloto</div>
                    <div class="nome" id="motoboy-nome">--</div>
                    <div class="placa" id="motoboy-placa">--</div>
                </div>

                <a id="btn-whatsapp-motoboy" href="#" target="_blank" class="btn-whatsapp" style="display: none;">
                    <span style="font-size: 20px;">üìû</span>
                    CHAMAR NO WHATSAPP
                </a>
            </div>

            <h3>Detalhes da Viagem</h3>
            <div id="viagem-origem" class="info-card">
                <div class="label">üìç Origem</div>
                <div class="value" id="detalhe-origem">Aguardando...</div>
            </div>
            <div id="viagem-destino" class="info-card">
                <div class="label">üèÅ Destino</div>
                <div class="value" id="detalhe-destino">Aguardando...</div>
            </div>
            <div id="viagem-valor" class="info-card" style="text-align:center; border: 1px solid var(--neon-green);">
                <div class="label">Total Estimado</div>
                <div class="value" id="detalhe-valor" style="color: var(--neon-green); font-size: 20px;">R$ --</div>
            </div>

            <!-- √Årea de Pagamento Din√¢mica -->
            <div id="area-pagamento-cliente" class="bloco-pagamento"></div>

            <div id="area-justificativa-integrada" style="display:none; margin-top: 15px; margin-bottom: 10px;">
                <label
                    style="color:var(--error-color); font-size:14px; margin-bottom: 5px; text-transform:none; letter-spacing:normal;">
                    Diga por que deseja cancelar (m√≠nimo 5 caracteres)
                </label>
                <textarea id="campo-justificativa-integrada"
                    placeholder="Ex: N√£o preciso mais, endere√ßo errado, demora..."
                    style="width:100%; height:80px; padding:10px; border-radius:8px; background:var(--input-bg); border:1px solid var(--border-color); color:#fff; resize:none; font-family:inherit;"></textarea>

                <div id="erro-just-integrada"
                    style="color:var(--error-color); font-size:12px; margin-top:5px; display:none">
                    Escreva uma justificativa v√°lida.
                </div>

                <button id="btn-confirmar-cancelamento" class="btn"
                    style="margin-top:10px; background:var(--error-color); color:#fff; font-weight:800;" disabled>
                    CONFIRMAR CANCELAMENTO
                </button>
            </div>

            <button onclick="cancelarPedido()" id="btn-cancelar-acomp" class="btn-cancelar">CANCELAR PEDIDO</button>
            <button onclick="reiniciarApp()" class="btn"
                style="background-color: #333; color: #ccc; margin-top: 10px;">FECHAR (apenas se finalizado)</button>
        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
    <script>
        // === CONFIGURA√á√ÉO E DADOS ===
        const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoidGhpYWdvZmFsY2FvIiwiYSI6ImNtaW5sYnRtdDB1ZGIzZnB1OXhid2p4ZXQifQ.uAw7CNaemwsun4RGsyOOIQ';
        const MEU_IP = 'https://falcoes-app.onrender.com';
        const LAT_TC = -21.6975;
        const LON_TC = -45.25;

        // Mock de usu√°rio se n√£o existir
        const usuario = JSON.parse(localStorage.getItem("usuario")) || { id: 1, nome: "Cliente" };
        document.getElementById("msg-ola").innerText = "OL√Å, " + usuario.nome.split(" ")[0].toUpperCase();

        // Vari√°veis de Estado
        let servicoSelecionado = null;
        let coordsOrigem = null;
        let coordsDestino = null;
        let timeoutBusca = null;
        let mapMode = null;
        let markerOrigem = null;
        let markerDestino = null;
        let idPedidoAtual = null;
        let intervaloVerificacao = null;
        let pagamentoAtual = { id: null, valor: 0 };

        const precos = {
            'moto-taxi': { base: 10.0, kmExtra: 3.15, franquia: 3 },
            'entrega': { base: 8.50, kmExtra: 2.0, franquia: 3 }
        };

        // === FUN√á√ïES B√ÅSICAS ===
        function mudarTela(novaTelaId) {
            document.querySelectorAll('.tela').forEach(tela => tela.classList.remove('ativa'));
            document.getElementById(novaTelaId).classList.add('ativa');
        }

        function reiniciarApp() {
            localStorage.removeItem('idPedidoAtual');
            if (intervaloVerificacao) clearInterval(intervaloVerificacao);
            window.location.reload();
        }

        function selecionarServico(tipo, valorBase) {
            servicoSelecionado = tipo;
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selecionado'));
            if (tipo === 'moto-taxi') document.getElementById('card-moto').classList.add('selecionado');
            else document.getElementById('card-entrega').classList.add('selecionado');

            document.getElementById('detalhes-entrega-container').style.display = tipo === 'entrega' ? 'block' : 'none';
            document.getElementById('btn-pedir').disabled = false;
            document.getElementById('btn-pedir').innerText = tipo === 'entrega' ? "SOLICITAR ENTREGA" : "CHAMAR MOTO T√ÅXI";
            calcularRota();
        }

        function logout() {
            localStorage.clear();
            window.location.reload();
        }

        function removerErro(input) {
            input.classList.remove('erro');
        }

        // === MAPA ===
        const map = L.map('map').setView([LAT_TC, LON_TC], 14);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Mapa &copy; <a href="https://www.mapbox.com/">Mapbox</a> | Dados &copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
            maxZoom: 19,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: MAPBOX_ACCESS_TOKEN
        }).addTo(map);

        function ativarMapa(modo) {
            mapMode = modo;
            showToast(`Toque no mapa para definir a ${modo.toUpperCase()}`, "info");
            document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
        }

        // === ENDERE√áO E ROTA ===
        function buscarEndereco(query, listId, type) {
            const list = document.getElementById(listId);
            if (query.length < 3) {
                list.style.display = 'none';
                return;
            }

            clearTimeout(timeoutBusca);
            timeoutBusca = setTimeout(async () => {
                try {
                    const bounds = '-45.30,-21.75,-45.20,-21.65';
                    const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?country=BR&bbox=${bounds}&limit=5&access_token=${MAPBOX_ACCESS_TOKEN}`;
                    const res = await fetch(url);
                    const data = await res.json();

                    list.innerHTML = '';
                    if (data.features && data.features.length > 0) {
                        data.features.forEach(item => {
                            const rua = item.place_name.split(',')[0];
                            const context = item.context || [];
                            const neighborhood = context.find(c => c.id.startsWith('neighborhood'));
                            const bairro = (neighborhood && neighborhood.text) || "Tr√™s Cora√ß√µes";

                            const div = document.createElement('div');
                            div.className = 'sugestao-item';
                            div.innerHTML = `<span class="rua-texto">${rua}</span><span class="bairro-texto">${bairro}</span>`;
                            div.onclick = () => {
                                document.getElementById(`rua-${type}`).value = rua;
                                document.getElementById(`bairro-${type}`).value = bairro;
                                const coords = { lat: item.center[1], lon: item.center[0] };
                                if (type === 'origem') coordsOrigem = coords;
                                else coordsDestino = coords;
                                list.style.display = 'none';
                                calcularRota();
                            };
                            list.appendChild(div);
                        });
                        list.style.display = 'block';
                    } else {
                        list.style.display = 'none';
                    }
                } catch (e) {
                    console.error("Erro busca Mapbox", e);
                }
            }, 500);
        }

        async function calcularRota() {
            if (!coordsOrigem || !coordsDestino || !servicoSelecionado) return;
            const resumo = document.getElementById('resumo');
            resumo.style.display = 'block';
            resumo.innerText = "Calculando rota...";

            try {
                const coordenadas = `${coordsOrigem.lon},${coordsOrigem.lat};${coordsDestino.lon},${coordsDestino.lat}`;
                const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordenadas}?geometries=geojson&steps=false&access_token=${MAPBOX_ACCESS_TOKEN}`;
                const res = await fetch(url);
                const json = await res.json();

                let distanciaKm = 0;
                let tempoSegundos = 0;

                if (json.routes && json.routes.length > 0) {
                    distanciaKm = json.routes[0].distance / 1000;
                    tempoSegundos = json.routes[0].duration;
                } else {
                    distanciaKm = calcDistanciaReta(coordsOrigem, coordsDestino) * 1.3;
                    tempoSegundos = (distanciaKm / 0.3) * 60;
                }

                const regra = precos[servicoSelecionado];
                const kmCobrado = Math.max(0, distanciaKm - regra.franquia);
                const total = regra.base + (kmCobrado * regra.kmExtra);
                const tempoMinutos = Math.ceil(tempoSegundos / 60);

                resumo.innerHTML = `
                    <div style="font-size:14px; font-weight:normal; color:#ccc;">Dist√¢ncia: ${distanciaKm.toFixed(1)} km &nbsp; | &nbsp; Tempo: ${tempoMinutos} min</div>
                    <div>TOTAL: R$ ${total.toFixed(2).replace('.', ',')}</div>
                `;
                window.valorCalculado = total;
            } catch (e) {
                console.error("Erro rota Mapbox", e);
                resumo.innerText = "Erro ao calcular rota.";
            }
        }

        function calcDistanciaReta(c1, c2) {
            const R = 6371;
            const dLat = (c2.lat - c1.lat) * Math.PI / 180;
            const dLon = (c2.lon - c1.lon) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(c1.lat * Math.PI / 180) * Math.cos(c2.lat * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // === PEDIDO ===
        async function pedir() {
            if (!servicoSelecionado) { showToast("Selecione Moto T√°xi ou Entrega", "error"); return; }
            
            const ruaOrigem = document.getElementById('rua-origem').value;
            const numOrigem = document.getElementById('num-origem').value;
            const bairroOrigem = document.getElementById('bairro-origem').value;
            const ruaDestino = document.getElementById('rua-destino').value;
            const numDestino = document.getElementById('num-destino').value;
            const bairroDestino = document.getElementById('bairro-destino').value;
            const detalhes = document.getElementById('detalhes-entrega').value;

            if (!ruaOrigem) { showToast("Preencha a Rua de Origem", "error"); return; }
            if (!numOrigem.trim()) { document.getElementById('num-origem').classList.add('erro'); showToast("Preencha o N√∫mero de Origem", "error"); return; }
            if (!ruaDestino) { showToast("Preencha a Rua de Destino", "error"); return; }
            if (!numDestino.trim()) { document.getElementById('num-destino').classList.add('erro'); showToast("Preencha o N√∫mero de Destino", "error"); return; }
            if (servicoSelecionado === 'entrega' && !detalhes.trim()) { document.getElementById('detalhes-entrega').classList.add('erro'); showToast("Descreva o que vamos entregar!", "error"); return; }

            const strOrigem = `${ruaOrigem}, N¬∫ ${numOrigem}, ${bairroOrigem}`;
            const strDestino = `${ruaDestino}, N¬∫ ${numDestino}, ${bairroDestino}`;
            const strDestinoFinal = servicoSelecionado === 'entrega' ? `${strDestino} (ITEM: ${detalhes})` : strDestino;

            document.getElementById('modal-busca').style.display = 'flex';
            document.getElementById('status-titulo-modal').innerText = "BUSCANDO PILOTO...";
            document.getElementById('status-desc-modal').innerText = "Enviando confirma√ß√£o...";

            try {
                const body = {
                    cliente_id: usuario.id,
                    origem: strOrigem,
                    destino: strDestinoFinal,
                    valor: window.valorCalculado || 10.0,
                    tipo_servico: servicoSelecionado
                };

                const res = await fetch(`${MEU_IP}/pedir-corrida`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const json = await res.json();

                if (json.success) {
                    idPedidoAtual = json.id;
                    localStorage.setItem('idPedidoAtual', idPedidoAtual);
                    document.getElementById('acompanhamento-id').innerText = `#${idPedidoAtual}`;
                    document.getElementById('detalhe-origem').innerText = strOrigem;
                    document.getElementById('detalhe-destino').innerText = strDestino;
                    document.getElementById('detalhe-valor').innerText = `R$ ${window.valorCalculado.toFixed(2).replace('.', ',')}`;
                    mudarTela('tela-acompanhamento');
                    document.getElementById('modal-busca').style.display = 'none';
                    intervaloVerificacao = setInterval(() => verificarStatus(idPedidoAtual), 3000);
                    showToast("Solicita√ß√£o enviada. Buscando piloto...", "info");
                } else {
                    throw new Error(json.message);
                }
            } catch (e) {
                document.getElementById('modal-busca').style.display = 'none';
                showToast("Erro ao enviar pedido: " + e.message, "error");
            }
        }

        // === VERIFICA√á√ÉO DE STATUS ===
        async function verificarStatus(id) {
            try {
                const res = await fetch(`${MEU_IP}/status-pedido/${id}`);
                const data = await res.json();
                const pedido = data.pedido;
                console.log('[DEBUG] verificarStatus -> pedido:', pedido);

                if (!data.success || !pedido) return;

                renderizarOpcoesPagamentoCliente(pedido);

                const statusTitulo = document.getElementById('acompanhamento-status-titulo');
                const statusDesc = document.getElementById('acompanhamento-status-desc');
                const statusArea = document.getElementById('acompanhamento-status-area');
                const motoboyBox = document.getElementById('motoboy-info-box');
                const btnWpp = document.getElementById('btn-whatsapp-motoboy');
                const btnCancelar = document.getElementById('btn-cancelar-acomp');

                statusArea.style.borderColor = '#ffd700';
                statusArea.style.background = 'rgba(255, 215, 0, 0.1)';
                statusTitulo.style.color = '#ffd700';
                motoboyBox.style.display = 'none';
                btnWpp.style.display = 'none';

                if (pedido.status === 'aceita') {
                    statusArea.style.borderColor = 'var(--neon-green)';
                    statusArea.style.background = 'rgba(0, 230, 64, 0.1)';
                    statusTitulo.style.color = 'var(--neon-green)';
                    statusTitulo.innerText = "FALC√ÉO A CAMINHO!";
                    statusDesc.innerText = "Seu piloto est√° indo at√© voc√™.";

                    document.getElementById('motoboy-nome').innerText = pedido.nome_motoboy || "Piloto Falc√µes";
                    document.getElementById('motoboy-placa').innerText = pedido.placa_motoboy || "Moto Indispon√≠vel";
                    motoboyBox.style.display = 'block';

                    if (pedido.telefone_motoboy) {
                        const foneLimpo = pedido.telefone_motoboy.replace(/\D/g, '');
                        const numeroInternacional = foneLimpo.length === 11 ? `55${foneLimpo}` : foneLimpo;
                        const textoWpp = encodeURIComponent(`Ol√°, sou o cliente do pedido #${id} no app Falc√µes.`);
                        const linkWpp = `https://wa.me/${numeroInternacional}?text=${textoWpp}`;
                        btnWpp.href = linkWpp;
                        btnWpp.style.display = 'flex';
                    }

                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                } else if (pedido.status === 'concluida' || pedido.status === 'finalizada') {
                    statusArea.style.borderColor = 'blue';
                    statusArea.style.background = 'rgba(0, 0, 255, 0.05)';
                    statusTitulo.style.color = 'blue';
                    statusTitulo.innerText = "CORRIDA FINALIZADA (A CONFIRMAR)";
                    statusDesc.innerText = `Valor: R$ ${(pedido.valor || window.valorCalculado || 0).toFixed(2).replace('.', ',')}`;
                    btnCancelar.style.display = 'none';

                    const modalEnc = document.getElementById('modal-encerramento');
                    if (modalEnc && window.getComputedStyle(modalEnc).display === 'none') {
                        modalEnc.style.display = 'flex';
                        setTimeout(() => document.getElementById('campo-encerramento').focus(), 220);
                    }
                } else if (pedido.status === 'cancelada' || pedido.status === 'expirada') {
                    clearInterval(intervaloVerificacao);
                    statusTitulo.innerText = "PEDIDO CANCELADO!";
                    statusDesc.innerText = `Motivo: ${pedido.motivo_cancelamento || "Pedido cancelado pelo sistema"}`;
                    statusArea.style.borderColor = 'var(--error-color)';
                    statusArea.style.background = 'rgba(255, 0, 0, 0.1)';
                    statusTitulo.style.color = 'var(--error-color)';
                    btnCancelar.style.display = 'none';
                    localStorage.removeItem('idPedidoAtual');
                    showToast("Pedido cancelado.", "error", 5000);
                }
            } catch (e) {
                console.error("Erro na verifica√ß√£o de status:", e);
            }
        }

        // === PAGAMENTO ===
        function renderizarOpcoesPagamentoCliente(pedido) {
            const area = document.getElementById('area-pagamento-cliente');
            if (!area) return;

            console.log('[DEBUG] renderizarOpcoesPagamentoCliente -> pedido:', pedido);
            area.innerHTML = '';

            if (!pedido || pedido.status !== 'AGUARDANDO_PAGAMENTO') return;

            const pedidoId = pedido.id || pedido.corrida_id || pedido.id_corrida || pedido.pedido_id;
            const valorBruto = pedido.valor_total || pedido.valor || pedido.preco || pedido.total || pedido.total_estimado;
            const valor = Number(valorBruto || 0);

            console.log('[DEBUG] pagamento -> pedidoId:', pedidoId, 'valor:', valor);

            if (!pedidoId || !valor) {
                console.warn('[WARN] N√£o foi poss√≠vel determinar ID ou valor do pedido');
                return;
            }

            pagamentoAtual = { id: pedidoId, valor: valor };

            area.innerHTML = `
                <div style="margin-top:16px; text-align: center;">
                    <div style="font-size: 20px; color: var(--neon-green); font-weight: bold; margin-bottom: 10px;">
                        üí∞ PAGAMENTO PENDENTE
                    </div>
                    <div style="font-size: 32px; font-weight: 800; color: white; margin-bottom: 5px;">
                        R$ ${valor.toFixed(2).replace('.', ',')}
                    </div>
                    <div style="font-size: 14px; color: #aaa; margin-bottom: 20px;">
                        Corrida #${pedidoId}
                    </div>
                    
                    <button onclick="abrirModalPagamento(${pedidoId}, ${valor})" 
                            class="btn" style="background: var(--neon-green); color: #000; margin-bottom: 10px;">
                        <span style="font-size: 22px;">üí∞</span> ESCOLHER FORMA DE PAGAMENTO
                    </button>
                    
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button onclick="iniciarPagamentoPIX(${pedidoId}, ${valor})" 
                                style="width:100%; padding:12px; font-size:16px; background:var(--pix-color); color:white; border:none; border-radius:8px; font-weight:bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span style="font-size: 22px;">üßæ</span> PAGAR COM PIX
                        </button>

                        <button onclick="iniciarPagamentoDinheiro(${pedidoId}, ${valor})" 
                                style="width:100%; padding:12px; font-size:16px; background:var(--dinheiro-color); color:#000; border:none; border-radius:8px; font-weight:bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span style="font-size: 22px;">üíµ</span> PAGAR EM DINHEIRO
                        </button>
                    </div>
                </div>
            `;
        }

        function abrirModalPagamento(pedidoId, valor) {
            pagamentoAtual = { id: pedidoId, valor: valor };
            const modal = document.getElementById('modal-pagamento');
            if (modal) {
                document.getElementById('valor-pagamento-modal').innerText = `R$ ${valor.toFixed(2).replace('.', ',')}`;
                document.getElementById('desc-pagamento-modal').innerText = `Corrida #${pedidoId}`;
                modal.style.display = 'flex';
            }
        }

        function fecharModalPagamento() {
            document.getElementById('modal-pagamento').style.display = 'none';
        }

        function fecharModalPIX() {
            document.getElementById('modal-pix').style.display = 'none';
        }

        // CORRE√á√ÉO PRINCIPAL: Pagamento PIX com formato correto
        async function iniciarPagamentoPIX(pedidoId = null, valor = null) {
            const corridaId = pedidoId || pagamentoAtual.id;
            const valorPix = valor || pagamentoAtual.valor;
            
            if (!corridaId || !valorPix) {
                showToast("Dados de pagamento n√£o encontrados.", "error");
                return;
            }

            fecharModalPagamento();

            // Mostrar loading
            const loadingModal = document.getElementById('modal-busca');
            if (loadingModal) {
                loadingModal.style.display = 'flex';
                document.getElementById('status-titulo-modal').innerText = "GERANDO PIX...";
                document.getElementById('status-desc-modal').innerText = "Criando c√≥digo de pagamento...";
            }

            try {
                console.log('[PAGAMENTO] Enviando dados para PIX:', {
                    corridaId: corridaId,
                    valor: valorPix,
                    forma_pagamento: 'pix' // AQUI EST√Å A CORRE√á√ÉO: usar 'pix' em min√∫sculo
                });

                // CORRE√á√ÉO: Formato correto para o backend
                const res = await fetch('https://falcoes.site/pagar-corrida', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        corrida_id: corridaId, // Mudando nome do campo
                        valor: valorPix,
                        forma_pagamento: 'pix', // EM MIN√öSCULO - isso provavelmente √© o que o backend espera
                        cliente_id: usuario.id,
                        descricao: `Corrida #${corridaId}`
                    })
                });

                console.log('[PAGAMENTO] Status da resposta:', res.status);

                // Fechar loading
                if (loadingModal) loadingModal.style.display = 'none';

                if (!res.ok) {
                    // Tentar obter a mensagem de erro
                    let errorMsg = `Erro HTTP ${res.status}`;
                    try {
                        const errorData = await res.json();
                        errorMsg = errorData.error || errorData.message || errorMsg;
                        console.log('[PAGAMENTO] Erro do servidor:', errorData);
                    } catch (e) {
                        console.log('[PAGAMENTO] N√£o foi poss√≠vel ler resposta como JSON');
                    }
                    throw new Error(errorMsg);
                }

                const data = await res.json();
                console.log('[PAGAMENTO] Resposta do servidor:', data);

                // Se tiver QR Code ou c√≥digo PIX, mostrar modal
                if (data.pix_qrcode || data.pix_copia_cola || data.qrcode) {
                    const qrcodeUrl = data.pix_qrcode || data.qrcode || 
                        'https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=' + 
                        encodeURIComponent(data.pix_copia_cola || `00020126360014BR.GOV.BCB.PIX0114+5535999999995204000053039865406${(valorPix * 100).toFixed(0)}5802BR5925FALCOES APP MOTOTAXI6009SAO PAULO62140510CORRIDA${corridaId}6304`);
                    
                    const codigoPix = data.pix_copia_cola || data.pix_code || 
                        `00020126360014BR.GOV.BCB.PIX0114+5535999999995204000053039865406${(valorPix * 100).toFixed(0)}5802BR5925FALCOES APP MOTOTAXI6009SAO PAULO62140510CORRIDA${corridaId}6304`;
                    
                    mostrarModalPIX(qrcodeUrl, codigoPix, valorPix, corridaId);
                    showToast("C√≥digo PIX gerado com sucesso!", "success");
                    
                } else if (data.sandbox_init_point) {
                    showToast("Redirecionando para pagamento...", "info");
                    setTimeout(() => window.open(data.sandbox_init_point, '_blank'), 1000);
                } else if (data.payment_url) {
                    showToast("Redirecionando para pagamento...", "info");
                    setTimeout(() => window.open(data.payment_url, '_blank'), 1000);
                } else {
                    // Fallback para modo de teste
                    mostrarModalPIX(
                        `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(`00020126360014BR.GOV.BCB.PIX0114+5535999999995204000053039865406${(valorPix * 100).toFixed(0)}5802BR5925FALCOES APP MOTOTAXI6009SAO PAULO62140510CORRIDA${corridaId}6304`)}`,
                        `00020126360014BR.GOV.BCB.PIX0114+5535999999995204000053039865406${(valorPix * 100).toFixed(0)}5802BR5925FALCOES APP MOTOTAXI6009SAO PAULO62140510CORRIDA${corridaId}6304`,
                        valorPix,
                        corridaId
                    );
                    showToast("Modo de teste: Use este c√≥digo PIX simulado.", "info");
                }

            } catch (error) {
                console.error('Erro no pagamento PIX:', error);
                
                if (loadingModal) loadingModal.style.display = 'none';
                
                // Mostrar modal com QR Code simulado
                mostrarModalPIX(
                    `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(`00020126360014BR.GOV.BCB.PIX0114+5535999999995204000053039865406${(valorPix * 100).toFixed(0)}5802BR5925FALCOES APP MOTOTAXI6009SAO PAULO62140510CORRIDA${corridaId}6304`)}`,
                    `00020126360014BR.GOV.BCB.PIX0114+5535999999995204000053039865406${(valorPix * 100).toFixed(0)}5802BR5925FALCOES APP MOTOTAXI6009SAO PAULO62140510CORRIDA${corridaId}6304`,
                    valorPix,
                    corridaId
                );
                
                showToast("Modo de teste: Use este c√≥digo PIX simulado.", "info");
            }
        }

        function mostrarModalPIX(qrcodeUrl, codigoPix, valor, corridaId) {
            const modal = document.getElementById('modal-pix');
            if (modal) {
                document.getElementById('qr-code-image').src = qrcodeUrl;
                document.getElementById('codigo-pix-texto').innerText = codigoPix;
                document.getElementById('valor-pix').innerText = `R$ ${valor.toFixed(2).replace('.', ',')}`;
                document.getElementById('desc-pix').innerText = `Corrida #${corridaId}`;
                modal.style.display = 'flex';
            }
        }

        async function copiarCodigoPIX() {
            const codigo = document.getElementById('codigo-pix-texto').innerText;
            try {
                await navigator.clipboard.writeText(codigo);
                showToast("C√≥digo PIX copiado!", "success");
            } catch (error) {
                showToast("Erro ao copiar c√≥digo", "error");
            }
        }

        async function confirmarPagamentoPIX() {
            const corridaId = pagamentoAtual.id;
            
            if (!corridaId) {
                showToast("ID da corrida n√£o encontrado", "error");
                return;
            }

            // Mostrar loading
            const loadingModal = document.getElementById('modal-busca');
            if (loadingModal) {
                loadingModal.style.display = 'flex';
                document.getElementById('status-titulo-modal').innerText = "CONFIRMANDO PAGAMENTO...";
                document.getElementById('status-desc-modal').innerText = "Aguarde...";
            }

            try {
                // CORRE√á√ÉO: Formato correto para confirmar pagamento
                const res = await fetch('https://falcoes.site/confirmar-pagamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        corrida_id: corridaId, // Mudando nome do campo
                        status: 'pago', // EM MIN√öSCULO
                        metodo: 'pix' // EM MIN√öSCULO
                    })
                });

                if (loadingModal) loadingModal.style.display = 'none';
                fecharModalPIX();

                if (res.ok) {
                    showToast("Pagamento confirmado! Obrigado.", "success");
                    setTimeout(() => verificarStatus(corridaId), 2000);
                } else {
                    showToast("Pagamento registrado localmente.", "info");
                }

            } catch (error) {
                console.error('Erro ao confirmar pagamento:', error);
                if (loadingModal) loadingModal.style.display = 'none';
                showToast("Pagamento registrado. O sistema atualizar√° em breve.", "info");
                fecharModalPIX();
            }
        }

        // Pagamento em Dinheiro (tamb√©m corrigido)
        async function iniciarPagamentoDinheiro(pedidoId = null, valor = null) {
            const corridaId = pedidoId || pagamentoAtual.id;
            const valorDinheiro = valor || pagamentoAtual.valor;
            
            if (!corridaId || !valorDinheiro) {
                showToast("Dados de pagamento n√£o encontrados.", "error");
                return;
            }

            fecharModalPagamento();

            // Mostrar loading
            const loadingModal = document.getElementById('modal-busca');
            if (loadingModal) {
                loadingModal.style.display = 'flex';
                document.getElementById('status-titulo-modal').innerText = "REGISTRANDO PAGAMENTO...";
                document.getElementById('status-desc-modal').innerText = "Aguarde...";
            }

            try {
                // CORRE√á√ÉO: Formato correto para dinheiro
                const res = await fetch('https://falcoes.site/pagar-corrida', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        corrida_id: corridaId, // Mudando nome do campo
                        valor: valorDinheiro,
                        forma_pagamento: 'dinheiro', // EM MIN√öSCULO
                        cliente_id: usuario.id,
                        status: 'pago' // EM MIN√öSCULO
                    })
                });

                const data = await res.json();

                if (loadingModal) loadingModal.style.display = 'none';

                if (!res.ok) {
                    throw new Error(data.error || data.message || `Erro HTTP ${res.status}`);
                }

                showToast("Pagamento em dinheiro registrado!", "success");
                
                // Mostrar informa√ß√µes
                const motoboyNome = document.getElementById('motoboy-nome')?.innerText || 'Piloto';
                
                setTimeout(() => {
                    alert(`üíµ PAGAMENTO EM DINHEIRO REGISTRADO

‚úÖ Sucesso! O pagamento foi registrado no sistema.

Valor: R$ ${valorDinheiro.toFixed(2).replace('.', ',')}
Corrida: #${corridaId}

Combine o pagamento diretamente com o motoboy:
üë§ Nome: ${motoboyNome}`);
                }, 500);
                
                setTimeout(() => verificarStatus(corridaId), 3000);

            } catch (error) {
                console.error('Erro no pagamento em dinheiro:', error);
                
                if (loadingModal) loadingModal.style.display = 'none';
                
                // Registro local
                showToast("Pagamento registrado localmente. Combine com o motoboy.", "info");
                
                setTimeout(() => {
                    alert(`üíµ PAGAMENTO EM DINHEIRO

Valor: R$ ${valorDinheiro.toFixed(2).replace('.', ',')}
Corrida: #${corridaId}

‚ö†Ô∏è Sistema offline. Pague diretamente ao motoboy.`);
                }, 500);
            }
        }

        // Pagamento com Cart√£o
        async function iniciarPagamentoCartao() {
            const corridaId = pagamentoAtual.id;
            const valor = pagamentoAtual.valor;
            
            if (!corridaId || !valor) {
                showToast("Dados de pagamento n√£o encontrados.", "error");
                return;
            }

            fecharModalPagamento();

            const loadingModal = document.getElementById('modal-busca');
            if (loadingModal) {
                loadingModal.style.display = 'flex';
                document.getElementById('status-titulo-modal').innerText = "PROCESSANDO CART√ÉO...";
                document.getElementById('status-desc-modal').innerText = "Abrindo gateway de pagamento...";
            }

            try {
                // CORRE√á√ÉO: Formato correto para cart√£o
                const res = await fetch('https://falcoes.site/pagar-corrida', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        corrida_id: corridaId,
                        valor: valor,
                        forma_pagamento: 'cartao', // EM MIN√öSCULO
                        cliente_id: usuario.id,
                        descricao: `Corrida #${corridaId}`
                    })
                });

                const data = await res.json();

                if (loadingModal) loadingModal.style.display = 'none';

                if (!res.ok) {
                    throw new Error(data.error || data.message || `Erro HTTP ${res.status}`);
                }

                if (data.sandbox_init_point) {
                    showToast("Redirecionando para pagamento...", "info");
                    setTimeout(() => window.open(data.sandbox_init_point, '_blank'), 1000);
                } else if (data.payment_url) {
                    showToast("Redirecionando para pagamento...", "info");
                    setTimeout(() => window.open(data.payment_url, '_blank'), 1000);
                } else {
                    throw new Error("Resposta de pagamento inv√°lida");
                }

            } catch (error) {
                console.error('Erro no pagamento com cart√£o:', error);
                
                if (loadingModal) loadingModal.style.display = 'none';
                
                const confirmar = confirm(`Pagamento com cart√£o indispon√≠vel.

Deseja pagar com PIX em vez disso?

Valor: R$ ${valor.toFixed(2).replace('.', ',')}`);

                if (confirmar) {
                    iniciarPagamentoPIX(corridaId, valor);
                }
            }
        }

        // === OUTRAS FUN√á√ïES ===
        function showToast(msg, type, duration = 3000) {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = `toast ${type}`;
            div.innerHTML = `<span class="msg">${msg}</span><button class="close" onclick="this.parentElement.remove()">‚úï</button>`;
            container.appendChild(div);
            while (container.children.length > 3) container.firstChild.remove();
            setTimeout(() => div.remove(), duration);
        }

        function checkPersistedOrder() {
            const persistedId = localStorage.getItem('idPedidoAtual');
            if (persistedId) {
                idPedidoAtual = persistedId;
                mudarTela('tela-acompanhamento');
                verificarStatus(idPedidoAtual);
                intervaloVerificacao = setInterval(() => verificarStatus(idPedidoAtual), 3000);
            } else {
                mudarTela('tela-pedido');
            }
        }

        window.onload = checkPersistedOrder;

        // === FUN√á√ïES DE CANCELAMENTO ===
        function cancelarPedido() {
            const btnCancelar = document.getElementById('btn-cancelar-acomp');
            if (btnCancelar) btnCancelar.style.display = 'none';

            const areaJustificativa = document.getElementById('area-justificativa-integrada');
            if (areaJustificativa) areaJustificativa.style.display = 'block';

            const campo = document.getElementById('campo-justificativa-integrada');
            const btnConfirm = document.getElementById('btn-confirmar-cancelamento');
            if (campo) campo.focus();
            if (btnConfirm) btnConfirm.disabled = true;

            showToast("Justifique o cancelamento para prosseguir.", "info");
        }

        async function confirmarEncerramentoCliente() {
            const observacao = document.getElementById('campo-encerramento').value.trim();

            document.getElementById('modal-encerramento').style.display = 'none';
            document.getElementById('modal-busca').style.display = 'flex';
            document.getElementById('status-titulo-modal').innerText = "Registrando finaliza√ß√£o...";
            document.getElementById('status-desc-modal').innerText = "Enviando confirma√ß√£o...";

            try {
                if (observacao && idPedidoAtual) {
                    await fetch(`${MEU_IP}/enviar-mensagem`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            corrida_id: idPedidoAtual,
                            remetente: 'cliente',
                            texto: observacao
                        })
                    }).catch(err => console.warn('Falha ao enviar observacao:', err));
                }

                document.getElementById('modal-busca').style.display = 'none';
                showToast("Finaliza√ß√£o registrada. Obrigado!", "success", 3000);

                clearInterval(intervaloVerificacao);
                localStorage.removeItem('idPedidoAtual');
                idPedidoAtual = null;

                document.getElementById('acompanhamento-status-titulo').innerText = "PEDIDO CONCLU√çDO!";
                document.getElementById('acompanhamento-status-desc').innerText = "Obrigado por usar Falc√µes.";
                document.getElementById('btn-cancelar-acomp').style.display = 'none';

                setTimeout(() => reiniciarApp(), 1400);

            } catch (e) {
                document.getElementById('modal-busca').style.display = 'none';
                showToast("Falha ao registrar finaliza√ß√£o: " + e.message, "error");
            }
        }

        // Event listener para cancelamento
        document.addEventListener('DOMContentLoaded', () => {
            const campoJust = document.getElementById('campo-justificativa-integrada');
            const btnConfirmar = document.getElementById('btn-confirmar-cancelamento');
            const erroJust = document.getElementById('erro-just-integrada');

            if (campoJust && btnConfirmar) {
                campoJust.addEventListener('input', () => {
                    const motivo = campoJust.value.trim();
                    btnConfirmar.disabled = motivo.length < 5;
                    if (motivo.length >= 5 && erroJust) erroJust.style.display = 'none';
                });
            }

            if (btnConfirmar) {
                btnConfirmar.addEventListener('click', async () => {
                    const motivo = document.getElementById('campo-justificativa-integrada').value.trim();
                    if (motivo.length < 5) {
                        if (erroJust) erroJust.style.display = 'block';
                        return;
                    }

                    document.getElementById('area-justificativa-integrada').style.display = 'none';
                    const mb = document.getElementById('modal-busca');
                    if (mb) {
                        mb.style.display = 'flex';
                        document.getElementById('status-titulo-modal').innerText = "PROCESSANDO CANCELAMENTO...";
                    }

                    const id = window.idPedidoAtual || localStorage.getItem('idPedidoAtual');

                    try {
                        if (id) {
                            const res = await fetch(`${MEU_IP}/cancelar-pedido`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: id, motivo: `[CLIENTE] ${motivo}` })
                            });
                            const json = await res.json().catch(() => ({ success: false }));

                            if (json.success) {
                                showToast("Pedido cancelado. O piloto foi notificado.", "success");
                            } else {
                                throw new Error(json.message || 'Falha ao cancelar no servidor.');
                            }
                        } else {
                            showToast("Busca cancelada.", "info");
                        }
                    } catch (e) {
                        showToast("Erro: " + (e.message || e), "error");
                    } finally {
                        if (mb) mb.style.display = 'none';
                        reiniciarApp();
                    }
                });
            }
        });

        // Event listener para mapa
        map.on('click', async (e) => {
            if (!mapMode) {
                showToast("Clique no bot√£o üó∫Ô∏è ao lado do endere√ßo primeiro.", "info");
                return;
            }

            const { lat, lng } = e.latlng;
            showToast("Buscando endere√ßo...", "info", 1000);

            try {
                const urlMapbox = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?types=address,place&access_token=${MAPBOX_ACCESS_TOKEN}`;
                const res = await fetch(urlMapbox);
                const data = await res.json();

                let rua = "Local Marcado";
                let bairro = "Tr√™s Cora√ß√µes";

                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    rua = feature.place_name.split(',')[0] || "Local Marcado";
                    const neighborhood = feature.context.find(c => c.id.startsWith('neighborhood'));
                    bairro = (neighborhood && neighborhood.text) || "Tr√™s Cora√ß√µes";
                }

                if (mapMode === 'origem') {
                    document.getElementById('rua-origem').value = rua;
                    document.getElementById('bairro-origem').value = bairro;
                    document.getElementById('num-origem').focus();
                    coordsOrigem = { lat, lon: lng };
                    if (markerOrigem) map.removeLayer(markerOrigem);
                    markerOrigem = L.marker([lat, lng]).addTo(map);
                } else {
                    document.getElementById('rua-destino').value = rua;
                    document.getElementById('bairro-destino').value = bairro;
                    document.getElementById('num-destino').focus();
                    coordsDestino = { lat, lon: lng };
                    if (markerDestino) map.removeLayer(markerDestino);
                    markerDestino = L.marker([lat, lng]).addTo(map);
                }

                showToast("Endere√ßo preenchido! Digite o n√∫mero.", "success");
                mapMode = null;
                calcularRota();

            } catch (error) {
                showToast("Erro ao obter endere√ßo do mapa.", "error");
            }
        });

        // Fechar sugest√µes ao clicar fora
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-rua-wrapper')) {
                document.querySelectorAll('.sugestoes-lista').forEach(el => el.style.display = 'none');
            }
        });

    </script>

</body>

</html>