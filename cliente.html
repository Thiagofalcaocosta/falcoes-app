<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Falc√µes App</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin="" />

    <style>
        /* --- IDENTIDADE VISUAL FALC√ïES (DARK MODE OFICIAL - PRESERVADO) --- */
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --neon-green: #00e640;
            --text-color: #ffffff;
            --input-bg: #2c2c2c;
            --border-color: #333;
            --error-color: #ff4444;
            --dica-color: #888;
        }

        body {
            font-family: "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--card-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 230, 64, 0.1);
            position: relative;
            border: 1px solid var(--border-color);
            padding-bottom: 80px;
            /* Espa√ßo para n√£o cortar conteudo em mobile */
        }

        /* Gerenciamento de Telas */
        .tela {
            display: none;
            /* Todas as telas escondidas por padr√£o */
        }

        .tela.ativa {
            display: block;
            /* Tela ativa */
            animation: fadeIn 0.5s;
        }

        .logo-area {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo-area img {
            max-height: 100px;
            filter: drop-shadow(0 0 5px rgba(0, 230, 64, 0.5));
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .user-info {
            font-weight: 600;
            color: #ccc;
        }

        .estrelas {
            background-color: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: bold;
        }

        .logout a {
            color: var(--error-color);
            text-decoration: none;
            font-weight: 600;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            color: var(--neon-green);
            letter-spacing: 1px;
        }

        /* --- SELETOR DE SERVI√áO --- */
        .opcoes-servico {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .card {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: #252525;
            color: #aaa;
        }

        .card:hover {
            border-color: var(--neon-green);
            color: white;
        }

        .card.selecionado {
            border-color: var(--neon-green);
            background-color: rgba(0, 230, 64, 0.1);
            color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 230, 64, 0.2);
        }

        .icon {
            font-size: 28px;
            display: block;
            margin-bottom: 5px;
        }

        .preco {
            font-size: 14px;
            font-weight: 500;
        }

        /* --- NOVOS CAMPOS DE ENDERE√áO (GRID) --- */
        label {
            display: block;
            margin-top: 15px;
            font-weight: 700;
            color: var(--neon-green);
            /* Label verde para destaque */
            margin-bottom: 8px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .address-container {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        /* Linha 1: Rua + Bot√£o Mapa */
        .row-rua {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            position: relative;
        }

        .input-rua-wrapper {
            flex: 1;
            position: relative;
        }

        .btn-map-icon {
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            border-radius: 8px;
            width: 44px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-map-icon:hover {
            background: rgba(0, 230, 64, 0.1);
        }

        /* Linha 2: N√∫mero e Bairro */
        .row-details {
            display: flex;
            gap: 8px;
        }

        .input-num-wrapper {
            flex: 1;
            /* 25% */
            max-width: 80px;
            position: relative;
        }

        .input-bairro-wrapper {
            flex: 3;
            /* 75% */
        }

        input {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 15px;
            transition: 0.3s;
        }

        input:focus {
            border-color: var(--neon-green);
            outline: none;
        }

        /* Erro espec√≠fico para n√∫mero vazio */
        input.erro {
            border-color: var(--error-color) !important;
            animation: shake 0.4s ease-in-out;
        }

        .erro-msg {
            position: absolute;
            bottom: -16px;
            left: 0;
            font-size: 10px;
            color: var(--error-color);
            font-weight: bold;
            display: none;
        }

        input.erro+.erro-msg {
            display: block;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* Campo de detalhes da entrega */
        #detalhes-entrega-container {
            display: none;
            /* S√≥ aparece se for entrega */
            margin-top: 15px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }


        /* Lista de Sugest√µes */
        .sugestoes-lista {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
        }

        .sugestao-item {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
        }

        .sugestao-item:last-child {
            border-bottom: none;
        }

        .sugestao-item:hover {
            background-color: #2c2c2c;
        }

        .rua-texto {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: var(--neon-green);
        }

        .bairro-texto {
            display: block;
            font-size: 12px;
            color: #aaa;
            margin-top: 2px;
        }

        /* --- RESUMO E BOT√ÉO --- */
        .resumo-final {
            margin-top: 25px;
            padding: 15px;
            background-color: rgba(0, 230, 64, 0.1);
            color: var(--neon-green);
            border: 1px solid var(--neon-green);
            text-align: center;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            display: none;
        }

        .btn {
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            background-color: var(--neon-green);
            color: black;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--neon-green);
        }

        .btn:disabled {
            background-color: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- ESTILOS ESPEC√çFICOS ACOMPANHAMENTO --- */
        .info-card {
            background: #252525;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }

        .info-card .label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .info-card .value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }

        .motoboy-box {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border: 2px solid var(--neon-green);
            border-radius: 15px;
            background: rgba(0, 230, 64, 0.1);
        }

        .motoboy-box .nome {
            font-size: 24px;
            font-weight: 800;
            color: var(--neon-green);
            margin-top: 5px;
        }

        .motoboy-box .placa {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 10px;
        }

        /* --- ESTILO NOVO: WHATSAPP AZUL NEON COMPACTO --- */

/* Container para centralizar o bot√£o na tela */
.whatsapp-center-wrapper {
    text-align: center;
    width: 100%;
    margin: 15px 0 5px 0; /* Espa√ßo entre o verde e o vermelho */
    display: flex;
    justify-content: center;
}

.btn-whatsapp-neon {
    --cyan-neon: #00ffff;
    background-color: rgba(0, 255, 255, 0.1);
    border: 2px solid var(--cyan-neon);
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    color: var(--cyan-neon) !important;
    font-weight: 800;
    text-transform: uppercase;
    font-size: 13px;
    text-decoration: none !important; /* Tira o sublinhado */
    width: auto;
    padding: 10px 25px;
    border-radius: 50px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: 0.3s;
}
.btn-whatsapp-neon:hover {
    background-color: rgba(0, 255, 255, 0.25);
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
    color: #fff !important;
    transform: scale(1.05);
}

        /* --- MODAL DE BUSCA (ATUALIZADO) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            /* Z-index alto para ficar acima de tudo */
            overflow-y: auto;
            /* PERMITE ROLAR SE O CONTE√öDO FOR MAIOR QUE A TELA */
            padding: 20px 0;
            /* Espa√ßo vertical para n√£o grudar no topo/base */
        }

        .modal-content {
            background: var(--card-color);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 85%;
            max-width: 350px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 40px rgba(0, 230, 64, 0.15);
            margin: auto;
            /* Centraliza verticalmente */
        }

        .spinner {
            border: 5px solid #333;
            border-top: 5px solid var(--neon-green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: girar 1s linear infinite;
            margin: 0 auto 20px auto;
        }

        @keyframes girar {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .btn-cancelar {
            background-color: transparent;
            border: 1px solid var(--error-color);
            color: var(--error-color);
            font-size: 14px;
            margin-top: 20px;
            padding: 10px;
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
        }


        /* Bloco de ESTILO PARA O CAMPO TEXTAREA NO MODAL DE JUSTIFICATIVA (aproximadamente linha 283) */
        .modal-content textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: white;
            resize: none;
            font-family: inherit;
            /* --- CORRE√á√ÉO: ADICIONAR Z-INDEX ALTO E GARANTIR VISIBILIDADE --- */
            position: relative;
            z-index: 1000000;
            margin-bottom: 5px;
            /* Adiciona espa√ßo extra para n√£o ser cortado */
        }

        #map {
            height: 180px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        /* --- TOAST --- */
        .toast-container {
            position: fixed;
            left: 50%;
            bottom: 24px;
            transform: translateX(-50%);
            z-index: 10050;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            pointer-events: none;
            width: 90%;
        }

        .toast {
            width: 100%;
            max-width: 400px;
            background: #000;
            border-radius: 12px;
            padding: 12px 16px;
            color: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            display: flex;
            gap: 12px;
            align-items: center;
            opacity: 0;
            transform: translateY(10px);
            animation: toast-in 0.3s forwards;
            font-weight: 600;
            border: 1px solid var(--neon-green);
            pointer-events: auto;
        }

        @keyframes toast-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast.error {
            border-color: var(--error-color);
        }

        .toast .msg {
            flex: 1;
            font-size: 14px;
        }

        .toast .close {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 18px;
        }

       

        #modal-busca .modal-content,
        #modal-justificativa .modal-content,
        #modal-encerramento .modal-content,
        #modal-pagamento .modal-content,
        #modal-justificativa-cliente .modal-box,
        #modal-confirmar-cancelamento-busca .modal-content {    
            /* Ajustado para modal-box */
            z-index: 2147483647 !important;
            position: relative !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            margin: auto !important;
        }

        /* Estilo para a modal-box no modal-justificativa-cliente */
        #modal-justificativa-cliente .modal-box {
            background: var(--card-color);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 85%;
            max-width: 350px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 40px rgba(0, 230, 64, 0.15);
        }

        #modal-justificativa-cliente .modal-titulo {
            font-size: 24px;
            color: var(--error-color);
            margin-bottom: 15px;
            font-weight: bold;
        }

        #modal-justificativa-cliente .modal-desc {
            font-size: 16px;
            color: white;
            margin-bottom: 10px;
            font-weight: 600;
        }
        /* ===== CORRE√á√ÉO FINAL MODAL PAGAMENTO ===== */
#modal-pagamento {
    display: none;              /* come√ßa fechado */
    position: fixed;
    inset: 0;                   /* top, right, bottom, left = 0 */
    z-index: 2147483646;
    background: rgba(0,0,0,0.85);

    /* ESSENCIAL */
    align-items: center;
    justify-content: center;
}

#modal-pagamento.show {
    display: flex !important;
}

/* ===== ESTILO ESPEC√çFICO DO MODAL PAGAMENTO ===== */
#modal-pagamento .modal-content {
    background: #1e1e1e;
    border: 1px solid var(--neon-green);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
}

#modal-pagamento .btn-pagamento-item {
    width: 100%;
    padding: 16px;
    margin-top: 10px;
    font-size: 16px;
    font-weight: 800;
    background-color: var(--neon-green);
    color: #000;
    border-radius: 12px;
    border: none;
}

/* Bot√£o de Estorno (Contato ADM) */
.area-estorno {
    margin-top: 20px;
    padding: 15px;
    background: rgba(255, 204, 0, 0.05); /* Fundo amarelo bem leve */
    border: 1px solid #ffcc00;
    border-radius: 12px;
    text-align: center;
    animation: fadeIn 0.5s;
}

.titulo-estorno {
    color: #ffcc00;
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 5px;
    text-transform: uppercase;
}

.desc-estorno {
    color: #ccc;
    font-size: 12px;
    margin-bottom: 12px;
}

.btn-falar-adm {
    background: transparent;
    border: 1px solid #ffcc00;
    color: #ffcc00;
    padding: 10px;
    border-radius: 8px;
    width: 100%;
    font-weight: 800;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: 0.3s;
}

.btn-falar-adm:hover {
    background: rgba(255, 204, 0, 0.15);
}
/* Bot√£o M√©dio com Borda Neon */
.btn-novo-pedido-neon {
    background: transparent;
    border: 2px solid #00e640; /* Verde Neon */
    color: #fff;
    padding: 12px 25px; /* Tamanho M√©dio */
    font-size: 14px;
    font-weight: 800;
    text-transform: uppercase;
    border-radius: 50px; /* Redondinho */
    cursor: pointer;
    box-shadow: 0 0 10px rgba(0, 230, 64, 0.2); /* Brilho suave */
    transition: 0.3s;
    margin-top: 15px;
    display: inline-block;
}

.btn-novo-pedido-neon:hover {
    background: rgba(0, 230, 64, 0.1);
    box-shadow: 0 0 20px rgba(0, 230, 64, 0.6); /* Brilho forte ao passar mouse */
    transform: scale(1.05);
}
/* --- ESTILOS DO MODAL DE PAGAMENTO OTIMIZADO --- */

/* Bot√£o PIX (O Principal) */
.btn-pagamento-pix {
    width: 100%;
    padding: 16px;
    background-color: #00e640; /* Verde Neon */
    color: #000; /* Texto Preto para contraste */
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 900;
    text-transform: uppercase;
    cursor: pointer;
    box-shadow: 0 0 15px rgba(0, 230, 64, 0.4); /* Brilho Neon */
    transition: transform 0.2s;
}
.btn-pagamento-pix:active {
    transform: scale(0.98);
}

/* Bot√£o DINHEIRO (O Secund√°rio) */
.btn-pagamento-dinheiro {
    width: 100%;
    padding: 16px;
    background-color: transparent; /* Fundo invis√≠vel */
    border: 2px solid #00e640; /* Borda Verde */
    color: #00e640; /* Texto Verde */
    border-radius: 12px;
    font-size: 16px;
    font-weight: 800;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.3s;
}
.btn-pagamento-dinheiro:hover {
    background-color: rgba(0, 230, 64, 0.1);
}

/* Bot√£o Fechar (Discreto) */
.btn-fechar-texto {
    background: none;
    border: none;
    color: #666; /* Cinza escuro para n√£o chamar aten√ß√£o */
    margin-top: 20px;
    cursor: pointer;
    font-size: 13px;
    text-decoration: underline;
}
.btn-fechar-texto:hover {
    color: #fff;
}
/* --- NOVOS ESTADOS NEON (Coloque no seu <style>) --- */

/* ESTADO 1: BUSCANDO (Azul Ciano Neon) */
/* Remove o fundo verde padr√£o e aplica o azul */
#acompanhamento-status-area.status-buscando {
    border: 2px solid #00ffff !important; /* Azul Neon */
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3) !important;
    background-color: rgba(0, 255, 255, 0.05) !important; /* Fundo azulzinho muito leve */
}
/* Muda a cor do t√≠tulo e √≠cone */
#acompanhamento-status-area.status-buscando #acompanhamento-status-titulo {
    color: #00ffff !important;
}
/* Muda a cor do timer para combinar */
#acompanhamento-status-area.status-buscando #timer-numeros {
    color: #00ffff !important;
}

/* ESTADO 2: FINALIZADA (Dourado Neon) */
#acompanhamento-status-area.status-finalizada {
    border: 2px solid #ffd700 !important; /* Dourado Neon */
    box-shadow: 0 0 25px rgba(255, 215, 0, 0.4) !important; /* Brilho mais forte */
    background-color: rgba(255, 215, 0, 0.08) !important; /* Fundo dourado leve */
}
/* Muda a cor do t√≠tulo */
#acompanhamento-status-area.status-finalizada #acompanhamento-status-titulo {
    color: #ffd700 !important;
}
.erro {
    border: 2px solid #ff4d4d !important;
    background-color: #fff5f5;
}
.notification-container {
    position: fixed;
    top: 15px;
    right: 15px;
    z-index: 9999;
    cursor: pointer;
}

.bell-box {
    background: rgba(255, 255, 255, 0.1); /* Efeito transparente */
    backdrop-filter: blur(10px);
    padding: 12px;
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.3s;
}

.bell-box i {
    color: #FFD700; /* Dourado met√°lico */
    font-size: 24px;
    filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
}

.badge-red {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff0000;
    color: white;
    font-size: 11px;
    font-weight: bold;
    padding: 2px 7px;
    border-radius: 50%;
    border: 2px solid #121212;
    box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
}

/* Efeito de balan√ßo quando o mouse passa ou quando tiver aviso */
.bell-box:hover {
    transform: scale(1.1) rotate(10deg);
}
    </style>
   
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker
                .register("/service-worker.js")
                .then(() => console.log("SW registrado!"))
                .catch(err => console.log("Erro SW:", err));
        }
    </script>

    <link rel="stylesheet" href="/style.css?v=9899.0">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00e640">
</head>

<body>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="notification-container" onclick="abrirAviso()">
    <div class="bell-box">
        <i class="fas fa-bell"></i>
        <span class="badge-red">1</span>
    </div>
</div>

<div id="modal-aviso" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: #1a1a1a; padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; border: 1px solid #333; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        
        <div style="font-size: 40px; margin-bottom: 10px;">üì¢</div>
        <h3 style="color: #fff; margin: 0 0 10px 0; font-family: sans-serif;">AVISO IMPORTANTE</h3>
        
        <p id="texto-alerta" style="color: #ccc; line-height: 1.5; font-family: sans-serif; margin-bottom: 20px;">
            Mau tempo na sua √°rea üåßÔ∏è Para manter a opera√ß√£o ativa e recompensar nossos parceiros sob chuva, uma taxa extra est√° sendo aplicada neste momento.
        </p>
        
        <button onclick="fecharAviso()" style="background: #00ff00; color: #000; border: none; padding: 12px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;">
            ENTENDIDO
        </button>
    </div>
</div>

<div id="modal-aviso" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 20px; border-radius: 15px; width: 80%; max-width: 400px; text-align: center; color: #333;">
        <h3 style="color: #d9534f;">Informativo Falc√µes</h3>
        <p id="texto-alerta">Estamos com alta demanda em Tr√™s Cora√ß√µes! As corridas podem demorar um pouco mais.</p>
        <button onclick="fecharAviso()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Entendido</button>
    </div>
</div>

    <div class="toast-container" id="toast-container"></div>

    <div class="modal-overlay" id="modal-busca">
        <div class="modal-content">
            <div id="area-spinner" class="spinner"></div>

            <div id="status-titulo-modal"
                style="font-size: 18px; font-weight: bold; color: white; margin-bottom: 10px;">BUSCANDO PILOTO...</div>
            <div id="status-desc-modal" style="font-size: 14px; color: #aaa;">Notificando parceiros pr√≥ximos.</div>

            <button class="btn-cancelar" onclick="abrirJustificativaCliente()">CANCELAR PEDIDO</button>

        </div>
    </div>


    <div class="modal-overlay" id="modal-encerramento" style="display:none;">
        <div class="modal-content">
            <div style="font-size: 22px; color: var(--neon-green); margin-bottom: 12px;">‚úÖ Corrida Finalizada</div>
            <div id="encerramento-titulo" style="font-size:16px; color:#fff; margin-bottom:8px;">
                A corrida foi finalizada. Confirme e, se desejar, deixe uma observa√ß√£o (opcional)
            </div>
            <textarea id="campo-encerramento" placeholder="Ex: Tudo ok, atraso, avaria..."></textarea>
            <button onclick="confirmarEncerramentoCliente()" class="btn" style="margin-top:12px;">CONFIRMAR
                ENCERRAMENTO</button>
            <button onclick="document.getElementById('modal-encerramento').style.display='none'" class="btn-cancelar"
                style="margin-top:8px;">Fechar</button>
        </div>
    </div>
   <div id="modal-pagamento">
    <div class="modal-content">
        <div style="font-size: 40px; margin-bottom: 10px;">‚úÖ</div>
        
        <h3 style="color: var(--neon-green); margin: 0; font-size: 22px; font-weight: 800;">PILOTO ENCONTRADO!</h3>
        <p style="color: #ccc; font-size: 14px; margin-top: 5px;">Como voc√™ deseja pagar?</p>
        
        <div id="valor-modal-pagamento" style="
            font-size: 28px; 
            font-weight: 900; 
            color: #fff; 
            margin: 20px 0; 
            text-shadow: 0 0 10px rgba(255,255,255,0.2);
        ">
            R$ --,--
        </div>

        <div class="btn-pagamento-opcoes" style="display: flex; flex-direction: column; gap: 15px;">
            
            <button class="btn-pagamento-pix" onclick="pagarPix()">
                üì± PAGAR COM PIX
            </button>

            <button class="btn-pagamento-dinheiro" onclick="pagarDinheiro()">
                üíµ PAGAR EM DINHEIRO
            </button>

        </div>
        
        <button onclick="document.getElementById('modal-pagamento').classList.remove('show')" 
                class="btn-fechar-texto">
            Fechar e decidir depois
        </button>
    </div>
</div>


        <div class="container"></div>
        <div class="logo-area"><img src="assets/logo.png" alt="Logo"
                onerror="this.style.display='none'; document.querySelector('.logo-area').innerHTML='<h1 style=\'color:var(--neon-green)\'>FALC√ïES</h1>'" />
        </div>

        <div class="header-top">
            <div class="user-info"><span id="msg-ola">Piloto</span> <span class="estrelas">‚òÖ 5.0</span></div>
            <div class="logout"><a href="#" onclick="logout()">SAIR</a></div>
        </div>

        <div id="tela-pedido" class="tela ativa">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin: 0;">NOVA SOLICITA√á√ÉO</h2>
    <button onclick="limparFormularioManual()" class="btn-limpar-discreto">
        üóëÔ∏è Limpar
    </button>
</div>

            <div class="opcoes-servico">
                <div class="card" id="card-moto" onclick="selecionarServico('moto-taxi', 10.0)">
                     <span class="icon">üèçÔ∏è</span>
                    <div class="card-title">MOTO T√ÅXI</div>
                    <div class="preco">R$ 10,00 + Km</div>
                </div>
                <div class="card" id="card-entrega" onclick="selecionarServico('entrega', 8.50)">
                    <span class="icon">üì¶</span>
                    <div class="card-title">ENTREGA</div>
                    <div class="preco">R$ 8,50 + Km</div>
                </div>
            </div>

            <div id="form-endereco">

    <label>üìç Onde vamos buscar? (Origem)</label>
    <div class="address-container">
        <div class="row-rua">
            <div class="input-rua-wrapper">
                <input type="text" id="rua-origem" placeholder="Busque a rua..."
                    oninput="buscarEndereco(this.value, 'lista-origem', 'origem')" autocomplete="off">
                <div id="lista-origem" class="sugestoes-lista"></div>
            </div>
            
            <button class="btn-map-icon btn-my-location" onclick="usarMeuLocal()" title="Usar minha localiza√ß√£o">
    üìç <span class="gps-text">MEU LOCAL</span>
</button>

            <button class="btn-map-icon" onclick="ativarMapa('origem')" title="Marcar no mapa">
                üó∫Ô∏è
            </button>
        </div>
        
        <div class="row-details">
            <div class="input-num-wrapper">
                <input type="text" id="num-origem" placeholder="N¬∫" oninput="removerErro(this)">
                <span class="erro-msg">Obrigat√≥rio</span>
            </div>
            <div class="input-bairro-wrapper">
                <input type="text" id="bairro-origem" placeholder="Bairro">
            </div>
        </div>
    </div>

    <label>üèÅ Onde vamos levar? (Destino)</label>
    <div class="address-container">
        <div class="row-rua">
            <div class="input-rua-wrapper">
                <input type="text" id="rua-destino" placeholder="Busque a rua..."
                    oninput="buscarEndereco(this.value, 'lista-destino', 'destino')" autocomplete="off">
                <div id="lista-destino" class="sugestoes-lista"></div>
            </div>
            <button class="btn-map-icon" onclick="ativarMapa('destino')" title="Marcar no mapa">üó∫Ô∏è</button>
        </div>
        <div class="row-details">
            <div class="input-num-wrapper">
                <input type="text" id="num-destino" placeholder="N¬∫" oninput="removerErro(this)">
                <span class="erro-msg">Obrigat√≥rio</span>
            </div>
            <div class="input-bairro-wrapper">
                <input type="text" id="bairro-destino" placeholder="Bairro">
            </div>
        </div>
    </div>

    <div id="detalhes-entrega-container">
        <label>üì¶ O que vamos levar?</label>
        <input type="text" id="detalhes-entrega" placeholder="Ex: Chaves, Marmita, Documento..."
            oninput="removerErro(this)">
        <span class="erro-msg" style="position:relative; bottom:0;">Descreva o item</span>
    </div>

</div>

            <div id="map"></div>
            <p style="font-size:12px; color:#666; text-align:center; margin-top:5px;">Toque no bot√£o üó∫Ô∏è para marcar no
                mapa</p>

            <div class="resumo-final" id="resumo"></div>

            <button onclick="pedir()" id="btn-pedir" class="btn" disabled>SELECIONE O SERVI√áO</button>
        </div>

       <div id="tela-acompanhamento" class="tela">
        <div id="fluxo-cliente-comum">

    <div class="status-header" id="acompanhamento-status-area">
        
        <div id="area-estorno-adm" class="area-estorno" style="display:none; margin-bottom: 15px;">
    <div class="titulo-estorno">‚ö†Ô∏è CORRIDA CANCELADA?</div>
    <p class="desc-estorno">Houve um imprevisto.<br>Solicite o reembolso (Taxa: R$ 0,10).</p>
    <a id="btn-link-estorno" 
       href="https://wa.me/5535997806080?text=Ol√°%20ADM%2C%20preciso%20de%20suporte%20com%20meu%20pedido%20no%20Falc√µes%20App." 
       class="btn-falar-adm">
        <i class="fab fa-whatsapp"></i> FALAR COM O ADM
    </a>
</div>

        <div class="header-top-row">
            <div class="status-info">
                <h2 id="acompanhamento-status-titulo" style="display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-search-location"></i> BUSCANDO...
                </h2>
                <p id="acompanhamento-status-desc">Aguarde, estamos localizando um piloto.</p>

                <div id="area-codigo-seguranca" style="display:none; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; width: fit-content;">
                    <span style="font-size: 10px; color: #fff; display: block; opacity: 0.8;">INFORME AO PILOTO:</span>
                    <span id="texto-codigo-seguranca" style="font-size: 24px; font-weight: 800; color: #00ffff; letter-spacing: 3px; text-shadow: 0 0 10px rgba(0,255,255,0.5);">----</span>
                </div>
            </div>
            
            <div class="order-badge-group">
                <span class="badge-label">PEDIDO</span>
                <span class="badge-value" id="acompanhamento-id">#000</span>
            </div>
        </div>
        
        <div id="tempo-restante-busca" style="
    margin-top: 15px;
    font-size: 14px;
    color: #ccc;
    text-align: center;
    padding: 10px;
    background: rgba(0, 255, 0, 0.1); /* Fundo verde bem suave */
    border-radius: 20px; /* Bordas arredondadas tipo p√≠lula */
    border: 1px solid rgba(0, 255, 0, 0.3); /* Borda verde sutil */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px; /* Espa√ßo entre o emoji e o texto */
">
    ‚è≥ Tempo estimado: 
    <span id="timer-numeros" style="color: var(--neon-green); font-weight: bold; font-size: 16px;">--s</span>
</div>
    </div>

    <div class="whatsapp-center-wrapper" style="text-align: center; margin: 15px 0;">
        <a id="btn-whatsapp-motoboy" href="#" target="_blank" class="btn-whatsapp-neon" style="display:none;">
            <i class="fab fa-whatsapp"></i> FALAR COM O PILOTO
        </a>
    </div>

    <div id="area-botao-cancelar-taxa" class="area-cancelar-taxa" style="display:none; text-align:center;">
        <button onclick="cancelarComTaxa()" class="btn-cancelar-taxa">
            <i class="fas fa-ban"></i> Cancelar Corrida
        </button>
        <span class="aviso-taxa-texto" style="display:block; font-size:11px; color:#888; margin-top:5px;">
            <i class="fas fa-exclamation-triangle" style="color:#ffcc00;"></i> ‚ö†Ô∏è Uma taxa de cancelamento de R$ 5,00 pode ser aplicada (deslocamento motoboy).
        </span>
    </div>

    <button id="btn-cancelar-busca" onclick="abrirModalCancelamentoBusca()" class="btn-cancel-outline" style="width:100%; margin-top:10px;">
        CANCELAR BUSCA
    </button>

    <div id="motoboy-info-box" style="display:none; margin-top: 15px;">
        <div class="driver-card">
            <div class="driver-card-header">
                <img src="https://cdn-icons-png.flaticon.com/512/709/709699.png" class="driver-img-fix" alt="Avatar" id="motoboy-foto">
                <div class="driver-title-box">
                    <span class="driver-subtitle">SEU PILOTO</span>
                    <h3 class="driver-name-main" id="motoboy-nome">--</h3>
                    <div style="color: var(--neon-green); font-size: 12px; font-weight: bold;">‚≠ê 5.0</div>
                </div>
            </div>
            <div class="driver-data-grid">
                <div class="data-item"><span class="data-label">Ve√≠culo</span><span class="data-value" id="motoboy-modelo">--</span></div>
                <div class="data-item"><span class="data-label">Cor</span><span class="data-value" id="motoboy-cor">--</span></div>
                <div class="data-item" style="grid-column: span 2;"><span class="data-label">Placa</span><span class="data-value"><span class="plate-badge-new" id="motoboy-placa">---</span></span></div>
            </div>
        </div>
    </div>

    <button id="btn-fechar-novo" class="btn-fechar-topo" onclick="fecharTela()" style="display:none;">FECHAR TELA X</button>

    <div class="route-container" style="margin-top:20px;">
        <div class="route-item"><div class="route-dot origin"></div><div class="route-content"><label>RETIRADA</label><span id="detalhe-origem">...</span></div></div>
        <div class="route-connector"></div>
        <div class="route-item"><div class="route-dot dest"></div><div class="route-content"><label>ENTREGA</label><span id="detalhe-destino">...</span></div></div>
    </div>

    <div class="price-section">
        <div id="area-pagamento-cliente"></div> 
        <div class="price-display"><span>Total estimado</span><h1 id="detalhe-valor">R$ --</h1></div>
    </div>

    <div id="area-justificativa-integrada" class="cancel-area" style="display:none;">
        <label>Motivo:</label>
        <textarea id="campo-justificativa-integrada" placeholder="Digite o motivo..." rows="3"></textarea>
        <div id="erro-just-integrada" class="error-msg">M√≠nimo 5 caracteres.</div>
        <button id="btn-confirmar-cancelamento" class="btn-danger-full" disabled>CONFIRMAR</button>
    </div>
    </div> <div id="fluxo-restaurante" style="display: none; padding: 10px;">
        <h2 style="color: var(--neon-green); text-align: left; margin-bottom: 20px;">CENTRAL DE ENTREGAS</h2>
        
        <div id="lista-pedidos-ativos" style="display: flex; flex-direction: column; gap: 15px;">
            </div>
        
        <button onclick="mudarTela('tela-pedido')" class="btn-novo-pedido-neon" style="width: 100%; margin-top: 25px;">
            + LAN√áAR NOVO PEDIDO
        </button>
    </div>
</div>

    </div>
     <div id="modal-confirmar-cancelamento-busca" class="modal-overlay" style="display: none; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999;">
    <div class="modal-box" style="background: #1e1e1e; border: 1px solid #333; padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 0 30px rgba(255, 68, 68, 0.2);">
        
        <div style="font-size: 50px; margin-bottom: 15px;">‚ö†Ô∏è</div>
        
        <div class="modal-titulo" style="font-size: 20px; font-weight: 800; color: #ff4444; margin-bottom: 10px; text-transform: uppercase;">
            CANCELAR BUSCA?
        </div>
        
        <p class="modal-desc" style="color: #aaa; margin-bottom: 25px; font-size: 15px;">
            Tem certeza que deseja parar de procurar um motoboy?
        </p>
        
        <div class="modal-botoes" style="display: flex; gap: 10px;">
            <button onclick="fecharModal('modal-confirmar-cancelamento-busca')" 
                    style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; background-color: #333; color: white;">
                N√ÉO, VOLTAR
            </button>
            <button onclick="confirmarCancelamentoBusca()" 
                    style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; background-color: #ff4444; color: white;">
                SIM, CANCELAR
            </button>
        </div>
    </div>
</div>
<div id="modal-justificativa-cliente" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <div class="modal-titulo">CANCELAR CORRIDA?</div>
        <div class="modal-desc">O piloto j√° aceitou. Uma taxa de R$ 5,00 ser√° aplicada no estorno.</div>
        
        <label style="color: #888; font-size: 12px; margin-bottom: 5px; display: block; text-align: left;">
            Motivo do cancelamento:
        </label>
        <textarea id="justificativa-texto" 
                  placeholder="Ex: Vou pedir novamente, desisti da viagem..." 
                  style="width: 100%; height: 90px; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #2c2c2c; color: white; resize: none; font-family: inherit; margin-bottom: 20px; box-sizing: border-box;"></textarea>
        
        <div class="modal-botoes" style="display: flex; gap: 10px;">
            <button onclick="fecharModal('modal-justificativa-cliente')" 
                    style="flex: 1; padding: 14px; border-radius: 10px; border: none; font-weight: bold; background: #333; color: white; cursor: pointer;">
                VOLTAR
            </button>
            <button onclick="enviarCancelamentoComJustificativa()" 
                    style="flex: 1; padding: 14px; border-radius: 10px; border: none; font-weight: bold; background: #ff4444; color: white; cursor: pointer;">
                CONFIRMAR
            </button>
        </div>
    </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
    <script>
    // --- COLE ISSO DENTRO DA TAG SCRIPT ---

    // 1. Abre o modal quando clica no bot√£o
    function abrirModalCancelamentoBusca() {
    const modal = document.getElementById('modal-confirmar-cancelamento-busca');
    if (modal) {
        // Usa flex para centralizar e !important para vencer bloqueios do CSS
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.opacity = '1';
        modal.style.visibility = 'visible';
    } else {
        console.error("Erro: O modal 'modal-confirmar-cancelamento-busca' n√£o foi encontrado no HTML.");
    }
}

    // 2. Fecha qualquer modal
    function fecharModal(idModal) {
        const modal = document.getElementById(idModal);
        if(modal) modal.style.display = 'none';
    }

    // Fun√ß√£o unificada usando o modal original do navegador
    // 3. Executa o cancelamento real (Quando clica em SIM)

    async function confirmarCancelamentoBusca() {

        fecharModal('modal-confirmar-cancelamento-busca');

       

        // Tenta pegar o ID da corrida (ajuste conforme seu c√≥digo salva o ID)

        // Se voc√™ usa uma vari√°vel global chamada 'idCorridaAtual', use ela.

        // Se usa localStorage, use o localStorage.

        const idParaCancelar = window.idPedidoAtual || localStorage.getItem('idPedidoAtual');

       

       if (!idParaCancelar || idParaCancelar === '000') {

            showToast("Nenhuma busca ativa encontrada para cancelar.", "error");

            // Se o ID sumiu mas a tela est√° aberta, apenas reinicia o app

            setTimeout(() => reiniciarApp(), 1000);

            return;

        }



        try {

            // Endere√ßo do seu backend

            const MEU_IP = 'https://falcoes-app.onrender.com';



            const res = await fetch(`${MEU_IP}/cancelar-pedido`, {

                method: 'POST',

                headers: { 'Content-Type': 'application/json' },

                body: JSON.stringify({

                    id: idParaCancelar,

                    motivo: 'Cliente desistiu da busca',

                    cancelado_por: 'cliente'

                })

            });



            const data = await res.json();



            if (data.success) {

                showToast("Busca cancelada!", "success");

                // Limpa as mem√≥rias da corrida atual

                localStorage.removeItem('idPedidoAtual');

                localStorage.removeItem('pedidoAtual');

                localStorage.removeItem('inicioBuscaTimestamp');

               

                // Pequeno delay para o usu√°rio ver o aviso e reinicia

                setTimeout(() => {

                    window.location.reload();

                }, 1000);

            } else {

                showToast("Erro: " + (data.message || "N√£o foi poss√≠vel cancelar."), "error");

            }

        } catch (err) {

            console.error("Erro ao cancelar:", err);

            showToast("Erro de conex√£o com o servidor.", "error");

        }

    }



    // === CONFIGURA√á√ÉO E DADOS ===
    // O correto √© com aspas no come√ßo e no fim:
const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoidGhpYWdvZmFsY2FvIiwiYSI6ImNtamxtMms3cDBvdGEzZ3B2NzBkajE3NmUifQ.qTGPzR6IIc2-JetrQnB-yQ';// SEU TOKEN AQUI!
    const MEU_IP = 'https://falcoes-app.onrender.com';
    const LAT_TC = -21.6975;
    const LON_TC = -45.25; 

    // Mock de usu√°rio
    const usuario = JSON.parse(localStorage.getItem("usuario"));
    document.getElementById("msg-ola").innerText = "OL√Å, " + usuario.nome.split(" ")[0].toUpperCase();

    // Vari√°veis de Estado
    let servicoSelecionado = null;
    let coordsOrigem = null;
    let coordsDestino = null;
    let timeoutBusca = null;
    let mapMode = null;
    let markerOrigem = null;
    let markerDestino = null;
    let idPedidoAtual = localStorage.getItem('idPedidoAtual');
    let intervaloVerificacao = null;
    let buscaMotoboyInterval = null; // Para controlar o tempo limite da busca
    let tempoBuscaRestante = 0; 

    const precos = {
        'moto-taxi': { base: 10.0, kmExtra: 3.15, franquia: 3 },
        'entrega': { base: 8.50, kmExtra: 2.0, franquia: 3 }
    };

    // === FUN√á√ïES DE GERENCIAMENTO DE TELA E UTILIDADES ===
    function mudarTela(novaTelaId) {
        document.querySelectorAll('.tela').forEach(tela => {
            tela.classList.remove('ativa');
        });
        document.getElementById(novaTelaId).classList.add('ativa');
    }

    function reiniciarApp() {
        localStorage.removeItem('idPedidoAtual');
        localStorage.removeItem('pedidoAtual');
        if (intervaloVerificacao) clearInterval(intervaloVerificacao);
        if (buscaMotoboyInterval) clearInterval(buscaMotoboyInterval);
        window.location.reload();
    }
    
    function removerErro(input) {
        input.classList.remove('erro');
    }

    // Toast Helper
    function showToast(msg, type, duration = 3000) {
        const container = document.getElementById('toast-container');
        const div = document.createElement('div');
        div.className = `toast ${type}`;
        div.innerHTML = `<span class="msg">${msg}</span><button class="close" onclick="this.parentElement.remove()">‚úï</button>`;
        container.appendChild(div);
        while (container.children.length > 3) {
            container.firstChild.remove();
        }
        setTimeout(() => div.remove(), duration);
    }
    
    // === FUN√á√ïES AUXILIARES DE PERSIST√äNCIA ===
    function preencherDetalhesAcompanhamento() {
        const pedidoSalvo = JSON.parse(localStorage.getItem('pedidoAtual'));
        if (pedidoSalvo) {
            document.getElementById('acompanhamento-id').innerText = `#${idPedidoAtual}`;
            document.getElementById('detalhe-origem').innerText = pedidoSalvo.origem;
            document.getElementById('detalhe-destino').innerText = pedidoSalvo.destino;
            document.getElementById('detalhe-valor').innerText = `R$ ${pedidoSalvo.valor.toFixed(2).replace('.', ',')}`;
            return true;
        }
        return false;
    }
    
    // === FUN√á√ÉO PRINCIPAL DE PERSIST√äNCIA (Ao recarregar a p√°gina) ===
    function checkPersistedOrder() {
    const usuarioLogado = JSON.parse(localStorage.getItem("usuario"));
    const ehEmpresa = usuarioLogado && usuarioLogado.tipo === 'empresa';

    // 1. Se for EMPRESA, lida com m√∫ltiplos pedidos
    if (ehEmpresa) {
        const pedidosAtivos = JSON.parse(localStorage.getItem('meus_pedidos_ativos')) || [];
        
        if (pedidosAtivos.length > 0) {
            mudarTela('tela-acompanhamento');
            inicializarVisualAcompanhamento(); // Mostra o fluxo-restaurante
            atualizarCentralDePedidos(); // Chama a fun√ß√£o que cria a lista (vamos criar ela a seguir)
            
            // Inicia o "espi√£o" para atualizar a lista a cada 5 segundos
            if (intervaloVerificacao) clearInterval(intervaloVerificacao);
            intervaloVerificacao = setInterval(() => atualizarCentralDePedidos(), 5000);
        } else {
            mudarTela('tela-pedido');
        }
    } 
    // 2. Se for CLIENTE comum, segue a l√≥gica original de um pedido s√≥
    else {
        const persistedId = localStorage.getItem('idPedidoAtual');
        if (persistedId) {
            idPedidoAtual = persistedId;
            preencherDetalhesAcompanhamento();
            mudarTela('tela-acompanhamento');
            inicializarVisualAcompanhamento(); // Garante que mostre o fluxo-cliente-comum
            
            verificarStatus(idPedidoAtual);
            if (intervaloVerificacao) clearInterval(intervaloVerificacao); 
            intervaloVerificacao = setInterval(() => verificarStatus(idPedidoAtual), 3000);
        } else {
            mudarTela('tela-pedido');
        }
    }
}

// --- FUN√á√ÉO AUXILIAR PARA TROCAR O VISUAL ---
function inicializarVisualAcompanhamento() {
    const usuarioLogado = JSON.parse(localStorage.getItem("usuario"));
    const fluxoComum = document.getElementById('fluxo-cliente-comum');
    const fluxoEmpresa = document.getElementById('fluxo-restaurante');

    if (usuarioLogado && usuarioLogado.tipo === 'empresa') {
        if(fluxoComum) fluxoComum.style.display = 'none';
        if(fluxoEmpresa) fluxoEmpresa.style.display = 'block';
    } else {
        if(fluxoComum) fluxoComum.style.display = 'block';
        if(fluxoEmpresa) fluxoEmpresa.style.display = 'none';
    }
}
async function atualizarCentralDePedidos() {
    const container = document.getElementById('lista-pedidos-ativos');
    const listaIds = JSON.parse(localStorage.getItem('meus_pedidos_ativos')) || [];

    if (!container) return;

    if (listaIds.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #666;">
                <i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                <p>Nenhuma entrega ativa no momento.</p>
            </div>`;
        return;
    }

    // Criamos uma vari√°vel para acumular o HTML e n√£o ficar "piscando" a tela
    let htmlFinal = "";

    // Fazemos um loop por cada ID salvo
    for (const id of listaIds) {
        try {
            const res = await fetch(`${MEU_IP}/status-pedido/${id}`);
            const data = await res.json();
            
            if (data.success && data.pedido) {
                const p = data.pedido;

                // Define a cor baseada no status (Azul, Verde, Dourado ou Vermelho)
                let corStatus = "#00ffff"; // Buscando
                let icone = "üîç";
                
                if (p.status === 'liberada' || p.status === 'em_andamento') {
                    corStatus = "#00e640"; 
                    icone = "üèçÔ∏è";
                } else if (p.status === 'concluida') {
                    corStatus = "#ffd700";
                    icone = "‚úÖ";
                } else if (p.status === 'cancelada') {
                    corStatus = "#ff4444";
                    icone = "‚ùå";
                }

                htmlFinal += `
                    <div class="info-card" style="border-left: 4px solid ${corStatus}; margin-bottom: 10px; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <span style="font-size: 11px; color: #888; font-weight: bold;">PEDIDO #${id}</span>
                                <div style="color: ${corStatus}; font-size: 13px; font-weight: 800; margin-top: 2px;">
                                    ${icone} ${p.status.toUpperCase()}
                                </div>
                            </div>
                            <button onclick="verDetalhesPedido('${id}')" style="background: ${corStatus}; color: black; border: none; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: bold; cursor: pointer;">
                                VER PEDIDO
                            </button>
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 13px; color: #eee; border-top: 1px solid #333; padding-top: 8px;">
                            <strong>Para:</strong> ${(p.destino || "Endere√ßo n√£o informado").split(',')[0]}
                        </div>
                        
                        <div style="font-size: 12px; color: #aaa; margin-top: 4px;">
                            <strong>Piloto:</strong> ${p.nome_motoboy || 'Procurando...'}
                        </div>
                    </div>
                `;
            }
        } catch (err) {
            console.error("Erro ao buscar pedido " + id, err);
        }
    }

    container.innerHTML = htmlFinal;
}


    // === FUN√á√ïES MAPA E C√ÅLCULO ===
    const map = L.map('map').setView([LAT_TC, LON_TC], 14);
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Mapa &copy; <a href="https://www.mapbox.com/">Mapbox</a> | Dados &copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
        maxZoom: 19,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: MAPBOX_ACCESS_TOKEN
    }).addTo(map);

    map.on('click', async (e) => {
        if (!mapMode) {
            showToast("Clique no bot√£o üó∫Ô∏è ao lado do endere√ßo primeiro.", "info");
            return;
        }
        const { lat, lng } = e.latlng;
        showToast("Buscando endere√ßo com Mapbox...", "info", 1000);
        try {
            const urlMapbox = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?types=address,place&access_token=${MAPBOX_ACCESS_TOKEN}`;
            const res = await fetch(urlMapbox);
            const data = await res.json();
            let rua, bairro;

            if (data.features && data.features.length > 0) {
                const feature = data.features[0];
                rua = feature.place_name.split(',')[0] || "Local Marcado";
                const neighborhood = feature.context.find(c => c.id.startsWith('neighborhood'));
                bairro = (neighborhood && neighborhood.text) || "Tr√™s Cora√ß√µes";
            } else {
                rua = "Local Marcado";
                bairro = "Tr√™s Cora√ß√µes";
            }
            if (mapMode === 'origem') {
                document.getElementById('rua-origem').value = rua;
                document.getElementById('bairro-origem').value = bairro;
                document.getElementById('num-origem').focus();
                coordsOrigem = { lat, lon: lng };
                if (markerOrigem) map.removeLayer(markerOrigem);
                markerOrigem = L.marker([lat, lng]).addTo(map);
            } else {
                document.getElementById('rua-destino').value = rua;
                document.getElementById('bairro-destino').value = bairro;
                document.getElementById('num-destino').focus();
                coordsDestino = { lat, lon: lng };
                if (markerDestino) map.removeLayer(markerDestino);
                markerDestino = L.marker([lat, lng]).addTo(map);
            }

            showToast("Endere√ßo preenchido! Digite o n√∫mero.", "success");
            mapMode = null; 
            calcularRota();
        } catch (error) {
            showToast("Erro ao obter endere√ßo do mapa.", "error");
        }
    });

    function ativarMapa(modo) {
        mapMode = modo;
        showToast(`Toque no mapa para definir a ${modo.toUpperCase()}`, "info");
        document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
    }

    function selecionarServico(tipo, valorBase) {
        servicoSelecionado = tipo;
        document.querySelectorAll('.card').forEach(c => c.classList.remove('selecionado'));
        if (tipo === 'moto-taxi') document.getElementById('card-moto').classList.add('selecionado');
        else document.getElementById('card-entrega').classList.add('selecionado');

        const detailsDiv = document.getElementById('detalhes-entrega-container');
        if (tipo === 'entrega') {
            detailsDiv.style.display = 'block';
        } else {
            detailsDiv.style.display = 'none';
        }

        document.getElementById('btn-pedir').disabled = false;
        document.getElementById('btn-pedir').innerText = tipo === 'entrega' ? "SOLICITAR ENTREGA" : "CHAMAR MOTO T√ÅXI";
        calcularRota();
    }

    

    function calcDistanciaReta(c1, c2) {
        const R = 6371;
        const dLat = (c2.lat - c1.lat) * Math.PI / 180;
        const dLon = (c2.lon - c1.lon) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(c1.lat * Math.PI / 180) * Math.cos(c2.lat * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    async function calcularRota() {
        if (!coordsOrigem || !coordsDestino || !servicoSelecionado) return;
        const resumo = document.getElementById('resumo');
        resumo.style.display = 'block';
        resumo.innerText = "Calculando rota com Mapbox...";

        try {
            const coordenadas = `${coordsOrigem.lon},${coordsOrigem.lat};${coordsDestino.lon},${coordsDestino.lat}`;
            const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordenadas}?geometries=geojson&steps=false&access_token=${MAPBOX_ACCESS_TOKEN}`;
            const res = await fetch(url);
            const json = await res.json();

            let distanciaKm = 0;
            let tempoSegundos = 0;

            if (json.routes && json.routes.length > 0) {
                distanciaKm = json.routes[0].distance / 1000;
                tempoSegundos = json.routes[0].duration;
            } else {
                distanciaKm = calcDistanciaReta(coordsOrigem, coordsDestino) * 1.3;
                tempoSegundos = (distanciaKm / 0.3) * 60; 
            }

            const regra = precos[servicoSelecionado];
            const kmCobrado = Math.max(0, distanciaKm - regra.franquia);
            const total = regra.base + (kmCobrado * regra.kmExtra);
            const tempoMinutos = Math.ceil(tempoSegundos / 60);

            resumo.innerHTML = `
                <div style="font-size:14px; font-weight:normal; color:#ccc;">Dist√¢ncia: ${distanciaKm.toFixed(1)} km &nbsp; | &nbsp; Tempo: ${tempoMinutos} min</div>
                <div>TOTAL: R$ ${total.toFixed(2).replace('.', ',')}</div>
            `;
            window.valorCalculado = total;
        } catch (e) {
            console.error("Erro rota Mapbox", e);
            resumo.innerText = "Erro ao calcular rota.";
        }
    }


    // === FUN√á√ïES DE BUSCA/TIMEOUT ===
    

    async function cancelarBuscaMotoboy() {
        const id = idPedidoAtual || localStorage.getItem('idPedidoAtual');
        if (!id) {
            showToast('Nenhum pedido ativo para cancelar.', 'error');
            return;
        }
        if (!confirm("Tem certeza que deseja cancelar a busca por um motoboy?")) return;

        document.getElementById('modal-busca').style.display = 'flex';
        if (buscaMotoboyInterval) {
            clearInterval(buscaMotoboyInterval);
            buscaMotoboyInterval = null;
        }

        try {
            const res = await fetch(`${MEU_IP}/cancelar-pedido`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, motivo: 'Cancelado pelo cliente durante a busca.' })
            });
            const data = await res.json();

            if (data.success) {
                showToast('Busca cancelada com sucesso!', 'success');
                reiniciarApp(); 
            } else {
                showToast('Erro ao cancelar busca: ' + (data.message || 'Erro desconhecido.'), 'error');
            }
        } catch (err) {
            console.error('Erro ao cancelar busca:', err);
            showToast('Erro de conex√£o. Tente novamente.', 'error');
        } finally {
            document.getElementById('modal-busca').style.display = 'none';
        }
    }

    async function encerrarBuscaPorTimeout(corridaId) {
    try {
        // Chama o backend para cancelar
        await fetch(`${MEU_IP}/cancelar-pedido`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                id: corridaId, 
                motivo: 'Cancelado automaticamente por tempo esgotado (10 minutos).' 
            })
        });
        
        // PARA o timer
        if (buscaMotoboyInterval) {
            clearInterval(buscaMotoboyInterval);
            buscaMotoboyInterval = null;
        }
        
        // Atualiza a interface
        const statusTitulo = document.getElementById('acompanhamento-status-titulo');
        const statusDesc = document.getElementById('acompanhamento-status-desc');
        const timerElement = document.getElementById('timer-segundos');
        const containerTimer = document.getElementById('tempo-restante-busca');
        
        // 1. Atualiza o t√≠tulo e descri√ß√£o
        if (statusTitulo) {
            statusTitulo.innerHTML = '<i class="fas fa-clock"></i> TEMPO ESGOTADO';
            statusTitulo.style.color = "#ff4444";
        }
        
        if (statusDesc) {
            statusDesc.textContent = "N√£o encontramos um piloto dispon√≠vel no momento.";
            statusDesc.style.color = "#aaa";
        }
        
        // 2. CORRE√á√ÉO: N√ÉO remove o timerElement, apenas atualiza
        if (timerElement) {
            timerElement.textContent = "0";
            timerElement.style.color = "#ff4444";
        }
        
        // 3. CORRE√á√ÉO: Atualiza APENAS o conte√∫do de texto, mantendo a estrutura
        if (containerTimer) {
            // Encontra o texto "Tempo estimado:" e substitui
            const elementos = containerTimer.childNodes;
            
            for (let node of elementos) {
                if (node.nodeType === Node.TEXT_NODE && 
                    node.textContent.includes('Tempo estimado:')) {
                    // Substitui APENAS o texto "Tempo estimado:" por "‚è∞"
                    node.textContent = '‚è∞ ';
                    break;
                }
            }
            
            // Muda a cor do container
            containerTimer.style.color = '#ff4444';
        }
        
        // Para a verifica√ß√£o cont√≠nua
        clearInterval(intervaloVerificacao);
        
        // Esconde o bot√£o de cancelamento com taxa
        const areaCancelar = document.getElementById('area-botao-cancelar-taxa');
        if (areaCancelar) {
            areaCancelar.style.display = 'none';
        }
        
        // Mostra op√ß√µes para o usu√°rio
        mostrarOpcoesTempoEsgotado();
        
        showToast('Tempo limite de busca esgotado. Nenhum piloto encontrado.', 'error');
        
    } catch (err) {
        console.error('Erro ao encerrar busca por timeout:', err);
        showToast('Erro ao processar tempo esgotado.', 'error');
    }
}
function mostrarOpcoesTempoEsgotado() {
    const container = document.getElementById('acompanhamento-status-area');
    
    if (!container) return;
    
    // Remove op√ß√µes anteriores
    const opcoesAntigas = document.getElementById('opcoes-tempo-esgotado');
    if (opcoesAntigas) opcoesAntigas.remove();
    
    // Cria as op√ß√µes
    const opcoesDiv = document.createElement('div');
    opcoesDiv.id = 'opcoes-tempo-esgotado';
    opcoesDiv.style.cssText = `
        margin-top: 20px;
        padding: 15px;
        background: rgba(255, 68, 68, 0.1);
        border-radius: 8px;
        border-left: 4px solid #ff4444;
    `;
    
    opcoesDiv.innerHTML = `
        <p style="margin-bottom: 10px; color: #fff; font-size: 14px;">
            Nenhum piloto dispon√≠vel. O que deseja fazer?
        </p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="tentarNovamente()" class="btn-primary" style="flex: 1; min-width: 120px;">
                <i class="fas fa-redo"></i> Nova Busca
            </button>
            <button onclick="voltarParaNovaCorrida()" class="btn-secondary" style="flex: 1; min-width: 120px;">
                <i class="fas fa-plus-circle"></i> Outro Pedido
            </button>
        </div>
        <p style="margin-top: 10px; color: #888; font-size: 11px;">
            "Nova Busca" recria o pedido. "Outro Pedido" volta ao in√≠cio.
        </p>
    `;
    
    container.appendChild(opcoesDiv);
}


function voltarParaNovaCorrida() {
    // Limpa os dados atuais
    clearInterval(intervaloVerificacao);
    clearInterval(buscaMotoboyInterval);
    
    // Mant√©m o rascunho do formul√°rio, mas remove o pedido atual
    localStorage.removeItem('idPedidoAtual');
    localStorage.removeItem('pedidoAtual');
    
    // Volta para a tela de pedido
    mudarTela('tela-pedido');
    
    // Restaura o formul√°rio com os dados salvos (se existirem)
    restaurarRascunhoFormulario();
    
    showToast('Preencha os dados para um novo pedido', 'info');
}

    // === FUN√á√ÉO DE BUSCA (LIMPA E MANUAL) ===
async function buscarEndereco(query, listaId, modo) {
    const lista = document.getElementById(listaId);
    
    if (!query || query.length < 3) {
        lista.innerHTML = '';
        lista.style.display = 'none';
        return;
    }

    // Coordenadas de Tr√™s Cora√ß√µes
    const proximidade = `-45.2581,-21.6931`; 

    try {
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
                    `access_token=${MAPBOX_ACCESS_TOKEN}&` +
                    `proximity=${proximidade}&` +
                    `types=address,poi&` +
                    `language=pt&` +
                    `country=br&` +
                    `limit=5`;

        const res = await fetch(url);
        const data = await res.json();
        
        lista.innerHTML = '';
        lista.style.display = 'block';

        if (data.features.length === 0) {
            lista.style.display = 'none';
            return;
        }

        data.features.forEach(f => {
            const item = document.createElement('div');
            item.className = 'sugestao-item';
            // Limpa o visual
            item.innerText = f.place_name
                .replace(', Minas Gerais', '')
                .replace(', Brasil', '')
                .replace('Tr√™s Cora√ß√µes,', ''); 
            
            item.onclick = () => {
                // 1. Pega apenas o nome da rua
                const nomeRua = f.text; 
                
                // 2. Preenche S√ì A RUA
                document.getElementById(`rua-${modo}`).value = nomeRua;
                
                // 3. LIMPA o Bairro (para obrigar ele a digitar o certo)
                document.getElementById(`bairro-${modo}`).value = "";
                
                // 4. Salva coordenadas
                if (modo === 'origem') coordsOrigem = { lat: f.center[1], lon: f.center[0] };
                else coordsDestino = { lat: f.center[1], lon: f.center[0] };

                // 5. Esconde lista
                lista.innerHTML = '';
                lista.style.display = 'none';

                // 6. Foca no N√öMERO (Fluxo natural: Rua -> N¬∫ -> Bairro)
                document.getElementById(`num-${modo}`).focus();
                
                calcularRota();
            };
            lista.appendChild(item);
        });
    } catch (e) {
        console.error("Erro na busca:", e);
    }
}

// Fecha a lista se clicar fora dela
document.addEventListener('click', (e) => {
    if (!e.target.closest('.address-container')) {
        document.querySelectorAll('.sugestoes-lista').forEach(el => el.style.display = 'none');
    }
});
    // === ENVIO DE PEDIDO ===
    async function pedir() {
    // Pega os valores brutos primeiro para validar
    const campoRuaOrigem = document.getElementById('rua-origem').value.trim();
    const campoRuaDestino = document.getElementById('rua-destino').value.trim();

    // Bloqueio de seguran√ßa: se um dos dois estiver vazio, para tudo
    if (!campoRuaOrigem || !campoRuaDestino) {
        showToast("‚ö†Ô∏è Por favor, informe a rua de origem e destino!", "error");
        return;
    }
    
    const ruaOrigemPura = document.getElementById('rua-origem').value.split(',')[0].trim();
    const ruaDestinoPura = document.getElementById('rua-destino').value.split(',')[0].trim();
    const numOrigem = document.getElementById('num-origem').value.trim();
    const bairroOrigem = document.getElementById('bairro-origem').value.trim();
    const numDestino = document.getElementById('num-destino').value.trim();
    const bairroDestino = document.getElementById('bairro-destino').value.trim();
    const detalhes = document.getElementById('detalhes-entrega').value.trim();

    if (!numOrigem || !bairroOrigem || !numDestino || !bairroDestino || (servicoSelecionado === 'entrega' && !detalhes)) {
        showToast("‚ö†Ô∏è Preencha todos os campos obrigat√≥rios!", "error");
        return;
    }

    const strOrigem = `${ruaOrigemPura}, N¬∫ ${numOrigem}, ${bairroOrigem}`;
    const strDestino = `${ruaDestinoPura}, N¬∫ ${numDestino}, ${bairroDestino}`;
    const strDestinoFinal = servicoSelecionado === 'entrega' ? `${strDestino} (ITEM: ${detalhes})` : strDestino;
    
    document.getElementById('modal-busca').style.display = 'flex';

    try {
        const body = {
            cliente_id: usuario.id,
            origem: strOrigem,
            destino: strDestinoFinal,
            valor: window.valorCalculado || 10.0,
            tipo_servico: servicoSelecionado
        };

        const res = await fetch(`${MEU_IP}/pedir-corrida`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const json = await res.json();

        if (json.success) {
            const idNovo = json.id;
            idPedidoAtual = idNovo;

            // 1. Salva na lista de m√∫ltiplos (Para Empresas)
            let pedidosAtivos = JSON.parse(localStorage.getItem('meus_pedidos_ativos')) || [];
            if (!pedidosAtivos.includes(idNovo)) {
                pedidosAtivos.push(idNovo);
                localStorage.setItem('meus_pedidos_ativos', JSON.stringify(pedidosAtivos));
            }

            // 2. Salva dados para persist√™ncia
            const dadosParaSalvar = {
                origem: strOrigem,
                destino: strDestino,
                valor: window.valorCalculado || 10.0,
                tipo_servico: servicoSelecionado
            };
            localStorage.setItem('pedidoAtual', JSON.stringify(dadosParaSalvar));
            localStorage.setItem('idPedidoAtual', idNovo);
            localStorage.setItem('inicioBuscaTimestamp', Date.now());

            // 3. Decide qual fluxo mostrar baseado no tipo do usu√°rio
            if (usuario && usuario.tipo === 'empresa') {
                mudarTela('tela-acompanhamento');
                inicializarVisualAcompanhamento(); 
                atualizarCentralDePedidos();
            } else {
                preencherDetalhesAcompanhamento();
                mudarTela('tela-acompanhamento');
                inicializarVisualAcompanhamento();
                iniciarContadorBusca(idNovo, 600);
            }

            document.getElementById('modal-busca').style.display = 'none';
            showToast("Solicita√ß√£o enviada!", "success");
            limparRascunho(); // Limpa o formul√°rio para o pr√≥ximo pedido

        } else {
            throw new Error(json.message || "Erro ao processar");
        }
    } catch (e) {
        document.getElementById('modal-busca').style.display = 'none';
        showToast("Erro: " + e.message, "error");
    }
}
function verDetalhesPedido(id) {
    // 1. Define este ID como o principal temporariamente
    idPedidoAtual = id;
    localStorage.setItem('idPedidoAtual', id);
    
    // 2. Esconde a lista da empresa e mostra o acompanhamento comum
    document.getElementById('fluxo-restaurante').style.display = 'none';
    document.getElementById('fluxo-cliente-comum').style.display = 'block';
    
    // 3. Adiciona um bot√£o de "VOLTAR" caso ele n√£o exista
    let btnVoltar = document.getElementById('btn-voltar-lista');
    if (!btnVoltar) {
        const areaStatus = document.getElementById('acompanhamento-status-area');
        areaStatus.insertAdjacentHTML('afterbegin', `
            <button id="btn-voltar-lista" onclick="voltarParaListaEmpresa()" 
                style="width:100%; margin-bottom:15px; background:#333; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer;">
                ‚¨ÖÔ∏è VOLTAR PARA A LISTA
            </button>
        `);
    }

    // 4. Inicia o monitoramento desse pedido espec√≠fico
    preencherDetalhesAcompanhamento();
    verificarStatus(id);
}

function voltarParaListaEmpresa() {
    document.getElementById('fluxo-restaurante').style.display = 'block';
    document.getElementById('fluxo-cliente-comum').style.display = 'none';
    atualizarCentralDePedidos();
}

    // === SUBSTITUA S√ì A FUN√á√ÉO cancelarComTaxa POR ESTA ===
// === VERS√ÉO FINAL: SE N√ÉO ACHAR O ID, ELE PERGUNTA PRA VOC√ä ===
async function cancelarComTaxa() {
    console.log("Abrindo justificativa de cancelamento...");

    // 1. Localiza o modal de justificativa que j√° existe no seu c√≥digo
    const modalJustificativa = document.getElementById('modal-justificativa-cliente');
    
    if (modalJustificativa) {
        // Exibe o modal profissional em vez do confirm feio
        modalJustificativa.style.setProperty('display', 'flex', 'important');
        modalJustificativa.style.opacity = '1';
        modalJustificativa.style.visibility = 'visible';
    } else {
        // Caso o modal n√£o exista, ele avisa no console para voc√™ criar
        console.error("ID modal-justificativa-cliente n√£o encontrado no HTML");
        alert("Erro t√©cnico: Modal de justificativa n√£o localizado.");
    }
}

    
    async function confirmarEncerramentoCliente() {
    const observacao = document.getElementById('campo-encerramento').value.trim();

    document.getElementById('modal-encerramento').style.display = 'none';
    document.getElementById('modal-busca').style.display = 'flex';
    document.getElementById('status-titulo-modal').innerText = "Registrando finaliza√ß√£o...";
    document.getElementById('status-desc-modal').innerText = "Enviando confirma√ß√£o..."; 

    try {
        if (observacao && idPedidoAtual) {
            await fetch(`${MEU_IP}/enviar-mensagem`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    corrida_id: idPedidoAtual,
                    remetente: 'cliente',
                    texto: observacao
                })
            }).catch(err => console.warn('Falha ao enviar observacao:', err));
        }

        document.getElementById('modal-busca').style.display = 'none';
        showToast("Finaliza√ß√£o registrada. Obrigado!", "success", 3000);

        // --- AQUI √â O LUGAR CERTO ---
        limparRascunho(); // Limpa os campos salvos para a pr√≥xima vez
        // -----------------------------

        clearInterval(intervaloVerificacao);
        localStorage.removeItem('idPedidoAtual');
        idPedidoAtual = null;

        document.getElementById('acompanhamento-status-titulo').innerText = "PEDIDO CONCLU√çDO!";
        document.getElementById('acompanhamento-status-desc').innerText = "Obrigado por usar Falc√µes.";
        
        setTimeout(() => reiniciarApp(), 1400);

    } catch (e) {
        document.getElementById('modal-busca').style.display = 'none';
        showToast("Falha ao registrar finaliza√ß√£o: " + e.message, "error");
    }
}
    

    // === INICIALIZA√á√ÉO DE LISTENERS ===
    // === INICIALIZA√á√ÉO COM MEM√ìRIA DE TEMPO (COLE NO FINAL DO SCRIPT) ===
document.addEventListener('DOMContentLoaded', async () => {
    // === C√ìDIGO PARA MANTER LOGADO ===
    const usuarioSalvo = localStorage.getItem('usuario');
    if (usuarioSalvo) {
        window.usuario = JSON.parse(usuarioSalvo); // Restaura os dados do usu√°rio
        if (window.usuario.tipo === 'empresa') {
            document.getElementById('fluxo-restaurante').style.display = 'block';
            document.getElementById('fluxo-cliente-comum').style.display = 'none';
            atualizarCentralDePedidos(); // Carrega a lista automaticamente
        }
    } else {
        // Se n√£o houver sess√£o e n√£o estiver na index, volta pro login
        if (!window.location.href.includes('index.html')) {
            window.location.href = 'index.html';
        }
    }
    // =================================

    const idSalvo = localStorage.getItem('idPedidoAtual');
    // --- üö® AQUI EST√Å A CORRE√á√ÉO DO ID #000 ---
    // Isso garante que o n√∫mero apare√ßa na tela IMEDIATAMENTE
    if (idSalvo) {
        const elId = document.getElementById('acompanhamento-id');
        // Se o elemento existir, for√ßa o texto ser o ID salvo
        if (elId) elId.innerText = '#' + idSalvo; 
        
        // Tamb√©m garante que a vari√°vel global esteja certa
        window.idPedidoAtual = idSalvo;
    }
    

    if (idSalvo) {
        try {
            const API = (typeof MEU_IP !== 'undefined') ? MEU_IP : 'https://falcoes-app.onrender.com';
            
            // 1. Checa o status real no servidor
            const res = await fetch(`${API}/status-pedido/${idSalvo}`);
            const data = await res.json();
            const statusReal = data.pedido ? data.pedido.status : null;

            // Preenche dados visuais (Endere√ßo, Pre√ßo)
            const dados = JSON.parse(localStorage.getItem('pedidoAtual'));
            if (dados) {
                const elOrig = document.getElementById('detalhe-origem');
                const elDest = document.getElementById('detalhe-destino');
                const elValor = document.getElementById('detalhe-valor');
                const elId = document.getElementById('acompanhamento-id');
                if (elOrig) elOrig.innerText = dados.origem || '...';
                if (elDest) elDest.innerText = dados.destino || '...';
                if (elValor) elValor.innerText = `R$ ${parseFloat(dados.valor || 0).toFixed(2).replace('.', ',')}`;
                if (elId) elId.innerText = `#${idSalvo}`;
            }
            
            // Vai para a tela certa
            mudarTela('tela-acompanhamento');
            window.idPedidoAtual = idSalvo;

            // === L√ìGICA DO TIMER (AQUI EST√Å A M√ÅGICA) ===
            if (statusReal === 'pendente') {
                // Recupera quando a busca come√ßou
                const inicioBusca = parseInt(localStorage.getItem('inicioBuscaTimestamp') || Date.now());
                const agora = Date.now();
                const segundosPassados = Math.floor((agora - inicioBusca) / 1000);
                const tempoLimiteTotal = 600; // Seu limite original (600s)
                
                const tempoRestanteReal = tempoLimiteTotal - segundosPassados;

                if (tempoRestanteReal > 0) {
                    // AINDA EST√Å NO PRAZO: Restaura o timer e o bot√£o
                    console.log(`Restaurando busca: faltam ${tempoRestanteReal}s`);
                    
                    // For√ßa o bot√£o de cancelar busca aparecer
                    const btnCancelBusca = document.getElementById('btn-cancelar-busca');
                    if(btnCancelBusca) btnCancelBusca.style.display = 'block';

                    // Inicia o contador com o tempo que sobrou
                    iniciarContadorBusca(idSalvo, tempoRestanteReal);
                } else {
                    // J√Å ESTOUROU O TEMPO ENQUANTO ESTAVA FECHADO
                    document.getElementById('tempo-restante-busca').innerHTML = '<span style="color:#ff4444">‚è∞ Tempo esgotado (Offline).</span>';
                    const btnCancelBusca = document.getElementById('btn-cancelar-busca');
                    if(btnCancelBusca) btnCancelBusca.style.display = 'none';
                    
                    // Opcional: Cancelar automatico se quiser
                    // encerrarBuscaPorTimeout(idSalvo);
                }
            }
            // =============================================

            // Continua monitorando
            verificarStatus(idSalvo);
            if (typeof intervaloVerificacao !== 'undefined') clearInterval(intervaloVerificacao);
            intervaloVerificacao = setInterval(() => verificarStatus(idSalvo), 3000);

        } catch (e) {
            console.error("Erro ao restaurar:", e);
            // Se der erro (sem net), tenta restaurar visualmente pelo menos
            mudarTela('tela-acompanhamento');
        }

    } else {
        if (typeof restaurarRascunhoFormulario === 'function') restaurarRascunhoFormulario();
    }

    // --- MANTENHA O RESTO DOS SEUS LISTENERS ABAIXO DAQUI (Igual antes) ---
    // (Justificativa, Mercado Pago, Inputs, etc.)
    const campoJust = document.getElementById('campo-justificativa-integrada');
    const btnConfirmar = document.getElementById('btn-confirmar-cancelamento');
    const erroJust = document.getElementById('erro-just-integrada');

    // ... (Cole aqui o restante dos c√≥digos de listener que voc√™ j√° tinha) ...
    // Se quiser, posso mandar o bloco completo, mas √© s√≥ manter o final igual.
    
    // REPETINDO O FINAL PARA GARANTIR QUE N√ÉO FALTE NADA:
    if (campoJust && btnConfirmar) {
        campoJust.addEventListener('input', () => {
            const motivo = campoJust.value.trim();
            btnConfirmar.disabled = motivo.length < 5;
            if (motivo.length >= 5 && erroJust) erroJust.style.display = 'none';
        });

        btnConfirmar.addEventListener('click', async () => {
            const motivo = campoJust.value.trim();
            if (motivo.length < 5) {
                if (erroJust) erroJust.style.display = 'block';
                return;
            }
            document.getElementById('area-justificativa-integrada').style.display = 'none';
            const mb = document.getElementById('modal-busca');
            if (mb) { mb.style.display = 'flex'; document.getElementById('status-titulo-modal').innerText = "CANCELANDO..."; }

            const id = window.idPedidoAtual || localStorage.getItem('idPedidoAtual');

            try {
                if (id) {
                    const MEU_IP_GLOBAL = (typeof MEU_IP !== 'undefined') ? MEU_IP : "https://falcoes-app.onrender.com";
                    const res = await fetch(`${MEU_IP_GLOBAL}/cancelar-pedido`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: id, motivo: `[CLIENTE] ${motivo}` })
                    });
                    const json = await res.json().catch(() => ({ success: false }));

                    if (json.success) showToast("Pedido cancelado.", "success");
                    else throw new Error('Falha ao cancelar.');
                }
            } catch (e) {
                showToast("Erro: " + e.message, "error");
            } finally {
                if (mb) mb.style.display = 'none';
                reiniciarApp();
            }
        });
    }

    ['rua-origem', 'num-origem', 'bairro-origem', 'rua-destino', 'num-destino', 'bairro-destino', 'detalhes-entrega'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', salvarRascunhoFormulario);
    });
});

</script>
<script>
// pagamento em dinheiro
async function pagarDinheiro() {
    if (!idPedidoAtual) {
        alert('Pedido inv√°lido');
        return;
    }

    const res = await fetch(`${MEU_IP}/escolher-pagamento`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            id: idPedidoAtual,
            forma_pagamento: 'DINHEIRO'
        })
    });

    const data = await res.json();

    if (data.success) {
        document.getElementById('modal-pagamento').style.display = 'none';
        showToast('Pagamento em dinheiro selecionado', 'success');
    } else {
        alert(data.message || 'Erro ao confirmar pagamento');
    }
}

// pagamento pix
let monitorandoPix = null;

async function pagarPix() {
    if (!idPedidoAtual) {
        showToast('Pedido inv√°lido', 'error');
        return;
    }

    // Feedback visual de carregamento
    const btnPix = document.querySelector('button[onclick="pagarPix()"]');
    const originalText = btnPix.innerHTML;
    btnPix.innerText = "GERANDO C√ìDIGO...";
    btnPix.disabled = true;

    try {
        const res = await fetch(`${MEU_IP}/escolher-pagamento`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: idPedidoAtual,
                forma_pagamento: 'PIX'
            })
        });

        const data = await res.json();

        if (data.success && data.pix_qr_64) {
            const modalContent = document.querySelector('#modal-pagamento .modal-content');
            
            // Substitui o conte√∫do do modal pelos dados do PIX
            modalContent.innerHTML = `
                <h3 style="color: var(--brand-green);">PAGAMENTO PIX</h3>
                <p>Aponte a c√¢mera ou copie o c√≥digo:</p>
                <img src="data:image/jpeg;base64,${data.pix_qr_64}" style="width: 200px; border-radius: 12px; margin: 10px 0; border: 4px solid white;">
                <textarea id="pixCode" readonly style="width:100%; height:60px; font-size:11px; background:#222; color:#fff; border:1px solid #444; border-radius:8px; padding:8px; margin-bottom:10px; resize:none;">${data.pix_copia_cola}</textarea>
                <button class="btn" onclick="copiarCodigoPix()" style="background:#00e640; color:black; font-weight:800;">COPIAR C√ìDIGO PIX</button>
                <div style="margin-top:15px; color:#ffd700; font-weight:bold; font-size:14px;">
                    <span class="spinner-small"></span> Aguardando confirma√ß√£o...
                </div>
                <button onclick="location.reload()" style="background:none; border:none; color:#aaa; margin-top:15px; cursor:pointer;">Cancelar e Voltar</button>
            `;
            
            // O seu loop de 'verificarStatus' que j√° roda no fundo vai detectar a mudan√ßa para 'liberada'
            showToast("Pix gerado com sucesso!", "success");
        } else {
            throw new Error("Dados do Pix n√£o retornados");
        }
    } catch (err) {
        console.error(err);
        showToast('Erro ao gerar PIX. Tente novamente.', 'error');
        btnPix.innerHTML = originalText;
        btnPix.disabled = false;
    }
}

function copiarCodigoPix() {
    const copyText = document.getElementById("pixCode");
    copyText.select();
    copyText.setSelectionRange(0, 99999); // Para dispositivos m√≥veis
    navigator.clipboard.writeText(copyText.value);
    
    const btn = document.querySelector('button[onclick="copiarCodigoPix()"]');
    btn.innerText = "‚úÖ COPIADO!";
    setTimeout(() => { btn.innerText = "COPIAR C√ìDIGO PIX"; }, 2000);

}

// ============================================================
// SISTEMA DE MEM√ìRIA AUTOM√ÅTICA (PERSIST√äNCIA DE DADOS)
// ============================================================

// 1. Lista dos campos que queremos salvar
const camposParaSalvar = [
    'rua-origem', 'num-origem', 'bairro-origem',
    'rua-destino', 'num-destino', 'bairro-destino',
    'detalhes-entrega'
];

// 2. Fun√ß√£o que salva tudo no navegador
function salvarRascunhoFormulario() {
    const rascunho = {};
    
    // Salva o texto dos inputs
    camposParaSalvar.forEach(id => {
        const el = document.getElementById(id);
        if (el) rascunho[id] = el.value;
    });

    // IMPORTANTE: Salva tamb√©m as coordenadas (para o mapa n√£o quebrar)
    if (typeof coordsOrigem !== 'undefined') rascunho.coordsOrigem = coordsOrigem;
    if (typeof coordsDestino !== 'undefined') rascunho.coordsDestino = coordsDestino;
    if (typeof servicoSelecionado !== 'undefined') rascunho.servico = servicoSelecionado;

    localStorage.setItem('rascunho_cliente', JSON.stringify(rascunho));
}

// 3. Fun√ß√£o que recupera os dados quando a tela abre
function restaurarRascunhoFormulario() {
    const dados = JSON.parse(localStorage.getItem('rascunho_cliente'));
    if (!dados) return; // Se n√£o tem nada salvo, n√£o faz nada

    // Preenche os textos
    camposParaSalvar.forEach(id => {
        const el = document.getElementById(id);
        if (el && dados[id]) el.value = dados[id];
    });

    // Recupera as coordenadas e o servi√ßo
    if (dados.coordsOrigem) coordsOrigem = dados.coordsOrigem;
    if (dados.coordsDestino) coordsDestino = dados.coordsDestino;
    
    // Se tinha um servi√ßo selecionado, marca ele de novo
    if (dados.servico) {
        selecionarServico(dados.servico, dados.servico === 'moto-taxi' ? 10.0 : 8.50);
    }

    // Se tiver os dois endere√ßos completos, j√° tenta recalcular a rota/pre√ßo
    if (dados.coordsOrigem && dados.coordsDestino) {
        calcularRota();
    }
}

// 4. Fun√ß√£o para limpar (Usar apenas quando a corrida for FINALIZADA com sucesso)
function limparRascunho() {
    localStorage.removeItem('rascunho_cliente');
    // Limpa os campos visuais tamb√©m
    camposParaSalvar.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    coordsOrigem = null;
    coordsDestino = null;
    document.getElementById('resumo').innerHTML = '';
}

// 5. ATIVA√á√ÉO AUTOM√ÅTICA
document.addEventListener('DOMContentLoaded', () => {
    // Tenta restaurar assim que abre
    restaurarRascunhoFormulario();

    // Adiciona o "espi√£o" que salva a cada letra digitada
    camposParaSalvar.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', salvarRascunhoFormulario);
        }
    });
});

// === FUN√á√ÉO MEU LOCAL (GPS) ===
function usarMeuLocal() {
    if (!navigator.geolocation) {
        showToast("Seu navegador n√£o suporta geolocaliza√ß√£o.", "error");
        return;
    }

    const btn = document.querySelector('.btn-my-location');
    btn.classList.add('gps-loading'); // Ativa anima√ß√£o
    showToast("Obtendo sua localiza√ß√£o...", "info");

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        try {
            // Usa o Mapbox para descobrir o endere√ßo (Reverse Geocoding)
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lon},${lat}.json?types=address&access_token=${MAPBOX_ACCESS_TOKEN}`;
            const res = await fetch(url);
            const data = await res.json();

            if (data.features && data.features.length > 0) {
                const feature = data.features[0];
                const rua = feature.text; // Nome da rua
                const numero = feature.address || ""; // N√∫mero aproximado (se houver)
                
                // Tenta achar o bairro no contexto
                const neighborhood = feature.context.find(c => c.id.startsWith('neighborhood'));
                const bairro = (neighborhood && neighborhood.text) ? neighborhood.text : "Tr√™s Cora√ß√µes";

                // Preenche os campos
                document.getElementById('rua-origem').value = rua;
                document.getElementById('num-origem').value = numero; // Mapa as vezes erra o n√∫mero, mas ajuda
                document.getElementById('bairro-origem').value = bairro;

                // Salva coordenadas globais
                coordsOrigem = { lat, lon };
                
                // Coloca marcador no mapa
                if (markerOrigem) map.removeLayer(markerOrigem);
                markerOrigem = L.marker([lat, lon]).addTo(map);
                map.setView([lat, lon], 16);

                showToast("Localiza√ß√£o encontrada!", "success");
                
                // Recalcula rota se j√° tiver destino
                calcularRota();
                
                // Salva no rascunho
                salvarRascunhoFormulario();
            } else {
                showToast("N√£o consegui identificar o endere√ßo exato.", "error");
            }
        } catch (err) {
            console.error(err);
            showToast("Erro ao converter GPS em endere√ßo.", "error");
        } finally {
            btn.classList.remove('gps-loading');
        }

    }, (err) => {
        btn.classList.remove('gps-loading');
        if(err.code === 1) showToast("Permiss√£o de localiza√ß√£o negada.", "error");
        else showToast("Erro ao buscar GPS. Verifique se est√° ligado.", "error");
    }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
    });
}

// ============================================================
// üß† MEGA BLOCO: LIMPEZA INTELIGENTE, MEM√ìRIA E SAIR
// ============================================================

// 1. FUN√á√ÉO SAIR CORRIGIDA (Redireciona para o login real)
function logout() {
    localStorage.removeItem('usuario'); // Remove especificamente o login
    localStorage.removeItem('rascunho_cliente'); // Limpa rascunhos
    window.location.href = 'index.html'; // Volta para a tela de login real
}

// 2. FUN√á√ÉO DO BOT√ÉO "LIMPAR" (A Lixeira)
function limparFormularioManual() {
    // Limpa visualmente os campos
    document.getElementById('rua-origem').value = '';
    document.getElementById('num-origem').value = '';
    document.getElementById('bairro-origem').value = '';
    document.getElementById('rua-destino').value = '';
    document.getElementById('num-destino').value = '';
    document.getElementById('bairro-destino').value = '';
    document.getElementById('detalhes-entrega').value = '';
    
    // Zera vari√°veis internas do sistema
    coordsOrigem = null;
    coordsDestino = null;
    servicoSelecionado = null;
    
    // Remove marcadores do mapa se existirem
    if(typeof map !== 'undefined') {
        if(typeof markerOrigem !== 'undefined' && markerOrigem) map.removeLayer(markerOrigem);
        if(typeof markerDestino !== 'undefined' && markerDestino) map.removeLayer(markerDestino);
    }
    
    // Esconde o resumo de pre√ßo
    const resumo = document.getElementById('resumo');
    if(resumo) resumo.style.display = 'none';

    // Apaga a mem√≥ria do navegador
    localStorage.removeItem('rascunho_cliente');
    
    showToast("Campos limpos com sucesso!", "info");
}

// 3. SALVAR TUDO AUTOMATICAMENTE (Com Data e Hora)
function salvarRascunhoFormulario() {
    const rascunho = {};
    
    ['rua-origem', 'num-origem', 'bairro-origem', 
     'rua-destino', 'num-destino', 'bairro-destino', 
     'detalhes-entrega'].forEach(id => {
        const el = document.getElementById(id);
        if (el) rascunho[id] = el.value;
    });

    if (typeof coordsOrigem !== 'undefined') rascunho.coordsOrigem = coordsOrigem;
    if (typeof coordsDestino !== 'undefined') rascunho.coordsDestino = coordsDestino;
    if (typeof servicoSelecionado !== 'undefined') rascunho.servico = servicoSelecionado;

    // IMPORTANTE: Salva a hora exata (Timestamp) para saber se est√° velho depois
    rascunho.timestamp = new Date().getTime();

    localStorage.setItem('rascunho_cliente', JSON.stringify(rascunho));
}

// 4. RESTAURAR (S√≥ se foi salvo h√° menos de 2 horas)
function restaurarRascunhoFormulario() {
    const dadosString = localStorage.getItem('rascunho_cliente');
    if (!dadosString) return;

    const dados = JSON.parse(dadosString);

    // --- REGRA DE VALIDADE (2 HORAS) ---
    const AGORA = new Date().getTime();
    const DUAS_HORAS = 2 * 60 * 60 * 1000; // 7200000 milissegundos

    // Se o rascunho for velho, apaga e n√£o preenche nada
    if (dados.timestamp && (AGORA - dados.timestamp > DUAS_HORAS)) {
        console.log("Rascunho expirado (mais de 2h). Limpando...");
        localStorage.removeItem('rascunho_cliente');
        return; 
    }
    // -------------------------

    // Se estiver novo, preenche tudo
    ['rua-origem', 'num-origem', 'bairro-origem', 
     'rua-destino', 'num-destino', 'bairro-destino', 
     'detalhes-entrega'].forEach(id => {
        const el = document.getElementById(id);
        if (el && dados[id]) el.value = dados[id];
    });

    if (dados.coordsOrigem) coordsOrigem = dados.coordsOrigem;
    if (dados.coordsDestino) coordsDestino = dados.coordsDestino;
    
    if (dados.servico) {
        // Seleciona o bot√£o certo visualmente
        selecionarServico(dados.servico, dados.servico === 'moto-taxi' ? 10.0 : 8.50);
    }

    // Se tiver os dois endere√ßos, j√° calcula o pre√ßo
    if (dados.coordsOrigem && dados.coordsDestino) {
        calcularRota();
    }
}

// 5. ATIVAR OS ESPI√ïES (Start)
// Tenta restaurar assim que carrega o script
restaurarRascunhoFormulario();

// Adiciona o evento de salvar a cada letra digitada
['rua-origem', 'num-origem', 'bairro-origem', 
 'rua-destino', 'num-destino', 'bairro-destino', 
 'detalhes-entrega'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', salvarRascunhoFormulario);
    }
});
    // Se quiser esconder o card manualmente tamb√©m:
    document.getElementById('motoboy-info-box').style.display = 'none';

        

function resetarTimerCompletamente() {
    const containerTimer = document.getElementById('tempo-restante-busca');
    if (containerTimer) {
        // Volta ao HTML original
        containerTimer.innerHTML = '‚è≥ Tempo estimado: <span id="timer-segundos" style="color: var(--neon-green); font-weight: bold;">90</span>s';
        containerTimer.style.color = '#aaa';
        containerTimer.style.display = 'none';
    }
    
    // Para qualquer timer ativo
    if (buscaMotoboyInterval) {
        clearInterval(buscaMotoboyInterval);
        buscaMotoboyInterval = null;
    }
}

/* === COLE ISSO NO FINAL PARA TER O TIMER DE BARRA CORRETO === */



function atualizarTextoTimer(elemento, segundos) {
    const spanNumero = document.getElementById('timer-numeros');
    if (spanNumero) spanNumero.innerText = segundos + "s";
}

// ============================================================
// ‚úÖ BLOCO CORRIGIDO (TIMER + STATUS UNIFICADOS)
// Cole isso no final do seu script, substituindo as fun√ß√µes antigas
// ============================================================

// 1. Vari√°veis Globais de Controle
let timerBuscaInterval = null;   // Controla o rel√≥gio visual (90s)

// 2. Fun√ß√£o do Timer Visual (Corrigida)
// 2. Fun√ß√£o do Timer Visual (COM FORMATA√á√ÉO DE MINUTOS)
function iniciarContadorBusca(idPedido, segundosIniciais = 600) { // <--- MUDADO PARA 600
    // Limpa qualquer timer anterior
    if (timerBuscaInterval) clearInterval(timerBuscaInterval);

    const elContainer = document.getElementById('tempo-restante-busca'); 
    const elNumero = document.getElementById('timer-numeros');
    const btnCancelar = document.getElementById('btn-cancelar-busca');

    if (!elContainer) return;

    // Fun√ß√£o interna para formatar 00:00
    const formatarTempo = (s) => {
        const min = Math.floor(s / 60).toString().padStart(2, '0');
        const seg = (s % 60).toString().padStart(2, '0');
        return `${min}:${seg}`;
    };

    // Reseta o visual inicial
    elContainer.style.display = 'flex';
    elContainer.style.borderColor = 'rgba(0, 255, 0, 0.3)';
    elContainer.style.color = '#ccc';
    // Aqui j√° mostramos formatado
    elContainer.innerHTML = '‚è≥ Tempo estimado: <span id="timer-numeros" style="color: var(--neon-green); font-weight: bold; font-size: 16px; margin-left:5px;">' + formatarTempo(segundosIniciais) + '</span>';
    
    if (btnCancelar) btnCancelar.style.display = 'block';

    let restantes = segundosIniciais;

    timerBuscaInterval = setInterval(() => {
        restantes--;
        
        const spanNum = document.getElementById('timer-numeros');
        if (spanNum) {
            spanNum.innerText = formatarTempo(restantes); // <--- ATUALIZA COM FORMATO 00:00
        }

        // Cores de alerta (quando faltar 1 min e 30 seg)
        if (spanNum && restantes <= 60) spanNum.style.color = "#ff9900"; // Laranja
        if (spanNum && restantes <= 15) spanNum.style.color = "#ff4444"; // Vermelho

        if (restantes <= 0) {
            clearInterval(timerBuscaInterval);
            timerBuscaInterval = null;
            encerrarBuscaPorTimeout(idPedido);
        }
    }, 1000);
}
function abrirAviso() {
    document.getElementById('modal-aviso').style.display = 'flex';
}

function fecharAviso() {
    document.getElementById('modal-aviso').style.display = 'none';
}

// 3. Fun√ß√£o de Verifica√ß√£o de Status (Que sabe parar o timer acima)
async function verificarStatus(id) {
    try {
        const res = await fetch(`${MEU_IP}/status-pedido/${id}`);
        const data = await res.json();
        const pedido = data.pedido;

        if (!data.success || !pedido) return;

        // Elementos da Interface
        const statusTitulo = document.getElementById('acompanhamento-status-titulo');
        const statusDesc   = document.getElementById('acompanhamento-status-desc');
        const statusArea   = document.getElementById('acompanhamento-status-area'); 
        const motoboyBox   = document.getElementById('motoboy-info-box');
        const btnWpp       = document.getElementById('btn-whatsapp-motoboy');
        const wrapperWpp   = document.querySelector('.whatsapp-center-wrapper'); 
        const modal        = document.getElementById('modal-pagamento'); 
        const btnTaxa      = document.getElementById('area-botao-cancelar-taxa');
        const elTempo      = document.getElementById('tempo-restante-busca');
        const btnCancelBusca = document.getElementById('btn-cancelar-busca');
        const btnFechar    = document.getElementById('btn-fechar-novo');
        const areaCodigo   = document.getElementById('area-codigo-seguranca');
        const textoCodigo  = document.getElementById('texto-codigo-seguranca');

        // --- LIMPEZA DE CORES NEON (NOVO) ---
        // Garante que n√£o fique azul e verde ao mesmo tempo
        if (statusArea) {
            statusArea.classList.remove('status-buscando', 'status-finalizada');
        }

        // L√≥gica do C√≥digo de Seguran√ßa (Mantida)
        if (pedido.codigo_seguranca && areaCodigo && textoCodigo) {
            if (pedido.status !== 'concluida' && pedido.status !== 'cancelada') {
                areaCodigo.style.display = 'block'; 
                textoCodigo.innerText = pedido.codigo_seguranca; 
            } else {
                areaCodigo.style.display = 'none';
            }
        }

        // --- L√≥gica de Estados ---

        // üî¥ CANCELADA
        if (pedido.status === 'cancelada') {
            if (intervaloVerificacao) clearInterval(intervaloVerificacao);
            if (timerBuscaInterval) clearInterval(timerBuscaInterval);
            
            if (statusArea) statusArea.setAttribute('style', 'background: rgba(255, 68, 68, 0.15) !important; border: 1px solid #ff4444 !important;');
            if (statusTitulo) { statusTitulo.style.color = '#ff4444'; statusTitulo.innerText = "PEDIDO CANCELADO ‚ùå"; }
            if (statusDesc) statusDesc.innerText = "Esta corrida foi cancelada.";
            
            if (motoboyBox) motoboyBox.style.display = 'none';
            if (btnWpp) btnWpp.style.display = 'none';
            if (btnTaxa) btnTaxa.style.display = 'none';
            if (btnCancelBusca) btnCancelBusca.style.display = 'none';

            const areaEstorno = document.getElementById('area-estorno-adm');
            if(areaEstorno) areaEstorno.style.display = 'block';
            
            if(btnFechar) {
                btnFechar.style.display = 'block';
                btnFechar.innerText = "FAZER NOVO PEDIDO";
                btnFechar.onclick = reiniciarApp;
            }
        }

        // üîµ PENDENTE (BUSCANDO - NOVO VISUAL AZUL)
        else if (pedido.status === 'pendente') {
            if (statusTitulo) statusTitulo.innerHTML = 'BUSCANDO PILOTO...'; // Mantive seu texto original
            
            // APLICA O AZUL NEON
            if (statusArea) statusArea.classList.add('status-buscando');
            
            if (btnCancelBusca) btnCancelBusca.style.display = 'block';
        }

        // üü° AGUARDANDO PAGAMENTO / ACEITA
        else if (pedido.status === 'aguardando_pagamento' || pedido.status === 'aceita') {
            if (timerBuscaInterval) { clearInterval(timerBuscaInterval); timerBuscaInterval = null; }
            if (elTempo) elTempo.style.display = 'none';
            if (btnCancelBusca) btnCancelBusca.style.display = 'none';

            if (modal && !modal.classList.contains('show')) {
                modal.classList.add('show');
            }
            // Mantive sua l√≥gica de mostrar o pre√ßo
            if (document.getElementById('valor-modal-pagamento')) {
                 document.getElementById('valor-modal-pagamento').innerText = "R$ " + parseFloat(pedido.valor).toFixed(2).replace('.', ',');
            }
            
            if (statusTitulo) { statusTitulo.style.color = '#ffd700'; statusTitulo.innerText = "üéØ ESCOLHA COMO PAGAR"; }
            if (statusDesc) statusDesc.innerText = "Um piloto aceitou! Aguardando pagamento.";
        }

        // üü¢ EM CORRIDA / LIBERADA
        else if (pedido.status === 'liberada' || pedido.status === 'em_andamento') {
            if (timerBuscaInterval) { clearInterval(timerBuscaInterval); timerBuscaInterval = null; }
            if (elTempo) elTempo.style.display = 'none';
            if (btnCancelBusca) btnCancelBusca.style.display = 'none';
            if (modal) { modal.classList.remove('show'); modal.style.display = 'none'; }

            // Garante o Verde Padr√£o
            if (statusArea) statusArea.setAttribute('style', 'background: rgba(0, 230, 64, 0.15) !important; border: 1px solid #00e640 !important;');
            if (statusTitulo) { statusTitulo.style.color = '#00e640'; statusTitulo.innerHTML = '<i class="fas fa-motorcycle"></i> PILOTO A CAMINHO'; }
            
            if (motoboyBox) motoboyBox.style.display = 'block';
            document.getElementById('motoboy-nome').innerText = pedido.nome_motoboy || "Piloto";
            document.getElementById('motoboy-placa').innerText = pedido.placa || "---";
            document.getElementById('motoboy-modelo').innerText = pedido.modelo_moto || "Moto";
            document.getElementById('motoboy-cor').innerText = pedido.cor_moto || "";

            if (pedido.telefone_motoboy && btnWpp) {
                const fone = pedido.telefone_motoboy.replace(/\D/g, '');
                btnWpp.href = `https://wa.me/${fone.length === 11 ? '55' + fone : fone}`;
                btnWpp.style.display = 'inline-flex';
                if(wrapperWpp) wrapperWpp.style.display = 'flex';
            }

            if (btnTaxa) btnTaxa.style.display = 'block';

            if (pedido.status === 'em_andamento') {
                statusTitulo.innerHTML = '<i class="fas fa-route"></i> EM VIAGEM';
                statusDesc.innerText = "Voc√™ est√° a caminho do destino.";
                if (btnTaxa) btnTaxa.style.display = 'none';
            }
        }

        // üü° CONCLU√çDA (NOVO VISUAL DOURADO)
        else if (pedido.status === 'concluida') {
            if (intervaloVerificacao) clearInterval(intervaloVerificacao);
            
            // APLICA O DOURADO NEON
            if (statusArea) statusArea.classList.add('status-finalizada');
            // Remove o estilo inline cinza antigo para o CSS novo pegar
            statusArea.removeAttribute('style'); 

            if (statusTitulo) { 
                statusTitulo.innerHTML = "CORRIDA FINALIZADA ‚úÖ"; 
                // A cor do texto agora vem do CSS .status-finalizada
            }
            if (statusDesc) statusDesc.innerText = "Obrigado por viajar conosco!";
            
            // Esconde tudo
            if (motoboyBox) motoboyBox.style.display = 'none';
            if (btnWpp) btnWpp.style.display = 'none';
            if (wrapperWpp) wrapperWpp.style.display = 'none';
            if (btnTaxa) btnTaxa.style.display = 'none';
            if (btnCancelBusca) btnCancelBusca.style.display = 'none';
            if (areaCodigo) areaCodigo.style.display = 'none';

            // Mostra bot√£o novo pedido
            if(btnFechar) {
                btnFechar.style.display = 'block';
                btnFechar.innerText = "FAZER NOVO PEDIDO";
                btnFechar.onclick = reiniciarApp;
                
                // Aplica a classe do bot√£o bonito que fizemos antes
                btnFechar.className = 'btn-novo-pedido-neon'; 
                btnFechar.style.margin = "20px auto";
                btnFechar.style.display = "block";
            }
            
            if(typeof limparRascunho === 'function') limparRascunho();
        }

    } catch (e) {
        console.error("Erro status:", e);
    }
}
async function enviarCancelamentoComJustificativa() {
    // Pega o ID do pedido
    let id = idPedidoAtual || localStorage.getItem('idPedidoAtual');
    
    // Pega o texto que o cliente digitou no campo de justificativa
    // Certifique-se que o ID do seu campo de texto seja 'justificativa-texto'
    const campoTexto = document.getElementById('justificativa-texto');
    const motivoCliente = campoTexto ? campoTexto.value : "Cliente cancelou (sem justificativa)";

    if (!motivoCliente.trim()) {
        alert("Por favor, escreva o motivo do cancelamento.");
        return;
    }

    try {
        const res = await fetch(`${MEU_IP}/cancelar-pedido`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                id: id, 
                motivo: `[CLIENTE] ${motivoCliente}`,
                cancelado_por: 'cliente' 
            })
        });

        const json = await res.json();
        if (json.success) {
            alert("‚úÖ Corrida cancelada!");
            window.location.reload();
        }
    } catch (e) {
        alert("Erro de conex√£o.");
    }
}
function verDetalhesPedido(id) {
    // 1. Define este ID como o foco atual
    window.idPedidoAtual = id;
    
    // 2. Esconde a lista e mostra o mapa
    document.getElementById('fluxo-restaurante').style.display = 'none';
    document.getElementById('fluxo-cliente-comum').style.display = 'block';
    
    // 3. Cria o bot√£o de voltar para a lista se n√£o existir
    if (!document.getElementById('btn-voltar-lista')) {
        const areaHeader = document.getElementById('acompanhamento-status-area');
        areaHeader.insertAdjacentHTML('afterbegin', `
            <button id="btn-voltar-lista" onclick="voltarParaListaEmpresa()" 
                style="width:100%; margin-bottom:15px; background:#333; color:white; border:1px solid var(--neon-green); padding:10px; border-radius:8px; font-weight:bold; cursor:pointer;">
                ‚¨ÖÔ∏è VOLTAR PARA A CENTRAL
            </button>
        `);
    }

    // 4. Carrega os dados espec√≠ficos deste pedido no mapa
    // Nota: Como √© um pedido antigo, os dados de endere√ßo precisam ser buscados do servidor ou salvos em um objeto maior.
    // Para simplificar, o verificarStatus j√° vai preencher o motorista e o status no mapa.
    verificarStatus(id);
}

function voltarParaListaEmpresa() {
    document.getElementById('fluxo-restaurante').style.display = 'block';
    document.getElementById('fluxo-cliente-comum').style.display = 'none';
    const btn = document.getElementById('btn-voltar-lista');
    if (btn) btn.remove();
    atualizarCentralDePedidos();
}
</script>