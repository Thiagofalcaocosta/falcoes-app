<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Falc√µes App</title>

    <!-- Leaflet CSS para o mapa -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        crossorigin=""
    />

    <style>
        /* --- IDENTIDADE VISUAL FALC√ïES (DARK MODE OFICIAL - PRESERVADO) --- */
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --neon-green: #00e640;
            --text-color: #ffffff;
            --input-bg: #2c2c2c;
            --border-color: #333;
            --error-color: #ff4444;
            --dica-color: #555; /* dica mais escura e discreta */
        }

        body {
            font-family: "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--card-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 230, 64, 0.1);
            position: relative;
            border: 1px solid var(--border-color);
        }

        .logo-area {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo-area img {
            max-height: 100px;
            filter: drop-shadow(0 0 5px rgba(0, 230, 64, 0.5));
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .user-info {
            font-weight: 600;
            color: #ccc;
        }
        .estrelas {
            background-color: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        .logout a {
            color: var(--error-color);
            text-decoration: none;
            font-weight: 600;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            color: var(--neon-green);
            letter-spacing: 1px;
        }

        .opcoes-servico {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .instrucao-servico {
            font-size: 13px;
            color: var(--dica-color);
            margin-bottom: 12px;
            text-align: center;
            opacity: 0.85;
        }

        .card {
            flex: 1;
            padding: 20px 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: #252525;
            color: #aaa;
        }
        .card:hover {
            border-color: var(--neon-green);
            color: white;
        }
        .card.selecionado {
            border-color: var(--neon-green);
            background-color: rgba(0, 230, 64, 0.1);
            color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 230, 64, 0.2);
        }
        .icon {
            font-size: 32px;
            display: block;
            margin-bottom: 8px;
        }
        .preco {
            font-size: 15px;
            font-weight: 500;
        }

        label {
            display: block;
            margin-top: 12px;
            font-weight: 600;
            color: #ddd;
            margin-bottom: 8px;
        }
        .input-group {
            position: relative;
            margin-bottom: 6px;
        }
        input {
            width: 100%;
            padding: 14px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 16px;
            transition: 0.3s;
        }
        input:focus {
            border-color: var(--neon-green);
            outline: none;
        }
        input.erro {
            border-color: var(--error-color);
        }

        .sugestoes-lista {
            position: absolute;
            top: 105%;
            left: 0;
            right: 0;
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        .sugestao-item {
            padding: 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
        }
        .sugestao-item:hover {
            background-color: #2c2c2c;
        }
        .rua-texto {
            font-size: 16px;
            font-weight: 600;
            color: var(--neon-green);
        }
        .bairro-texto {
            font-size: 13px;
            color: #aaa;
        }

        .resumo-final {
            margin-top: 25px;
            padding: 18px;
            background-color: rgba(0, 230, 64, 0.15);
            color: var(--neon-green);
            border: 1px solid var(--neon-green);
            text-align: center;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 700;
            display: none;
        }

        .btn {
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            background-color: var(--neon-green);
            color: black;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
        }
        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--neon-green);
        }
        .btn:disabled {
            background-color: #444;
            color: #888;
            cursor: not-allowed;
        }

        /* --- MODAL (MANTIDO O DESIGN DARK) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .modal-content {
            background: var(--card-color);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            width: 85%;
            max-width: 350px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 40px rgba(0, 230, 64, 0.15);
        }
        .spinner {
            border: 6px solid #333;
            border-top: 6px solid var(--neon-green);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: girar 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes girar {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .status-texto {
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }
        .sub-status {
            font-size: 14px;
            color: #aaa;
            line-height: 1.4;
        }

        /* Bot√£o Cancelar Vermelho (Novo) */
        .btn-cancelar {
            background-color: transparent;
            border: 1px solid var(--error-color);
            color: var(--error-color);
            font-size: 14px;
            margin-top: 20px;
            padding: 10px;
        }
        .btn-cancelar:hover {
            background-color: var(--error-color);
            color: white;
            box-shadow: none;
        }

        #info-motoboy {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            border: 1px solid var(--neon-green);
        }
        .moto-nome {
            font-size: 20px;
            color: var(--neon-green);
            font-weight: 800;
            text-transform: uppercase;
            margin-top: 5px;
        }
        .moto-fone {
            color: white;
            margin-top: 5px;
            display: block;
            font-size: 16px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #121212;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-green);
        }

        /* Estilos para o mapa e bot√£o toggle */
        #map {
            height: 150px;
            border-radius: 12px;
            margin-top: 20px;
        }

        #btnDefinirOrigem, #btnDefinirDestino {
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 6px;
            width: auto;
            display: inline-block;
            cursor: pointer;
            font-weight: 700;
        }

        #btnDefinirOrigem:hover, #btnDefinirDestino:hover {
            background: rgba(0,230,64,0.12);
        }

        /* dica discreta acima do bot√£o */
        .dica-mapa {
            font-size: 12px;
            margin: 4px 0 6px 0;
            color: var(--dica-color);
            opacity: 0.75;
        }

        /* TOAST posicionado embaixo (voltar ao estilo inicial sugerido) */
        .toast-container {
            position: fixed;
            left: 50%;
            bottom: 24px;
            transform: translateX(-50%);
            z-index: 10050;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            pointer-events: none;
        }
        .toast {
            min-width: 280px;
            max-width: 520px;
            background: #000;
            border-radius: 12px;
            padding: 12px 16px;
            color: #fff;
            box-shadow: 0 12px 40px rgba(0,0,0,0.6);
            display: flex;
            gap: 12px;
            align-items: center;
            opacity: 0;
            transform: translateY(6px);
            animation: toast-in 260ms forwards;
            font-weight: 700;
            border: 2px solid var(--neon-green);
            pointer-events: auto;
        }
        @keyframes toast-in {
            to { opacity: 1; transform: translateY(0); }
        }
        .toast.info { border-color: var(--neon-green); color: #eaffea; }
        .toast.success { border-color: #00c853; color: #eaffea; }
        .toast.error { border-color: var(--error-color); color: #ffdede; }
        .toast .msg { flex: 1; font-size: 15px; color: inherit; }
        .toast .close {
            cursor: pointer;
            background: transparent;
            border: none;
            color: inherit;
            font-weight: 900;
            font-size: 14px;
            opacity: 0.95;
        }

        /* Responsividade: reduzir largura do toast em telas pequenas */
        @media (max-width: 420px) {
            .toast { min-width: 240px; max-width: 340px; padding: 10px; font-size: 14px; }
            #map { height: 130px; }
            .container { padding: 18px; }
        }
    </style>
</head>
<body>
    <!-- Toast embaixo -->
    <div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <div class="modal-overlay" id="modal-busca">
        <div class="modal-content">
            <div id="area-spinner" class="spinner"></div>

            <div id="status-titulo" class="status-texto">BUSCANDO PILOTO...</div>
            <div id="status-desc" class="sub-status">
                Notificando os pilotos mais pr√≥ximos.
            </div>

            <div id="info-motoboy">
                <div style="font-size: 40px; margin-bottom: 10px;">üèçÔ∏è</div>
                <div style="font-size: 12px; color: #aaa;">SEU PILOTO:</div>
                <div class="moto-nome" id="nome-motoboy">--</div>
                <span class="moto-fone" id="fone-motoboy">--</span>
                <br />
                <button
                    onclick="window.location.reload()"
                    style="margin-top: 15px; font-size: 14px; padding: 10px"
                >
                    FECHAR / NOVO PEDIDO
                </button>
            </div>

            <!-- inicialmente oculto -->
            <button id="btn-cancelar-pedido" class="btn-cancelar" onclick="cancelarPedido()" style="display:none;">
                CANCELAR PEDIDO
            </button>
        </div>
    </div>

    <div class="container">
        <div class="logo-area"><img src="assets/logo.png" alt="Logo" /></div>

        <div class="header-top">
            <div class="user-info">
                <span id="msg-ola">Piloto</span> <span class="estrelas">‚òÖ 5.0</span>
            </div>
            <div class="logout"><a href="index.html" onclick="localStorage.clear()">SAIR</a></div>
        </div>

        <h2>NOVA CORRIDA</h2>

        <div class="opcoes-servico">
            <div class="card" id="card-moto" onclick="selecionarServico('moto-taxi', 10.0)">
                <span class="icon">üèçÔ∏è</span>
                <div class="card-title">MOTO T√ÅXI</div>
                <div class="preco">R$ 10,00</div>
            </div>
            <div class="card" id="card-entrega" onclick="selecionarServico('entrega', 8.50)">
                <span class="icon">üì¶</span>
                <div class="card-title">ENTREGA</div>
                <div class="preco">R$ 8,50</div>
            </div>
        </div>

        <!-- instru√ß√£o geral curta abaixo dos servi√ßos (mais discreta) -->
        <div class="instrucao-servico">üîπ Obrigat√≥rio escolher um servi√ßo acima.</div>

        <div id="form-endereco">
            <!-- ORIGEM: dica curta (acima do bot√£o), bot√£o e campo -->
            <div class="dica-mapa">üîπ Toque no bot√£o e depois no mapa.</div>
            <div style="text-align:right; margin-bottom:6px;">
                <button id="btnDefinirOrigem">üìç Escolher ORIGEM no mapa</button>
            </div>
            <label>üìç LOCAL DE BUSCA (ORIGEM)</label>
            <div class="input-group">
                <!-- Campo inicialmente VAZIO; s√≥ preenche quando o usu√°rio escolhe a rua -->
                <input
                    type="text"
                    id="origem"
                    placeholder="Digite o nome da rua..."
                    oninput="limparErro(this); buscarEndereco(this.value, 'lista-origem', 'origem')"
                    autocomplete="off"
                />
                <div id="lista-origem" class="sugestoes-lista"></div>
            </div>

            <!-- DESTINO: dica curta (acima do bot√£o), bot√£o e campo -->
            <div class="dica-mapa">üîπ Toque no bot√£o e depois no mapa.</div>
            <div style="text-align:right; margin-bottom:6px;">
                <button id="btnDefinirDestino">üèÅ Escolher DESTINO no mapa</button>
            </div>
            <label>üèÅ LOCAL DE ENTREGA (DESTINO)</label>
            <div class="input-group">
                <input
                    type="text"
                    id="destino"
                    placeholder="Digite o nome da rua..."
                    oninput="limparErro(this); buscarEndereco(this.value, 'lista-destino', 'destino')"
                    autocomplete="off"
                />
                <div id="lista-destino" class="sugestoes-lista"></div>
            </div>
        </div>

        <!-- Div para o mapa -->
        <div id="map"></div>

        <div class="resumo-final" id="resumo">Total: R$ 0,00</div>

        <button onclick="pedir()" id="btn-pedir" class="btn" disabled>SELECIONE O SERVI√áO</button>
    </div>

    <!-- SCRIPTS -->
    <script>
        // TOAST default duration (ms)
        const TOAST_DEFAULT = 4200;

        function showToast(message, type = "info", duration = TOAST_DEFAULT) {
            const container = document.getElementById("toast-container");
            // manter apenas 1 toast vis√≠vel (interface limpa)
            container.innerHTML = "";
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.innerHTML = `<div class="msg">${message}</div><button class="close" aria-label="Fechar">‚úï</button>`;
            container.appendChild(toast);

            const closeBtn = toast.querySelector(".close");
            let hideTimeout = setTimeout(() => removeToast(toast), duration);
            closeBtn.addEventListener("click", () => {
                clearTimeout(hideTimeout);
                removeToast(toast);
            });

            function removeToast(node) {
                node.style.transition = "all 200ms ease";
                node.style.opacity = "0";
                node.style.transform = "translateY(8px)";
                setTimeout(() => {
                    if (node.parentNode) node.parentNode.removeChild(node);
                }, 220);
            }
        }

        // === CONFIGURA√á√ÉO ===
        const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6Ijg2N2E2MTBhODg4ODQxNmVhYThlNjJmYWM4N2VkNjVlIiwiaCI6Im11cm11cjY0In0=";
        const MEU_IP = 'https://falcoes-app.onrender.com';
        const LAT_TC = -21.69;
        const LON_TC = -45.25;

        const usuario = JSON.parse(localStorage.getItem("usuario"));
        if (!usuario) window.location.href = "index.html";
        document.getElementById("msg-ola").innerText =
            "OL√Å, " + usuario.nome.split(" ")[0].toUpperCase();

        const baseFee = { "moto-taxi": 10.0, entrega: 8.50 };
        const pricePerKm = { "moto-taxi": 3.15, entrega: 2.0 };

        let servicoSelecionado = "",
            valorFinal = 0,
            timeoutBusca = null,
            intervaloVerificacao = null,
            idPedidoAtual = null,
            coordsOrigem = null,
            coordsDestino = null,
            ultimoKmCalculado = null;

        function selecionarServico(tipo, valor) {
            servicoSelecionado = tipo;
            valorFinal = valor;
            document.getElementById("card-moto").classList.remove("selecionado");
            document.getElementById("card-entrega").classList.remove("selecionado");
            if (tipo === "moto-taxi")
                document.getElementById("card-moto").classList.add("selecionado");
            else document.getElementById("card-entrega").classList.add("selecionado");
            const resumo = document.getElementById("resumo");
            resumo.style.display = "block";
            if (ultimoKmCalculado !== null && ultimoKmCalculado !== undefined) {
                const calc = calcularValorPorKm(ultimoKmCalculado, tipo);
                resumo.innerText = `DIST: ${ultimoKmCalculado.toFixed(
                    2
                )} km ‚Äî TOTAL: R$ ${formatBRL(calc.total)}`;
                valorFinal = calc.total;
            } else {
                resumo.innerText = `TOTAL A PAGAR: R$ ${valor.toFixed(2)}`;
                valorFinal = valor;
            }
            document.getElementById("btn-pedir").disabled = false;
            document.getElementById("btn-pedir").innerText = "CHAMAR MOTOBOY";
        }

        function formatBRL(n) {
            return Number(n).toFixed(2).replace(".", ",");
        }

        function calcularValorPorKm(km, tipo) {
            const base = baseFee[tipo] ?? 0;
            const perKm = pricePerKm[tipo] ?? 0;

            if (tipo === "moto-taxi") {
                // moto-taxi: apenas acima de 3 km √© cobrado por km
                const kmCobrado = Math.max(0, km - 3); // km acima de 3
                const total = base + kmCobrado * perKm;
                return {
                    total,
                    base,
                    perKm,
                    kmTotal: km,      // km real da corrida
                    kmCobrado,        // km que gerou cobran√ßa por km
                    tipo
                };
            }

            // entrega: apenas acima de 3 km √© cobrado por km
                const kmCobrado = Math.max(0, km - 3); // km acima de 3
                const total = base + kmCobrado * perKm;
                return {
                    total,
                    base,
                    perKm,
                    kmTotal: km,      // km real da corrida
                    kmCobrado,        // km que gerou cobran√ßa por km
                    tipo
                };
            }

        // ==== FUN√á√ÉO ADICIONADA: atualizarResumoComKm (necess√°ria) ====
        function atualizarResumoComKm(km) {
            ultimoKmCalculado = km;
            const resumo = document.getElementById("resumo");
            resumo.style.display = "block";
            if (!servicoSelecionado) {
                resumo.innerText = `DIST: ${km.toFixed(2)} km ‚Äî Selecione o servi√ßo para ver o total.`;
                return;
            }
            const calc = calcularValorPorKm(km, servicoSelecionado);
            valorFinal = calc.total;

            if (servicoSelecionado === "moto-taxi") {
                resumo.innerText = `DIST: ${calc.kmTotal.toFixed(2)} km (cobrado ${calc.kmCobrado.toFixed(2)} km) ‚Äî TOTAL: R$ ${formatBRL(calc.total)}`;
            } else {
                resumo.innerText = `DIST: ${calc.kmTotal.toFixed(2)} km ‚Äî TOTAL: R$ ${formatBRL(calc.total)}`;
            }
        }
        // ==== fim fun√ß√£o adicionada ====

        async function obterDistanciaEmKm(lat1, lon1, lat2, lon2) {
            try {
                const body = {
                    coordinates: [
                        [lon1, lat1],
                        [lon2, lat2],
                    ],
                    units: "m",
                };
                const response = await fetch(
                    "https://api.openrouteservice.org/v2/directions/driving-car/geojson",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: ORS_API_KEY,
                        },
                        body: JSON.stringify(body),
                    }
                );
                if (!response.ok) {
                    console.error("ORS directions error status:", response.status);
                    return null;
                }
                const json = await response.json();
                if (
                    json &&
                    json.features &&
                    json.features.length > 0 &&
                    json.features[0].properties &&
                    json.features[0].properties.summary
                ) {
                    const meters = json.features[0].properties.summary.distance;
                    const km = meters / 1000;
                    return km;
                } else if (
                    json &&
                    json.routes &&
                    json.routes.length > 0 &&
                    json.routes[0].summary
                ) {
                    const meters = json.routes[0].summary.distance;
                    return meters / 1000;
                } else {
                    console.error("Resposta ORS inesperada:", json);
                    return null;
                }
            } catch (err) {
                console.error("Erro ao chamar ORS Directions:", err);
                return null;
            }
        }

        // buscarEndereco: preenche o campo apenas quando o usu√°rio escolhe a rua (ou o mapa define)
        function buscarEndereco(texto, idLista, idInput) {
            const lista = document.getElementById(idLista);
            if (texto.length < 3) {
                lista.style.display = "none";
                return;
            }
            clearTimeout(timeoutBusca);
            timeoutBusca = setTimeout(async () => {
                const url = `https://api.openrouteservice.org/geocode/autocomplete?text=${encodeURIComponent(
                    texto
                )}&focus.point.lat=${LAT_TC}&focus.point.lon=${LON_TC}&boundary.country=BR&size=6`;
                try {
                    const response = await fetch(url, {
                        headers: { Authorization: ORS_API_KEY },
                    });
                    if (!response.ok) {
                        console.error("Erro autocomplete ORS status:", response.status);
                        lista.style.display = "none";
                        return;
                    }
                    const data = await response.json();
                    lista.innerHTML = "";
                    let encontrou = false;
                    if (data.features && data.features.length > 0) {
                        data.features.forEach((local) => {
                            const props = local.properties || {};
                            const textoCompleto = (props.label || "").toString();
                            const textoNormalizado = textoCompleto
                                .normalize("NFD")
                                .replace(/[\u0300-\u036f]/g, "")
                                .toLowerCase();
                            // filtrar para Tr√™s Cora√ß√µes
                            if (
                                !textoNormalizado.includes("tres coracoes") &&
                                !textoNormalizado.includes("tres cora√ßoes") &&
                                !textoNormalizado.includes("tr√™s cora√ß√µes") &&
                                !textoNormalizado.includes("tres-coroacoes")
                            ) {
                                return;
                            }
                            let bairroDoMapa =
                                props.neighbourhood ||
                                props.suburb ||
                                props.locality ||
                                props.county ||
                                "";
                            const city = props.city || "";
                            const cityNorm = city.normalize
                                ? city.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase()
                                : "";
                            if (!bairroDoMapa && city && cityNorm !== "tres coracoes") {
                                bairroDoMapa = city;
                            }
                            const nomeRua =
                                props.street ||
                                props.name ||
                                textoCompleto.split(",")[0] ||
                                textoCompleto;
                            const detalheLista = bairroDoMapa
                                ? `${bairroDoMapa} - Tr√™s Cora√ß√µes`
                                : "Tr√™s Cora√ß√µes - MG";
                            const coords =
                                local.geometry && local.geometry.coordinates
                                    ? {
                                          lon: local.geometry.coordinates[0],
                                          lat: local.geometry.coordinates[1],
                                      }
                                    : null;
                            encontrou = true;
                            const div = document.createElement("div");
                            div.className = "sugestao-item";
                            if (coords) {
                                div.dataset.lat = coords.lat;
                                div.dataset.lon = coords.lon;
                            }
                            if (bairroDoMapa) div.dataset.bairro = bairroDoMapa;
                            div.innerHTML = `
                                <div style="display:flex; flex-direction:column;">
                                    <span class="rua-texto">${nomeRua}</span>
                                    <span class="bairro-texto">${detalheLista}</span>
                                </div>
                            `;
                            div.onclick = async () => {
                                const inputField = document.getElementById(idInput);
                                const bairro = div.dataset.bairro ? div.dataset.bairro : "";
                                // Preenche o campo apenas quando o usu√°rio escolhe a rua
                                if (bairro)
                                    inputField.value = `${nomeRua}, N¬∫ , Bairro ${bairro}`;
                                else inputField.value = `${nomeRua}, N¬∫ , Bairro `;
                                const posCursor = nomeRua.length + 5;
                                inputField.focus();
                                try {
                                    inputField.setSelectionRange(posCursor, posCursor);
                                } catch (e) {}
                                lista.style.display = "none";
                                const lat = div.dataset.lat ? parseFloat(div.dataset.lat) : null;
                                const lon = div.dataset.lon ? parseFloat(div.dataset.lon) : null;
                                if (idInput === "origem")
                                    coordsOrigem = lat && lon ? { lat, lon } : null;
                                else coordsDestino = lat && lon ? { lat, lon } : null;
                                if (coordsOrigem && coordsDestino) {
                                    const km = await obterDistanciaEmKm(
                                        coordsOrigem.lat,
                                        coordsOrigem.lon,
                                        coordsDestino.lat,
                                        coordsDestino.lon
                                    );
                                    if (km !== null) atualizarResumoComKm(km);
                                }
                                // after selection, show reminder that number and bairro are required
                                showToast("Preencha N¬∫ e Bairro no campo selecionado.", "info", TOAST_DEFAULT);
                            };
                            lista.appendChild(div);
                        });
                    }
                    lista.style.display = encontrou ? "block" : "none";
                } catch (error) {
                    console.error("Erro API (autocomplete):", error);
                    lista.style.display = "none";
                }
            }, 400);
        }

        function limparErro(input) {
            input.classList.remove("erro");
        }
        function verificarNumero(texto) {
            if (!texto.includes("N¬∫")) return false;
            const partes = texto.split("N¬∫");
            if (partes.length < 2) return false;
            const trechoNumero = partes[1].split(",")[0].trim();
            if (trechoNumero.length === 0) return false;
            return true;
        }

        async function pedir() {
            const origemInput = document.getElementById("origem");
            const destinoInput = document.getElementById("destino");
            const origem = origemInput.value;
            const destino = destinoInput.value;
            let erro = false;
            if (!origem || !verificarNumero(origem)) {
                origemInput.classList.add("erro");
                erro = true;
            }
            if (!destino || !verificarNumero(destino)) {
                destinoInput.classList.add("erro");
                erro = true;
            }
            if (erro) {
                showToast("‚ö†Ô∏è N√öMERO da casa OBRIGAT√ìRIO.", "error", TOAST_DEFAULT );
                return;
            }

            // Se ainda n√£o calculou km, tenta calcular
            if ((ultimoKmCalculado === null || ultimoKmCalculado === undefined) && coordsOrigem && coordsDestino) {
                const km = await obterDistanciaEmKm(
                    coordsOrigem.lat,
                    coordsOrigem.lon,
                    coordsDestino.lat,
                    coordsDestino.lon
                );
                if (km !== null) {
                    atualizarResumoComKm(km);
                }
            }

            // mostra modal e spinner, ativa cancelar
            document.getElementById("area-spinner").style.display = "block";
            document.getElementById("btn-cancelar-pedido").style.display = "block";
            document.getElementById("status-titulo").innerText = "BUSCANDO PILOTO...";
            document.getElementById("status-titulo").style.color = "white";
            document.getElementById("status-desc").innerText = "Notificando os pilotos mais pr√≥ximos.";
            document.getElementById("info-motoboy").style.display = "none";

            document.getElementById("modal-busca").style.display = "flex";

            const bodyData = {
                cliente_id: usuario.id,
                origem: origem,
                destino: destino,
                valor: valorFinal,
                tipo_servico: servicoSelecionado,
            };

            try {
                const response = await fetch(`${MEU_IP}/pedir-corrida`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(bodyData),
                });
                if (!response.ok) {
                    document.getElementById("modal-busca").style.display = "none";
                    showToast("Erro no servidor: status " + response.status, "error", TOAST_DEFAULT );
                    return;
                }
                const result = await response.json();
                if (result.success) {
                    idPedidoAtual = result.id;
                    // iniciar checagem de status
                    intervaloVerificacao = setInterval(() => verificarStatus(idPedidoAtual), 3000);
                    showToast("Pedido enviado. Aguardando piloto...", "success", TOAST_DEFAULT );
                } else {
                    document.getElementById("modal-busca").style.display = "none";
                    showToast("Erro no servidor: " + result.message, "error", TOAST_DEFAULT );
                }
            } catch (err) {
                document.getElementById("modal-busca").style.display = "none";
                showToast("Erro de conex√£o.", "error", TOAST_DEFAULT );
                console.error("Erro ao enviar pedido:", err);
            }
        }

        async function cancelarPedido() {
            if (!idPedidoAtual) return;

            // Mantive prompt() por enquanto; posso trocar por modal se quiser
            const motivo = prompt("Qual o motivo do cancelamento?");
            if (motivo === null) return;

            clearInterval(intervaloVerificacao);

            try {
                const response = await fetch(`${MEU_IP}/cancelar-pedido`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id: idPedidoAtual, motivo: motivo || "Sem motivo" }),
                });
                if (!response.ok) {
                    showToast("Erro ao cancelar (status " + response.status + ")", "error", TOAST_DEFAULT + 2000);
                    return;
                }
                showToast("Pedido cancelado.", "success", TOAST_DEFAULT );
                window.location.reload();
            } catch (err) {
                showToast("Erro ao cancelar.", "error", TOAST_DEFAULT );
                console.error("Erro cancelarPedido:", err);
            }
        }

        async function verificarStatus(idPedido) {
            try {
                const response = await fetch(`${MEU_IP}/status-pedido/${idPedido}`);
                if (!response.ok) {
                    console.error("Erro status-pedido:", response.status);
                    return;
                }
                const data = await response.json();
                if (data.success) {
                    const pedido = data.pedido;
                    if (pedido.status === "aceita") {
                        clearInterval(intervaloVerificacao);
                        document.getElementById("area-spinner").style.display = "none";
                        document.getElementById("btn-cancelar-pedido").style.display = "none";

                        document.getElementById("status-titulo").innerText = "FALC√ÉO LOCALIZADO!";
                        document.getElementById("status-titulo").style.color = "var(--neon-green)";
                        document.getElementById("status-desc").innerText =
                            "Seu piloto est√° a caminho do ponto de coleta.";
                        document.getElementById("info-motoboy").style.display = "block";

                        const nomeM = pedido.nome_motoboy
                            ? pedido.nome_motoboy.toUpperCase()
                            : "MOTOBOY";
                        const foneM = pedido.telefone_motoboy ? pedido.telefone_motoboy : "N√£o informado";
                        document.getElementById("nome-motoboy").innerText = nomeM;
                        document.getElementById("fone-motoboy").innerText = foneM;
                    }
                }
            } catch (err) {
                console.error("Erro verifica√ß√£o", err);
            }
        }

        document.addEventListener("click", function (e) {
            if (!e.target.closest(".input-group")) {
                document.querySelectorAll(".sugestoes-lista").forEach((el) => (el.style.display = "none"));
            }
        });
    </script>

    <!-- Leaflet JS para o mapa -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
    <script>
        // Inicializando mapa centralizado em Tr√™s Cora√ß√µes
        const map = L.map("map").setView([-21.69, -45.255], 15);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "¬© OpenStreetMap",
        }).addTo(map);

        let definirPonto = null; // null | "origem" | "destino"
        let markerOrigem = null;
        let markerDestino = null;

        // Bot√µes para selecionar qual ponto ser√° definido no mapa
        document.getElementById("btnDefinirOrigem").addEventListener("click", () => {
            definirPonto = "origem";
            showToast("Toque no mapa para definir a ORIGEM.", "info", TOAST_DEFAULT );
        });

        document.getElementById("btnDefinirDestino").addEventListener("click", () => {
            definirPonto = "destino";
            showToast("Toque no mapa para definir o DESTINO.", "info", TOAST_DEFAULT );
        });

        map.on("click", async (e) => {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;

            // Se n√£o foi selecionado um bot√£o, avisa e retorna
            if (!definirPonto) {
                showToast("Clique primeiro em 'Escolher ORIGEM'.", "info", TOAST_DEFAULT + 2000);
                return;
            }

            // Adiciona/atualiza marcador correto
            if (definirPonto === "origem") {
                if (markerOrigem) map.removeLayer(markerOrigem);
                markerOrigem = L.marker(e.latlng).addTo(map);
            } else if (definirPonto === "destino") {
                if (markerDestino) map.removeLayer(markerDestino);
                markerDestino = L.marker(e.latlng).addTo(map);
            }

            // Geocodifica√ß√£o reversa -> usar header Authorization
            const url = `https://api.openrouteservice.org/geocode/reverse?point.lat=${lat}&point.lon=${lon}&size=1`;
            try {
                const response = await fetch(url, {
                    headers: {
                        Authorization: ORS_API_KEY,
                    },
                });
                if (!response.ok) {
                    console.error("Erro reverse geocode status:", response.status);
                    showToast("Erro na busca do endere√ßo (geocode).", "error", TOAST_DEFAULT );
                    return;
                }
                const data = await response.json();
                if (data.features && data.features.length > 0) {
                    const props = data.features[0].properties;
                    const street = props.street || props.name || "";
                    const bairro =
                        props.neighbourhood ||
                        props.suburb ||
                        props.locality ||
                        props.county ||
                        "";
                    if (street) {
                        if (definirPonto === "origem") {
                            const origemInput = document.getElementById("origem");
                            // Preenche com bairro autom√°tico
                            origemInput.value = `${street}, N¬∫ , Bairro ${bairro}`;
                            origemInput.focus();
                            try { origemInput.setSelectionRange(street.length + 7, street.length + 7); } catch(e){}
                            coordsOrigem = { lat, lon };
                            showToast("Origem definida. Preencha N¬∫ se necess√°rio.", "success", TOAST_DEFAULT );
                        } else {
                            const destinoInput = document.getElementById("destino");
                            destinoInput.value = `${street}, N¬∫ , Bairro ${bairro}`;
                            destinoInput.focus();
                            try { destinoInput.setSelectionRange(street.length + 7, street.length + 7); } catch(e){}
                            coordsDestino = { lat, lon };
                            showToast("Destino definido. Preencha N¬∫ se necess√°rio.", "success", TOAST_DEFAULT );
                        }

                        // Depois de definir o ponto, reseta para evitar novo clique acidental
                        definirPonto = null;

                        // Se j√° tem origem e destino definidos ‚Üí calcula km
                        if (coordsOrigem && coordsDestino) {
                            const km = await obterDistanciaEmKm(
                                coordsOrigem.lat,
                                coordsOrigem.lon,
                                coordsDestino.lat,
                                coordsDestino.lon
                            );
                            if (km !== null) atualizarResumoComKm(km);
                        }
                    } else {
                        showToast("Endere√ßo n√£o encontrado para esse ponto.", "error", TOAST_DEFAULT );
                    }
                } else {
                    showToast("Endere√ßo n√£o encontrado para esse ponto.", "error", TOAST_DEFAULT );
                }
            } catch (e) {
                console.error("Erro na geocodifica√ß√£o reversa:", e);
                showToast("Erro ao consultar o endere√ßo.", "error", TOAST_DEFAULT );
            }
        });
    </script>
</body>
</html>
